<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üí≥ M√©todos de Pago - Totales - Esentia</title>
  <script type="module">
    // üî• Firebase Config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentia-factura-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===============================
    // üìä Estado global
    // ===============================
    let resumenMetodos = {
      efectivo: { cantidad: 0, monto: 0, clientes: new Set() },
      sinpe: { cantidad: 0, monto: 0, clientes: new Set() },
      transferencia: { cantidad: 0, monto: 0, clientes: new Set() },
      tarjeta: { cantidad: 0, monto: 0, clientes: new Set() },
      pendiente: { cantidad: 0, monto: 0, clientes: new Set() }
    };
    let transacciones = [];
    let clientesCache = {};

    // ===============================
    // üì• Cargar datos de m√©todos de pago
    // ===============================
    async function cargarMetodosPago() {
      try {
        document.getElementById('loading').style.display = 'flex';
        
        // Resetear contadores
        resumenMetodos = {
          efectivo: { cantidad: 0, monto: 0, clientes: new Set() },
          sinpe: { cantidad: 0, monto: 0, clientes: new Set() },
          transferencia: { cantidad: 0, monto: 0, clientes: new Set() },
          tarjeta: { cantidad: 0, monto: 0, clientes: new Set() },
          pendiente: { cantidad: 0, monto: 0, clientes: new Set() }
        };
        transacciones = [];
        
        // 1. Cargar clientes base
        const snapClientes = await getDocs(collection(db, "clientesBD"));
        snapClientes.forEach(doc => {
          clientesCache[doc.id] = { id: doc.id, ...doc.data() };
        });

        // 2. Cargar TODAS las facturas
        const snapFacturas = await getDocs(collection(db, "facturas"));
        
        for (const docSnap of snapFacturas.docs) {
          const clienteId = docSnap.id;
          const cliente = clientesCache[clienteId] || { nombre: 'Cliente #' + clienteId.slice(0,5), telefono: '' };
          const data = docSnap.data();
          const compras = data.compras || [];
          
          compras.forEach(compra => {
            const fecha = compra.fecha ? new Date(compra.fecha) : null;
            const montoTotal = Number(compra.total ?? (compra.monto - (compra.descuento || 0)));
            const pagado = Number(compra.pagado || 0);
            const metodo = (compra.metodoPago || 'Pendiente').toLowerCase();
            const saldo = montoTotal - pagado;
            
            // Determinar estado
            const estado = saldo <= 0 ? 'pagado' : 'pendiente';
            
            // Normalizar m√©todo
            let metodoNormalizado = 'pendiente';
            if (estado === 'pagado') {
              if (metodo.includes('efectivo')) metodoNormalizado = 'efectivo';
              else if (metodo.includes('sinpe') || metodo.includes('sinpemovil')) metodoNormalizado = 'sinpe';
              else if (metodo.includes('transferencia') || metodo.includes('transfer')) metodoNormalizado = 'transferencia';
              else if (metodo.includes('tarjeta') || metodo.includes('credito') || metodo.includes('debito')) metodoNormalizado = 'tarjeta';
              else metodoNormalizado = 'efectivo'; // Default para pagos completos sin m√©todo especificado
            }
            
            // Acumular en resumen
            resumenMetodos[metodoNormalizado].cantidad += 1;
            resumenMetodos[metodoNormalizado].monto += pagado > 0 ? pagado : montoTotal;
            resumenMetodos[metodoNormalizado].clientes.add(clienteId);
            
            // Guardar transacci√≥n detallada
            transacciones.push({
              clienteId,
              clienteNombre: cliente.nombre || 'Sin nombre',
              clienteTelefono: cliente.telefono || '',
              fecha: fecha ? fecha.toISOString().split('T')[0] : 'Sin fecha',
              fechaObj: fecha,
              metodo: metodoNormalizado,
              monto: pagado > 0 ? pagado : montoTotal,
              montoTotalFactura: montoTotal,
              pagado: pagado,
              saldo: saldo,
              estado: estado,
              productos: compra.productos || []
            });
          });
        }
        
        document.getElementById('loading').style.display = 'none';
        renderizarResumen();
        renderizarTransacciones();
        actualizarGraficos();
      } catch (error) {
        console.error("Error cargando m√©todos de pago:", error);
        document.getElementById('loading').style.display = 'none';
        mostrarToast("‚ùå Error al cargar datos: " + error.message);
      }
    }

    // ===============================
    // üìä Renderizar resumen visual
    // ===============================
    function renderizarResumen() {
      const contenedor = document.getElementById('resumen-metodos');
      
      // Calcular totales generales
      const totalTransacciones = Object.values(resumenMetodos).reduce((sum, m) => sum + m.cantidad, 0);
      const totalMonto = Object.values(resumenMetodos).reduce((sum, m) => sum + m.monto, 0);
      
      let html = `
        <div class="resumen-grid">
          ${crearTarjetaMetodo('efectivo', 'üíµ Efectivo', '#4CAF50')}
          ${crearTarjetaMetodo('sinpe', 'üì± SINPE M√≥vil', '#2196F3')}
          ${crearTarjetaMetodo('transferencia', 'üè¶ Transferencia', '#FF9800')}
          ${crearTarjetaMetodo('tarjeta', 'üí≥ Tarjeta', '#9C27B0')}
          ${crearTarjetaMetodo('pendiente', '‚è≥ Pendiente/Cr√©dito', '#F44336')}
          
          <div class="resumen-item total">
            <span class="etiqueta">TOTAL GENERAL</span>
            <span class="valor-grande">‚Ç°${totalMonto.toLocaleString('es-CR')}</span>
            <span class="subvalor">${totalTransacciones} transacciones</span>
          </div>
        </div>
      `;
      
      contenedor.innerHTML = html;
    }
    
    function crearTarjetaMetodo(metodo, nombre, color) {
      const datos = resumenMetodos[metodo];
      const porcentaje = datos.monto > 0 ? Math.round((datos.monto / Object.values(resumenMetodos).reduce((sum, m) => sum + m.monto, 0)) * 100) : 0;
      
      return `
        <div class="resumen-item metodo" style="--color:${color}">
          <div class="icono-metodo" style="background-color:${color}22; color:${color}">
            ${nombre.split(' ')[0]}
          </div>
          <div class="datos-metodo">
            <span class="etiqueta">${nombre}</span>
            <span class="valor">‚Ç°${datos.monto.toLocaleString('es-CR')}</span>
            <span class="subvalor">${datos.cantidad} pagos | ${datos.clientes.size} clientes</span>
            ${porcentaje > 0 ? `<div class="barra-porcentaje" style="width:${porcentaje}%; background-color:${color}"></div>` : ''}
          </div>
        </div>
      `;
    }

    // ===============================
    // üìã Renderizar transacciones detalladas
    // ===============================
    function renderizarTransacciones() {
      const contenedor = document.getElementById('tabla-transacciones');
      const fechaDesde = document.getElementById('fecha-desde').value;
      const fechaHasta = document.getElementById('fecha-hasta').value;
      const metodoFiltro = document.getElementById('filtro-metodo').value;
      
      // Filtrar transacciones
      let filtradas = [...transacciones];
      
      if (fechaDesde) {
        filtradas = filtradas.filter(t => t.fecha >= fechaDesde);
      }
      if (fechaHasta) {
        filtradas = filtradas.filter(t => t.fecha <= fechaHasta);
      }
      if (metodoFiltro !== 'todos') {
        filtradas = filtradas.filter(t => t.metodo === metodoFiltro);
      }
      
      // Ordenar por fecha descendente
      filtradas.sort((a, b) => (b.fechaObj || 0) - (a.fechaObj || 0));
      
      let html = `
        <div class="tabla-responsive">
          <table class="tabla-transacciones">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>M√©todo</th>
                <th>Monto</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      filtradas.forEach(trans => {
        const colorMetodo = {
          'efectivo': '#4CAF50',
          'sinpe': '#2196F3',
          'transferencia': '#FF9800',
          'tarjeta': '#9C27B0',
          'pendiente': '#F44336'
        }[trans.metodo];
        
        html += `
          <tr>
            <td data-label="Fecha">${trans.fecha}</td>
            <td data-label="Cliente">
              <strong>${trans.clienteNombre}</strong>
              ${trans.clienteTelefono ? `<br><small>üìû ${trans.clienteTelefono}</small>` : ''}
            </td>
            <td data-label="M√©todo">
              <span class="badge-metodo" style="background-color:${colorMetodo}22; color:${colorMetodo}; border-color:${colorMetodo}44">
                ${trans.metodo === 'efectivo' ? 'üíµ Efectivo' : 
                  trans.metodo === 'sinpe' ? 'üì± SINPE' : 
                  trans.metodo === 'transferencia' ? 'üè¶ Transf.' : 
                  trans.metodo === 'tarjeta' ? 'üí≥ Tarjeta' : '‚è≥ Pendiente'}
              </span>
            </td>
            <td data-label="Monto" class="numero">
              <strong>‚Ç°${trans.monto.toLocaleString('es-CR')}</strong>
              ${trans.saldo > 0 ? `<br><small class="saldo-pendiente">Saldo: ‚Ç°${trans.saldo.toLocaleString('es-CR')}</small>` : ''}
            </td>
            <td data-label="Estado">
              <span class="badge-estado ${trans.estado === 'pagado' ? 'pagado' : 'pendiente'}">
                ${trans.estado === 'pagado' ? '‚úÖ Pagado' : '‚è≥ Pendiente'}
              </span>
            </td>
          </tr>
        `;
      });
      
      if (filtradas.length === 0) {
        html += `
          <tr>
            <td colspan="5" class="sin-datos">
              No hay transacciones con los filtros seleccionados
            </td>
          </tr>
        `;
      }
      
      html += `
            </tbody>
          </table>
        </div>
        
        <div class="resumen-pie">
          <strong>${filtradas.length}</strong> transacciones | 
          <strong>‚Ç°${filtradas.reduce((sum, t) => sum + t.monto, 0).toLocaleString('es-CR')}</strong> total
        </div>
      `;
      
      contenedor.innerHTML = html;
    }

    // ===============================
    // üìà Generar gr√°ficos con Canvas (sin librer√≠as externas)
    // ===============================
    function actualizarGraficos() {
      // Gr√°fico de Montos por M√©todo
      const canvasMonto = document.getElementById('grafico-monto');
      const ctxMonto = canvasMonto.getContext('2d');
      
      // Gr√°fico de Cantidad por M√©todo
      const canvasCantidad = document.getElementById('grafico-cantidad');
      const ctxCantidad = canvasCantidad.getContext('2d');
      
      const metodos = ['efectivo', 'sinpe', 'transferencia', 'tarjeta', 'pendiente'];
      const colores = ['#4CAF50', '#2196F3', '#FF9800', '#9C27B0', '#F44336'];
      const labels = ['Efectivo', 'SINPE', 'Transferencia', 'Tarjeta', 'Pendiente'];
      
      // Datos para gr√°ficos
      const montos = metodos.map(m => resumenMetodos[m].monto);
      const cantidades = metodos.map(m => resumenMetodos[m].cantidad);
      
      // Limpiar canvases anteriores
      ctxMonto.clearRect(0, 0, canvasMonto.width, canvasMonto.height);
      ctxCantidad.clearRect(0, 0, canvasCantidad.width, canvasCantidad.height);
      
      // Dibujar gr√°fico de montos
      dibujarGraficoBarras(ctxMonto, montos, colores, 'Montos Totales');
      
      // Dibujar gr√°fico de cantidades
      dibujarGraficoBarras(ctxCantidad, cantidades, colores, 'Cantidad de Pagos');
    }
    
    function dibujarGraficoBarras(ctx, valores, colores, titulo) {
      const ancho = ctx.canvas.width;
      const alto = ctx.canvas.height;
      const margen = 40;
      const anchoBarra = 40;
      const espacioBarra = 15;
      
      // Encontrar m√°ximo para escala
      const maximo = Math.max(...valores, 1);
      
      // Fondo
      ctx.fillStyle = '#f8f9fa';
      ctx.fillRect(0, 0, ancho, alto);
      
      // T√≠tulo
      ctx.fillStyle = '#333';
      ctx.font = 'bold 16px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(titulo, ancho / 2, 25);
      
      // Dibujar barras
      valores.forEach((valor, i) => {
        if (valor === 0) return;
        
        const alturaBarra = ((valor / maximo) * (alto - margen - 60));
        const x = margen + i * (anchoBarra + espacioBarra);
        const y = alto - margen - alturaBarra;
        
        // Barra
        ctx.fillStyle = colores[i];
        ctx.fillRect(x, y, anchoBarra, alturaBarra);
        
        // Borde superior decorativo
        ctx.fillStyle = colores[i].replace(')', ', 0.8)').replace('rgb', 'rgba');
        ctx.fillRect(x - 2, y - 5, anchoBarra + 4, 5);
        
        // Valor encima
        ctx.fillStyle = '#333';
        ctx.font = 'bold 12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(
          valor >= 1000000 ? '‚Ç°' + Math.round(valor/1000000) + 'M' : 
          valor >= 1000 ? '‚Ç°' + Math.round(valor/1000) + 'K' : 
          '‚Ç°' + valor,
          x + anchoBarra/2, y - 10
        );
        
        // Etiqueta debajo
        ctx.fillStyle = '#666';
        ctx.font = '11px sans-serif';
        ctx.fillText(
          i === 0 ? 'Efectivo' : 
          i === 1 ? 'SINPE' : 
          i === 2 ? 'Transf.' : 
          i === 3 ? 'Tarjeta' : 'Pend.',
          x + anchoBarra/2, alto - margen + 15
        );
      });
      
      // L√≠nea base
      ctx.strokeStyle = '#ddd';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(margen - 10, alto - margen);
      ctx.lineTo(ancho - margen + 10, alto - margen);
      ctx.stroke();
    }

    // ===============================
    // üíæ Exportar a CSV
    // ===============================
    function exportarCSV() {
      const fechaDesde = document.getElementById('fecha-desde').value || 'inicio';
      const fechaHasta = document.getElementById('fecha-hasta').value || 'actualidad';
      
      // Filtrar seg√∫n controles actuales
      let filtradas = [...transacciones];
      if (document.getElementById('fecha-desde').value) {
        filtradas = filtradas.filter(t => t.fecha >= document.getElementById('fecha-desde').value);
      }
      if (document.getElementById('fecha-hasta').value) {
        filtradas = filtradas.filter(t => t.fecha <= document.getElementById('fecha-hasta').value);
      }
      if (document.getElementById('filtro-metodo').value !== 'todos') {
        const metodo = document.getElementById('filtro-metodo').value;
        filtradas = filtradas.filter(t => t.metodo === metodo);
      }
      
      let csvContent = 'Fecha,Cliente,Tel√©fono,M√©todo,Monto,Estado,Saldo\n';
      
      filtradas.forEach(trans => {
        csvContent += `"${trans.fecha}","${trans.clienteNombre}","${trans.clienteTelefono}","${trans.metodo}","${trans.monto}","${trans.estado}","${trans.saldo}"\n`;
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `metodos_pago_${fechaDesde}_a_${fechaHasta}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      mostrarToast(`‚úÖ Exportado: ${filtradas.length} transacciones`);
    }

    // ===============================
    // üìÖ Funciones auxiliares
    // ===============================
    function mostrarToast(mensaje) {
      const toast = document.getElementById('toast');
      toast.textContent = mensaje;
      toast.className = 'toast show';
      
      setTimeout(() => {
        toast.className = toast.className.replace('show', '');
      }, 2500);
    }
    
    function aplicarFiltros() {
      renderizarTransacciones();
      actualizarGraficos();
    }

    // ===============================
    // üéõÔ∏è Inicializaci√≥n
    // ===============================
    document.addEventListener('DOMContentLoaded', () => {
      // Eventos de filtros
      document.getElementById('fecha-desde').addEventListener('change', aplicarFiltros);
      document.getElementById('fecha-hasta').addEventListener('change', aplicarFiltros);
      document.getElementById('filtro-metodo').addEventListener('change', aplicarFiltros);
      
      document.getElementById('btn-recargar').addEventListener('click', cargarMetodosPago);
      document.getElementById('btn-exportar').addEventListener('click', exportarCSV);
      
      // Establecer fechas por defecto (√∫ltimos 30 d√≠as)
      const hoy = new Date();
      const hace30 = new Date();
      hace30.setDate(hoy.getDate() - 30);
      
      document.getElementById('fecha-desde').valueAsDate = hace30;
      document.getElementById('fecha-hasta').valueAsDate = hoy;
      
      // Cargar datos iniciales
      cargarMetodosPago();
      
      // Redimensionar canvases para alta DPI
      const canvases = document.querySelectorAll('canvas');
      canvases.forEach(canvas => {
        const dpr = window.devicePixelRatio || 1;
        canvas.width = canvas.clientWidth * dpr;
        canvas.height = canvas.clientHeight * dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);
      });
    });

    // Exponer funciones globales
    window.cargarMetodosPago = cargarMetodosPago;
    window.exportarCSV = exportarCSV;
    window.aplicarFiltros = aplicarFiltros;
  </script>
  <style>
    :root {
      --color-primary: #8B7500;
      --color-bg: rgba(255, 255, 255, 0.92);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      color: #333;
      padding: 12px;
      min-height: 100vh;
      overflow-x: hidden;
      font-size: 16px;
    }
    
    .contenedor-principal {
      max-width: 100%;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 15px;
      padding: 0 8px;
    }
    
    h1 {
      font-size: 1.9rem;
      color: #5c6bc0;
      margin-bottom: 8px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.08);
      line-height: 1.3;
    }
    
    .subtitulo {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 12px;
    }
    
    .panel {
      background: var(--color-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 18px;
      margin-bottom: 20px;
      border: 1px solid rgba(92, 107, 192, 0.2);
    }
    
    .controles-filtro {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 20px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      border-left: 3px solid #5c6bc0;
    }
    
    .grupo-fecha {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 140px;
    }
    
    .grupo-fecha label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    
    .grupo-fecha input {
      padding: 11px 14px;
      border: 2px solid #ddd;
      border-radius: 14px;
      font-size: 1.1rem;
      width: 100%;
      transition: border-color 0.25s;
    }
    
    .grupo-fecha input:focus {
      border-color: #5c6bc0;
      outline: none;
      box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.2);
    }
    
    #filtro-metodo {
      padding: 11px 14px;
      border: 2px solid #ddd;
      border-radius: 14px;
      font-size: 1.05rem;
      min-width: 160px;
      background: white;
    }
    
    .btn-recargar {
      background: #5c6bc0;
      color: white;
      border: none;
      padding: 11px 22px;
      border-radius: 16px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 14px rgba(92, 107, 192, 0.3);
      flex: 1;
      min-width: 140px;
      transition: all 0.2s;
    }
    
    .btn-recargar:active {
      transform: scale(0.97);
      background: #3949ab;
    }
    
    .resumen-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .resumen-item {
      background: white;
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      position: relative;
      overflow: hidden;
    }
    
    .resumen-item.metodo {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .resumen-item.total {
      grid-column: span 2;
      background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%);
      color: white;
      text-align: center;
      padding: 22px;
    }
    
    .resumen-item.total .etiqueta {
      color: rgba(255,255,255,0.9);
      font-size: 1.1rem;
    }
    
    .resumen-item.total .valor-grande {
      font-size: 2.1rem;
      font-weight: 700;
      margin: 8px 0;
    }
    
    .resumen-item.total .subvalor {
      color: rgba(255,255,255,0.85);
      font-size: 1.15rem;
      font-weight: 500;
    }
    
    .icono-metodo {
      width: 60px;
      height: 60px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    
    .datos-metodo {
      flex: 1;
    }
    
    .etiqueta {
      display: block;
      color: #777;
      font-size: 0.95rem;
      margin-bottom: 6px;
      font-weight: 600;
    }
    
    .valor {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--color);
      margin-bottom: 4px;
    }
    
    .subvalor {
      color: #777;
      font-size: 0.9rem;
    }
    
    .barra-porcentaje {
      height: 6px;
      border-radius: 3px;
      margin-top: 8px;
      background-color: var(--color);
    }
    
    .graficos-container {
      display: grid;
      grid-template-columns: repeat(1, 1fr);
      gap: 20px;
      margin: 25px 0;
    }
    
    .grafico-item {
      background: white;
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--shadow);
      text-align: center;
    }
    
    .grafico-item h3 {
      color: #5c6bc0;
      margin-bottom: 15px;
      font-size: 1.3rem;
    }
    
    canvas {
      width: 100%;
      height: 250px;
      display: block;
      margin: 0 auto;
    }
    
    .tabla-responsive {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin: 15px 0;
    }
    
    .tabla-transacciones {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 650px;
    }
    
    .tabla-transacciones th {
      background: #5c6bc0;
      color: white;
      padding: 13px 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      font-size: 0.95rem;
    }
    
    .tabla-transacciones td {
      padding: 14px 12px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
      font-size: 0.95rem;
    }
    
    .tabla-transacciones tr:hover {
      background-color: rgba(232, 240, 254, 0.4);
    }
    
    .tabla-transacciones tr:nth-child(even) {
      background-color: rgba(248, 249, 250, 0.6);
    }
    
    .numero {
      text-align: right;
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }
    
    .badge-metodo {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
      border: 1.5px solid;
    }
    
    .badge-estado {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .badge-estado.pagado {
      background: #e8f5e9;
      color: #2e7d32;
      border: 1.5px solid #2e7d3244;
    }
    
    .badge-estado.pendiente {
      background: #ffebee;
      color: #c62828;
      border: 1.5px solid #c6282844;
    }
    
    .saldo-pendiente {
      color: #c62828;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .sin-datos {
      text-align: center;
      padding: 35px 20px;
      color: #999;
      font-style: italic;
      background: rgba(245, 245, 245, 0.6);
      font-size: 1.05rem;
      font-weight: 500;
      line-height: 1.5;
    }
    
    .resumen-pie {
      background: rgba(232, 240, 254, 0.3);
      padding: 14px;
      border-radius: 14px;
      margin: 18px 0 10px;
      border-left: 3px solid #5c6bc0;
      font-weight: 600;
      color: #3949ab;
      font-size: 1.05rem;
      text-align: center;
    }
    
    .acciones-exportar {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 15px;
    }
    
    .btn-exportar {
      background: #2e7d32;
      color: white;
      border: none;
      padding: 13px 28px;
      border-radius: 18px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 16px rgba(46, 125, 50, 0.35);
      transition: all 0.25s;
    }
    
    .btn-exportar:active {
      transform: scale(0.97);
      background: #1b5e20;
    }
    
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.94);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2500;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(92, 107, 192, 0.25);
      border-top: 5px solid #5c6bc0;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1.5rem;
      color: #5c6bc0;
      font-weight: 700;
      text-align: center;
      padding: 0 20px;
      line-height: 1.4;
    }
    
    #toast {
      visibility: hidden;
      min-width: 250px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 16px;
      padding: 15px 22px;
      position: fixed;
      z-index: 4000;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%) translateY(50px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      font-size: 1.1rem;
      box-shadow: 0 5px 18px rgba(0,0,0,0.35);
      max-width: 90%;
    }
    
    #toast.show {
      visibility: visible;
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    @media (min-width: 768px) {
      body {
        padding: 20px;
      }
      
      .resumen-grid {
        grid-template-columns: repeat(3, 1fr);
      }
      
      .resumen-item.total {
        grid-column: span 3;
      }
      
      .graficos-container {
        grid-template-columns: repeat(2, 1fr);
      }
      
      canvas {
        height: 280px;
      }
      
      .tabla-transacciones {
        min-width: auto;
        font-size: 1rem;
      }
      
      .tabla-transacciones th,
      .tabla-transacciones td {
        padding: 15px 14px;
      }
      
      .acciones-exportar {
        justify-content: flex-end;
      }
      
      .btn-exportar {
        padding: 14px 32px;
        font-size: 1.15rem;
      }
    }
    
    @media (min-width: 1024px) {
      .resumen-grid {
        grid-template-columns: repeat(6, 1fr);
      }
      
      .resumen-item.total {
        grid-column: span 6;
      }
      
      .controles-filtro {
        flex-wrap: nowrap;
      }
      
      .grupo-fecha {
        min-width: 160px;
      }
    }
  </style>
</head>
<body>
  <div id="toast"></div>
  
  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Analizando m√©todos de pago...</div>
    <div style="color:#777; margin-top:12px">Procesando transacciones</div>
  </div>

  <div class="contenedor-principal">
    <header>
      <h1>üí≥ M√©todos de Pago - Totales</h1>
      <div class="subtitulo">Resumen detallado por tipo de pago: Efectivo, SINPE, Transferencia, Tarjeta</div>
    </header>

    <div class="panel">
      <div class="controles-filtro">
        <div class="grupo-fecha">
          <label for="fecha-desde">Desde</label>
          <input type="date" id="fecha-desde">
        </div>
        <div class="grupo-fecha">
          <label for="fecha-hasta">Hasta</label>
          <input type="date" id="fecha-hasta">
        </div>
        <div class="grupo-fecha">
          <label for="filtro-metodo">M√©todo</label>
          <select id="filtro-metodo">
            <option value="todos">Todos los m√©todos</option>
            <option value="efectivo">üíµ Efectivo</option>
            <option value="sinpe">üì± SINPE M√≥vil</option>
            <option value="transferencia">üè¶ Transferencia</option>
            <option value="tarjeta">üí≥ Tarjeta</option>
            <option value="pendiente">‚è≥ Pendiente/Cr√©dito</option>
          </select>
        </div>
        <button id="btn-recargar" class="btn-recargar">
          <span>‚Üª</span> Actualizar
        </button>
      </div>

      <div id="resumen-metodos">
        <!-- Se llenar√° din√°micamente -->
        <div class="resumen-grid">
          <div class="resumen-item" style="grid-column: span 2;">
            <div style="text-align:center; padding:30px; color:#888">
              <div class="spinner" style="width:40px; height:40px; margin:0 auto 15px;"></div>
              <div>Cargando resumen...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel graficos-container">
      <div class="grafico-item">
        <h3>üìä Montos Totales por M√©todo</h3>
        <canvas id="grafico-monto" width="400" height="300"></canvas>
      </div>
      <div class="grafico-item">
        <h3>üìà Cantidad de Transacciones</h3>
        <canvas id="grafico-cantidad" width="400" height="300"></canvas>
      </div>
    </div>

    <div class="panel">
      <div class="acciones-exportar">
        <button id="btn-exportar" class="btn-exportar">
          üì• Exportar a CSV
        </button>
      </div>
      
      <div id="tabla-transacciones">
        <div style="text-align:center; padding:40px 20px; color:#888">
          <div class="spinner" style="width:45px; height:45px; margin:0 auto 20px;"></div>
          <div>Cargando transacciones...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Polyfill b√°sico
    if (!window.customElements) {
      console.log("Cargando en navegador b√°sico");
    }
  </script>
</body>
</html>
