<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="dtf.css" />
    <title>Generador de Etiquetas DTF - Esentia</title>


    <!-- Librer√≠as para exportaci√≥n -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    
</head>
<body>
    <div class="container">
        <header>
            <h1>üè≠ Generador de Etiquetas DTF - Esentia</h1>
            <p class="subtitle">Sistema completo para DTF Textil Reversible y DTF UV con fondos transparentes</p>
        </header>

        <div class="badge-dtf">‚ú® Modo Producci√≥n DTF Activo</div>

        <div class="main-controls">
            <!-- Configuraci√≥n DTF -->
            <div class="control-card">
                <h3>‚öôÔ∏è Configuraci√≥n DTF</h3>
                <div class="control-group">
                    <label for="dtfMode">Tipo de DTF:</label>
                    <select id="dtfMode">
                        <option value="uv">DTF UV (Fondo Transparente)</option>
                        <option value="textil">DTF Textil Reversible</option>
                        <option value="standard">Est√°ndar (con fondo)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="sheetSize">Tama√±o de hoja:</label>
                    <select id="sheetSize">
                        <option value="letter">Letter (8.5x11")</option>
                        <option value="a4">A4 (21x29.7 cm)</option>
                        <option value="legal">Legal (8.5x14")</option>
                        <option value="tabloid">Tabloide (11x17")</option>
                        <option value="dtf-uv" selected>DTF UV (28x100 cm)</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>

                <div id="customSize" style="display: none;">
                    <div class="control-group">
                        <label for="sheetWidth">Ancho hoja (cm):</label>
                        <input type="number" id="sheetWidth" value="50" step="0.1" min="1">
                    </div>
                    <div class="control-group">
                        <label for="sheetHeight">Alto hoja (cm):</label>
                        <input type="number" id="sheetHeight" value="50" step="0.1" min="1">
                    </div>
                </div>

                <div class="control-group">
                    <label for="labelWidth">Ancho etiqueta (cm):</label>
                    <input type="number" id="labelWidth" value="6" step="0.5" min="1">
                </div>

                <div class="control-group">
                    <label for="labelHeight">Alto etiqueta (cm):</label>
                    <input type="number" id="labelHeight" value="4" step="0.5" min="1">
                </div>

                <div class="control-group">
                 <label>Dimensiones actuales:</label>
                  <div id="currentSheetDimensions" style="font-weight: bold; color: #006400;">
                  28 x 100 cm
                 </div>
                </div>

                <button class="btn" onclick="applyLabelSize()">üîÑ Aplicar Cambios de Tama√±o</button>
            </div>

            <!-- Forma y Estilo -->
            <div class="control-card">
                <h3>üé® Forma y Estilo DTF</h3>
                
                <div class="production-info">
                    <strong>üí° Recomendaciones DTF:</strong><br>
                    ‚Ä¢ DTF UV: Fondo transparente obligatorio<br>
                    ‚Ä¢ DTF Textil: Invertir imagen (efecto espejo)<br>
                    ‚Ä¢ Resoluci√≥n m√≠nima: 300 DPI<br>
                    ‚Ä¢ Formato PNG sin compresi√≥n
                </div>

                <div class="control-group">
                    <label>Forma de la etiqueta:</label>
                    <div class="shape-option">
                        <input type="radio" id="shapeRounded" name="labelShape" value="rounded" checked>
                        <label for="shapeRounded">
                            <div class="shape-preview rounded">RGBO</div>
                            Esquinas redondeadas
                        </label>

                        <input type="radio" id="shapeRect" name="labelShape" value="rect">
                        <label for="shapeRect">
                            <div class="shape-preview rect">RECT</div>
                            Rectangular
                        </label>

                        <input type="radio" id="shapeCircle" name="labelShape" value="circle">
                        <label for="shapeCircle">
                            <div class="shape-preview circle">CIRC</div>
                            Redonda (c√≠rculo)
                        </label>
                    </div>
                </div>

                <div class="control-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="transparentBg" checked>
                        <label for="transparentBg">Fondo transparente (DTF UV)</label>
                    </div>
                </div>

                <div class="control-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="mirrorEffect">
                        <label for="mirrorEffect">Efecto espejo (DTF Textil Reversible)</label>
                    </div>
                </div>

                <div class="control-group">
                    <label for="borderColor">Color borde:</label>
                    <input type="color" id="borderColor" value="#8B4513">
                </div>

                <div class="control-group">
                    <label for="borderWidth">Grosor borde (px):</label>
                    <input type="number" id="borderWidth" value="2" min="0" max="10">
                </div>

                <div class="control-group">
                    <label for="textColor">Color texto:</label>
                    <input type="color" id="textColor" value="#000000">
                </div>
            </div>

            <!-- Productos y Contenido -->
            <div class="control-card">
                <h3>üì¶ Productos</h3>
                
                <div class="control-group">
                    <label>Fuente de productos:</label>
                    <div class="source-buttons">
                        <button class="source-btn active" onclick="switchSource('stock')" id="btnStock">
                            üì¶ Desde Stock (Firestore)
                        </button>
                        <button class="source-btn" onclick="switchSource('json')" id="btnJSON">
                            üìÑ Todos los Productos (JSON)
                        </button>
                    </div>
                </div>

                <!-- Opci√≥n 1: Desde Stock Firestore -->
                <div id="stockProducts" style="display: block;">
                    <div class="control-group">
                        <label>Productos en stock:</label>
                        <div id="stockStatus" style="margin: 10px 0; font-weight: 500;">
                            <span class="loading-spinner"></span> Cargando productos desde Stock...
                        </div>
                        
                        <button class="btn btn-secondary" onclick="loadFromStock()" style="width: 100%; margin-top: 10px;">
                            ‚Üª Recargar stock
                        </button>
                    </div>

                    <div class="btn-select-container">
                        <button class="btn-select-all" onclick="selectAllProducts()">‚úì </button>
                        <button class="btn-select-none" onclick="deselectAllProducts()">‚úó</button>
                        <button class="btn btn-success" onclick="generateLabels()">üîÑ </button>
                    </div>

                    <div class="product-list-container" id="productList">
                        <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
                    </div>

                    <div class="selection-summary" id="selectionSummary">
                        üìä Seleccionados: 0 productos
                    </div>
                </div>

                <!-- Opci√≥n 2: Desde JSON -->
                <div id="jsonProducts" style="display: none;">
                    <div class="control-group">
                        <label>Todos los productos:</label>
                        <div id="jsonStatus" style="margin: 10px 0; font-weight: 500;">
                            <span class="loading-spinner"></span> Cargando cat√°logo completo...
                        </div>
                        
                        <button class="btn btn-secondary" onclick="loadFromJSON()" style="width: 100%; margin-top: 10px;">
                            ‚Üª Recargar cat√°logo
                        </button>
                    </div>

                    <div class="btn-select-container">
                        <button class="btn-select-all" onclick="selectAllProducts()">‚úì Seleccionar Todos</button>
                        <button class="btn-select-none" onclick="deselectAllProducts()">‚úó Deseleccionar Todos</button>
                    </div>

                    <div class="product-list-container" id="jsonProductList">
                        <!-- Los productos JSON se cargar√°n aqu√≠ -->
                    </div>

                    <div class="selection-summary" id="jsonSelectionSummary">
                        üìä Seleccionados: 0 productos
                    </div>
                </div>

            </div>
        </div>

        <!--88888888888888888888888888888888888888888888888888888888888888-->
         <div class="control-card">
            <div class="collapse-section">
<div class="control-group"></div>
                <div class="control-group">
                    <label for="quantityPerProduct">Cantidad por producto:</label>
                    <input type="number" id="quantityPerProduct" value="1" min="1">
                </div>

                <div class="control-group">
                    <label for="fontSize">Tama√±o texto nombre (px):</label>
                    <input type="number" id="fontSize" value="10" min="8" max="48">
                </div>

                <div class="control-group">
                    <label for="fontRotation">Rotaci√≥n texto nombre (grados):</label>
                    <select id="fontRotation">
                        <option value="0">0¬∞ (normal)</option>
                        <option value="90">90¬∞ (vertical)</option>
                        <option value="180">180¬∞ (invertido)</option>
                        <option value="-90">-90¬∞ (vertical inverso)</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="fontPosX">Posici√≥n X texto nombre (%) :</label>
                    <input type="number" id="fontPosX" value="148" min="0" max="100">
                </div>

                <div class="control-group">
                    <label for="fontPosY">Posici√≥n Y texto nombre (%) :</label>
                    <input type="number" id="fontPosY" value="100" min="0" max="100">
                </div>

                <div class="control-group">
                    <label for="priceFormat">Precio com√∫n (ej: ¬§20 ml ¬§30 ml):</label>
                    <input type="text" id="priceFormat" value="">
                </div>
                <button class="btn btn-secondary" onclick="previewChanges()">üëÅÔ∏è Vista previa</button>
            </div>

            </div>
            </div>
                <!--88888888888888888888888888888888888888888888888888888888888888-->

        <!-- Imagen de Productos -->
        <div class="control-card">
            <div class="collapse-section">
                <div class="collapse-header" onclick="toggleCollapse('productImage')">
                    üñºÔ∏è Imagen de Productos (del JSON)
                    <span id="arrowProductImage">‚ñº</span>
                </div>
                <div class="collapse-content" id="productImageContent">
                    <div class="control-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showProductImage" checked>
                            <label for="showProductImage">Mostrar imagen del producto</label>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="productImageWidth">Ancho imagen (px):</label>
                        <input type="number" id="productImageWidth" value="90" min="10" max="500">
                    </div>
                    <div class="control-group">
                        <label for="productImageHeight">Alto imagen (px):</label>
                        <input type="number" id="productImageHeight" value="90" min="10" max="500">
                    </div>
                    <div class="control-group">
                        <label for="productImagePosX">Posici√≥n X (%) :</label>
                        <input type="number" id="productImagePosX" value="60" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="productImagePosY">Posici√≥n Y (%) :</label>
                        <input type="number" id="productImagePosY" value="75" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="productImageRotation">Rotaci√≥n (grados):</label>
                        <select id="productImageRotation">
                            <option value="0">0¬∞ (normal)</option>
                            <option value="90">90¬∞ (vertical)</option>
                            <option value="180">180¬∞ (invertido)</option>
                            <option value="-90">-90¬∞ (vertical inverso)</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="previewChanges()">üëÅÔ∏è Vista previa</button>
                </div>
            </div>
        </div>

        <!-- Im√°genes Adicionales -->
        <div class="control-card">
            <div class="collapse-section">
                <div class="collapse-header" onclick="toggleCollapse('additionalImages')">
                    üñºÔ∏è+ Im√°genes Adicionales (m√≠nimo 3)
                    <span id="arrowAdditionalImages">‚ñº</span>
                </div>
                <div class="collapse-content" id="additionalImagesContent">
                    <div class="control-group">
                        <label>Cargar imagen adicional 1:</label>
                        <input type="file" id="additionalImage1" accept="image/*" onchange="previewAdditionalImage(1)">
                        <img id="previewImage1" class="additional-image-preview" style="display: none;">
                            <button class="btn btn-small btn-danger" onclick="removeAdditionalImage(1)" style="display: none;" id="removeBtn1">X ELIMINAR</button>
                        <div class="control-group">
                            <label for="img1Width">Ancho (px):</label>
                            <input type="number" id="img1Width" value="80" min="10" max="300">
                        </div>
                        <div class="control-group">
                            <label for="img1PosX">Posici√≥n X (%) :</label>
                            <input type="number" id="img1PosX" value="60" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label for="img1PosY">Posici√≥n Y (%) :</label>
                            <input type="number" id="img1PosY" value="20" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label for="img1Rotation">Rotaci√≥n (grados):</label>
                            <select id="img1Rotation">
                                <option value="0">0¬∞</option>
                                <option value="90">90¬∞</option>
                                <option value="180">180¬∞</option>
                                <option value="270">270¬∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Cargar imagen adicional 2:</label>
                        <input type="file" id="additionalImage2" accept="image/*" onchange="previewAdditionalImage(2)">
                        <img id="previewImage2" class="additional-image-preview" style="display: none;">
                            <button class="btn btn-small btn-danger" onclick="removeAdditionalImage(2)" style="display: none;" id="removeBtn2">X ELIMINAR</button>
                        <div class="control-group">
                            <label for="img2Width">Ancho (px):</label>
                            <input type="number" id="img2Width" value="80" min="10" max="300">
                        </div>
                        <div class="control-group">
                            <label for="img2PosX">Posici√≥n X (%) :</label>
                            <input type="number" id="img2PosX" value="80" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label for="img2PosY">Posici√≥n Y (%) :</label>
                            <input type="number" id="img2PosY" value="20" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label for="img2Rotation">Rotaci√≥n (grados):</label>
                            <select id="img2Rotation">
                                <option value="0">0¬∞</option>
                                <option value="90">90¬∞</option>
                                <option value="180">180¬∞</option>
                                <option value="270">270¬∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Cargar imagen adicional 3:</label>
                        <input type="file" id="additionalImage3" accept="image/*" onchange="previewAdditionalImage(3)">
                        <img id="previewImage3" class="additional-image-preview" style="display: none;">
                        <button class="btn btn-small btn-danger" onclick="removeAdditionalImage(3)" style="display: none;" id="removeBtn3">‚úñ Eliminar</button>
                        <div class="control-group">
                            <label for="img3Width">Ancho (px):</label>
                            <input type="number" id="img3Width" value="80" min="10" max="300">
                        </div>
                        <div class="control-group">
                            <label for="img3PosX">Posici√≥n X (%) :</label>
                            <input type="number" id="img3PosX" value="20" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label for="img3PosY">Posici√≥n Y (%) :</label>
                            <input type="number" id="img3PosY" value="80" min="0" max="100">
                        </div>
                        <div class="control-group">
                            <label for="img3Rotation">Rotaci√≥n (grados):</label>
                            <select id="img3Rotation">
                                <option value="0">0¬∞</option>
                                <option value="90">90¬∞</option>
                                <option value="180">180¬∞</option>
                                <option value="270">270¬∞</option>
                            </select>
                        </div>
                    </div>

                    <div class="control-group">
                        <label>Im√°genes de ejemplo:</label>
                         <div class="image-grid">
                            <div class="image-option" onclick="selectExampleImage('https://wil1979.github.io/esentia-factura/images/logo.png')">
                                <img src="https://wil1979.github.io/esentia-factura/images/logo.png" alt="Ejemplo 1">
                                <div>Logo</div>
                            </div>
                            <div class="image-option" onclick="selectExampleImage('https://wil1979.github.io/esentia-factura/images/slogan.png')">
                                <img src="https://wil1979.github.io/esentia-factura/images/slogan.png" alt="Slogan">
                                <div>Slogan</div>
                            </div>
                            <div class="image-option" onclick="selectExampleImage('https://wil1979.github.io/esentia-factura/images/qr.png')">
                                <img src="https://wil1979.github.io/esentia-factura/images/qr.png" alt="QR">
                                <div>QR</div>
                            </div>
                            <div class="image-option" onclick="selectExampleImage('https://wil1979.github.io/esentia-factura/images/qr.png')">
                                <img src="https://wil1979.github.io/esentia-factura/images/qr.png" alt="CT">
                                <div>Contac</div>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="previewChanges()">üëÅÔ∏è Vista previa</button>
                </div>
            </div>
        </div>

        <!-- Texto e Indicaciones -->
        <div class="control-card">
            <div class="collapse-section">
                <div class="collapse-header" onclick="toggleCollapse('instructions')">
                    üìù Texto e Indicaciones
                    <span id="arrowInstructions">‚ñº</span>
                </div>
                <div class="collapse-content" id="instructionsContent">
                    <div class="control-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="showInstructions" checked>
                            <label for="showInstructions">Mostrar indicaciones de uso</label>
                        </div>
                    </div>

                    <div class="control-group">
                     <label for="instructionsSource">Tipo de instrucciones:</label>
                     <select id="instructionsSource" onchange="cargarTipoInstruccion()">
                      <option value="">Selecciona un tipo...</option>
                               <!-- Las opciones se cargar√°n din√°micamente -->
                     </select>
                    </div>

                    <!--
                    <div class="control-group">
                        <label for="instructionsSource">Fuente de indicaciones:</label>                        
                        <select id="instructionsSource" onchange="loadInstructions()">
                         <option value="Aromaterapia">Aromaterapia</option>
                         <option value="Masajes">Masajes</option>
                         <option value="Controlador de Olor">Controlador de Olor</option>
                         <option value="Desinfectante">Desinfectante</option>
                         <option value="default">Predeterminado (JSON)</option>
                         <option value="custom">Personalizado</option>
                        </select>-->

                    </div>
                    <div id="customInstructions" style="display: none;">
                        <div class="control-group">
                            <label for="customInstructionsText">Texto personalizado:</label>
                            <textarea id="customInstructionsText" placeholder="Escribe tus indicaciones aqu√≠..."></textarea>
                        </div>
                    </div>
                    <div class="control-group">
                        <label for="instructionsFontSize">Tama√±o texto (px):</label>
                        <input type="number" id="instructionsFontSize" value="8" min="8" max="24">
                    </div>
                    <div class="control-group">
                        <label for="instructionsColor">Color texto:</label>
                        <input type="color" id="instructionsColor" value="#000000">
                    </div>
                    <div class="control-group">
                        <label for="instructionsRotation">Orientaci√≥n:</label>
                        <select id="instructionsRotation">
                            <option value="0">0¬∞ (normal)</option>
                            <option value="90">90¬∞ (vertical)</option>
                            <option value="180">180¬∞ (invertido)</option>
                            <option value="-90">-90¬∞ (vertical inverso)</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="instructionsPosX">Posici√≥n X (%) :</label>
                        <input type="number" id="instructionsPosX" value="10" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="instructionsPosY">Posici√≥n Y (%) :</label>
                        <input type="number" id="instructionsPosY" value="60" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="instructionsWidth">Ancho m√°ximo (%) :</label>
                        <input type="number" id="instructionsWidth" value="30" min="20" max="100">
                    </div>
                    <button class="btn btn-secondary" onclick="previewChanges()">üëÅÔ∏è Vista previa</button>
                    <div id="preview-indicaciones" style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
                      <!-- El preview se generar√° aqu√≠ din√°micamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Textos Adicionales -->
        <div class="control-card">
            <div class="collapse-section">
                <div class="collapse-header" onclick="toggleCollapse('additionalTexts')">
                    ‚úçÔ∏è Textos Adicionales (m√≠nimo 3)
                    <span id="arrowAdditionalTexts">‚ñº</span>
                </div>
                <div class="collapse-content" id="additionalTextsContent">
                    <!-- Texto 1 -->
                    <div class="control-group">
                        <label for="additionalText1">Texto adicional 1:</label>
                        <input type="text" id="additionalText1" placeholder="Ej: Aromatizante 100% natural">
                    </div>
                    <div class="control-group">
                        <label for="text1FontSize">Tama√±o fuente 1 (px):</label>
                        <input type="number" id="text1FontSize" value="10" min="8" max="48">
                    </div>
                    <div class="control-group">
                        <label for="text1Color">Color 1:</label>
                        <input type="color" id="text1Color" value="#f45601">
                    </div>
                    <div class="control-group">
                        <label for="text1PosX">Posici√≥n X 1 (%) :</label>
                        <input type="number" id="text1PosX" value="55" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="text1PosY">Posici√≥n Y 1 (%) :</label>
                        <input type="number" id="text1PosY" value="60" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="text1Rotation">Rotaci√≥n 1 (grados):</label>
                        <select id="text1Rotation">
                            <option value="0">0¬∞</option>
                            <option value="90">90¬∞</option>
                            <option value="180">180¬∞</option>
                            <option value="270">270¬∞</option>
                        </select>
                    </div>

                    <!-- Texto 2 -->
                    <div class="control-group">
                        <label for="additionalText2">Texto adicional 2:</label>
                        <input type="text" id="additionalText2" placeholder="Ej: Hecho en Costa Rica">
                    </div>
                    <div class="control-group">
                        <label for="text2FontSize">Tama√±o fuente 2 (px):</label>
                        <input type="number" id="text2FontSize" value="10" min="8" max="48">
                    </div>
                    <div class="control-group">
                        <label for="text2Color">Color 2:</label>
                        <input type="color" id="text2Color" value="#DAA520">
                    </div>
                    <div class="control-group">
                        <label for="text2PosX">Posici√≥n X 2 (%) :</label>
                        <input type="number" id="text2PosX" value="50" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="text2PosY">Posici√≥n Y 2 (%) :</label>
                        <input type="number" id="text2PosY" value="95" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="text2Rotation">Rotaci√≥n 2 (grados):</label>
                        <select id="text2Rotation">
                            <option value="0">0¬∞</option>
                            <option value="90">90¬∞</option>
                            <option value="180">180¬∞</option>
                            <option value="270">270¬∞</option>
                        </select>
                    </div>

                    <!-- Texto 3 -->
                    <div class="control-group">
                        <label for="additionalText3">Texto adicional 3:</label>
                        <input type="text" id="additionalText3" placeholder="Ej: www.esentia.com">
                    </div>
                    <div class="control-group">
                        <label for="text3FontSize">Tama√±o fuente 3 (px):</label>
                        <input type="number" id="text3FontSize" value="10" min="8" max="48">
                    </div>
                    <div class="control-group">
                        <label for="text3Color">Color 3:</label>
                        <input type="color" id="text3Color" value="#000000">
                    </div>
                    <div class="control-group">
                        <label for="text3PosX">Posici√≥n X 3 (%) :</label>
                        <input type="number" id="text3PosX" value="50" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="text3PosY">Posici√≥n Y 3 (%) :</label>
                        <input type="number" id="text3PosY" value="5" min="0" max="100">
                    </div>
                    <div class="control-group">
                        <label for="text3Rotation">Rotaci√≥n 3 (grados):</label>
                        <select id="text3Rotation">
                            <option value="0">0¬∞</option>
                            <option value="90">90¬∞</option>
                            <option value="180">180¬∞</option>
                            <option value="270">270¬∞</option>
                        </select>
                    </div>

                    <div class="control-group">
                        <label>Tipo de fuente:</label>
                        <div class="font-selector">
                            <div class="font-option" style="font-family: Arial;" onclick="setFont('Arial')">Arial</div>
                            <div class="font-option" style="font-family: 'Times New Roman';" onclick="setFont('Times New Roman')">Times</div>
                            <div class="font-option" style="font-family: 'Courier New';" onclick="setFont('Courier New')">Courier</div>
                            <div class="font-option" style="font-family: Georgia;" onclick="setFont('Georgia')">Georgia</div>
                            <div class="font-option" style="font-family: Verdana;" onclick="setFont('Verdana')">Verdana</div>
                            <div class="font-option" style="font-family: Impact;" onclick="setFont('Impact')">Impact</div>
                            <div class="font-option" style="font-family: adelia;" onclick="setFont('adelia')">adelia</div>
                        </div>
                        <input type="hidden" id="selectedFont" value="Arial">
                    </div>

                    <button class="btn btn-secondary" onclick="previewChanges()">üëÅÔ∏è Vista previa</button>
                </div>
            </div>
        </div>

        <!-- Fondo de Etiqueta -->
        <div class="control-card">
            <div class="collapse-section">
                <div class="collapse-header" onclick="toggleCollapse('background')">
                    üé® Fondo de Etiqueta
                    <span id="arrowBackground">‚ñº</span>
                </div>
                <div class="collapse-content" id="backgroundContent">
                    <div class="control-group">
                        <label for="backgroundType">Tipo de fondo:</label>
                        <select id="backgroundType" onchange="toggleBackgroundOptions()">
                            <option value="none">Ninguno (transparente)</option>
                            <option value="color">Color s√≥lido</option>
                            <option value="image">Imagen</option>
                            <option value="pattern">Patr√≥n</option>
                        </select>
                    </div>

                    <div id="backgroundColorOption" style="display: none;">
                        <div class="control-group">
                            <label for="backgroundColor">Color de fondo:</label>
                            <input type="color" id="backgroundColor" value="#FFFFFF">
                        </div>
                    </div>

                    <div id="backgroundImageOption" style="display: none;">
                        <div class="control-group">
                            <label>Cargar imagen de fondo:</label>
                            <input type="file" id="backgroundImage" accept="image/*" onchange="previewBackgroundImage()">
                            <img id="previewBackground" class="additional-image-preview" style="display: none;">
                        </div>
                        <div class="control-group">
                            <label for="backgroundImageUrl">O URL de imagen:</label>
                            <input type="text" id="backgroundImageUrl" placeholder="https://ejemplo.com/fondo.jpg" onchange="loadBackgroundFromUrl()">
                        </div>
                        <div class="control-group">
                            <label for="backgroundOpacity">Opacidad (0-1):</label>
                            <input type="number" id="backgroundOpacity" value="0.3" step="0.1" min="0" max="1">
                        </div>
                        <div class="control-group">
                            <label>Im√°genes de fondo predefinidas:</label>
                            <!-- Reemplaza las im√°genes de fondo predefinidas -->
<div class="image-grid">
    <div class="image-option" onclick="selectBackgroundImage('https://wil1979.github.io/esentia-factura/fondos/Mesa%20de%20trabajo%202_1.png')">
        <img src="https://wil1979.github.io/esentia-factura/fondos/Mesa%20de%20trabajo%202_1.png" alt="Fondo 1" style="width:100px;height:80px;">
        <div>Fondo 1</div>
    </div>
    <div class="image-option" onclick="selectBackgroundImage('https://wil1979.github.io/esentia-factura/fondos/Mesa%20de%20trabajo%202%20copia.png')">
        <img src="https://wil1979.github.io/esentia-factura/fondos/Mesa%20de%20trabajo%202%20copia.png" alt="Fondo 2" style="width:100px;height:80px;">
        <div>Fondo 2</div>
    </div>
    <div class="image-option" onclick="selectBackgroundImage('https://wil1979.github.io/esentia-factura/fondos/Mesa%20de%20trabajo%202%20copia%202.png')">
        <img src="https://wil1979.github.io/esentia-factura/fondos/Mesa%20de%20trabajo%202%20copia%202.png" alt="Fondo 3" style="width:100px;height:80px;">
        <div>Fondo 3</div>
    </div>
</div>
                        </div>
                    </div>

                    <div id="backgroundPatternOption" style="display: none;">
                        <div class="control-group">
                            <label for="patternType">Tipo de patr√≥n:</label>
                            <select id="patternType">
                                <option value="dots">Puntos</option>
                                <option value="lines">L√≠neas</option>
                                <option value="grid">Cuadr√≠cula</option>
                                <option value="diagonal">Diagonal</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="patternColor">Color del patr√≥n:</label>
                            <input type="color" id="patternColor" value="#8B4513">
                        </div>
                        <div class="control-group">
                            <label for="patternOpacity">Opacidad del patr√≥n:</label>
                            <input type="number" id="patternOpacity" value="0.2" step="0.1" min="0" max="1">
                        </div>
                    </div>

                    <button class="btn btn-secondary" onclick="previewChanges()">üëÅÔ∏è Vista previa</button>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n Guardada -->
        <div class="control-card">
            <h3>üíæ Configuraci√≥n Guardada</h3>
            <div class="config-buttons">
                <button class="btn btn-success" onclick="saveConfig()">üíæ Guardar Configuraci√≥n</button>
                <button class="btn btn-secondary" onclick="loadConfig()">üìÇ Cargar Configuraci√≥n</button>
                <button class="btn btn-warning" onclick="exportConfig()">üì§ Exportar Configuraci√≥n</button>
                <button class="btn" onclick="importConfig()">üì• Importar Configuraci√≥n</button>
            </div>
            <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                Guarda tu configuraci√≥n en el navegador. Puedes exportarla para usar en otro equipo.
            </p>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-display">
            <span id="statsText">üìä 0 etiquetas generadas de 0 posibles</span>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="control-card">
            <div class="btn-group">
                <button class="btn btn-success" onclick="generateLabels()">
                    üîÑ Generar Etiquetas
                </button>
                <!--<button class="btn" onclick="printLabels()">
                    üñ®Ô∏è Imprimir etiquetas
                </button>-->
                <button class="btn btn-warning" onclick="downloadAllZIP()">
                    üíæ Todas (ZIP)
                </button>
                <button class="btn" onclick="exportPDF()">
                    üì•  PDF
                </button>
                <button class="btn btn-dtf" onclick="exportDTF()">
                    üßµ PNG DTF
                </button>
                <button class="btn" onclick="toggleDarkMode()">
                    üåë Modo Oscuro
                </button>
                <button class="btn" onclick="applyLabelSize()">üîÑ Aplicar Tama√±o</button>
                <button class="btn-select-all" onclick="selectAllProducts()">‚úì </button>
            </div>
        </div>

        <!-- Preview -->
        <div class="preview-container">
            <div class="preview-header">
                <h2>üëÄ Vista Previa de Etiquetas</h2>
                <button class="btn btn-secondary" onclick="calculateProduction()">üß† Calcular producci√≥n</button>
            </div>
            <div class="preview-grid" id="previewGrid">
                <!-- Las etiquetas se generar√°n aqu√≠ din√°micamente -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="toast-message"></span>
    </div>

    <!-- File Input Hidden for Import -->
    <input type="file" id="configFileInput" accept=".json" style="display: none;" onchange="handleConfigImport(event)">

    <script>
       // Variables globales
let labelWidthCm = 5;
let labelHeightCm = 5;
let labelWidthPx = 200;
let labelHeightPx = 200;
let currentPreviewIndex = -1;
let previewLabels = [];
       
       
        
        // Variables para im√°genes adicionales (base64)
        let additionalImages = {
            img1: null,
            img2: null,
            img3: null
        };

        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
            authDomain: "esentiacreditos-8345f.firebaseapp.com",
            projectId: "esentiacreditos-8345f",
            storageBucket: "esentiacreditos-8345f.firebasestorage.app",
            messagingSenderId: "888658236080",
            appId: "1:888658236080:web:506e5e2085b5a452dba175"
        };

        // Inicializar Firebase
        if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "AIzaSyDfQjV4M2QvXQvJ3K9X7Z7Z7Z7Z7Z7Z7Z7") {
            firebase.initializeApp(firebaseConfig);
        }

        // Estado inicial
        let isDarkMode = false;
        let currentSource = 'stock';
        let generatedLabels = [];
        let allProducts = [];
        let selectedProducts = new Map();
        let productosJSON = [];
        let indicacionesJSON = null;
      
       

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {

            document.getElementById('sheetSize').addEventListener('change', updateSheetDimensions);
           // document.getElementById('sheetSize').addEventListener('change', toggleCustomSize);
            document.getElementById('dtfMode').addEventListener('change', updateDTFMode);
            document.getElementById('instructionsSource').addEventListener('change', toggleCustomInstructions);
            document.getElementById('labelWidth').addEventListener('change', updateLabelDimensions);
            document.getElementById('labelHeight').addEventListener('change', updateLabelDimensions);
            
            updateDTFMode();
            
            // Solo cargar stock si Firebase est√° configurado
            if (firebase.apps.length > 0) {
                loadFromStock();
            } else {
                document.getElementById('stockStatus').innerHTML = '‚ö†Ô∏è Firebase no configurado. Usa modo JSON.';
                document.getElementById('btnJSON').click(); // Cambiar a JSON
            }
            
            loadInstructions();
            
            // Cargar configuraci√≥n guardada al iniciar
            loadConfig();
        });
        function updateSheetDimensions() {
          const sheetSize = document.getElementById('sheetSize').value;
          const sheetWidthInput = document.getElementById('sheetWidth');
          const sheetHeightInput = document.getElementById('sheetHeight');
    
          // Definir dimensiones preestablecidas (en cm)
          const sizes = {
           'letter': { width: 21.59, height: 27.94 },    // 8.5x11 pulgadas
           'a4': { width: 21, height: 29.7 },            // 21x29.7 cm
           'legal': { width: 21.59, height: 35.56 },     // 8.5x14 pulgadas
           'tabloid': { width: 27.94, height: 43.18 },   // 11x17 pulgadas
           'dtf-uv': { width: 28, height: 100 },         // 28x100 cm
           'custom': { width: 50, height: 50 }          // Personalizado
           
         };
    
    const size = sizes[sheetSize];
    
    if (size) {
        sheetWidthInput.value = size.width;
        sheetHeightInput.value = size.height;
        
        // Mostrar/ocultar inputs personalizados
        document.getElementById('customSize').style.display = 
            sheetSize === 'custom' ? 'block' : 'none';
        
        showToast(`üìè Hoja ${sheetSize.toUpperCase()} seleccionada: ${size.width}x${size.height} cm`, 'success');
    }
    // Al final de updateSheetDimensions()
document.getElementById('currentSheetDimensions').textContent = 
    `${size.width} x ${size.height} cm`;
}

        // Funciones principales
        function toggleCustomSize() {
    const customSizeDiv = document.getElementById('customSize');
    const sheetSize = document.getElementById('sheetSize').value;
    
    customSizeDiv.style.display = sheetSize === 'custom' ? 'block' : 'none';
    
    // Si no es personalizado, actualizar dimensiones
    if (sheetSize !== 'custom') {
        updateSheetDimensions();
    }
}

        function updateDTFMode() {
    const mode = document.getElementById('dtfMode').value;
    const transparentBg = document.getElementById('transparentBg');
    const mirrorEffect = document.getElementById('mirrorEffect');
    const sheetSize = document.getElementById('sheetSize');
    
    if (mode === 'uv') {
        transparentBg.checked = true;
        mirrorEffect.checked = false;
        sheetSize.value = 'dtf-uv';
        updateSheetDimensions(); // ‚úÖ Actualizar dimensiones
        showToast('Modo DTF UV activado: Fondo transparente y tama√±o 28x100 cm', 'success');
    } else if (mode === 'textil') {
        transparentBg.checked = false;
        mirrorEffect.checked = true;
        showToast('Modo DTF Textil Reversible activado: Efecto espejo aplicado', 'success');
    } else {
        transparentBg.checked = false;
        mirrorEffect.checked = false;
    }
}

        // Actualizar dimensiones de la etiqueta
        function updateLabelDimensions() {
            labelWidthCm = parseFloat(document.getElementById('labelWidth').value) || 5;
            labelHeightCm = parseFloat(document.getElementById('labelHeight').value) || 5;
            
            // Convertir cm a px aproximadamente (asumiendo 96 DPI = ~38 px por cm)
            labelWidthPx = Math.round(labelWidthCm * 38);
            labelHeightPx = Math.round(labelHeightCm * 38);
            
            // Aplicar a las etiquetas existentes
            document.querySelectorAll('.label-preview').forEach(label => {
                label.style.width = `${labelWidthPx}px`;
                label.style.height = `${labelHeightPx}px`;
            });
            
            showToast(`üìè Tama√±o de etiqueta actualizado: ${labelWidthCm}x${labelHeightCm} cm (${labelWidthPx}x${labelHeightPx} px)`, 'success');
        }

        // Aplicar cambios de tama√±o expl√≠citamente
        function applyLabelSize() {
            updateLabelDimensions();
            if (generatedLabels.length > 0) {
                generateLabels(); // Regenerar con nuevo tama√±o
            }
        }

        function applyChanges() {
            showToast('Cambios aplicados correctamente', 'success');
            calculateProduction();
        }

        // Toggle collapse sections
        function toggleCollapse(sectionId) {
            const content = document.getElementById(`${sectionId}Content`);
            const arrow = document.getElementById(`arrow${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
            
            if (content.classList.contains('show')) {
                content.classList.remove('show');
                arrow.textContent = '‚ñº';
            } else {
                content.classList.add('show');
                arrow.textContent = '‚ñ≤';
            }
        }

        // Cambiar fuente
        function setFont(fontName) {
            document.querySelectorAll('.font-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            document.getElementById('selectedFont').value = fontName;
            previewChanges();
        }
//funcion para eliminar imagenes adicionales
        function removeAdditionalImage(index) {
    // Limpiar la variable global
    additionalImages[`img${index}`] = null;
    
    // Limpiar el preview
    const preview = document.getElementById(`previewImage${index}`);
    preview.src = '';
    preview.style.display = 'none';
    
    // Ocultar el bot√≥n de eliminar
    const removeBtn = document.getElementById(`removeBtn${index}`);
    if (removeBtn) {
        removeBtn.style.display = 'none';
    }
    
    // Resetear el input file
    const input = document.getElementById(`additionalImage${index}`);
    input.value = '';
    
    // Actualizar vista previa
    previewChanges();
    
    showToast(`‚úÖ Imagen adicional ${index} eliminada`, 'success');
}
function previewAdditionalImage(index) {
    const input = document.getElementById(`additionalImage${index}`);
    const preview = document.getElementById(`previewImage${index}`);
    const removeBtn = document.getElementById(`removeBtn${index}`);
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            preview.src = base64;
            preview.style.display = 'block';
            
            // ‚úÖ Mostrar bot√≥n de eliminar
            if (removeBtn) {
                removeBtn.style.display = 'inline-block';
            }
            
            // Guardar en variable global
            additionalImages[`img${index}`] = base64;
            previewChanges();
        };
        reader.readAsDataURL(input.files[0]);
    }
}
function selectExampleImage(url) {
    for (let i = 1; i <= 3; i++) {
        const preview = document.getElementById(`previewImage${i}`);
        const removeBtn = document.getElementById(`removeBtn${i}`);
        
        if (!preview.src || preview.style.display === 'none') {
            preview.src = url;
            preview.style.display = 'block';
            
            // ‚úÖ Mostrar bot√≥n de eliminar
            if (removeBtn) {
                removeBtn.style.display = 'inline-block';
            }
            
            // Guardar URL en variable global
            additionalImages[`img${i}`] = url;
            showToast(`Imagen de ejemplo asignada a posici√≥n ${i}`, 'success');
            previewChanges();
            break;
        }
    }
}

        // Fondo de etiqueta
        function toggleBackgroundOptions() {
            const type = document.getElementById('backgroundType').value;
            
            document.getElementById('backgroundColorOption').style.display = type === 'color' ? 'block' : 'none';
            document.getElementById('backgroundImageOption').style.display = type === 'image' ? 'block' : 'none';
            document.getElementById('backgroundPatternOption').style.display = type === 'pattern' ? 'block' : 'none';
            
            previewChanges();
        }

        function previewBackgroundImage() {
            const input = document.getElementById('backgroundImage');
            const preview = document.getElementById('previewBackground');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    previewChanges();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function loadBackgroundFromUrl() {
            const url = document.getElementById('backgroundImageUrl').value;
            const preview = document.getElementById('previewBackground');
            
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                previewChanges();
            }
        }

        function selectBackgroundImage(url) {
            document.getElementById('backgroundImageUrl').value = url;
            document.getElementById('previewBackground').src = url;
            document.getElementById('previewBackground').style.display = 'block';
            previewChanges();
            showToast('Fondo seleccionado', 'success');
        }

        // Texto e indicaciones
        function toggleCustomInstructions() {
            const source = document.getElementById('instructionsSource').value;
            document.getElementById('customInstructions').style.display = source === 'custom' ? 'block' : 'none';
            loadInstructions();
        }

async function loadInstructions() {
    try {
        const response = await fetch('https://wil1979.github.io/esentia-factura/indicaciones.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // ‚úÖ Verificar estructura del JSON
        if (!Array.isArray(data)) {
            console.error('Formato de JSON incorrecto. Se esperaba un array.');
            showToast('‚ùå Formato de JSON incorrecto', 'error');
            return;
        }
        
        // ‚úÖ Guardar todas las instrucciones
        indicacionesJSON = data;
        
        // ‚úÖ Seleccionar primer tipo por defecto
        if (data.length > 0) {
            indicacionesJSON.current = data[0].info;
            indicacionesJSON.currentTipo = data[0].tipo;
            mostrarPreviewIndicaciones();
            previewChanges();
            showToast(`‚úÖ Cargados ${data.length} tipos de instrucciones`, 'success');
        }
        
    } catch (error) {
        console.error('Error cargando indicaciones:', error);
        showToast('‚ùå Error al cargar las instrucciones', 'error');
        
        // ‚úÖ Indicaciones por defecto
        indicacionesJSON = [
            {
                "tipo": "Aromaterapia",
                "info": {
                    "titulo": "Indicaciones de uso",
                    "indicaciones": [
                        "Agregar de 5 a 10 gotas por cada 100 ml de agua en el difusor.",
                        "Utilizar en espacios ventilados.",
                        "Ideal para sesiones de relajaci√≥n o meditaci√≥n."
                    ],
                    "advertencias_titulo": "Advertencias",
                    "advertencias": [
                        "No ingerir.",
                        "Evitar contacto directo con los ojos.",
                        "Mantener fuera del alcance de ni√±os y mascotas."
                    ]
                }
            }
        ];
        indicacionesJSON.current = indicacionesJSON[0].info;
        indicacionesJSON.currentTipo = "Aromaterapia";
        mostrarPreviewIndicaciones();
        previewChanges();
    }
}

// ‚úÖ Nueva funci√≥n: Cargar tipos en el dropdown
function cargarTiposEnDropdown() {
    const dropdown = document.getElementById('instructionsSource');
    if (!dropdown || !indicacionesJSON) return;
    
    // Limpiar opciones existentes (excepto la primera)
    while (dropdown.options.length > 1) {
        dropdown.remove(1);
    }
    
    // Agregar cada tipo del JSON
    indicacionesJSON.forEach(item => {
        const option = document.createElement('option');
        option.value = item.tipo;
        option.textContent = item.tipo;
        dropdown.appendChild(option);
    });
    
    // Seleccionar el tipo actual si existe
    if (indicacionesJSON.currentTipo) {
        dropdown.value = indicacionesJSON.currentTipo;
    }
}

// ‚úÖ Nueva funci√≥n: Cargar tipo de instrucci√≥n seleccionado
function cargarTipoInstruccion() {
    const tipoSeleccionado = document.getElementById('instructionsSource').value;
    
    if (!tipoSeleccionado || !indicacionesJSON) {
        return;
    }
    
    // Buscar el tipo en el JSON
    const encontrada = indicacionesJSON.find(item => 
        item.tipo === tipoSeleccionado
    );
    
    if (encontrada) {
        indicacionesJSON.current = encontrada.info;
        indicacionesJSON.currentTipo = tipoSeleccionado;
        mostrarPreviewIndicaciones();
        previewChanges();
        showToast(`‚úÖ Instrucciones "${tipoSeleccionado}" cargadas`, 'success');
    } else {
        showToast('‚ö†Ô∏è Tipo no encontrado', 'warning');
    }
}
function cargarTiposEnDropdown() {
    const dropdown = document.getElementById('instructionsSource');
    if (!dropdown || !indicacionesJSON) return;
    
    // ‚úÖ Limpiar opciones existentes (excepto la primera)
    while (dropdown.options.length > 1) {
        dropdown.remove(1);
    }
    
    // ‚úÖ Agregar cada tipo del JSON
    indicacionesJSON.forEach(item => {
        const option = document.createElement('option');
        option.value = item.tipo;
        option.textContent = item.tipo;
        dropdown.appendChild(option);
    });
    
    // ‚úÖ Seleccionar el tipo actual si existe
    if (indicacionesJSON.currentTipo) {
        dropdown.value = indicacionesJSON.currentTipo;
    }
}

function mostrarPreviewIndicaciones() {
    const preview = document.getElementById('preview-indicaciones');
    if (!preview || !indicacionesJSON || !indicacionesJSON.current) {
        return;
    }
    
    const data = indicacionesJSON.current;
    let contenidoHTML = '';
    
    // ‚úÖ T√≠tulo
    if (data.titulo) {
        contenidoHTML += `<h4 style="margin-bottom: 10px; color: #006400;">${data.titulo}</h4>`;
    }
    
    // ‚úÖ Indicaciones
    if (data.indicaciones && data.indicaciones.length > 0) {
        contenidoHTML += `<div style="margin-bottom: 15px;">`;
        contenidoHTML += `<strong style="color: #8B4513;">Instrucciones:</strong><ul style="margin-left: 20px; margin-top: 5px;">`;
        
        data.indicaciones.forEach(texto => {
            contenidoHTML += `<li style="margin-bottom: 5px;">${texto}</li>`;
        });
        
        contenidoHTML += `</ul></div>`;
    }
    
    // ‚úÖ Advertencias
    if (data.advertencias && data.advertencias.length > 0) {
        contenidoHTML += `<div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">`;
        
        if (data.advertencias_titulo) {
            contenidoHTML += `<strong style="color: #dc3545;">${data.advertencias_titulo}</strong><ul style="margin-left: 20px; margin-top: 5px;">`;
        } else {
            contenidoHTML += `<strong style="color: #dc3545;">Advertencias:</strong><ul style="margin-left: 20px; margin-top: 5px;">`;
        }
        
        data.advertencias.forEach(texto => {
            contenidoHTML += `<li style="margin-bottom: 5px; color: #dc3545;">${texto}</li>`;
        });
        
        contenidoHTML += `</ul></div>`;
    }
    
    preview.innerHTML = contenidoHTML;
}
        // Vista previa en tiempo real
        function previewChanges() {
            if (generatedLabels.length > 0) {
                generateLabels();
                applyLabelSize()
            }
        }

        // Cambiar fuente de productos
        function switchSource(source) {
            currentSource = source;
            
            document.getElementById('btnStock').classList.toggle('active', source === 'stock');
            document.getElementById('btnJSON').classList.toggle('active', source === 'json');
            
            document.getElementById('stockProducts').style.display = source === 'stock' ? 'block' : 'none';
            document.getElementById('jsonProducts').style.display = source === 'json' ? 'block' : 'none';
            
            if (source === 'stock' && allProducts.length === 0 && firebase.apps.length > 0) {
                loadFromStock();
            } else if (source === 'json' && productosJSON.length === 0) {
                loadFromJSON();
            }
        }

        // Opci√≥n 1: Cargar desde colecci√≥n "stock"
        async function loadFromStock() {
            // Verificar si Firebase est√° configurado
            if (firebase.apps.length === 0) {
                document.getElementById('stockStatus').innerHTML = '‚ö†Ô∏è Firebase no est√° configurado';
                return;
            }
            
            const statusEl = document.getElementById('stockStatus');
            const productListEl = document.getElementById('productList');
            
            statusEl.innerHTML = '<span class="loading-spinner"></span> Cargando productos desde Stock...';
            productListEl.innerHTML = '';
            selectedProducts.clear();
            
            try {
                const db = firebase.firestore();
                const stockRef = db.collection('stock');
                
                const snapshot = await stockRef.get();

                if (snapshot.empty) {
                    statusEl.innerHTML = '‚ö†Ô∏è No se encontraron productos en la colecci√≥n "stock"';
                    return;
                }

                const jsonProductos = await fetchAndFlattenJSON();
                
                allProducts = [];
                let html = '';
                let productosSinNombreJSON = 0;
                let productosConStock = 0;

                snapshot.forEach(doc => {
                    const product = doc.data();
                    product.firebaseId = doc.id;
                    
                    if (product.cantidad > 0 && product.id) {
                        productosConStock++;
                        
                        const productoJSON = jsonProductos.find(p => 
                            String(p.id) === String(product.id)
                        );
                        
                        if (productoJSON && productoJSON.nombreOriginal) {
                            product.nombreOriginal = productoJSON.nombreOriginal;
                            product.categoria = productoJSON.categoria || product.categoria || 'Sin categor√≠a';
                            product.imagen = productoJSON.imagen || '';
                        } else {
                            product.nombreOriginal = product.nombre || `ID ${product.id}`;
                            productosSinNombreJSON++;
                        }
                        
                        allProducts.push(product);
                    }
                });

                allProducts.sort((a, b) => 
                    (a.nombreOriginal || '').localeCompare(b.nombreOriginal || '')
                );

                allProducts.forEach(product => {
                    html += `
                        <div class="product-item">
                            <input type="checkbox" 
                                   id="prod-${product.firebaseId}" 
                                   data-id="${product.firebaseId}"
                                   onchange="toggleProductSelection('${product.firebaseId}')">
                            <div class="product-info">
                                <div class="product-name">${product.nombreOriginal}</div>
                                <div class="product-category">${product.categoria || 'Sin categor√≠a'}</div>
                                <div class="product-stock">Stock: ${product.cantidad}</div>
                                <div class="product-id">ID: ${product.id}</div>
                            </div>
                            <input type="number" 
                                   class="quantity-input" 
                                   id="qty-${product.firebaseId}" 
                                   value="1" 
                                   min="1" 
                                   max="${product.cantidad}" 
                                   onchange="updateProductQuantity('${product.firebaseId}')"
                                   style="display: none;">
                        </div>
                    `;
                });

                productListEl.innerHTML = html;
                
                if (productosSinNombreJSON > 0) {
                    statusEl.innerHTML = `
                        ‚ö†Ô∏è ${productosSinNombreJSON} producto(s) sin coincidencia en JSON.<br>
                        ‚úì ${productosConStock} productos con stock disponible
                    `;
                } else {
                    statusEl.innerHTML = `‚úì ${productosConStock} productos en stock cargados correctamente`;
                }
                
                updateSelectionSummary();
                showToast(`‚úÖ Stock cargado: ${productosConStock} productos disponibles`, 'success');
                
            } catch (error) {
                console.error('Error cargando stock:', error);
                statusEl.innerHTML = `‚ùå Error: ${error.message.substring(0, 80)}`;
                showToast('‚ö†Ô∏è No se pudo cargar el stock. Verifica tu conexi√≥n.', 'error');
            }
        }

        // Opci√≥n 2: Cargar desde JSON
        async function loadFromJSON() {
            const statusEl = document.getElementById('jsonStatus');
            const productListEl = document.getElementById('jsonProductList');
            
            statusEl.innerHTML = '<span class="loading-spinner"></span> Cargando cat√°logo completo...';
            productListEl.innerHTML = '';
            selectedProducts.clear();
            
            try {
                const productos = await fetchAndFlattenJSON();
                
                if (productos.length === 0) {
                    statusEl.innerHTML = '‚ö†Ô∏è No se encontraron productos en el JSON';
                    return;
                }

                allProducts = [...productos];
                let html = '';
                let currentCategory = '';

                allProducts.sort((a, b) => {
                    const catA = a.categoria || '';
                    const catB = b.categoria || '';
                    if (catA !== catB) return catA.localeCompare(catB);
                    return (a.nombreOriginal || '').localeCompare(b.nombreOriginal || '');
                });

                allProducts.forEach((product, index) => {
                    const categoria = product.categoria || 'Sin categor√≠a';
                    
                    if (categoria !== currentCategory) {
                        currentCategory = categoria;
                        html += `<div class="category-header">${categoria.toUpperCase()}</div>`;
                    }
                    
                    const productId = product.id || `json_${index}`;
                    
                    html += `
                        <div class="product-item">
                            <input type="checkbox" 
                                   id="json-${productId}" 
                                   data-id="${productId}"
                                   onchange="toggleProductSelection('${productId}', true)">
                            <div class="product-info">
                                <div class="product-name">${product.nombreOriginal || product.nombre || 'Sin nombre'}</div>
                                <div class="product-category">${product.categoria || 'Sin categor√≠a'}</div>
                                <div class="product-id">ID: ${product.id || 'N/A'}</div>
                            </div>
                            <input type="number" 
                                   class="quantity-input" 
                                   id="qty-${productId}" 
                                   value="1" 
                                   min="1" 
                                   max="999" 
                                   onchange="updateProductQuantity('${productId}')"
                                   style="display: none;">
                        </div>
                    `;
                });

                productListEl.innerHTML = html;
                statusEl.innerHTML = `‚úì ${productos.length} productos cargados del cat√°logo completo`;
                
                updateSelectionSummary();
                showToast(`‚úÖ Cat√°logo cargado: ${productos.length} productos disponibles`, 'success');
                
            } catch (error) {
                console.error('Error cargando JSON:', error);
                statusEl.innerHTML = `‚ùå Error: ${error.message}`;
                showToast('‚ö†Ô∏è No se pudo cargar el cat√°logo JSON.', 'error');
            }
        }

        // Fetch JSON y aplanar estructura
       // Fetch JSON y aplanar estructura - CORREGIDO
async function fetchAndFlattenJSON() {
    if (productosJSON.length > 0) {
        return productosJSON;
    }
    
    try {
        const response = await fetch('https://wil1979.github.io/esentia-factura/productos_esentia.json');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const jsonData = await response.json();
        const flattened = [];
        
        // Manejar diferentes estructuras del JSON
        if (Array.isArray(jsonData)) {
            // Si es array directo
            productosJSON = jsonData;
            return jsonData;
        }
        
        // Si es objeto con categor√≠as
        Object.keys(jsonData).forEach(categoria => {
            const productosEnCategoria = jsonData[categoria];
            
            if (Array.isArray(productosEnCategoria)) {
                productosEnCategoria.forEach(producto => {
                    flattened.push({
                        ...producto,
                        categoria: categoria,
                        id: producto.id || producto.ID || null,
                        nombre: producto.nombre || producto.Nombre || producto.name || 'Sin nombre',
                        nombreOriginal: producto.nombreOriginal || producto.nombre || producto.Nombre || producto.name || 'Sin nombre',
                        precio: producto.precio || producto.Precio || producto.price || 0,
                        imagen: producto.imagen || producto.Imagen || producto.image || '',
                        stock: producto.stock || producto.Stock || 0
                    });
                });
            } else if (typeof productosEnCategoria === 'object') {
                // Si es objeto dentro de categor√≠a
                Object.keys(productosEnCategoria).forEach(key => {
                    const producto = productosEnCategoria[key];
                    flattened.push({
                        ...producto,
                        categoria: categoria,
                        id: producto.id || producto.ID || key,
                        nombre: producto.nombre || producto.Nombre || producto.name || key,
                        nombreOriginal: producto.nombreOriginal || producto.nombre || producto.Nombre || producto.name || key,
                        precio: producto.precio || producto.Precio || producto.price || 0,
                        imagen: producto.imagen || producto.Imagen || producto.image || '',
                        stock: producto.stock || producto.Stock || 0
                    });
                });
            }
        });
        
        productosJSON = flattened;
        console.log('Productos JSON cargados:', productosJSON.length);
        return flattened;
        
    } catch (error) {
        console.error('Error fetching/flattening JSON:', error);
        showToast('‚ùå Error al cargar productos JSON', 'error');
        return [];
    }
}

// Cargar desde JSON - CORREGIDO
async function loadFromJSON() {
    const statusEl = document.getElementById('jsonStatus');
    const productListEl = document.getElementById('jsonProductList');
    
    statusEl.innerHTML = '<span class="loading-spinner"></span> Cargando cat√°logo completo...';
    productListEl.innerHTML = '';
    selectedProducts.clear();
    
    try {
        const productos = await fetchAndFlattenJSON();
        
        if (productos.length === 0) {
            statusEl.innerHTML = '‚ö†Ô∏è No se encontraron productos en el JSON';
            showToast('‚ö†Ô∏è Cat√°logo vac√≠o', 'warning');
            return;
        }
        
        allProducts = [...productos];
        let html = '';
        let currentCategory = '';
        let totalProductos = 0;
        
        // Ordenar por categor√≠a y nombre
        allProducts.sort((a, b) => {
            const catA = (a.categoria || '').toLowerCase();
            const catB = (b.categoria || '').toLowerCase();
            if (catA !== catB) return catA.localeCompare(catB);
            
            const nameA = (a.nombreOriginal || '').toLowerCase();
            const nameB = (b.nombreOriginal || '').toLowerCase();
            return nameA.localeCompare(nameB);
        });
        
        allProducts.forEach((product, index) => {
            const categoria = product.categoria || 'Sin categor√≠a';
            const productId = product.id || `json_${index}`;
            
            // Agrupar por categor√≠a
            if (categoria !== currentCategory) {
                currentCategory = categoria;
                html += `<div class="category-header">${categoria.toUpperCase()}</div>`;
            }
            
            totalProductos++;
            
            html += `
            <div class="product-item">
                <input type="checkbox"
                    id="json-${productId}"
                    data-id="${productId}"
                    onchange="toggleProductSelection('${productId}', true)">
                <div class="product-info">
                    <div class="product-name">${product.nombreOriginal || product.nombre || 'Sin nombre'}</div>
                    <div class="product-category">${product.categoria || 'Sin categor√≠a'}</div>
                    ${product.precio ? `<div class="product-stock">Precio: ‚Ç°${parseInt(product.precio).toLocaleString()}</div>` : ''}
                    ${product.stock !== undefined ? `<div class="product-stock">Stock: ${product.stock}</div>` : ''}
                    <div class="product-id">ID: ${productId}</div>
                </div>
                <input type="number"
                    class="quantity-input"
                    id="qty-${productId}"
                    value="1"
                    min="1"
                    max="999"
                    onchange="updateProductQuantity('${productId}')"
                    style="display: none;">
            </div>
            `;
        });
        
        productListEl.innerHTML = html;
        statusEl.innerHTML = `‚úì ${totalProductos} productos cargados del cat√°logo completo`;
        
        updateSelectionSummary();
        showToast(`‚úÖ Cat√°logo cargado: ${totalProductos} productos disponibles`, 'success');
        
    } catch (error) {
        console.error('Error cargando JSON:', error);
        statusEl.innerHTML = `‚ùå Error: ${error.message.substring(0, 100)}`;
        showToast('‚ö†Ô∏è No se pudo cargar el cat√°logo JSON', 'error');
    }
}

// Cargar desde JSON - CORREGIDO
async function loadFromJSON() {
    const statusEl = document.getElementById('jsonStatus');
    const productListEl = document.getElementById('jsonProductList');
    
    statusEl.innerHTML = '<span class="loading-spinner"></span> Cargando cat√°logo completo...';
    productListEl.innerHTML = '';
    selectedProducts.clear();
    
    try {
        const productos = await fetchAndFlattenJSON();
        
        if (productos.length === 0) {
            statusEl.innerHTML = '‚ö†Ô∏è No se encontraron productos en el JSON';
            showToast('‚ö†Ô∏è Cat√°logo vac√≠o', 'warning');
            return;
        }
        
        allProducts = [...productos];
        let html = '';
        let currentCategory = '';
        let totalProductos = 0;
        
        // Ordenar por categor√≠a y nombre
        allProducts.sort((a, b) => {
            const catA = (a.categoria || '').toLowerCase();
            const catB = (b.categoria || '').toLowerCase();
            if (catA !== catB) return catA.localeCompare(catB);
            
            const nameA = (a.nombreOriginal || '').toLowerCase();
            const nameB = (b.nombreOriginal || '').toLowerCase();
            return nameA.localeCompare(nameB);
        });
        
        allProducts.forEach((product, index) => {
            const categoria = product.categoria || 'Sin categor√≠a';
            const productId = product.id || `json_${index}`;
            
            // Agrupar por categor√≠a
            if (categoria !== currentCategory) {
                currentCategory = categoria;
                html += `<div class="category-header">${categoria.toUpperCase()}</div>`;
            }
            
            totalProductos++;
            
            html += `
            <div class="product-item">
                <input type="checkbox"
                    id="json-${productId}"
                    data-id="${productId}"
                    onchange="toggleProductSelection('${productId}', true)">
                <div class="product-info">
                    <div class="product-name">${product.nombreOriginal || product.nombre || 'Sin nombre'}</div>
                    <div class="product-category">${product.categoria || 'Sin categor√≠a'}</div>
                    ${product.precio ? `<div class="product-stock">Precio: ‚Ç°${parseInt(product.precio).toLocaleString()}</div>` : ''}
                    ${product.stock !== undefined ? `<div class="product-stock">Stock: ${product.stock}</div>` : ''}
                    <div class="product-id">ID: ${productId}</div>
                </div>
                <input type="number"
                    class="quantity-input"
                    id="qty-${productId}"
                    value="1"
                    min="1"
                    max="999"
                    onchange="updateProductQuantity('${productId}')"
                    style="display: none;">
            </div>
            `;
        });
        
        productListEl.innerHTML = html;
        statusEl.innerHTML = `‚úì ${totalProductos} productos cargados del cat√°logo completo`;
        
        updateSelectionSummary();
        showToast(`‚úÖ Cat√°logo cargado: ${totalProductos} productos disponibles`, 'success');
        
    } catch (error) {
        console.error('Error cargando JSON:', error);
        statusEl.innerHTML = `‚ùå Error: ${error.message.substring(0, 100)}`;
        showToast('‚ö†Ô∏è No se pudo cargar el cat√°logo JSON', 'error');
    }
}

        function toggleProductSelection(productId, isJSON = false) {
            const prefix = isJSON ? 'json-' : 'prod-';
            const checkbox = document.getElementById(`${prefix}${productId}`);
            const quantityInput = document.getElementById(`qty-${productId}`);
            
            if (checkbox.checked) {
                const product = allProducts.find(p => 
                    (isJSON ? String(p.id) === String(productId) : p.firebaseId === productId) || 
                    String(p.id) === String(productId)
                );
                
                selectedProducts.set(productId, {
                    product: product || { nombreOriginal: productId, id: productId },
                    quantity: 1,
                    isJSON: isJSON
                });
                quantityInput.style.display = 'inline-block';
            } else {
                selectedProducts.delete(productId);
                quantityInput.style.display = 'none';
            }
            
            updateSelectionSummary();
        }

        function updateProductQuantity(productId) {
            const quantityInput = document.getElementById(`qty-${productId}`);
            const quantity = parseInt(quantityInput.value) || 1;
            
            if (selectedProducts.has(productId)) {
                const productData = selectedProducts.get(productId);
                productData.quantity = quantity;
                selectedProducts.set(productId, productData);
            }
            
            updateSelectionSummary();
        }

        function selectAllProducts() {
            const container = currentSource === 'stock' ? 
                document.getElementById('productList') : 
                document.getElementById('jsonProductList');
            
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    const productId = checkbox.dataset.id;
                    toggleProductSelection(productId, currentSource === 'json');
                }
            });
            
            updateSelectionSummary();
            showToast(`‚úì Seleccionados ${selectedProducts.size} productos`, 'success');
        }

        function deselectAllProducts() {
            const container = currentSource === 'stock' ? 
                document.getElementById('productList') : 
                document.getElementById('jsonProductList');
            
            container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const productId = checkbox.dataset.id;
                    toggleProductSelection(productId, currentSource === 'json');
                }
            });
            
            updateSelectionSummary();
            showToast('‚úó Todos los productos deseleccionados', 'warning');
        }

        function updateSelectionSummary() {
            const summaryEl = currentSource === 'stock' ? 
                document.getElementById('selectionSummary') : 
                document.getElementById('jsonSelectionSummary');
            
            const totalSelected = selectedProducts.size;
            const totalLabels = Array.from(selectedProducts.values())
                .reduce((sum, item) => sum + item.quantity, 0);
            
            summaryEl.innerHTML = `
                üìä Seleccionados: ${totalSelected} productos<br>
                üè∑Ô∏è Total de etiquetas: ${totalLabels}
            `;
        }

        function generateLabels() {
            const fontSize = document.getElementById('fontSize').value;
            const fontRotation = document.getElementById('fontRotation').value;
            const fontPosX = document.getElementById('fontPosX').value;
            const fontPosY = document.getElementById('fontPosY').value;
            const priceFormat = document.getElementById('priceFormat').value;
            const transparentBg = document.getElementById('transparentBg').checked;
            const mirrorEffect = document.getElementById('mirrorEffect').checked;
            const shape = document.querySelector('input[name="labelShape"]:checked').value;
            const showProductImage = document.getElementById('showProductImage').checked;
            const showInstructions = document.getElementById('showInstructions').checked;
            const selectedFont = document.getElementById('selectedFont').value;
            const backgroundType = document.getElementById('backgroundType').value;
            

            const previewGrid = document.getElementById('previewGrid');
            previewGrid.innerHTML = '';
            generatedLabels = [];

            let labelCount = 0;

            if (selectedProducts.size === 0) {
                showToast('‚ö†Ô∏è Por favor selecciona al menos un producto', 'error');
                return;
            }

            selectedProducts.forEach((item, productId) => {
                const product = item.product;
                const quantity = item.quantity;
                const name = product.nombreOriginal || product.nombre || productId;

                for (let i = 0; i < quantity; i++) {
                    createLabelElement(name, priceFormat, fontSize, fontRotation, fontPosX, fontPosY, transparentBg, mirrorEffect, shape, showProductImage, product.imagen, showInstructions, selectedFont, backgroundType, labelCount);
                    generatedLabels.push({
                        name: name,
                        price: priceFormat,
                        index: labelCount + 1,
                        productId: productId,
                        product: product
                    });
                    labelCount++;
                }
            });

            const totalProducts = selectedProducts.size;
            updateStats(totalProducts, labelCount / totalProducts, labelCount);
            showToast(`‚úÖ Generadas ${labelCount} etiquetas de ${totalProducts} productos`, 'success');
        }

       // CORREGIDO: Funci√≥n para crear etiqueta
function createLabelElement(name, price, fontSize, fontRotation, fontPosX, fontPosY, transparentBg, mirrorEffect, shape, showProductImage, imageUrl, showInstructions, font, backgroundType, index) {
    const previewGrid = document.getElementById('previewGrid');
    const labelDiv = document.createElement('div');
    
    // Obtener dimensiones de la etiqueta
    const labelWidth = parseFloat(document.getElementById('labelWidth').value) || 5;
    const labelHeight = parseFloat(document.getElementById('labelHeight').value) || 5;
    
    // Usar 300 DPI para c√°lculos de posici√≥n (118.11 px/cm)
    const dpi = 300;
    const pxPerCm = dpi / 2.54;
    
    // Calcular dimensiones en p√≠xeles
    const labelWidthPx = Math.round(labelWidth * pxPerCm);
    const labelHeightPx = Math.round(labelHeight * pxPerCm);
    
    // Aplicar dimensiones de la etiqueta
    labelDiv.style.width = `${labelWidthPx}px`;
    labelDiv.style.height = `${labelHeightPx}px`;
    labelDiv.className = `label-preview ${transparentBg ? 'dtf-transparent' : ''} clickable`;
    labelDiv.onclick = () => openPreviewModal(index);
    labelDiv.style.borderColor = document.getElementById('borderColor').value;
    labelDiv.style.borderWidth = document.getElementById('borderWidth').value + 'px';
    labelDiv.style.fontFamily = font;
    
    if (shape === 'rounded') {
        labelDiv.style.borderRadius = '15px';
    } else if (shape === 'circle') {
        labelDiv.style.borderRadius = '50%';
    } else {
        labelDiv.style.borderRadius = '0';
    }
    
    if (mirrorEffect) {
        labelDiv.style.transform = 'scaleX(-1)';
    }
    
    // Aplicar fondo
    if (backgroundType === 'color') {
        labelDiv.style.backgroundColor = document.getElementById('backgroundColor').value;
    } else if (backgroundType === 'image') {
        const bgUrl = document.getElementById('backgroundImageUrl').value || document.getElementById('previewBackground').src;
        if (bgUrl) {
            labelDiv.style.backgroundImage = `url(${bgUrl})`;
            labelDiv.style.backgroundSize = 'cover';
            labelDiv.style.backgroundPosition = 'center';
            labelDiv.style.opacity = document.getElementById('backgroundOpacity').value;
        }
    }
    
    let html = '<div class="label-content" style="position: relative; width: 100%; height: 100%;">';
    
    // Imagen del producto
    if (showProductImage && imageUrl) {
        const imgWidth = document.getElementById('productImageWidth').value;
        const imgHeight = document.getElementById('productImageHeight').value;
        const imgPosX = document.getElementById('productImagePosX').value;
        const imgPosY = document.getElementById('productImagePosY').value;
        const imgRotation = document.getElementById('productImageRotation').value;
        
        // Calcular posiciones en p√≠xeles
        const imgX = (imgPosX / 100) * labelWidthPx;
        const imgY = (imgPosY / 100) * labelHeightPx;
        
        html += `
        <img src="${imageUrl.trim()}"
        class="product-image"
        style="position: absolute;
        width: ${imgWidth}px;
        height: ${imgHeight}px;
        left: calc(${imgPosX}% - ${imgWidth / 2}px);
        top: calc(${imgPosY}% - ${imgHeight / 2}px);
        transform: rotate(${imgRotation}deg);
        object-fit: contain;"
        onerror="this.style.display='none'">
        `;
    }
    
    // Im√°genes adicionales
    for (let i = 1; i <= 3; i++) {
        const imgSrc = additionalImages[`img${i}`];
        if (imgSrc) {
            const imgWidth = document.getElementById(`img${i}Width`).value;
            const imgPosX = document.getElementById(`img${i}PosX`).value;
            const imgPosY = document.getElementById(`img${i}PosY`).value;
            const imgRotation = document.getElementById(`img${i}Rotation`).value;
            
            // Calcular posiciones en p√≠xeles
            const imgX = (imgPosX / 100) * labelWidthPx;
            const imgY = (imgPosY / 100) * labelHeightPx;
            
            html += `
            <img src="${imgSrc}"
            style="position: absolute;
            width: ${imgWidth}px;
            left: calc(${imgPosX}% - ${imgWidth / 2}px);
            top: calc(${imgPosY}% - ${imgWidth / 2}px);
            transform: rotate(${imgRotation}deg);
            object-fit: contain;"
            onerror="this.style.display='none'">
            `;
        }
    }
    
    // Nombre del producto
    html += `
    <div class="label-name"
    style="position: absolute;
    left: calc(${fontPosX}% - 50%);
    top: calc(${fontPosY}% - 50%);
    transform: translate(-50%, -50%) rotate(${fontRotation}deg);
    font-size: ${fontSize}px;
    color: ${document.getElementById('textColor').value};
    text-align: center;
    width: 90%;
    font-weight: bold;">
    ${name}
    </div>
    `;
    
    // Precio
    html += `
    <div class="label-price"
    style="position: absolute;
    left: 50%;
    top: 65%;
    transform: translate(-50%, -50%);
    text-align: center;
    width: 90%;
    font-weight: bold;
    color: ${document.getElementById('borderColor').value};">
    ${price}
    </div>
    `;
    
    // Indicaciones
if (showInstructions && indicacionesJSON && indicacionesJSON.current) {
    const instFontSize = document.getElementById('instructionsFontSize').value;
    const instColor = document.getElementById('instructionsColor').value;
    const instRotation = document.getElementById('instructionsRotation').value;
    const instPosX = document.getElementById('instructionsPosX').value;
    const instPosY = document.getElementById('instructionsPosY').value;
    const instWidth = document.getElementById('instructionsWidth').value;
    
    const current = indicacionesJSON.current;
    let indicacionesText = '';
    
    // ‚úÖ Indicaciones
    if (current.indicaciones && current.indicaciones.length > 0) {
        indicacionesText += current.indicaciones.join('<br>');
    }
    
    // ‚úÖ Advertencias
    if (current.advertencias && current.advertencias.length > 0) {
        indicacionesText += '<br><br><strong>Advertencias:</strong><br>';
        indicacionesText += current.advertencias.join('<br>');
    }
    
    if (indicacionesText) {
        html += `
        <div style="position: absolute;
            left: calc(${instPosX}% - ${instWidth/2}%);
            top: calc(${instPosY}% - 50%);
            width: ${instWidth}%;
            font-size: ${instFontSize}px;
            color: ${instColor};
            transform: rotate(${instRotation}deg);
            text-align: left;
            line-height: 1.4;
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            ${indicacionesText}
        </div>
        `;
    }
}
    
    // Textos adicionales
    for (let i = 1; i <= 3; i++) {
        const text = document.getElementById(`additionalText${i}`).value;
        if (text) {
            const textFontSize = document.getElementById(`text${i}FontSize`).value;
            const textColor = document.getElementById(`text${i}Color`).value;
            const textPosX = document.getElementById(`text${i}PosX`).value;
            const textPosY = document.getElementById(`text${i}PosY`).value;
            const textRotation = document.getElementById(`text${i}Rotation`).value;
            
            html += `
            <div style="position: absolute;
            left: calc(${textPosX}% - 50%);
            top: calc(${textPosY}% - 50%);
            transform: rotate(${textRotation}deg);
            font-size: ${textFontSize}px;
            color: ${textColor};
            text-align: center;
            font-weight: ${i === 1 ? 'bold' : 'normal'};">
            ${text}
            </div>
            `;
        }
    }
    
    html += '</div>';
    labelDiv.innerHTML = html;
    previewGrid.appendChild(labelDiv);
}

        function updateStats(productCount, quantity, total) {
            document.getElementById('statsText').textContent = 
                `üìä ${total} etiquetas generadas (${productCount} productos √ó ${quantity.toFixed(1)} promedio)`;
        }

    function calculateProduction() {
    const previewGrid = document.getElementById('previewGrid');
    previewGrid.innerHTML = '';
    
    if (generatedLabels.length === 0) {
        previewGrid.innerHTML = '<p class="no-labels">‚ö†Ô∏è Genera etiquetas primero</p>';
        return;
    }
    
    // ‚úÖ Obtener dimensiones de la etiqueta
    const labelW = parseFloat(document.getElementById('labelWidth').value) || 5;
    const labelH = parseFloat(document.getElementById('labelHeight').value) || 5;
    
    // ‚úÖ Calcular dimensiones en p√≠xeles (300 DPI)
    const dpi = 300;
    const pxPerCm = dpi / 2.54;
    const labelWPx = Math.round(labelW * pxPerCm);
    const labelHPx = Math.round(labelH * pxPerCm);
    
    // ‚úÖ Calcular cu√°ntas etiquetas caben por fila
    const gridWidth = previewGrid.clientWidth;
    const labelsPerRow = Math.max(1, Math.floor(gridWidth / (labelWPx + 20)));
    
    // ‚úÖ Configurar el grid
    previewGrid.style.display = 'grid';
    previewGrid.style.gridTemplateColumns = `repeat(${labelsPerRow}, 1fr)`;
    previewGrid.style.gap = '15px';
    previewGrid.style.padding = '15px';
    previewGrid.style.backgroundColor = '#f8f9fa';
    previewGrid.style.overflow = 'auto';
    previewGrid.style.maxHeight = '600px';
    
    let totalLabels = 0;
    
    // ‚úÖ Generar cada etiqueta
    generatedLabels.forEach((labelData, index) => {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'preview-label';
        labelDiv.style.position = 'relative';
        labelDiv.style.boxSizing = 'border-box';
        labelDiv.style.border = '2px solid #e0e0e0';
        labelDiv.style.borderRadius = '4px';
        labelDiv.style.background = 'white';
        labelDiv.style.display = 'flex';
        labelDiv.style.flexDirection = 'column';
        labelDiv.style.alignItems = 'center';
        labelDiv.style.justifyContent = 'center';
        labelDiv.style.overflow = 'hidden';
        labelDiv.style.padding = '10px';
        labelDiv.style.aspectRatio = `${labelW}/${labelH}`;
        labelDiv.style.cursor = 'pointer';
        labelDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        labelDiv.style.transition = 'transform 0.2s, box-shadow 0.2s';
        
        // ‚úÖ Efecto hover
        labelDiv.addEventListener('mouseenter', () => {
            labelDiv.style.transform = 'scale(1.05)';
            labelDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        });
        
        labelDiv.addEventListener('mouseleave', () => {
            labelDiv.style.transform = 'scale(1)';
            labelDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        });
        
        // ‚úÖ Click para ver vista previa grande
        labelDiv.addEventListener('click', () => {
            currentPreviewIndex = index;
            previewLabels = generatedLabels;
            openLargePreview();
        });
        
        // ‚úÖ Contenido de la etiqueta
        const contentDiv = document.createElement('div');
        contentDiv.style.width = '100%';
        contentDiv.style.height = '100%';
        contentDiv.style.display = 'flex';
        contentDiv.style.flexDirection = 'column';
        contentDiv.style.alignItems = 'center';
        contentDiv.style.justifyContent = 'center';
        contentDiv.style.textAlign = 'center';
        contentDiv.style.position = 'relative';
        
        // ‚úÖ Nombre del producto
        const nameDiv = document.createElement('div');
        nameDiv.style.fontWeight = 'bold';
        nameDiv.style.fontSize = '14px';
        nameDiv.style.color = document.getElementById('textColor').value;
        nameDiv.style.marginBottom = '5px';
        nameDiv.style.maxWidth = '90%';
        nameDiv.style.wordWrap = 'break-word';
        nameDiv.textContent = labelData.name;
        
        // ‚úÖ ID del producto
        const idDiv = document.createElement('div');
        idDiv.style.fontSize = '11px';
        idDiv.style.color = '#666';
        idDiv.textContent = `ID: ${labelData.productId || 'N/A'}`;
        
        // ‚úÖ Categor√≠a
        const categoryDiv = document.createElement('div');
        categoryDiv.style.fontSize = '10px';
        categoryDiv.style.color = '#888';
        categoryDiv.style.marginTop = '3px';
        categoryDiv.textContent = labelData.product?.categoria || 'Sin categor√≠a';
        
        // ‚úÖ Badge con dimensiones
        const sizeBadge = document.createElement('div');
        sizeBadge.style.position = 'absolute';
        sizeBadge.style.bottom = '5px';
        sizeBadge.style.right = '5px';
        sizeBadge.style.background = 'rgba(0,0,0,0.7)';
        sizeBadge.style.color = 'white';
        sizeBadge.style.fontSize = '9px';
        sizeBadge.style.padding = '2px 5px';
        sizeBadge.style.borderRadius = '3px';
        sizeBadge.textContent = `${labelW}x${labelH} cm`;
        
        contentDiv.appendChild(nameDiv);
        contentDiv.appendChild(idDiv);
        contentDiv.appendChild(categoryDiv);
        contentDiv.appendChild(sizeBadge);
        
        labelDiv.appendChild(contentDiv);
        previewGrid.appendChild(labelDiv);
        totalLabels++;
    });
    
    // ‚úÖ Mostrar resumen
    const summaryDiv = document.createElement('div');
    summaryDiv.style.gridColumn = '1 / -1';
    summaryDiv.style.padding = '15px';
    summaryDiv.style.backgroundColor = '#e8f5e9';
    summaryDiv.style.borderRadius = '8px';
    summaryDiv.style.marginBottom = '15px';
    summaryDiv.style.textAlign = 'center';
    summaryDiv.innerHTML = `
        <strong>üìä Resumen de Producci√≥n</strong><br>
        Total: ${totalLabels} etiquetas<br>
        Grid: ${labelsPerRow} columnas x ${Math.ceil(totalLabels / labelsPerRow)} filas<br>
        Dimensiones: ${labelW}x${labelH} cm (${labelWPx}x${labelHPx} px)
    `;
    
    previewGrid.insertBefore(summaryDiv, previewGrid.firstChild);
    
    showToast(`‚úÖ Vista previa generada: ${totalLabels} etiquetas en grid de ${labelsPerRow} columnas`, 'success');
}
        // ========== FUNCIONES DE EXPORTACI√ìN COMPLETAS ==========

// CORREGIDO: Funci√≥n para crear canvas de etiqueta a 300 DPI
async function createLabelCanvas(labelData, options = {}) {
    const {
        transparentBg = false,
        mirrorEffect = false,
        mode = 'dtf-textil'
    } = options;
    
    // Usar 300 DPI para exportaci√≥n (300 DPI / 2.54 cm/inch ‚âà 118.11 px/cm)
    const dpi = 300;
    const pxPerCm = dpi / 2.54;
    
    // Obtener dimensiones de la etiqueta en cm
    const widthCm = parseFloat(document.getElementById('labelWidth').value) || 5;
    const heightCm = parseFloat(document.getElementById('labelHeight').value) || 5;
    
    // Calcular dimensiones en p√≠xeles
    const widthPx = Math.round(widthCm * pxPerCm);
    const heightPx = Math.round(heightCm * pxPerCm);
    
    const canvas = document.createElement('canvas');
    canvas.width = widthPx;
    canvas.height = heightPx;
    const ctx = canvas.getContext('2d');
    
    // Fondo
    if (!transparentBg) {
        const backgroundType = document.getElementById('backgroundType').value;
        if (backgroundType === 'color') {
            ctx.fillStyle = document.getElementById('backgroundColor').value;
            ctx.fillRect(0, 0, widthPx, heightPx);
        } else if (backgroundType === 'image') {
            const bgUrl = document.getElementById('backgroundImageUrl').value || document.getElementById('previewBackground').src;
            if (bgUrl) {
                const bgImg = await loadImage(bgUrl);
                ctx.globalAlpha = parseFloat(document.getElementById('backgroundOpacity').value) || 1;
                ctx.drawImage(bgImg, 0, 0, widthPx, heightPx);
                ctx.globalAlpha = 1;
            }
        }
    }
    
    // Efecto espejo
    if (mirrorEffect) {
        ctx.translate(widthPx, 0);
        ctx.scale(-1, 1);
    }
    
    // Borde
    const borderWidth = (parseFloat(document.getElementById('borderWidth').value) || 0) * (pxPerCm / 38);
    if (borderWidth > 0) {
        ctx.strokeStyle = document.getElementById('borderColor').value;
        ctx.lineWidth = borderWidth;
        const shape = document.querySelector('input[name="labelShape"]:checked').value;
        if (shape === 'rounded') {
            const radius = 15 * (pxPerCm / 38);
            drawRoundedRect(ctx, borderWidth/2, borderWidth/2, widthPx - borderWidth, heightPx - borderWidth, radius);
            ctx.stroke();
        } else if (shape === 'circle') {
            ctx.beginPath();
            ctx.arc(widthPx/2, heightPx/2, Math.min(widthPx, heightPx)/2 - borderWidth/2, 0, Math.PI * 2);
            ctx.stroke();
        } else {
            ctx.strokeRect(borderWidth/2, borderWidth/2, widthPx - borderWidth, heightPx - borderWidth);
        }
    }
    
    // Imagen del producto
    const showProductImage = document.getElementById('showProductImage').checked;
    if (showProductImage && labelData.product && labelData.product.imagen) {
        try {
            const img = await loadImage(labelData.product.imagen);
            const imgW = (parseFloat(document.getElementById('productImageWidth').value) || 100) * (pxPerCm / 38);
            const imgH = (parseFloat(document.getElementById('productImageHeight').value) || 100) * (pxPerCm / 38);
            const imgX = (parseFloat(document.getElementById('productImagePosX').value) / 100) * widthPx;
            const imgY = (parseFloat(document.getElementById('productImagePosY').value) / 100) * heightPx;
            const imgRot = (parseFloat(document.getElementById('productImageRotation').value) || 0) * Math.PI / 180;
            
            ctx.save();
            ctx.translate(imgX, imgY);
            ctx.rotate(imgRot);
            ctx.drawImage(img, -imgW/2, -imgH/2, imgW, imgH);
            ctx.restore();
        } catch (e) { 
            console.error("Error loading product image", e); 
        }
    }
    
    // Im√°genes adicionales
    for (let i = 1; i <= 3; i++) {
        const imgSrc = additionalImages[`img${i}`];
        if (imgSrc) {
            try {
                const img = await loadImage(imgSrc);
                const imgW = (parseFloat(document.getElementById(`img${i}Width`).value) || 50) * (pxPerCm / 38);
                const imgH = (parseFloat(document.getElementById(`img${i}Width`).value) || 50) * (pxPerCm / 38);
                const imgX = (parseFloat(document.getElementById(`img${i}PosX`).value) / 100) * widthPx;
                const imgY = (parseFloat(document.getElementById(`img${i}PosY`).value) / 100) * heightPx;
                const imgRot = (parseFloat(document.getElementById(`img${i}Rotation`).value) || 0) * Math.PI / 180;
                
                ctx.save();
                ctx.translate(imgX, imgY);
                ctx.rotate(imgRot);
                ctx.drawImage(img, -imgW/2, -imgH/2, imgW, imgH);
                ctx.restore();
            } catch (e) { 
                console.error(`Error loading additional image ${i}`, e); 
            }
        }
    }
    
    // Nombre del producto
    const fontSize = (parseFloat(document.getElementById('fontSize').value) || 16) * (pxPerCm / 38);
    const fontRot = (parseFloat(document.getElementById('fontRotation').value) || 0) * Math.PI / 180;
    const fontX = (parseFloat(document.getElementById('fontPosX').value) / 100) * widthPx;
    const fontY = (parseFloat(document.getElementById('fontPosY').value) / 100) * heightPx;
    const textColor = document.getElementById('textColor').value;
    const selectedFont = document.getElementById('selectedFont').value;
    
    ctx.save();
    ctx.translate(fontX, fontY);
    ctx.rotate(fontRot);
    ctx.fillStyle = textColor;
    ctx.font = `bold ${fontSize}px ${selectedFont}`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(labelData.name, 0, 0);
    ctx.restore();
    
    // Precio
    const priceFormat = document.getElementById('priceFormat').value;
    if (priceFormat) {
        ctx.save();
        ctx.translate(widthPx/2, heightPx * 0.65);
        ctx.fillStyle = document.getElementById('borderColor').value;
        ctx.font = `bold ${fontSize * 0.8}px ${selectedFont}`;
        ctx.textAlign = 'center';
        ctx.fillText(priceFormat, 0, 0);
        ctx.restore();
    }
    
    // Textos adicionales
    for (let i = 1; i <= 3; i++) {
        const text = document.getElementById(`additionalText${i}`).value;
        if (text) {
            const textFontSize = (parseFloat(document.getElementById(`text${i}FontSize`).value) || 12) * (pxPerCm / 38);
            const textColor = document.getElementById(`text${i}Color`).value;
            const textX = (parseFloat(document.getElementById(`text${i}PosX`).value) / 100) * widthPx;
            const textY = (parseFloat(document.getElementById(`text${i}PosY`).value) / 100) * heightPx;
            const textRot = (parseFloat(document.getElementById(`text${i}Rotation`).value) || 0) * Math.PI / 180;
            
            ctx.save();
            ctx.translate(textX, textY);
            ctx.rotate(textRot);
            ctx.fillStyle = textColor;
            ctx.font = `${i === 1 ? 'bold' : 'normal'} ${textFontSize}px ${selectedFont}`;
            ctx.textAlign = 'center';
            ctx.fillText(text, 0, 0);
            ctx.restore();
        }
    }
    
    // Indicaciones
    if (document.getElementById('showInstructions').checked && indicacionesJSON) {
        const instFontSize = (parseFloat(document.getElementById('instructionsFontSize').value) || 10) * (pxPerCm / 38);
        const instColor = document.getElementById('instructionsColor').value;
        const instRotation = (parseFloat(document.getElementById('instructionsRotation').value) || 0) * Math.PI / 180;
        const instPosX = (parseFloat(document.getElementById('instructionsPosX').value) / 100) * widthPx;
        const instPosY = (parseFloat(document.getElementById('instructionsPosY').value) / 100) * heightPx;
        const instWidth = (parseFloat(document.getElementById('instructionsWidth').value) / 100) * widthPx;
        
        let indicacionesText = '';
        if (Array.isArray(indicacionesJSON)) {
            const current = indicacionesJSON.current;
            if (current) {
                if (current.indicaciones && current.indicaciones.length > 0) {
                    indicacionesText += current.indicaciones.join('<br>');
                }
                if (current.advertencias && current.advertencias.length > 0) {
                    indicacionesText += '<br><br><strong>Advertencias:</strong><br>';
                    indicacionesText += current.advertencias.join('<br>');
                }
            }
        } else {
            if (indicacionesJSON.indicaciones) {
                indicacionesText += indicacionesJSON.indicaciones.join('<br>');
            }
            if (indicacionesJSON.advertencias) {
                indicacionesText += '<br><br><strong>Advertencias:</strong><br>';
                indicacionesText += indicacionesJSON.advertencias.join('<br>');
            }
        }
        
        if (indicacionesText) {
            ctx.save();
            ctx.translate(instPosX, instPosY);
            ctx.rotate(instRotation);
            
            // Dividir texto en l√≠neas
            const lines = indicacionesText.split('<br>');
            const lineHeight = instFontSize * 1.2;
            
            // Dibujar cada l√≠nea
            lines.forEach((line, index) => {
                const y = (index - lines.length/2) * lineHeight;
                ctx.fillText(line, 0, y);
            });
            
            ctx.restore();
        }
    }
    
    return canvas;
}


function loadImage(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = url;
    });
}

function drawRoundedRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
}

async function generateSheetCanvas() {

    console.log('üìÑ Hoja seleccionada:', document.getElementById('sheetSize').value);
    console.log('üìè Dimensiones: ', document.getElementById('sheetWidth').value, 'x', document.getElementById('sheetHeight').value, 'cm');

    const sheetW = parseFloat(document.getElementById('sheetWidth').value) || 58;
    const sheetH = parseFloat(document.getElementById('sheetHeight').value) || 100;
    const labelW = parseFloat(document.getElementById('labelWidth').value) || 5;
    const labelH = parseFloat(document.getElementById('labelHeight').value) || 5;
    
    const dpi = 300;
    const pxPerCm = dpi / 2.54;
    
    // ‚úÖ Calcular dimensiones de hoja en p√≠xeles
    const sheetWPx = Math.round(sheetW * pxPerCm);
    const sheetHPx = Math.round(sheetH * pxPerCm);
    
    // ‚úÖ Calcular dimensiones de etiqueta en p√≠xeles
    const labelWPx = Math.round(labelW * pxPerCm);
    const labelHPx = Math.round(labelH * pxPerCm);
    
    // ‚úÖ Calcular cu√°ntas etiquetas caben POR FILA y COLUMNA en p√≠xeles
    const labelsPerRow = Math.floor(sheetWPx / labelWPx);
    const labelsPerCol = Math.floor(sheetHPx / labelHPx);
    
    // ‚úÖ Calcular m√°rgenes para centrar
    const totalWidthUsed = labelsPerRow * labelWPx;
    const totalHeightUsed = labelsPerCol * labelHPx;
    const marginX = Math.round((sheetWPx - totalWidthUsed) / 2);
    const marginY = Math.round((sheetHPx - totalHeightUsed) / 2);
    
    console.log(`üìÑ Hoja: ${sheetW}x${sheetH} cm (${sheetWPx}x${sheetHPx} px)`);
    console.log(`üè∑Ô∏è Etiqueta: ${labelW}x${labelH} cm (${labelWPx}x${labelHPx} px)`);
    console.log(`üìä Grid: ${labelsPerRow}x${labelsPerCol} = ${labelsPerRow * labelsPerCol} etiquetas`);
    console.log(`üìê M√°rgenes: X=${marginX}px, Y=${marginY}px`);
    
    const canvas = document.createElement('canvas');
    canvas.width = sheetWPx;
    canvas.height = sheetHPx;
    const ctx = canvas.getContext('2d');
    
    // ‚úÖ Fondo blanco o transparente
    const transparentBg = document.getElementById('transparentBg').checked;
    if (!transparentBg) {
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, sheetWPx, sheetHPx);
    } else {
        // Fondo transparente (por defecto)
    }
    
    const mode = document.getElementById('dtfMode').value;
    const mirrorEffect = document.getElementById('mirrorEffect').checked;
    
    let labelIndex = 0;
    let drawnCount = 0;
    
    // ‚úÖ Dibujar etiquetas en grid
    for (let row = 0; row < labelsPerCol; row++) {
        for (let col = 0; col < labelsPerRow; col++) {
            if (labelIndex >= generatedLabels.length) break;
            
            try {
                const labelData = generatedLabels[labelIndex];
                const labelCanvas = await createLabelCanvas(labelData, {
                    transparentBg,
                    mirrorEffect,
                    mode
                });
                
                // ‚úÖ Posici√≥n exacta con m√°rgenes
                const x = marginX + (col * labelWPx);
                const y = marginY + (row * labelHPx);
                
                // ‚úÖ ESPECIFICAR TAMA√ëO AL DIBUJAR (¬°CR√çTICO!)
                ctx.drawImage(labelCanvas, x, y, labelWPx, labelHPx);
                
                drawnCount++;
                labelIndex++;
            } catch (error) {
                console.error(`Error generando etiqueta ${labelIndex}:`, error);
            }
        }
        if (labelIndex >= generatedLabels.length) break;
    }
    
    console.log(`‚úÖ Generadas ${drawnCount} etiquetas en la plancha`);
    
    // ‚úÖ Dibujar l√≠neas de gu√≠a (opcional, para visualizaci√≥n)
    ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
    ctx.lineWidth = 1;
    
    // L√≠neas verticales
    for (let col = 0; col <= labelsPerRow; col++) {
        const x = marginX + (col * labelWPx);
        ctx.beginPath();
        ctx.moveTo(x, marginY);
        ctx.lineTo(x, marginY + (labelsPerCol * labelHPx));
        ctx.stroke();
    }
    
    // L√≠neas horizontales
    for (let row = 0; row <= labelsPerCol; row++) {
        const y = marginY + (row * labelHPx);
        ctx.beginPath();
        ctx.moveTo(marginX, y);
        ctx.lineTo(marginX + (labelsPerRow * labelWPx), y);
        ctx.stroke();
    }
    
    return canvas;
}


async function exportDTF() {
    if (generatedLabels.length === 0) {
        showToast('‚ö†Ô∏è Genera etiquetas primero', 'error');
        return;
    }

    const transparentBg = document.getElementById('transparentBg').checked;
    showToast(`üé® Generando Plancha PNG DTF (${transparentBg ? 'Transparente' : 'Fondo Blanco'}) a 300 DPI...`, 'warning');

    try {
        const canvas = await generateSheetCanvas();
        canvas.toBlob((blob) => {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            saveAs(blob, `plancha_dtf_${timestamp}.png`);
            showToast('‚úÖ Plancha DTF exportada exitosamente', 'success');
        }, 'image/png', 1.0);
    } catch (error) {
        console.error('Error exportando DTF:', error);
        showToast('‚ùå Error al generar PNG DTF', 'error');
    }
}

async function exportPDF() {
    if (generatedLabels.length === 0) {
        showToast('‚ö†Ô∏è Genera etiquetas primero', 'error');
        return;
    }
    
    showToast('üìÑ Generando PDF de alta resoluci√≥n...', 'warning');
    
    try {
        const canvas = await generateSheetCanvas();
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        
        const { jsPDF } = window.jspdf;
        const sheetW = parseFloat(document.getElementById('sheetWidth').value) || 58;
        const sheetH = parseFloat(document.getElementById('sheetHeight').value) || 100;
        
        const pdf = new jsPDF({
            orientation: sheetW > sheetH ? 'l' : 'p',
            unit: 'cm',
            format: [sheetW, sheetH]
        });
        
        pdf.addImage(imgData, 'JPEG', 0, 0, sheetW, sheetH);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        pdf.save(`plancha_dtf_${timestamp}.pdf`);
        
        showToast('‚úÖ PDF generado exitosamente', 'success');
    } catch (error) {
        console.error('Error exportando PDF:', error);
        showToast('‚ùå Error al generar PDF', 'error');
    }
}

// Imprimir etiquetas
function printLabels() {
    if (generatedLabels.length === 0) {
        showToast('‚ö†Ô∏è Genera etiquetas primero', 'error');
        return;
    }
    showToast('üñ®Ô∏è Preparando plancha para impresi√≥n...', 'warning');
    
    // Usar Promise en lugar de async/await
    generateSheetCanvas().then(function(canvas) {
        var dataUrl = canvas.toDataURL();
        var windowContent = '' +
        '<!DOCTYPE html>' +
        '<html>' +
        '<head><title>Imprimir Plancha DTF</title></head>' +
        '<body style="margin: 0; padding: 0;">' +
        '<img src="' + dataUrl + '" style="width: 100%;">' +
        '<script>' +
        'window.onload = function() {' +
        '    window.print();' +
        '    setTimeout(function() { window.close(); }, 500);' +
        '};' +
        '</' + 'script>' +
        '</body>' +
        '</html>';
        
        var printWin = window.open('', '', 'width=800,height=600');
        printWin.document.open();
        printWin.document.write(windowContent);
        printWin.document.close();
        showToast('üñ®Ô∏è Enviando a impresora...', 'success');
    }).catch(function(error) {
        console.error('Error al imprimir:', error);
        showToast('‚ùå Error al preparar impresi√≥n', 'error');
    });
}

        function downloadAllZIP() {
            if (generatedLabels.length === 0) {
                showToast('‚ö†Ô∏è Genera etiquetas primero', 'error');
                return;
            }
            showToast('üíæ Creando archivo ZIP con todas las etiquetas...', 'warning');
            setTimeout(() => {
                showToast('‚úÖ Descarga iniciada: etiquetas_dtf.zip', 'success');
            }, 1200);
        }

        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            showToast(isDarkMode ? 'üåô Modo oscuro activado' : '‚òÄÔ∏è Modo claro activado', 'warning');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = toast.querySelector('.toast-message');
            
            toastMessage.innerHTML = message.replace(/\n/g, '<br>');
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3500);
        }

        // CORREGIDO: Descargar solo la etiqueta seleccionada
function downloadLabel() {
    if (currentPreviewIndex < 0) return;
    
    const labelData = previewLabels[currentPreviewIndex];
    showToast(`üíæ Descargando etiqueta: ${labelData.name}`, 'success');
    
    // Generar solo la etiqueta seleccionada
    createLabelCanvas(labelData).then(canvas => {
        // Convertir a imagen y descargar
        canvas.toBlob(blob => {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            saveAs(blob, `etiqueta_${labelData.name}_${timestamp}.png`);
            showToast('‚úÖ Etiqueta descargada exitosamente', 'success');
        }, 'image/png', 1.0);
    }).catch(error => {
        console.error('Error generando etiqueta:', error);
        showToast('‚ùå Error al generar la etiqueta', 'error');
    });
}

// CORREGIDO: Imprimir solo la etiqueta seleccionada
function printLabel() {
    if (currentPreviewIndex < 0) return;
    
    const labelData = previewLabels[currentPreviewIndex];
    showToast(`üñ®Ô∏è Imprimiendo: ${labelData.name}`, 'success');
    
    // Generar solo la etiqueta seleccionada
    createLabelCanvas(labelData).then(canvas => {
        // Crear una ventana para imprimir solo la etiqueta
        const printWin = window.open('', '', 'width=800,height=600');
        printWin.document.write(`
            <html>
            <head>
                <title>Etiqueta para imprimir</title>
                <style>
                    @media print {
                        body { margin: 0; padding: 0; }
                        .print-only { display: block; }
                        .no-print { display: none; }
                    }
                    @media screen {
                        .print-only { display: none; }
                        .no-print { display: block; }
                    }
                </style>
            </head>
            <body>
                <div class="print-only">
                    <img src="${canvas.toDataURL()}" style="width: 100%; height: auto;">
                </div>
                <div class="no-print">
                    <p>Esta secci√≥n no se imprimir√°</p>
                </div>
            </body>
            </html>
        `);
        printWin.document.close();
        
        // Esperar a que se cargue la imagen antes de imprimir
        setTimeout(() => {
            printWin.print();
            printWin.close();
            showToast('üñ®Ô∏è Etiqueta enviada a impresora', 'success');
        }, 500);
    }).catch(error => {
        console.error('Error generando etiqueta para impresi√≥n:', error);
        showToast('‚ùå Error al preparar la etiqueta para impresi√≥n', 'error');
    });
}

        // Sistema de guardado de configuraci√≥n
        function saveConfig() {
            const config = {
                // Configuraci√≥n DTF
                dtfMode: document.getElementById('dtfMode').value,
                sheetSize: document.getElementById('sheetSize').value,
                sheetWidth: document.getElementById('sheetWidth').value,
                sheetHeight: document.getElementById('sheetHeight').value,
                labelWidth: document.getElementById('labelWidth').value,
                labelHeight: document.getElementById('labelHeight').value,
                
                // Forma y estilo
                labelShape: document.querySelector('input[name="labelShape"]:checked').value,
                transparentBg: document.getElementById('transparentBg').checked,
                mirrorEffect: document.getElementById('mirrorEffect').checked,
                borderColor: document.getElementById('borderColor').value,
                borderWidth: document.getElementById('borderWidth').value,
                textColor: document.getElementById('textColor').value,
                
                // Texto nombre
                fontSize: document.getElementById('fontSize').value,
                fontRotation: document.getElementById('fontRotation').value,
                fontPosX: document.getElementById('fontPosX').value,
                fontPosY: document.getElementById('fontPosY').value,
                priceFormat: document.getElementById('priceFormat').value,
                
                // Imagen de producto
                showProductImage: document.getElementById('showProductImage').checked,
                productImageWidth: document.getElementById('productImageWidth').value,
                productImageHeight: document.getElementById('productImageHeight').value,
                productImagePosX: document.getElementById('productImagePosX').value,
                productImagePosY: document.getElementById('productImagePosY').value,
                productImageRotation: document.getElementById('productImageRotation').value,
                
                // Im√°genes adicionales (guardar URLs/base64)
                additionalImages: additionalImages,
                img1Width: document.getElementById('img1Width').value,
                img1PosX: document.getElementById('img1PosX').value,
                img1PosY: document.getElementById('img1PosY').value,
                img1Rotation: document.getElementById('img1Rotation').value,
                img2Width: document.getElementById('img2Width').value,
                img2PosX: document.getElementById('img2PosX').value,
                img2PosY: document.getElementById('img2PosY').value,
                img2Rotation: document.getElementById('img2Rotation').value,
                img3Width: document.getElementById('img3Width').value,
                img3PosX: document.getElementById('img3PosX').value,
                img3PosY: document.getElementById('img3PosY').value,
                img3Rotation: document.getElementById('img3Rotation').value,
                
                // Indicaciones
                showInstructions: document.getElementById('showInstructions').checked,
                instructionsSource: document.getElementById('instructionsSource').value,
                customInstructionsText: document.getElementById('customInstructionsText').value,
                instructionsFontSize: document.getElementById('instructionsFontSize').value,
                instructionsColor: document.getElementById('instructionsColor').value,
                instructionsRotation: document.getElementById('instructionsRotation').value,
                instructionsPosX: document.getElementById('instructionsPosX').value,
                instructionsPosY: document.getElementById('instructionsPosY').value,
                instructionsWidth: document.getElementById('instructionsWidth').value,
                
                // Textos adicionales
                additionalText1: document.getElementById('additionalText1').value,
                text1FontSize: document.getElementById('text1FontSize').value,
                text1Color: document.getElementById('text1Color').value,
                text1PosX: document.getElementById('text1PosX').value,
                text1PosY: document.getElementById('text1PosY').value,
                text1Rotation: document.getElementById('text1Rotation').value,
                
                additionalText2: document.getElementById('additionalText2').value,
                text2FontSize: document.getElementById('text2FontSize').value,
                text2Color: document.getElementById('text2Color').value,
                text2PosX: document.getElementById('text2PosX').value,
                text2PosY: document.getElementById('text2PosY').value,
                text2Rotation: document.getElementById('text2Rotation').value,
                
                additionalText3: document.getElementById('additionalText3').value,
                text3FontSize: document.getElementById('text3FontSize').value,
                text3Color: document.getElementById('text3Color').value,
                text3PosX: document.getElementById('text3PosX').value,
                text3PosY: document.getElementById('text3PosY').value,
                text3Rotation: document.getElementById('text3Rotation').value,
                
                selectedFont: document.getElementById('selectedFont').value,
                
                // Fondo
                backgroundType: document.getElementById('backgroundType').value,
                backgroundColor: document.getElementById('backgroundColor').value,
                backgroundImageUrl: document.getElementById('backgroundImageUrl').value,
                backgroundOpacity: document.getElementById('backgroundOpacity').value,
                patternType: document.getElementById('patternType').value,
                patternColor: document.getElementById('patternColor').value,
                patternOpacity: document.getElementById('patternOpacity').value,
                
                // Timestamp
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('etiquetaDTFConfig', JSON.stringify(config));
            showToast('‚úÖ Configuraci√≥n guardada en el navegador', 'success');
        }

        function loadConfig() {
            const configStr = localStorage.getItem('etiquetaDTFConfig');
            if (!configStr) {
                console.log('No hay configuraci√≥n guardada');
                return;
            }
            
            try {
                const config = JSON.parse(configStr);
                
                // Restaurar configuraci√≥n DTF
                document.getElementById('dtfMode').value = config.dtfMode || 'uv';
                document.getElementById('sheetSize').value = config.sheetSize || 'dtf-uv';
                document.getElementById('sheetWidth').value = config.sheetWidth || '28';
                document.getElementById('sheetHeight').value = config.sheetHeight || '100';
                document.getElementById('labelWidth').value = config.labelWidth || '5';
                document.getElementById('labelHeight').value = config.labelHeight || '5';
                
                // Restaurar forma y estilo
                document.querySelector(`input[name="labelShape"][value="${config.labelShape || 'rounded'}"]`).checked = true;
                document.getElementById('transparentBg').checked = config.transparentBg !== undefined ? config.transparentBg : true;
                document.getElementById('mirrorEffect').checked = config.mirrorEffect || false;
                document.getElementById('borderColor').value = config.borderColor || '#8B4513';
                document.getElementById('borderWidth').value = config.borderWidth || '2';
                document.getElementById('textColor').value = config.textColor || '#000000';
                
                // Restaurar texto nombre
                document.getElementById('fontSize').value = config.fontSize || '16';
                document.getElementById('fontRotation').value = config.fontRotation || '0';
                document.getElementById('fontPosX').value = config.fontPosX || '50';
                document.getElementById('fontPosY').value = config.fontPosY || '50';
                document.getElementById('priceFormat').value = config.priceFormat || '';
                
                // Restaurar imagen de producto
                document.getElementById('showProductImage').checked = config.showProductImage !== undefined ? config.showProductImage : true;
                document.getElementById('productImageWidth').value = config.productImageWidth || '100';
                document.getElementById('productImageHeight').value = config.productImageHeight || '100';
                document.getElementById('productImagePosX').value = config.productImagePosX || '50';
                document.getElementById('productImagePosY').value = config.productImagePosY || '30';
                document.getElementById('productImageRotation').value = config.productImageRotation || '0';
                
                // Restaurar im√°genes adicionales
                if (config.additionalImages) {
            additionalImages = config.additionalImages;
            
            // Restaurar previews y botones
            for (let i = 1; i <= 3; i++) {
                if (additionalImages[`img${i}`]) {
                    const preview = document.getElementById(`previewImage${i}`);
                    const removeBtn = document.getElementById(`removeBtn${i}`);
                    
                    preview.src = additionalImages[`img${i}`];
                    preview.style.display = 'block';
                    
                    // ‚úÖ Mostrar bot√≥n de eliminar
                    if (removeBtn) {
                        removeBtn.style.display = 'inline-block';
                    }
                }
            }
        }
                
                document.getElementById('img1Width').value = config.img1Width || '50';
                document.getElementById('img1PosX').value = config.img1PosX || '10';
                document.getElementById('img1PosY').value = config.img1PosY || '80';
                document.getElementById('img1Rotation').value = config.img1Rotation || '0';
                document.getElementById('img2Width').value = config.img2Width || '50';
                document.getElementById('img2PosX').value = config.img2PosX || '90';
                document.getElementById('img2PosY').value = config.img2PosY || '80';
                document.getElementById('img2Rotation').value = config.img2Rotation || '0';
                document.getElementById('img3Width').value = config.img3Width || '80';
                document.getElementById('img3PosX').value = config.img3PosX || '50';
                document.getElementById('img3PosY').value = config.img3PosY || '90';
                document.getElementById('img3Rotation').value = config.img3Rotation || '0';
                
                // Restaurar indicaciones
                document.getElementById('showInstructions').checked = config.showInstructions !== undefined ? config.showInstructions : true;
                document.getElementById('instructionsSource').value = config.instructionsSource || 'default';
                document.getElementById('customInstructionsText').value = config.customInstructionsText || '';
                document.getElementById('instructionsFontSize').value = config.instructionsFontSize || '10';
                document.getElementById('instructionsColor').value = config.instructionsColor || '#000000';
                document.getElementById('instructionsRotation').value = config.instructionsRotation || '0';
                document.getElementById('instructionsPosX').value = config.instructionsPosX || '50';
                document.getElementById('instructionsPosY').value = config.instructionsPosY || '70';
                document.getElementById('instructionsWidth').value = config.instructionsWidth || '80';
                
                // Restaurar textos adicionales
                document.getElementById('additionalText1').value = config.additionalText1 || '';
                document.getElementById('text1FontSize').value = config.text1FontSize || '12';
                document.getElementById('text1Color').value = config.text1Color || '#8B4513';
                document.getElementById('text1PosX').value = config.text1PosX || '50';
                document.getElementById('text1PosY').value = config.text1PosY || '10';
                document.getElementById('text1Rotation').value = config.text1Rotation || '0';
                
                document.getElementById('additionalText2').value = config.additionalText2 || '';
                document.getElementById('text2FontSize').value = config.text2FontSize || '10';
                document.getElementById('text2Color').value = config.text2Color || '#DAA520';
                document.getElementById('text2PosX').value = config.text2PosX || '50';
                document.getElementById('text2PosY').value = config.text2PosY || '95';
                document.getElementById('text2Rotation').value = config.text2Rotation || '0';
                
                document.getElementById('additionalText3').value = config.additionalText3 || '';
                document.getElementById('text3FontSize').value = config.text3FontSize || '10';
                document.getElementById('text3Color').value = config.text3Color || '#000000';
                document.getElementById('text3PosX').value = config.text3PosX || '50';
                document.getElementById('text3PosY').value = config.text3PosY || '5';
                document.getElementById('text3Rotation').value = config.text3Rotation || '0';
                
                document.getElementById('selectedFont').value = config.selectedFont || 'Arial';
                
                // Restaurar fondo
                document.getElementById('backgroundType').value = config.backgroundType || 'none';
                document.getElementById('backgroundColor').value = config.backgroundColor || '#FFFFFF';
                document.getElementById('backgroundImageUrl').value = config.backgroundImageUrl || '';
                document.getElementById('backgroundOpacity').value = config.backgroundOpacity || '0.3';
                document.getElementById('patternType').value = config.patternType || 'dots';
                document.getElementById('patternColor').value = config.patternColor || '#8B4513';
                document.getElementById('patternOpacity').value = config.patternOpacity || '0.2';
                
                // Actualizar UI
                toggleCustomSize();
                toggleBackgroundOptions();
                toggleCustomInstructions();
                
                // Mostrar mensaje solo si hay configuraci√≥n v√°lida
                if (config.savedAt) {
                    showToast(`‚úÖ Configuraci√≥n cargada (guardada: ${new Date(config.savedAt).toLocaleString()})`, 'success');
                }
                
            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
                showToast('‚ùå Error al cargar la configuraci√≥n', 'error');
            }
        }

        function exportConfig() {
            const configStr = localStorage.getItem('etiquetaDTFConfig');
            if (!configStr) {
                showToast('‚ö†Ô∏è No hay configuraci√≥n guardada para exportar', 'error');
                return;
            }
            
            const config = JSON.parse(configStr);
            const dataStr = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `config_etiquetas_dtf_${Date.now()}.json`);
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            showToast('‚úÖ Configuraci√≥n exportada como archivo JSON', 'success');
        }

        function importConfig() {
            document.getElementById('configFileInput').click();
        }

        function handleConfigImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    
                    // Guardar en localStorage
                    localStorage.setItem('etiquetaDTFConfig', JSON.stringify(config));
                    
                    // Cargar la configuraci√≥n
                    loadConfig();
                    
                    showToast('‚úÖ Configuraci√≥n importada y aplicada', 'success');
                } catch (error) {
                    console.error('Error importando configuraci√≥n:', error);
                    showToast('‚ùå Error al importar el archivo de configuraci√≥n', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset input
        }


// Abrir vista previa grande al hacer clic en una etiqueta
function calculateProduction() {
    const previewGrid = document.getElementById('previewGrid');
    previewGrid.innerHTML = '';
    
    if (generatedLabels.length === 0) {
        previewGrid.innerHTML = '<p class="no-labels">‚ö†Ô∏è Genera etiquetas primero</p>';
        return;
    }
    
    // ‚úÖ Obtener dimensiones de la etiqueta
    const labelW = parseFloat(document.getElementById('labelWidth').value) || 5;
    const labelH = parseFloat(document.getElementById('labelHeight').value) || 5;
    
    // ‚úÖ Calcular dimensiones en p√≠xeles (300 DPI)
    const dpi = 300;
    const pxPerCm = dpi / 2.54;
    const labelWPx = Math.round(labelW * pxPerCm);
    const labelHPx = Math.round(labelH * pxPerCm);
    
    // ‚úÖ Calcular cu√°ntas etiquetas caben por fila
    const gridWidth = previewGrid.clientWidth;
    const labelsPerRow = Math.max(1, Math.floor(gridWidth / (labelWPx + 20)));
    
    // ‚úÖ Configurar el grid
    previewGrid.style.display = 'grid';
    previewGrid.style.gridTemplateColumns = `repeat(${labelsPerRow}, 1fr)`;
    previewGrid.style.gap = '15px';
    previewGrid.style.padding = '15px';
    previewGrid.style.backgroundColor = '#f8f9fa';
    previewGrid.style.overflow = 'auto';
    previewGrid.style.maxHeight = '600px';
    
    let totalLabels = 0;
    
    // ‚úÖ Generar cada etiqueta
    generatedLabels.forEach((labelData, index) => {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'preview-label';
        labelDiv.style.position = 'relative';
        labelDiv.style.boxSizing = 'border-box';
        labelDiv.style.border = '2px solid #e0e0e0';
        labelDiv.style.borderRadius = '4px';
        labelDiv.style.background = 'white';
        labelDiv.style.display = 'flex';
        labelDiv.style.flexDirection = 'column';
        labelDiv.style.alignItems = 'center';
        labelDiv.style.justifyContent = 'center';
        labelDiv.style.overflow = 'hidden';
        labelDiv.style.padding = '10px';
        labelDiv.style.aspectRatio = `${labelW}/${labelH}`;
        labelDiv.style.cursor = 'pointer';
        labelDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        labelDiv.style.transition = 'transform 0.2s, box-shadow 0.2s';
        
        // ‚úÖ Efecto hover
        labelDiv.addEventListener('mouseenter', () => {
            labelDiv.style.transform = 'scale(1.05)';
            labelDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        });
        
        labelDiv.addEventListener('mouseleave', () => {
            labelDiv.style.transform = 'scale(1)';
            labelDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        });
        
        // ‚úÖ Click para ver vista previa grande - CORREGIDO: openPreviewModal en lugar de openLargePreview
        labelDiv.addEventListener('click', () => {
            currentPreviewIndex = index;
            previewLabels = generatedLabels;
            openPreviewModal(); // ‚úÖ CORRECTO: openPreviewModal
        });
        
        // ‚úÖ Contenido de la etiqueta
        const contentDiv = document.createElement('div');
        contentDiv.style.width = '100%';
        contentDiv.style.height = '100%';
        contentDiv.style.display = 'flex';
        contentDiv.style.flexDirection = 'column';
        contentDiv.style.alignItems = 'center';
        contentDiv.style.justifyContent = 'center';
        contentDiv.style.textAlign = 'center';
        contentDiv.style.position = 'relative';
        
        // ‚úÖ Nombre del producto
        const nameDiv = document.createElement('div');
        nameDiv.style.fontWeight = 'bold';
        nameDiv.style.fontSize = '14px';
        nameDiv.style.color = document.getElementById('textColor').value;
        nameDiv.style.marginBottom = '5px';
        nameDiv.style.maxWidth = '90%';
        nameDiv.style.wordWrap = 'break-word';
        nameDiv.textContent = labelData.name;
        
        // ‚úÖ ID del producto
        const idDiv = document.createElement('div');
        idDiv.style.fontSize = '11px';
        idDiv.style.color = '#666';
        idDiv.textContent = `ID: ${labelData.productId || 'N/A'}`;
        
        // ‚úÖ Categor√≠a
        const categoryDiv = document.createElement('div');
        categoryDiv.style.fontSize = '10px';
        categoryDiv.style.color = '#888';
        categoryDiv.style.marginTop = '3px';
        categoryDiv.textContent = labelData.product?.categoria || 'Sin categor√≠a';
        
        // ‚úÖ Badge con dimensiones
        const sizeBadge = document.createElement('div');
        sizeBadge.style.position = 'absolute';
        sizeBadge.style.bottom = '5px';
        sizeBadge.style.right = '5px';
        sizeBadge.style.background = 'rgba(0,0,0,0.7)';
        sizeBadge.style.color = 'white';
        sizeBadge.style.fontSize = '9px';
        sizeBadge.style.padding = '2px 5px';
        sizeBadge.style.borderRadius = '3px';
        sizeBadge.textContent = `${labelW}x${labelH} cm`;
        
        contentDiv.appendChild(nameDiv);
        contentDiv.appendChild(idDiv);
        contentDiv.appendChild(categoryDiv);
        contentDiv.appendChild(sizeBadge);
        
        labelDiv.appendChild(contentDiv);
        previewGrid.appendChild(labelDiv);
        totalLabels++;
    });
    
    // ‚úÖ Mostrar resumen
    const summaryDiv = document.createElement('div');
    summaryDiv.style.gridColumn = '1 / -1';
    summaryDiv.style.padding = '15px';
    summaryDiv.style.backgroundColor = '#e8f5e9';
    summaryDiv.style.borderRadius = '8px';
    summaryDiv.style.marginBottom = '15px';
    summaryDiv.style.textAlign = 'center';
    summaryDiv.innerHTML = `
        <strong>üìä Resumen de Producci√≥n</strong><br>
        Total: ${totalLabels} etiquetas<br>
        Grid: ${labelsPerRow} columnas x ${Math.ceil(totalLabels / labelsPerRow)} filas<br>
        Dimensiones: ${labelW}x${labelH} cm (${labelWPx}x${labelHPx} px)
    `;
    
    previewGrid.insertBefore(summaryDiv, previewGrid.firstChild);
    
    showToast(`‚úÖ Vista previa generada: ${totalLabels} etiquetas en grid de ${labelsPerRow} columnas`, 'success');
}

// Cerrar modal
function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }, 300);
}

// Renderizar vista previa grande
// Renderizar vista previa grande
function renderLargePreview() {
    if (currentPreviewIndex < 0 || currentPreviewIndex >= previewLabels.length) return;
    
    const labelData = previewLabels[currentPreviewIndex];
    const labelDiv = document.createElement('div');
    
    // ‚úÖ Obtener dimensiones ACTUALES del formulario
    const labelWidth = parseFloat(document.getElementById('labelWidth').value) || 5;
    const labelHeight = parseFloat(document.getElementById('labelHeight').value) || 5;
    
    // ‚úÖ Calcular dimensiones en p√≠xeles (300 DPI)
    const dpi = 300;
    const pxPerCm = dpi / 2.54;
    const labelWidthPx = Math.round(labelWidth * pxPerCm);
    const labelHeightPx = Math.round(labelHeight * pxPerCm);
    
    // ‚úÖ Obtener configuraci√≥n actual
    const fontSize = document.getElementById('fontSize').value;
    const fontRotation = document.getElementById('fontRotation').value;
    const fontPosX = document.getElementById('fontPosX').value;
    const fontPosY = document.getElementById('fontPosY').value;
    const priceFormat = document.getElementById('priceFormat').value;
    const transparentBg = document.getElementById('transparentBg').checked;
    const mirrorEffect = document.getElementById('mirrorEffect').checked;
    const shape = document.querySelector('input[name="labelShape"]:checked').value;
    const showProductImage = document.getElementById('showProductImage').checked;
    const showInstructions = document.getElementById('showInstructions').checked;
    const selectedFont = document.getElementById('selectedFont').value;
    const backgroundType = document.getElementById('backgroundType').value;
    
    // ‚úÖ Aplicar dimensiones CORRECTAS
    labelDiv.style.width = `${labelWidthPx}px`;
    labelDiv.style.height = `${labelHeightPx}px`;
    labelDiv.className = `label-preview ${transparentBg ? 'dtf-transparent' : ''} clickable`;
    labelDiv.style.cursor = 'pointer';
    labelDiv.style.borderColor = document.getElementById('borderColor').value;
    labelDiv.style.borderWidth = '4px';
    labelDiv.style.fontFamily = selectedFont;
    
    if (shape === 'rounded') {
        labelDiv.style.borderRadius = '20px';
    } else if (shape === 'circle') {
        labelDiv.style.borderRadius = '50%';
    } else {
        labelDiv.style.borderRadius = '0';
    }
    
    if (mirrorEffect) {
        labelDiv.style.transform = 'scaleX(-1)';
    }
    
    // ‚úÖ Aplicar fondo
    if (backgroundType === 'color') {
        labelDiv.style.backgroundColor = document.getElementById('backgroundColor').value;
    } else if (backgroundType === 'image') {
        const bgUrl = document.getElementById('backgroundImageUrl').value || document.getElementById('previewBackground').src;
        if (bgUrl) {
            labelDiv.style.backgroundImage = `url(${bgUrl})`;
            labelDiv.style.backgroundSize = 'cover';
            labelDiv.style.backgroundPosition = 'center';
            labelDiv.style.opacity = document.getElementById('backgroundOpacity').value;
        }
    }
    
    let html = '<div class="label-content" style="position: relative; width: 100%; height: 100%;">';
    
    // ‚úÖ Imagen del producto
    if (showProductImage && labelData.product && labelData.product.imagen) {
        const imgWidth = document.getElementById('productImageWidth').value;
        const imgHeight = document.getElementById('productImageHeight').value;
        const imgPosX = document.getElementById('productImagePosX').value;
        const imgPosY = document.getElementById('productImagePosY').value;
        const imgRotation = document.getElementById('productImageRotation').value;
        
        html += `
        <img src="${labelData.product.imagen.trim()}"
            class="product-image"
            style="position: absolute;
                width: ${imgWidth}px;
                height: ${imgHeight}px;
                left: calc(${imgPosX}% - ${imgWidth/2}px);
                top: calc(${imgPosY}% - ${imgHeight/2}px);
                transform: rotate(${imgRotation}deg);
                object-fit: contain;"
            onerror="this.style.display='none'">
        `;
    }
    
    // ‚úÖ Im√°genes adicionales
    for (let i = 1; i <= 3; i++) {
        const imgSrc = additionalImages[`img${i}`];
        if (imgSrc) {
            const imgWidth = document.getElementById(`img${i}Width`).value;
            const imgPosX = document.getElementById(`img${i}PosX`).value;
            const imgPosY = document.getElementById(`img${i}PosY`).value;
            const imgRotation = document.getElementById(`img${i}Rotation`).value;
            
            html += `
            <img src="${imgSrc}"
                style="position: absolute;
                    width: ${imgWidth}px;
                    left: calc(${imgPosX}% - ${imgWidth/2}px);
                    top: calc(${imgPosY}% - ${imgWidth/2}px);
                    transform: rotate(${imgRotation}deg);
                    object-fit: contain;"
                onerror="this.style.display='none'">
            `;
        }
    }
    
    // ‚úÖ Nombre del producto
    html += `
    <div class="label-name"
        style="position: absolute;
            left: calc(${fontPosX}% - 50%);
            top: calc(${fontPosY}% - 50%);
            transform: translate(-50%, -50%) rotate(${fontRotation}deg);
            font-size: ${fontSize}px;
            color: ${document.getElementById('textColor').value};
            text-align: center;
            width: 90%;
            font-weight: bold;">
        ${labelData.name}
    </div>
    `;
    
    // ‚úÖ Precio
    html += `
    <div class="label-price"
        style="position: absolute;
            left: 50%;
            top: 65%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 90%;
            font-weight: bold;
            color: ${document.getElementById('borderColor').value};">
        ${priceFormat}
    </div>
    `;
    
    // ‚úÖ Indicaciones
if (showInstructions && indicacionesJSON && indicacionesJSON.current) {
    const instFontSize = document.getElementById('instructionsFontSize').value;
    const instColor = document.getElementById('instructionsColor').value;
    const instRotation = document.getElementById('instructionsRotation').value;
    const instPosX = document.getElementById('instructionsPosX').value;
    const instPosY = document.getElementById('instructionsPosY').value;
    const instWidth = document.getElementById('instructionsWidth').value;
    
    const current = indicacionesJSON.current;
    let indicacionesText = '';
    
    if (current.indicaciones && current.indicaciones.length > 0) {
        indicacionesText += current.indicaciones.join('<br>');
    }
    
    if (current.advertencias && current.advertencias.length > 0) {
        indicacionesText += '<br><br><strong>Advertencias:</strong><br>';
        indicacionesText += current.advertencias.join('<br>');
    }
    
    if (indicacionesText) {
        html += `
        <div style="position: absolute;
            left: calc(${instPosX}% - ${instWidth/2}%);
            top: calc(${instPosY}% - 50%);
            width: ${instWidth}%;
            font-size: ${instFontSize}px;
            color: ${instColor};
            transform: rotate(${instRotation}deg);
            text-align: left;
            line-height: 1.4;
            background-color: white;
            padding: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            ${indicacionesText}
        </div>
        `;
    }
}
    
    // ‚úÖ Textos adicionales
    for (let i = 1; i <= 3; i++) {
        const text = document.getElementById(`additionalText${i}`).value;
        if (text) {
            const textFontSize = document.getElementById(`text${i}FontSize`).value;
            const textColor = document.getElementById(`text${i}Color`).value;
            const textPosX = document.getElementById(`text${i}PosX`).value;
            const textPosY = document.getElementById(`text${i}PosY`).value;
            const textRotation = document.getElementById(`text${i}Rotation`).value;
            
            html += `
            <div style="position: absolute;
                left: calc(${textPosX}% - 50%);
                top: calc(${textPosY}% - 50%);
                transform: rotate(${textRotation}deg);
                font-size: ${textFontSize}px;
                color: ${textColor};
                text-align: center;
                font-weight: ${i === 1 ? 'bold' : 'normal'};">
                ${text}
            </div>
            `;
        }
    }
    
    html += '</div>';
    labelDiv.innerHTML = html;
    
    // ‚úÖ Insertar en contenedor
    const container = document.getElementById('largePreviewContainer');
    container.innerHTML = '';
    container.appendChild(labelDiv);
    
    // ‚úÖ Actualizar informaci√≥n
    document.getElementById('modalLabelIndex').textContent = `${currentPreviewIndex + 1} de ${previewLabels.length}`;
    document.getElementById('modalProductName').textContent = labelData.name;
    document.getElementById('modalProductId').textContent = labelData.productId || 'N/A';
    document.getElementById('modalProductCategory').textContent = (labelData.product && labelData.product.categoria) || 'Sin categor√≠a';
    
    // ‚úÖ Mostrar dimensiones CORRECTAS
    document.getElementById('modalLabelSize').textContent = `${labelWidth} x ${labelHeight} cm (${labelWidthPx} x ${labelHeightPx} px)`;
}
// Navegar a etiqueta anterior
function prevLabel() {
    if (currentPreviewIndex > 0) {
        currentPreviewIndex--;
        renderLargePreview();
    } else {
        showToast('‚ö†Ô∏è Primera etiqueta', 'warning');
    }
}

// Navegar a siguiente etiqueta
function nextLabel() {
    if (currentPreviewIndex < previewLabels.length - 1) {
        currentPreviewIndex++;
        renderLargePreview();
    } else {
        showToast('‚ö†Ô∏è √öltima etiqueta', 'warning');
    }
}

// Descargar etiqueta individual como PNG
function downloadLabel() {
    if (currentPreviewIndex < 0) return;
    
    const labelData = previewLabels[currentPreviewIndex];
    showToast(`üíæ Descargando etiqueta: ${labelData.name}`, 'success');
    
    // Aqu√≠ podr√≠as implementar el c√≥digo para convertir el canvas a PNG
    // Por ahora solo muestra mensaje
    setTimeout(() => {
        showToast('‚úÖ Etiqueta lista para descargar', 'success');
    }, 800);
}

// Imprimir etiqueta individual
function printLabel() {
    if (currentPreviewIndex < 0) return;
    
    const labelData = previewLabels[currentPreviewIndex];
    showToast(`üñ®Ô∏è Imprimiendo: ${labelData.name}`, 'success');
    window.print();
}

// Evento para cerrar modal con ESC
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closePreviewModal();
    }
});

// Evento para cerrar modal al hacer clic fuera del contenido
document.addEventListener('click', (e) => {
    const modal = document.getElementById('previewModal');
    if (e.target === modal) {
        closePreviewModal();
    }
});

function loadInstructions() {
    const source = document.getElementById('instructionsSource').value;
    
    // ‚úÖ Si es un tipo espec√≠fico de instrucci√≥n (Aromaterapia, Masajes, etc.)
    if (source !== 'default' && source !== 'custom') {
        try {
            const response = fetch('https://wil1979.github.io/esentia-factura/indicaciones.json');
            response.then(res => res.json()).then(data => {
                if (Array.isArray(data)) {
                    indicacionesJSON = data;
                    
                    // ‚úÖ Buscar el tipo seleccionado
                    const selected = data.find(item => 
                        item.tipo.toLowerCase() === source.toLowerCase()
                    );
                    
                    if (selected) {
                        indicacionesJSON.current = selected;
                        showToast(`‚úÖ Indicaciones "${source}" cargadas`, 'success');
                    } else {
                        indicacionesJSON.current = data[0];
                        showToast(`‚ö†Ô∏è Tipo "${source}" no encontrado, usando predeterminado`, 'warning');
                    }
                    
                    mostrarPreviewIndicaciones();
                    previewChanges();
                    // ‚úÖ Cargar tipos en el dropdown
                    cargarTiposEnDropdown();
                }
            });
        } catch (error) {
            console.error('Error cargando indicaciones:', error);
            showToast('‚ùå Error al cargar indicaciones', 'error');
        }
        return;
    }
    
    // ‚úÖ Si es "default" o "custom"
    if (source === 'default') {
        try {
            const response = fetch('https://wil1971979.github.io/esentia-factura/indicaciones.json');
            response.then(res => res.json()).then(data => {
                if (Array.isArray(data)) {
                    indicacionesJSON = data;
                    indicacionesJSON.current = data[0]; // Primer elemento por defecto
                    showToast('‚úÖ Indicaciones cargadas desde JSON', 'success');
                } else {
                    indicacionesJSON = data;
                    showToast('‚úÖ Indicaciones cargadas (formato antiguo)', 'success');
                }
                
                mostrarPreviewIndicaciones();
                previewChanges();
            });
        } catch (error) {
            console.error('Error cargando indicaciones:', error);
            // Indicaciones por defecto
            indicacionesJSON = [{
                "tipo": "Aromaterapia",
                "titulo": "Indicaciones de uso",
                "indicaciones": [
                    "- Agregar de 5 a 10 gotas en un difusor con agua.",
                    "- Utilizar en espacios ventilados.",
                    "- Ideal para sesiones de relajaci√≥n o meditaci√≥n."
                ],
                "advertencias": [
                    "‚úñ No ingerir.",
                    "‚úñ Evitar contacto directo con los ojos.",
                    "‚úñ Mantener fuera del alcance de los ni√±os y mascotas."
                ]
            }];
            indicacionesJSON.current = indicacionesJSON[0];
            showToast('‚ö†Ô∏è Usando indicaciones predeterminadas', 'warning');
        }
    }
    
    // ‚úÖ Mostrar/ocultar campo personalizado
    document.getElementById('customInstructions').style.display = 
        source === 'custom' ? 'block' : 'none';
}


function cargarTipoInstruccion() {
    const tipoSeleccionado = document.getElementById('instructionsSource').value;
    
    if (!tipoSeleccionado || !indicacionesJSON) {
        return;
    }
    
    // ‚úÖ Buscar el tipo en el JSON
    const encontrada = indicacionesJSON.find(item => 
        item.tipo === tipoSeleccionado
    );
    
    if (encontrada) {
        indicacionesJSON.current = encontrada.info;
        indicacionesJSON.currentTipo = tipoSeleccionado;
        mostrarPreviewIndicaciones();
        previewChanges();
        showToast(`‚úÖ Instrucciones "${tipoSeleccionado}" cargadas`, 'success');
    } else {
        showToast('‚ö†Ô∏è Tipo no encontrado', 'warning');
    }
}

/*function seleccionarInstruccion() {
    const tipoSeleccionado = document.getElementById("tipoInstruccion").value;

    const encontrada = indicacionesJSON.find(item =>
        item.tipo.toLowerCase() === tipoSeleccionado.toLowerCase()
    );

    if (encontrada) {
        indicacionesJSON.current = encontrada;

        mostrarPreviewIndicaciones(); // preview lateral
        previewChanges(); // regenerar etiqueta real
    }
}

*/

    </script>
<!-- Modal de Vista Previa Grande -->
<div id="previewModal" class="modal-preview" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üëÅÔ∏è Vista Previa Grande - Etiqueta <span id="modalLabelIndex"></span></h3>
            <span class="close-modal" onclick="closePreviewModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="largePreviewContainer" class="large-preview-container">
                <!-- La etiqueta grande se insertar√° aqu√≠ -->
            </div>
            <div class="label-info">
                <div class="info-row">
                    <strong>Producto:</strong>
                    <span id="modalProductName"></span>
                </div>
                <div class="info-row">
                    <strong>ID:</strong>
                    <span id="modalProductId"></span>
                </div>
                <div class="info-row">
                    <strong>Categor√≠a:</strong>
                    <span id="modalProductCategory"></span>
                </div>
                <div class="info-row">
                    <strong>Tama√±o:</strong>
                    <span id="modalLabelSize"></span>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="prevLabel()">
                ‚Üê Anterior
            </button>
            <button class="btn btn-secondary" onclick="downloadLabel()">
                üíæ Descargar PNG
            </button>
            <button class="btn btn-secondary" onclick="printLabel()">
                üñ®Ô∏è Imprimir
            </button>
            <button class="btn btn-secondary" onclick="nextLabel()">
                Siguiente ‚Üí
            </button>
        </div>
    </div>
</div>

</body>
</html>
