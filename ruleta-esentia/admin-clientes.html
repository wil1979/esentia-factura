<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>üë• Clientes - Esentia</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f5f7fa;
  padding: 16px;
}
h2 {
  text-align:center;
  color:#6c4ba3;
}
input, button {
  width:100%;
  max-width:420px;
  padding:10px;
  margin:6px auto;
  display:block;
  border-radius:8px;
  border:1px solid #ccc;
}
button {
  background:#6c4ba3;
  color:#fff;
  border:none;
}
button.secondary {
  background:#607d8b;
}
table {
  width:100%;
  border-collapse:collapse;
  background:#fff;
  margin-top:16px;
}
th, td {
  padding:10px;
  border-bottom:1px solid #eee;
  font-size:0.9rem;
}
th {
  background:#6c4ba3;
  color:#fff;
}
.badge {
  padding:4px 8px;
  border-radius:6px;
  font-size:0.75rem;
  font-weight:600;
}
.ok { background:#e8f5e9; color:#2e7d32; }
.dup { background:#fff3e0; color:#ef6c00; }

.modal {
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  align-items:center;
  justify-content:center;
}
.modal-content {
  background:#fff;
  padding:16px;
  border-radius:12px;
  width:90%;
  max-width:420px;
}
</style>
</head>

<body>

<h2>üë• Clientes</h2>

<input id="buscador" placeholder="Buscar por nombre o c√©dula‚Ä¶">
<button id="btnNuevo">‚ûï Nuevo cliente</button>

<table>
<thead>
<tr>
  <th>Nombre</th>
  <th>C√©dula</th>
  <th>Tel√©fono</th>
  <th>Compras</th>
  <th>Estado</th>
</tr>
</thead>
<tbody id="tabla"></tbody>
</table>

<!-- MODAL NUEVO CLIENTE -->
<div class="modal" id="modal">
  <div class="modal-content">
    <h3>‚ûï Nuevo cliente</h3>
    <input id="cedula" placeholder="C√©dula">
    <input id="nombre" placeholder="Nombre">
    <input id="telefono" placeholder="Tel√©fono">
    <button id="guardar">Guardar</button>
    <button class="secondary" id="cerrar">Cancelar</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

/* ================= FIREBASE ================= */
const firebaseConfig = {
  apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
  authDomain: "esentiacreditos-8345f.firebaseapp.com",
  projectId: "esentiacreditos-8345f",
  storageBucket: "esentiacreditos-8345f.firebasestorage.app",
  messagingSenderId: "888658236080",
  appId: "1:888658236080:web:506e5e2085b5a452dba175"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= ESTADO ================= */
const tbody = document.getElementById("tabla");
const buscador = document.getElementById("buscador");
const modal = document.getElementById("modal");

let clientes = [];
let personal = [];
let duplicados = new Set();

/* ================= PERSONAL.JSON ================= */
async function cargarPersonal() {
  const res = await fetch("personal.json");
  const data = await res.json();
  personal = Array.isArray(data) ? data : [data];
}

/* ================= DETECTAR DUPLICADOS ================= */
function detectarDuplicados(lista) {
  duplicados.clear();
  const conteo = {};

  lista.forEach(c => {
    if (!c.cedula) return;
    conteo[c.cedula] = (conteo[c.cedula] || 0) + 1;
  });

  Object.keys(conteo).forEach(c => {
    if (conteo[c] > 1) duplicados.add(c);
  });
}

/* ================= RENDER ================= */
function render(lista) {
  tbody.innerHTML = "";

  if (!lista.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Sin resultados</td></tr>`;
    return;
  }

  lista.forEach(c => {
    const esDup = c.cedula && duplicados.has(c.cedula);
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${c.nombre || "‚Äî"}</td>
      <td>${c.cedula || "‚Äî"}</td>
      <td>${c.telefono || "‚Äî"}</td>
      <td>${(c.compras || []).length}</td>
      <td>
        <span class="badge ${esDup ? "dup" : "ok"}">
          ${esDup ? "‚ö†Ô∏è Duplicado" : "OK"}
        </span>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

/* ================= FIRESTORE ================= */
async function cargarClientes() {
  const snap = await getDocs(collection(db, "clientes"));
  clientes = [];

  snap.forEach(d => clientes.push(d.data()));

  detectarDuplicados(clientes);
  render(clientes);
}

/* ================= BUSCADOR ================= */
buscador.addEventListener("input", () => {
  const f = buscador.value.toLowerCase();
  render(
    clientes.filter(c =>
      (c.nombre || "").toLowerCase().includes(f) ||
      (c.cedula || "").toString().includes(f)
    )
  );
});

/* ================= NUEVO CLIENTE ================= */
document.getElementById("btnNuevo").onclick = () => modal.style.display = "flex";
document.getElementById("cerrar").onclick = () => modal.style.display = "none";

document.getElementById("cedula").addEventListener("input", e => {
  const p = personal.find(x => x.cedula == e.target.value);
  if (p) {
    document.getElementById("nombre").value = p.nombre || "";
    document.getElementById("telefono").value = p.telefono || "";
  }
});

document.getElementById("guardar").onclick = async () => {
  const cedula = document.getElementById("cedula").value.trim();
  const nombre = document.getElementById("nombre").value.trim();
  const telefono = document.getElementById("telefono").value.trim();

  if (!nombre) {
    alert("Nombre obligatorio");
    return;
  }

  await addDoc(collection(db, "clientes"), {
    cedula,
    nombre,
    telefono,
    compras: [],
    yaParticipo: false,
    createdAt: new Date().toISOString()
  });

  modal.style.display = "none";
  document.getElementById("cedula").value = "";
  document.getElementById("nombre").value = "";
  document.getElementById("telefono").value = "";

  cargarClientes();
};

/* ================= INIT ================= */
await cargarPersonal();
await cargarClientes();
</script>

</body>
</html>