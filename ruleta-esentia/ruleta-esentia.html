<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ruleta Esentia üéÅ</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f8f9fa;
    }

    .modal {
      display: flex;
      justify-content: center;
      align-items: center;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.88);
      z-index: 1000;
    }

    header {
      position: relative;
      padding-right: 160px;
      box-sizing: border-box;
      text-align: center;
      margin-bottom: 20px;
    }

    .logo {
      max-width: 120px;
      margin-bottom: 10px;
    }

    .titulo {
      color: white;
      text-align: center;
      margin-bottom: 15px;
      font-size: 28px;
      font-weight: bold;
      text-shadow: 0 3px 5px rgba(0,0,0,0.5);
    }

    #mensaje-bienvenida {
      color: #ffd166;
      font-size: 1.1rem;
      margin: 10px 0;
      min-height: 24px;
      text-align: center;
    }

    .resultado {
      margin-top: 25px;
      font-size: 19px;
      font-weight: bold;
      color: white;
      text-align: center;
      min-height: 60px;
      line-height: 1.4;
    }

    .codigo {
      background: rgba(0,0,0,0.4);
      padding: 8px 12px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 15px;
      margin-top: 10px;
      display: inline-block;
    }

    .premios-lista {
      width: 300px;
      margin: 20px auto;
      padding: 0;
      list-style: none;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }

    .premio-item {
      padding: 12px 15px;
      margin-bottom: 1px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-weight: 600;
      text-align: left;
      transition: background 0.1s ease-in-out, transform 0.1s ease-in-out;
      border-left: 5px solid transparent;
    }

    .premio-item.highlight {
      background: #e63946;
      transform: scale(1.05);
      border-left: 5px solid #fff;
      box-shadow: 0 0 10px rgba(230, 57, 70, 0.8);
    }

    #girar-btn {
      margin-top: 25px;
      padding: 13px 26px;
      font-size: 18px;
      background: #e63946;
      color: white;
      border: none;
      border-radius: 40px;
      cursor: pointer;
      transition: background 0.3s;
      font-weight: bold;
      box-shadow: 0 3px 10px rgba(0,0,0,0.3);
    }

    #girar-btn:hover:not(:disabled) {
      background: #d90429;
    }

    #girar-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* Panel de usuario */
    #panelUsuario {
      display: none;
      position: absolute;
      top: 12px;
      right: 15px;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 24px;
      padding: 6px 12px;
      color: white;
      font-size: 0.95rem;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #panelUsuario button {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 1.2rem;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Modal Login Glass */
    .modal-login {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-login-contenido {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 25px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      color: white;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      font-family: 'Segoe UI', sans-serif;
    }
    .btn-tab {
      flex: 1;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-tab.activo {
      background: #6c4ba3;
      border-color: #6c4ba3;
    }
  </style>
</head>
<body>
  <header>
    <div id="panelUsuario">
      <span id="nombreUsuario"></span>
      <button onclick="cerrarSesion()">&times;</button>
    </div>
  </header>

  <div class="modal">
    <div style="text-align: center; color: white; max-width: 90%;">
      <div class="titulo">üéÅ Ruleta Esentia</div>
      
      <div id="mensaje-bienvenida"></div>

      <ul id="premiosLista" class="premios-lista"></ul>

      <button id="girar-btn">¬°Girar por tu premio!</button>
      <div id="resultado" class="resultado"></div>

      <div style="margin-top: 15px; font-size: 14px; color: #bbb;">
        Por tu compra de ‚Ç°10,000 o m√°s en Esentia, tienes la oportunidad de ganar premios exclusivos.  

        ¬°Gira la ruleta y descubre tu premio! üéâ
      </div>
    </div>
  </div>

  <div id="modalLoginRegistro" class="modal-login">
    <div class="modal-login-contenido">
      <h2 style="text-align:center; margin-top:0; color:#6c4ba3;">üë§ Bienvenido a Esentia</h2>
      <p style="text-align:center; margin-bottom:20px; color:#ddd;">
        Inicia sesi√≥n para participar
      </p>

      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button class="btn-tab activo" data-tab="login">Iniciar sesi√≥n</button>
      </div>

      <form id="formLogin">
        <input type="text" id="loginCedulaTel" placeholder="C√©dula o Tel√©fono" required
          style="width: 93%; padding:12px; margin:8px 0; border:1px solid rgba(255,255,255,0.3); border-radius:8px; background:rgba(255,255,255,0.9);">
        <button type="submit" style="width:100%; padding:12px; background:#6c4ba3; color:white; border:none; border-radius:8px; margin-top:10px;">
          Entrar
        </button>
      </form>

      <div id="loginMensaje" style="margin-top:15px; min-height:20px; text-align:center; font-size:0.9rem; color:#ffcccb;"></div>
    </div>
  </div>

  <div id="modalActualizar" class="modal-login" style="display:none; z-index: 2001;">
    <div class="modal-login-contenido" style="max-width: 420px;">
      <h2 style="text-align:center; margin-top:0; color:#6c4ba3;">üìù Completar Informaci√≥n</h2>
      <p style="text-align:center; margin-bottom:15px; color:#ddd;">
        Necesitamos algunos datos para validar tu participaci√≥n
      </p>

      <div style="margin-bottom:15px;">
        <label for="updNombre" style="display:block; margin-bottom:6px; font-weight:bold;">Nombre *</label>
        <input type="text" id="updNombre" placeholder="Nombre completo" required
          style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.9);">
        <small id="nombre-desde-api" style="color:#4CAF50; display:block; margin-top:5px;"></small>
      </div>

      <div style="margin-bottom:15px;">
        <label for="updCedula" style="display:block; margin-bottom:6px; font-weight:bold;">C√©dula (opcional)</label>
        <input type="text" id="updCedula" placeholder="C√©dula"
          style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.9);">
      </div>

      <div style="margin-bottom:15px;">
        <label for="updTelefono" style="display:block; margin-bottom:6px; font-weight:bold;">Tel√©fono *</label>
        <input type="text" id="updTelefono" placeholder="Tel√©fono" required
          style="width:100%; padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.9);">
      </div>

      <div style="text-align:center; margin-top:10px; font-size:0.85rem; color:#ffcccb;">
        * Nombre y Tel√©fono son obligatorios
      </div>

      <div style="display:flex; gap:10px; margin-top:20px;">
        <button class="btn-tab" onclick="cerrarModalActualizar()" style="flex:1; background:#666;">Cancelar</button>
        <button class="btn-tab" onclick="guardarActualizacion()" style="flex:1; background:#4CAF50;">‚úÖ Guardar y Continuar</button>
      </div>
    </div>
  </div>

  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, doc, getDoc, updateDoc, collection,
      query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const app = initializeApp(firebaseConfig );
    const db = getFirestore(app);
    const URL_PREMIOS = "https://wil1979.github.io/esentia-factura/premios.json?t=" + Date.now( );

    let clienteAutenticado = null;
    let premiosConProbabilidad = [];
    let yaGiro = false;

    async function cargarConfiguracionPremios() {
      try {
        const res = await fetch(URL_PREMIOS);
        if (res.ok) {
          const data = await res.json();
          if (data.activo) {
            premiosConProbabilidad = data.premios;
            return;
          }
        }
      } catch (err) {
        console.warn("Error cargando premios.json. Usando valores por defecto.");
      }
      premiosConProbabilidad = [
        { nombre: "M√°s suerte la pr√≥xima vez", prob: 50 },
        { nombre: "5% de descuento", prob: 30 },
        { nombre: "10% de descuento", prob: 15 },
        { nombre: "50% de descuento", prob: 3 },
        { nombre: "Difusor de Auto", prob: 2 }
      ];
    }

    async function consultarNombreDesdeCedula(cedula) {
      const cedLimpia = cedula.toString().replace(/\D/g, '');
      if (cedLimpia.length < 9) return null;
      try {
        const res = await fetch(`https://api.hacienda.go.cr/fe/ae?identificacion=${cedLimpia}` );
        if (!res.ok) return null;
        const data = await res.json();
        return data.nombre || data.nombre_completo || null;
      } catch (err) {
        return null;
      }
    }

    // --- L√ìGICA DE VALIDACI√ìN REFORZADA ---
    function necesitaActualizarDatos(data) {
      // Un nombre v√°lido debe existir y tener m√°s de 2 caracteres.
      const nombreValido = data && data.nombre && data.nombre.trim().length > 2;
      // Un tel√©fono v√°lido debe existir y tener 8 d√≠gitos.
      const telefonoValido = data && data.telefono && data.telefono.toString().replace(/\D/g, '').length === 8;
      
      // Si falta CUALQUIERA de los dos, necesita actualizar.
      return !nombreValido || !telefonoValido;
    }

    function abrirModalActualizar(data, clienteRef) {
      document.getElementById("updNombre").value = data.nombre || "";
      document.getElementById("updCedula").value = data.cedula || "";
      document.getElementById("updTelefono").value = data.telefono || "";
      document.getElementById("nombre-desde-api").textContent = "";
      window.tempClienteRef = clienteRef;
      document.getElementById("modalActualizar").style.display = "flex";
      return new Promise((resolve, reject) => {
        window.resolveActualizar = resolve;
        window.rejectActualizar = reject;
      });
    }

    function cerrarModalActualizar() {
      document.getElementById("modalActualizar").style.display = "none";
      if (window.rejectActualizar) {
        window.rejectActualizar(new Error("Actualizaci√≥n cancelada. Inicia sesi√≥n de nuevo."));
      }
    }

    document.getElementById("updCedula")?.addEventListener("blur", async () => {
      const cedulaInput = document.getElementById("updCedula");
      const nombreInput = document.getElementById("updNombre");
      const msg = document.getElementById("nombre-desde-api");
      const cedula = cedulaInput.value.trim();
      
      if (!cedula) return;
      
      msg.textContent = "Buscando en Hacienda...";
      msg.style.color = "#ffd166";
      const nombre = await consultarNombreDesdeCedula(cedula);
      
      if (nombre) {
        nombreInput.value = nombre;
        msg.textContent = `‚úÖ Nombre encontrado: ${nombre}`;
        msg.style.color = "#4CAF50";
      } else {
        msg.textContent = "‚ö†Ô∏è C√©dula no encontrada en Hacienda.";
        msg.style.color = "#d32f2f";
      }
    });

    async function guardarActualizacion() {
      const nombre = document.getElementById("updNombre").value.trim();
      const cedula = document.getElementById("updCedula").value.trim();
      const telefono = document.getElementById("updTelefono").value.trim();

      if (!nombre || nombre.length < 3) {
        alert("‚ö†Ô∏è El nombre es obligatorio y debe tener al menos 3 caracteres.");
        return;
      }

      const telLimpio = telefono.replace(/\D/g, '');
      if (telLimpio.length !== 8) {
        alert("‚ö†Ô∏è El tel√©fono debe tener 8 d√≠gitos.");
        return;
      }

      try {
        const cedLimpia = cedula ? cedula.replace(/\D/g, '') : null;

        await updateDoc(window.tempClienteRef, {
          nombre: nombre,
          cedula: cedLimpia,
          telefono: telLimpio
        });

        const clienteActualizado = {
          ...clienteAutenticado,
          nombre: nombre,
          cedula: cedLimpia,
          telefono: telLimpio
        };
        
        clienteAutenticado = clienteActualizado;

        document.getElementById("nombreUsuario").textContent = nombre;
        document.getElementById("mensaje-bienvenida").textContent = `¬°Hola, ${nombre}! Bienvenido a la Ruleta Esentia üåø`;
        document.getElementById("modalActualizar").style.display = "none";
        
        if (window.resolveActualizar) {
            window.resolveActualizar(clienteActualizado);
        }

      } catch (err) {
        console.error("Error al guardar:", err);
        alert("‚ùå Error al actualizar los datos.");
        if (window.rejectActualizar) {
            window.rejectActualizar(err);
        }
      }
    }

    function cerrarSesion() {
      clienteAutenticado = null;
      document.getElementById("panelUsuario").style.display = "none";
      document.getElementById("mensaje-bienvenida").textContent = "";
      document.getElementById("modalLoginRegistro").style.display = "flex";
      document.getElementById("loginCedulaTel").value = "";
      document.getElementById("loginMensaje").textContent = "";
      yaGiro = false;
      document.getElementById("girar-btn").disabled = false;
      document.getElementById("resultado").innerHTML = "";
      document.querySelectorAll(".premio-item").forEach(i => i.classList.remove("highlight"));
    }

    // --- L√ìGICA DE LOGIN REFORZADA ---
    document.getElementById("formLogin")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const valor = document.getElementById("loginCedulaTel").value.trim();
      const msg = document.getElementById("loginMensaje");
      if (!valor) {
        msg.textContent = "Ingresa c√©dula o tel√©fono.";
        return;
      }

      msg.textContent = "Buscando cliente...";
      try {
        const col = collection(db, "clientes");
        const q1 = query(col, where("cedula", "==", valor));
        const q2 = query(col, where("telefono", "==", valor));
        const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
        
        let docSnap = null;
        if (!snap1.empty) docSnap = snap1.docs[0];
        else if (!snap2.empty) docSnap = snap2.docs[0];
        
        if (!docSnap) { 
            msg.textContent = "Cliente no registrado."; 
            return; 
        }

        let data = docSnap.data();
        clienteAutenticado = { id: docSnap.id, ...data };
        
        // FORZAR LA VALIDACI√ìN SIEMPRE DESPU√âS DEL LOGIN
        if (necesitaActualizarDatos(data)) {
            msg.textContent = "Datos incompletos. Por favor, actualiza tu informaci√≥n.";
            try {
                // Abrimos el modal y esperamos a que se resuelva (guarde o cancele)
                const clienteActualizado = await abrirModalActualizar(data, docSnap.ref);
                // Actualizamos la data local con la que viene del modal resuelto
                data = clienteActualizado; 
                msg.textContent = ""; // Limpiar mensaje de "datos incompletos"
            } catch (error) {
                // El usuario cancel√≥ la actualizaci√≥n
                msg.textContent = error.message; // Mostrar mensaje de cancelaci√≥n
                cerrarSesion(); // Forzar cierre de sesi√≥n
                return;
                
            }
        }

        // Si los datos ya estaban completos o se acaban de actualizar, continuamos
        document.getElementById("nombreUsuario").textContent = data.nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("mensaje-bienvenida").textContent = `¬°Hola, ${data.nombre}! Bienvenido a la Ruleta Esentia üåø`;
        document.getElementById("modalLoginRegistro").style.display = "none";

      } catch (err) {
        console.error("Error en el proceso de login:", err);
        msg.textContent = "Error de conexi√≥n o en el proceso.";
        cerrarSesion();
      }
    });

    function sortearPremio() {
      const total = premiosConProbabilidad.reduce((sum, p) => sum + p.prob, 0);
      let rand = Math.random() * total;
      for (const premio of premiosConProbabilidad) {
        if (rand < premio.prob) return premio.nombre;
        rand -= premio.prob;
      }
      return premiosConProbabilidad[0].nombre;
    }

    function generarCodigo(valor, premio) {
      let sufijo = "UNK";
      if (premio.includes("5%")) sufijo = "5PCT";
      else if (premio.includes("10%")) sufijo = "10PCT";
      else if (premio.includes("50%")) sufijo = "50PCT";
      else if (premio.includes("Difusor")) sufijo = "DIFF5";
      else sufijo = "SUE";
      const timestamp = Date.now().toString(36).slice(-4).toUpperCase();
      return `ES-${valor.slice(-4)}-${sufijo}-${timestamp}`.toUpperCase();
    }

    function generarLinkWhatsApp(clienteData, premio, codigo) {
      const numeroDestino = "50672952454";
      const mensaje = `
üéâ ¬°FELICIDADES! üéâ

¬°El cliente ${clienteData.nombre} ha ganado un premio en la Ruleta Esentia!

- Premio Obtenido: ${premio}
- C√≥digo de Canje: ${codigo}

Datos del Cliente:
- C√©dula: ${clienteData.cedula || 'No proporcionada'}
- Tel√©fono: ${clienteData.telefono || 'No proporcionado'}

‚ö†Ô∏è IMPORTANTE: Este premio ser√° efectivo en la PR√ìXIMA COMPRA del cliente.
`;
      return `https://wa.me/${numeroDestino}?text=${encodeURIComponent(mensaje.trim( ))}`;
    }

    function renderizarPremiosVisuales() {
      const lista = document.getElementById("premiosLista");
      lista.innerHTML = "";
      const nombres = premiosConProbabilidad.map(p => p.nombre);
      nombres.forEach((texto) => {
        const li = document.createElement("li");
        li.className = "premio-item";
        li.textContent = texto;
        lista.appendChild(li);
      });
    }

    function animarTombola(indiceGanador) {
      return new Promise(resolve => {
        const items = document.querySelectorAll(".premio-item");
        if (items.length === 0 || indiceGanador < 0) return resolve();
        let actual = -1;
        let cuenta = 0;
        const totalVueltas = 3;
        const totalPasos = (items.length * totalVueltas) + indiceGanador;

        function resaltar() {
          if (actual >= 0) items[actual].classList.remove("highlight");
          actual = (actual + 1) % items.length;
          items[actual].classList.add("highlight");
          cuenta++;
          
          if (cuenta > totalPasos) {
            resolve();
            return;
          }
          
          const delay = 50 + Math.pow(cuenta / totalPasos, 2) * 150;
          setTimeout(resaltar, delay);
        }
        resaltar();
      });
    }

    async function registrarPremio() {
      if (!clienteAutenticado) throw new Error("Debes iniciar sesi√≥n.");

      const clienteRef = doc(db, "clientes", clienteAutenticado.id);
      const snap = await getDoc(clienteRef);
      if (!snap.exists()) throw new Error("Cliente no encontrado.");
      const data = snap.data();

      if (data.yaParticipo) {
        return {
          repetido: true,
          premio: data.premioObtenido || "No registrado",
          codigo: data.codigoCanje || "‚Äî",
          fecha: data.fechaPremio
        };
      }

      const compras = data.compras || [];
      const tieneCompraCalificada = compras.some(compra => {
        const totalNeto = (compra.monto || 0) - (compra.descuento || 0);
        return totalNeto >= 10000;
      });
      if (!tieneCompraCalificada) {
        throw new Error("‚ö†Ô∏è Debes tener una compra ‚â• ‚Ç°10,000 para participar.");
      }

      const premio = sortearPremio();
      const valor = (data.cedula || data.telefono || "0000").toString().replace(/\D/g, "");
      const codigo = generarCodigo(valor, premio);

      await updateDoc(clienteRef, {
        premioObtenido: premio,
        codigoCanje: codigo,
        fechaPremio: new Date(),
        yaParticipo: true
      });

      return { repetido: false, premio, codigo, clienteRef };
    }

    async function init() {
      await cargarConfiguracionPremios();
      renderizarPremiosVisuales();
      document.getElementById("modalLoginRegistro").style.display = "flex";

      document.getElementById("girar-btn").addEventListener("click", async () => {
        if (yaGiro) return;
        yaGiro = true;
        const btn = document.getElementById("girar-btn");
        const resEl = document.getElementById("resultado");
        btn.disabled = true;
        resEl.innerHTML = "Girando la ruleta...";

        try {
          const res = await registrarPremio();
          const nombres = premiosConProbabilidad.map(p => p.nombre);
          
          if (res.repetido) {
            resEl.innerHTML = `
              üîÅ Ya participaste antes  

              Premio: <strong>${res.premio}</strong>  

              C√≥digo: <div class="codigo">${res.codigo}</div>
            `;
            return;
          }

          const idx = nombres.indexOf(res.premio);
          await animarTombola(idx);

          if (res.premio === "M√°s suerte la pr√≥xima vez") {
            resEl.innerHTML = `üò¢ M√°s suerte la pr√≥xima vez.  
¬°Gracias por participar!`;
            setTimeout(() => window.location.href = "https://www.facebook.com/profile.php?id=61579078480913", 5000 );
          } else {
            const clienteData = (await getDoc(res.clienteRef)).data();
            const link = generarLinkWhatsApp(clienteData, res.premio, res.codigo);
            resEl.innerHTML = `
              üéâ ¬°Felicidades!  
<strong>${res.premio}</strong>  

              <div class="codigo">${res.codigo}</div>
              <a href="${link}" target="_blank" id="whatsapp-btn" style="display:inline-block; margin-top:15px; padding:10px 20px; background:#25D366; color:white; text-decoration:none; border-radius:20px; font-weight:bold;">
                Enviar C√≥digo por WhatsApp
              </a>
            `;
            document.getElementById("whatsapp-btn")?.addEventListener("click", () => {
              setTimeout(() => window.location.href = "https://www.facebook.com/profile.php?id=61579078480913", 3000 );
            });
          }
        } catch (err) {
          resEl.innerHTML = `‚ùå ${err.message || "Error inesperado."}`;
          yaGiro = false;
          btn.disabled = false;
          document.querySelectorAll(".premio-item").forEach(i => i.classList.remove("highlight"));
        }
      });
    }

    window.cerrarSesion = cerrarSesion;
    window.cerrarModalActualizar = cerrarModalActualizar;
    window.guardarActualizacion = guardarActualizacion;

    init();
  </script>
</body>
</html>

