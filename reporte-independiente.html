<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üí∞ Clientes con Saldo Pendiente - Esentia</title>
  <script type="module">
    // üî• Firebase Config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentia-factura-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===============================
    // üìä Estado global
    // ===============================
    let clientesConDeuda = [];
    let filtroMinimo = 0;
    let ordenarPor = 'monto';
    let ordenAsc = false;
    let clientePagoSeleccionado = null; // Para modal de pago

    // ===============================
    // üì• Cargar datos de clientes con deuda
    // ===============================
    async function cargarClientesConDeuda() {
      try {
        document.getElementById('loading').style.display = 'block';
        
        // 1. Cargar clientes base
        const snapClientes = await getDocs(collection(db, "clientesBD"));
        const clientesBase = [];
        
        for (const docSnap of snapClientes.docs) {
          const data = docSnap.data();
          clientesBase.push({
            id: docSnap.id,
            nombre: data.nombre || "Sin nombre",
            telefono: data.telefono || "",
            cedula: data.cedula || ""
          });
        }

        // 2. Cargar facturas y calcular deudas
        clientesConDeuda = [];
        
        for (const cliente of clientesBase) {
          const refFacturas = doc(db, "facturas", cliente.id);
          const snapFacturas = await getDoc(refFacturas);
          
          if (snapFacturas.exists()) {
            const data = snapFacturas.data();
            const compras = data.compras || [];
            const abonos = data.abonos || [];
            
            // Calcular deuda total
            let deudaTotal = 0;
            let fechaUltimaCompra = null;
            let fechaUltimaCompraPendiente = null;
            let comprasPendientes = [];
            let totalCompras = 0;
            let totalPagado = 0;
            
            compras.forEach(compra => {
              const monto = Number(compra.total ?? (compra.monto - (compra.descuento || 0)));
              const pagado = Number(compra.pagado || 0);
              const saldo = Math.max(0, monto - pagado);
              
              totalCompras += monto;
              totalPagado += pagado;
              
              if (saldo > 0) {
                deudaTotal += saldo;
                comprasPendientes.push({
                  fecha: compra.fecha,
                  monto: monto,
                  pagado: pagado,
                  saldo: saldo,
                  productos: compra.productos || [],
                  metodoPago: compra.metodoPago || "Pendiente"
                });
                
                if (compra.fecha) {
                  const fechaCompra = new Date(compra.fecha);
                  if (!fechaUltimaCompraPendiente || fechaCompra > fechaUltimaCompraPendiente) {
                    fechaUltimaCompraPendiente = fechaCompra;
                  }
                }
              }
              
              if (compra.fecha) {
                const fechaCompra = new Date(compra.fecha);
                if (!fechaUltimaCompra || fechaCompra > fechaUltimaCompra) {
                  fechaUltimaCompra = fechaCompra;
                }
              }
            });
            
            if (deudaTotal > 0) {
              clientesConDeuda.push({
                id: cliente.id,
                nombre: cliente.nombre,
                telefono: cliente.telefono,
                cedula: cliente.cedula,
                deudaTotal: deudaTotal,
                totalCompras: totalCompras,
                totalPagado: totalPagado,
                fechaUltimaCompra: fechaUltimaCompra,
                fechaUltimaCompraPendiente: fechaUltimaCompraPendiente,
                comprasPendientes: comprasPendientes,
                cantidadFacturasPendientes: comprasPendientes.length,
                abonos: abonos
              });
            }
          }
        }
        
        document.getElementById('loading').style.display = 'none';
        renderizarReporte();
        actualizarResumen();
      } catch (error) {
        console.error("Error cargando datos:", error);
        document.getElementById('loading').style.display = 'none';
        alert("‚ùå Error al cargar los datos: " + error.message);
      }
    }

    // ===============================
    // üí∞ ABRIR MODAL DE PAGO COMPLETO
    // ===============================
    function abrirPago(clienteId) {
      const cliente = clientesConDeuda.find(c => c.id === clientId);
      if (!cliente) return;
      
      clientePagoSeleccionado = cliente;
      
      // Rellenar modal
      document.getElementById('pago-cliente-nombre').textContent = cliente.nombre;
      document.getElementById('pago-cliente-deuda').textContent = `‚Ç°${cliente.deudaTotal.toLocaleString('es-CR')}`;
      document.getElementById('pago-monto').value = '';
      document.getElementById('pago-metodo').value = 'Efectivo';
      document.getElementById('pago-nota').value = '';
      
      // Mostrar modal
      document.getElementById('modal-registrar-pago').style.display = 'flex';
    }

    // ===============================
    // ‚úÖ GUARDAR PAGO COMPLETO
    // ===============================
    async function guardarPago() {
      if (!clientePagoSeleccionado) {
        alert("‚ùå No hay cliente seleccionado");
        return;
      }
      
      const monto = Number(document.getElementById('pago-monto').value);
      const metodo = document.getElementById('pago-metodo').value;
      const nota = document.getElementById('pago-nota').value.trim();
      
      // Validaciones
      if (!monto || monto <= 0) {
        alert("‚ùå Por favor ingresa un monto v√°lido mayor a ‚Ç°0");
        return;
      }
      
      if (monto > clientePagoSeleccionado.deudaTotal) {
        if (!confirm(`‚ö†Ô∏è El monto (‚Ç°${monto.toLocaleString('es-CR')}) es mayor que la deuda actual (‚Ç°${clientePagoSeleccionado.deudaTotal.toLocaleString('es-CR')}).\n\n¬øDeseas continuar?`)) {
          return;
        }
      }
      
      try {
        // Obtener documento del cliente
        const ref = doc(db, "facturas", clientePagoSeleccionado.id);
        const snap = await getDoc(ref);
        
        if (!snap.exists()) {
          alert("‚ùå Cliente no encontrado en facturas");
          return;
        }
        
        const data = snap.data();
        const compras = [...(data.compras || [])];
        const abonos = [...(data.abonos || [])];
        
        let restante = monto;
        
        // Aplicar pago FIFO (primero a las compras m√°s antiguas)
        const comprasOrdenadas = [...compras].sort((a, b) => {
          return new Date(a.fecha) - new Date(b.fecha);
        });
        
        comprasOrdenadas.forEach(compra => {
          if (restante <= 0) return;
          
          const totalCompra = Number(compra.total ?? (compra.monto - (compra.descuento || 0)));
          const pagadoActual = Number(compra.pagado || 0);
          const saldoActual = totalCompra - pagadoActual;
          
          if (saldoActual > 0) {
            const aplicar = Math.min(saldoActual, restante);
            compra.pagado = pagadoActual + aplicar;
            
            // Actualizar en el array original
            const index = compras.findIndex(c => c.fecha === compra.fecha && c.monto === compra.monto);
            if (index !== -1) {
              compras[index].pagado = compra.pagado;
              compras[index].metodoPago = metodo; // Actualizar m√©todo de pago
            }
            
            restante -= aplicar;
          }
        });
        
        // Registrar abono
        const nuevoAbono = {
          fecha: new Date().toISOString(),
          monto: monto,
          metodo: metodo,
          nota: nota || '-'
        };
        
        abonos.push(nuevoAbono);
        
        // Guardar en Firebase
        await updateDoc(ref, {
          compras: compras,
          abonos: abonos
        });
        
        // Cerrar modal
        cerrarModalPago();
        
        // Recargar datos
        await cargarClientesConDeuda();
        
        // Mensaje de √©xito
        const mensajeExito = `
‚úÖ PAGO REGISTRADO CORRECTAMENTE

Cliente: ${clientePagoSeleccionado.nombre}
Monto: ‚Ç°${monto.toLocaleString('es-CR')}
M√©todo: ${metodo}
${nota ? `Nota: ${nota}` : ''}
        `.trim();
        
        alert(mensajeExito);
        
      } catch (error) {
        console.error("Error guardando pago:", error);
        alert("‚ùå Error al registrar el pago: " + error.message);
      }
    }

    // ===============================
    // ‚ùå CERRAR MODAL DE PAGO
    // ===============================
    function cerrarModalPago() {
      document.getElementById('modal-registrar-pago').style.display = 'none';
      clientePagoSeleccionado = null;
    }

    // ===============================
    // üìä Renderizar reporte
    // ===============================
    function renderizarReporte() {
      const contenedor = document.getElementById('tabla-clientes-deuda');
      
      let clientesFiltrados = [...clientesConDeuda];
      if (filtroMinimo > 0) {
        clientesFiltrados = clientesFiltrados.filter(c => c.deudaTotal >= filtroMinimo);
      }
      
      clientesFiltrados.sort((a, b) => {
        let valorA, valorB;
        
        if (ordenarPor === 'monto') {
          valorA = a.deudaTotal;
          valorB = b.deudaTotal;
        } else if (ordenarPor === 'fecha') {
          valorA = a.fechaUltimaCompraPendiente ? a.fechaUltimaCompraPendiente.getTime() : 0;
          valorB = b.fechaUltimaCompraPendiente ? b.fechaUltimaCompraPendiente.getTime() : 0;
        } else if (ordenarPor === 'nombre') {
          valorA = a.nombre.toLowerCase();
          valorB = b.nombre.toLowerCase();
        }
        
        if (valorA < valorB) return ordenAsc ? -1 : 1;
        if (valorA > valorB) return ordenAsc ? 1 : -1;
        return 0;
      });
      
      let html = `
        <table class="tabla-deuda">
          <thead>
            <tr>
              <th onclick="cambiarOrden('nombre')">Cliente ${getIconoOrden('nombre')}</th>
              <th>Tel√©fono</th>
              <th onclick="cambiarOrden('monto')">Monto Pendiente ${getIconoOrden('monto')}</th>
              <th>Total Comprado</th>
              <th>Total Pagado</th>
              <th>Facturas Pend.</th>
              <th onclick="cambiarOrden('fecha')">√öltima Compra ${getIconoOrden('fecha')}</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      clientesFiltrados.forEach(cliente => {
        const fechaUltima = cliente.fechaUltimaCompraPendiente 
          ? formatearFecha(cliente.fechaUltimaCompraPendiente) 
          : 'Sin fecha';
        const diasAtraso = calcularDiasAtraso(cliente.fechaUltimaCompraPendiente);
        
        html += `
          <tr>
            <td>
              <strong>${cliente.nombre}</strong>
              ${cliente.cedula ? `<br><small>üÜî ${cliente.cedula}</small>` : ''}
            </td>
            <td>
              <a href="https://wa.me/506${cliente.telefono}" target="_blank" class="btn-whatsapp">
                üìû ${cliente.telefono}
              </a>
            </td>
            <td class="numero deuda-alta">
              <strong>‚Ç°${cliente.deudaTotal.toLocaleString('es-CR')}</strong>
              ${diasAtraso > 0 ? `<br><small class="badge-atraso">‚è± ${diasAtraso} d√≠as</small>` : ''}
            </td>
            <td class="numero">
              ‚Ç°${cliente.totalCompras.toLocaleString('es-CR')}
            </td>
            <td class="numero">
              ‚Ç°${cliente.totalPagado.toLocaleString('es-CR')}
            </td>
            <td class="numero">
              ${cliente.cantidadFacturasPendientes}
            </td>
            <td>
              ${fechaUltima}
              ${diasAtraso > 7 ? '<br><small class="atraso-alto">üî¥ Atrasado</small>' : ''}
            </td>
            <td class="acciones">
              <button onclick="enviarWhatsApp('${cliente.id}', '${cliente.nombre}', '${cliente.telefono}', ${cliente.deudaTotal})" class="btn-accion whatsapp" title="WhatsApp">
                üí¨
              </button>
              <button onclick="verDetalles('${cliente.id}')" class="btn-accion detalles" title="Ver detalles">
                üìã
              </button>
              <button onclick="abrirPago('${cliente.id}')" class="btn-accion pagar" title="Registrar pago">
                üí∞
              </button>
            </td>
          </tr>
        `;
      });
      
      if (clientesFiltrados.length === 0) {
        html += `
          <tr>
            <td colspan="8" class="sin-datos">
              ${clientesConDeuda.length === 0 
                ? 'No hay clientes con saldos pendientes' 
                : 'No hay clientes que coincidan con el filtro'}
            </td>
          </tr>
        `;
      }
      
      html += `
          </tbody>
        </table>
        
        <div class="resumen-pie">
          <strong>Total de clientes con deuda:</strong> ${clientesFiltrados.length}<br>
          <strong>Monto total pendiente:</strong> ‚Ç°${clientesFiltrados.reduce((sum, c) => sum + c.deudaTotal, 0).toLocaleString('es-CR')}
        </div>
        
        <div class="acciones-exportar">
          <button onclick="exportarCSV()" class="btn-exportar">
            üì• Exportar a CSV
          </button>
          <button onclick="window.print()" class="btn-imprimir">
            üñ®Ô∏è Imprimir
          </button>
        </div>
      `;
      
      contenedor.innerHTML = html;
    }

    // ===============================
    // üìÖ Funciones auxiliares
    // ===============================
    function formatearFecha(fecha) {
      if (!fecha) return 'Sin fecha';
      if (typeof fecha === 'string') fecha = new Date(fecha);
      return fecha.toLocaleDateString('es-CR');
    }
    
    function calcularDiasAtraso(fecha) {
      if (!fecha) return 0;
      if (typeof fecha === 'string') fecha = new Date(fecha);
      const hoy = new Date();
      const diff = hoy - fecha;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }
    
    function cambiarOrden(campo) {
      if (ordenarPor === campo) {
        ordenAsc = !ordenAsc;
      } else {
        ordenarPor = campo;
        ordenAsc = false;
      }
      renderizarReporte();
    }
    
    function getIconoOrden(campo) {
      if (ordenarPor !== campo) return '‚áÖ';
      return ordenAsc ? '‚Üë' : '‚Üì';
    }

    // ===============================
    // üí¨ WhatsApp
    // ===============================
    function enviarWhatsApp(clienteId, nombre, telefono, deudaTotal) {
      const limpio = telefono.replace(/\D/g, '');
      if (limpio.length !== 8) {
        alert("‚ö†Ô∏è Tel√©fono inv√°lido");
        return;
      }
      
      const mensaje = `Hola ${nombre} üëã\n\nTe env√≠o tu estado de cuenta actualizado en *Esentia*.\n\n` +
        `üíú *SALDO PENDIENTE: ‚Ç°${deudaTotal.toLocaleString('es-CR')}*\n\n` +
        `üí≥ *Formas de pago*\n` +
        `1Ô∏è‚É£ Efectivo contra entrega\n` +
        `2Ô∏è‚É£ SINPE M√≥vil: *7295-2454* (Wilber Calder√≥n)\n` +
        `3Ô∏è‚É£ Cuenta BAC: *CR59010200009453897656*\n\n` +
        `‚ú® Agradecemos tu pronta gesti√≥n. Estamos para servirte üíú`;
      
      window.open(`https://wa.me/506${limpio}?text=${encodeURIComponent(mensaje)}`, '_blank');
    }

    // ===============================
    // üìã Ver detalles
    // ===============================
    function verDetalles(clienteId) {
      const cliente = clientesConDeuda.find(c => c.id === clienteId);
      if (!cliente) return;
      
      let detalles = `üìã *DETALLES DE ${cliente.nombre.toUpperCase()}*\n\n`;
      detalles += `üìû Tel√©fono: ${cliente.telefono}\n`;
      detalles += `üÜî C√©dula: ${cliente.cedula || 'No registrada'}\n\n`;
      detalles += `üí∞ DEUDA TOTAL: ‚Ç°${cliente.deudaTotal.toLocaleString('es-CR')}\n`;
      detalles += `üìä Total comprado: ‚Ç°${cliente.totalCompras.toLocaleString('es-CR')}\n`;
      detalles += `‚úÖ Total pagado: ‚Ç°${cliente.totalPagado.toLocaleString('es-CR')}\n`;
      detalles += `üßæ Facturas pendientes: ${cliente.cantidadFacturasPendientes}\n\n`;
      
      if (cliente.comprasPendientes.length > 0) {
        detalles += `üì¶ FACTURAS PENDIENTES:\n`;
        cliente.comprasPendientes.forEach((compra, idx) => {
          const fecha = formatearFecha(compra.fecha);
          detalles += `\nFactura ${idx + 1} (${fecha}):\n`;
          detalles += `  Monto: ‚Ç°${compra.monto.toLocaleString('es-CR')}\n`;
          detalles += `  Pagado: ‚Ç°${compra.pagado.toLocaleString('es-CR')}\n`;
          detalles += `  Saldo: ‚Ç°${compra.saldo.toLocaleString('es-CR')}\n`;
          detalles += `  M√©todo: ${compra.metodoPago}\n`;
          
          if (compra.productos && compra.productos.length > 0) {
            detalles += `  Productos:\n`;
            compra.productos.forEach(p => {
              detalles += `    ‚Ä¢ ${p.cantidad}√ó ${p.nombre}\n`;
            });
          }
        });
      }
      
      alert(detalles);
    }

    // ===============================
    // üìä Actualizar resumen
    // ===============================
    function actualizarResumen() {
      const totalClientes = clientesConDeuda.length;
      const totalDeuda = clientesConDeuda.reduce((sum, c) => sum + c.deudaTotal, 0);
      const promedioDeuda = totalClientes > 0 ? totalDeuda / totalClientes : 0;
      
      const rango1 = clientesConDeuda.filter(c => c.deudaTotal <= 5000).length;
      const rango2 = clientesConDeuda.filter(c => c.deudaTotal > 5000 && c.deudaTotal <= 20000).length;
      const rango3 = clientesConDeuda.filter(c => c.deudaTotal > 20000).length;
      
      document.getElementById('resumen-deuda').innerHTML = `
        <div class="resumen-grid">
          <div class="resumen-item grande">
            <span class="etiqueta">Total Deuda</span>
            <span class="valor">‚Ç°${totalDeuda.toLocaleString('es-CR')}</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">Clientes</span>
            <span class="valor">${totalClientes}</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">Promedio</span>
            <span class="valor">‚Ç°${Math.round(promedioDeuda).toLocaleString('es-CR')}</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">‚â§ ‚Ç°5,000</span>
            <span class="valor">${rango1}</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">‚Ç°5k-20k</span>
            <span class="valor">${rango2}</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">> ‚Ç°20,000</span>
            <span class="valor">${rango3}</span>
          </div>
        </div>
      `;
    }

    // ===============================
    // üíæ Exportar CSV
    // ===============================
    function exportarCSV() {
      let csvContent = 'Cliente,Tel√©fono,C√©dula,Monto Pendiente,Total Comprado,Total Pagado,Facturas Pendientes,√öltima Compra\n';
      
      let clientesFiltrados = [...clientesConDeuda];
      if (filtroMinimo > 0) {
        clientesFiltrados = clientesFiltrados.filter(c => c.deudaTotal >= filtroMinimo);
      }
      
      clientesFiltrados.sort((a, b) => {
        let valorA, valorB;
        if (ordenarPor === 'monto') {
          valorA = a.deudaTotal;
          valorB = b.deudaTotal;
        } else if (ordenarPor === 'fecha') {
          valorA = a.fechaUltimaCompraPendiente ? a.fechaUltimaCompraPendiente.getTime() : 0;
          valorB = b.fechaUltimaCompraPendiente ? b.fechaUltimaCompraPendiente.getTime() : 0;
        } else {
          valorA = a.nombre.toLowerCase();
          valorB = b.nombre.toLowerCase();
        }
        if (valorA < valorB) return ordenAsc ? -1 : 1;
        if (valorA > valorB) return ordenAsc ? 1 : -1;
        return 0;
      });
      
      clientesFiltrados.forEach(cliente => {
        const fecha = cliente.fechaUltimaCompraPendiente 
          ? cliente.fechaUltimaCompraPendiente.toLocaleDateString('es-CR') 
          : 'Sin fecha';
        csvContent += `"${cliente.nombre}","${cliente.telefono}","${cliente.cedula || ''}",${cliente.deudaTotal},${cliente.totalCompras},${cliente.totalPagado},${cliente.cantidadFacturasPendientes},"${fecha}"\n`;
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `clientes_con_deuda_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ===============================
    // üéõÔ∏è Event Listeners
    // ===============================
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('filtro-monto').addEventListener('input', (e) => {
        filtroMinimo = Number(e.target.value) || 0;
        renderizarReporte();
      });
      
      document.getElementById('btn-recargar').addEventListener('click', () => {
        const filtro = document.getElementById('filtro-monto');
        filtroMinimo = Number(filtro.value) || 0;
        cargarClientesConDeuda();
      });
      
      document.getElementById('fecha-actual').textContent = new Date().toLocaleDateString('es-CR');
      
      // Modal de pago
      document.getElementById('btn-guardar-pago').addEventListener('click', guardarPago);
      document.getElementById('btn-cancelar-pago').addEventListener('click', cerrarModalPago);
      
      // Cerrar modal al hacer clic fuera
      document.getElementById('modal-registrar-pago').addEventListener('click', (e) => {
        if (e.target === document.getElementById('modal-registrar-pago')) {
          cerrarModalPago();
        }
      });
      
      // Validaci√≥n en tiempo real del monto
      document.getElementById('pago-monto').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
      });
      
      cargarClientesConDeuda();
      document.getElementById('filtro-monto').value = '0';
    });

    window.cambiarOrden = cambiarOrden;
    window.enviarWhatsApp = enviarWhatsApp;
    window.verDetalles = verDetalles;
    window.abrirPago = abrirPago;
    window.exportarCSV = exportarCSV;
    window.cargarClientesConDeuda = cargarClientesConDeuda;
    window.guardarPago = guardarPago;
    window.cerrarModalPago = cerrarModalPago;
  </script>
  <style>
    :root {
      --color-primary: #8B7500;
      --color-secondary: #2E7D32;
      --color-danger: #c62828;
      --color-bg: rgba(255, 255, 255, 0.85);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: #333;
      padding: 20px;
      min-height: 100vh;
    }
    
    .contenedor-principal {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    h1 {
      font-size: 2.4rem;
      color: var(--color-danger);
      margin-bottom: 10px;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
    }
    
    .subtitulo {
      color: #666;
      font-size: 1.1rem;
      margin-bottom: 20px;
    }
    
    .fecha-actual {
      background: rgba(255, 255, 255, 0.7);
      display: inline-block;
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: 600;
      color: var(--color-primary);
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .panel {
      background: var(--color-bg);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 25px;
      margin-bottom: 25px;
      border: 1px solid rgba(198, 40, 40, 0.2);
    }
    
    .controles-filtro {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding: 15px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 15px;
      border-left: 4px solid var(--color-danger);
    }
    
    .grupo-filtro {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .grupo-filtro label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    
    .grupo-filtro input {
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-size: 1rem;
      width: 150px;
      transition: border-color 0.3s;
    }
    
    .grupo-filtro input:focus {
      border-color: var(--color-danger);
      outline: none;
      box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.2);
    }
    
    .btn-recargar {
      background: var(--color-danger);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 15px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(198, 40, 40, 0.3);
    }
    
    .btn-recargar:hover {
      background: #b71c1c;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(198, 40, 40, 0.4);
    }
    
    .resumen-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .resumen-item {
      background: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.3s ease;
      border-top: 4px solid var(--color-danger);
    }
    
    .resumen-item.grande {
      grid-column: span 2;
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
    }
    
    .resumen-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    
    .etiqueta {
      display: block;
      color: #777;
      font-size: 0.95rem;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .valor {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--color-danger);
    }
    
    .tabla-deuda {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      font-size: 0.95rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      border-radius: 15px;
      overflow: hidden;
    }
    
    .tabla-deuda th {
      background: var(--color-danger);
      color: white;
      padding: 14px 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s;
    }
    
    .tabla-deuda th:hover {
      background: #d32f2f;
    }
    
    .tabla-deuda td {
      padding: 14px 12px;
      border-bottom: 1px solid #eee;
      vertical-align: middle;
    }
    
    .tabla-deuda tr:hover {
      background-color: rgba(255, 245, 245, 0.6);
    }
    
    .tabla-deuda tr:nth-child(even) {
      background-color: rgba(255, 250, 250, 0.4);
    }
    
    .numero {
      text-align: right;
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }
    
    .deuda-alta {
      color: var(--color-danger);
      font-size: 1.1rem;
    }
    
    .badge-atraso {
      background: #ffcdd2;
      color: var(--color-danger);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      display: inline-block;
      margin-top: 4px;
    }
    
    .atraso-alto {
      color: var(--color-danger);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .btn-whatsapp {
      color: #128C7E;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
    }
    
    .btn-whatsapp:hover {
      color: #075E54;
      text-decoration: underline;
    }
    
    .acciones {
      text-align: center;
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    
    .btn-accion {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .btn-accion.whatsapp {
      background: #25D366;
      color: white;
    }
    
    .btn-accion.whatsapp:hover {
      background: #128C7E;
      transform: scale(1.1);
    }
    
    .btn-accion.detalles {
      background: #42A5F5;
      color: white;
    }
    
    .btn-accion.detalles:hover {
      background: #1565C0;
      transform: scale(1.1);
    }
    
    .btn-accion.pagar {
      background: #FF9800;
      color: white;
    }
    
    .btn-accion.pagar:hover {
      background: #E65100;
      transform: scale(1.1);
    }
    
    .sin-datos {
      text-align: center;
      padding: 40px;
      color: #999;
      font-style: italic;
      background: rgba(245, 245, 245, 0.6);
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .resumen-pie {
      background: rgba(255, 245, 245, 0.7);
      padding: 15px;
      border-radius: 12px;
      margin: 20px 0;
      border-left: 4px solid var(--color-danger);
      font-weight: 600;
      color: var(--color-danger);
    }
    
    .acciones-exportar {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px dashed rgba(198, 40, 40, 0.3);
    }
    
    .btn-exportar {
      background: #1976d2;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 15px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
    }
    
    .btn-exportar:hover {
      background: #0d47a1;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
    }
    
    .btn-imprimir {
      background: #7b1fa2;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 15px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(123, 31, 162, 0.3);
    }
    
    .btn-imprimir:hover {
      background: #4a148c;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(123, 31, 162, 0.4);
    }
    
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      display: none;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(198, 40, 40, 0.2);
      border-top: 6px solid var(--color-danger);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1.3rem;
      color: var(--color-danger);
      font-weight: 600;
    }
    
    /* ===== MODAL DE PAGO ===== */
    #modal-registrar-pago {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .modal-contenido-pago {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      position: relative;
    }
    
    .modal-contenido-pago h3 {
      color: var(--color-danger);
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.8rem;
    }
    
    .info-cliente-pago {
      background: rgba(255, 245, 245, 0.3);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid var(--color-danger);
    }
    
    .info-cliente-pago p {
      margin: 8px 0;
      font-size: 1.05rem;
    }
    
    .info-cliente-pago strong {
      color: var(--color-danger);
    }
    
    .grupo-formulario {
      margin-bottom: 15px;
    }
    
    .grupo-formulario label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }
    
    .grupo-formulario input,
    .grupo-formulario select,
    .grupo-formulario textarea {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    
    .grupo-formulario input:focus,
    .grupo-formulario select:focus,
    .grupo-formulario textarea:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(139, 117, 0, 0.2);
    }
    
    .grupo-formulario textarea {
      resize: vertical;
      min-height: 60px;
      font-family: inherit;
    }
    
    .botones-modal {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 25px;
      padding-top: 20px;
      border-top: 2px solid #eee;
    }
    
    .btn-modal {
      padding: 12px 30px;
      border: none;
      border-radius: 15px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    #btn-guardar-pago {
      background: var(--color-danger);
      color: white;
      box-shadow: 0 4px 15px rgba(198, 40, 40, 0.3);
    }
    
    #btn-guardar-pago:hover {
      background: #b71c1c;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(198, 40, 40, 0.4);
    }
    
    #btn-cancelar-pago {
      background: #757575;
      color: white;
      box-shadow: 0 4px 15px rgba(117, 117, 117, 0.3);
    }
    
    #btn-cancelar-pago:hover {
      background: #424242;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(117, 117, 117, 0.4);
    }
    
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .controles-filtro,
      .acciones-exportar,
      .btn-recargar,
      .acciones,
      header h1::after {
        display: none !important;
      }
      
      .panel {
        box-shadow: none;
        border: none;
        padding: 15px;
      }
      
      .tabla-deuda {
        width: 100%;
        font-size: 0.8rem;
      }
      
      .tabla-deuda th {
        background: #d32f2f;
        color: white;
        page-break-inside: avoid;
      }
      
      .tabla-deuda tr {
        page-break-inside: avoid;
      }
      
      .resumen-grid {
        display: none;
      }
    }
    
    @media (max-width: 768px) {
      .controles-filtro {
        flex-direction: column;
        align-items: stretch;
      }
      
      .grupo-filtro input {
        width: 100%;
      }
      
      .acciones-exportar {
        flex-direction: column;
      }
      
      .tabla-deuda {
        font-size: 0.85rem;
      }
      
      .tabla-deuda th,
      .tabla-deuda td {
        padding: 8px 6px;
      }
      
      .acciones {
        flex-direction: column;
        gap: 4px;
      }
      
      .btn-accion {
        width: 32px;
        height: 32px;
        font-size: 1rem;
      }
      
      .resumen-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
      
      .resumen-item.grande {
        grid-column: span 1;
      }
      
      .modal-contenido-pago {
        padding: 20px;
        margin: 10px;
      }
      
      .botones-modal {
        flex-direction: column;
      }
      
      .btn-modal {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Cargando clientes con deuda...</div>
    <div style="color:#777; margin-top:15px">Analizando facturas y saldos pendientes</div>
  </div>

  <div class="contenedor-principal">
    <header>
      <h1>üí∞ Clientes con Saldo Pendiente</h1>
      <div class="subtitulo">Reporte detallado de clientes con montos pendientes de pago</div>
      <div class="fecha-actual" id="fecha-actual">Cargando...</div>
    </header>

    <div class="panel">
      <div class="controles-filtro">
        <div class="grupo-filtro">
          <label for="filtro-monto">Monto m√≠nimo (‚Ç°)</label>
          <input type="number" id="filtro-monto" min="0" placeholder="0">
        </div>
        <button id="btn-recargar" class="btn-recargar">
          <span>‚Üª</span> Actualizar Datos
        </button>
      </div>

      <div id="resumen-deuda">
        <div class="resumen-grid">
          <div class="resumen-item grande">
            <span class="etiqueta">Cargando...</span>
            <span class="valor">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div id="tabla-clientes-deuda">
        <div style="text-align:center; padding:40px; color:#888">
          <div class="spinner" style="margin:0 auto 20px;"></div>
          <div>Cargando reporte de clientes con deuda...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Registrar Pago -->
  <div id="modal-registrar-pago">
    <div class="modal-contenido-pago">
      <h3>üí∞ Registrar Pago</h3>
      
      <div class="info-cliente-pago">
        <p><strong>Cliente:</strong> <span id="pago-cliente-nombre">-</span></p>
        <p><strong>Deuda actual:</strong> <span id="pago-cliente-deuda">‚Ç°0</span></p>
      </div>
      
      <div class="grupo-formulario">
        <label for="pago-monto">Monto a pagar (‚Ç°)</label>
        <input type="number" id="pago-monto" placeholder="Ingrese monto" min="1">
      </div>
      
      <div class="grupo-formulario">
        <label for="pago-metodo">M√©todo de Pago</label>
        <select id="pago-metodo">
          <option value="Efectivo">üíµ Efectivo</option>
          <option value="SINPE">üì± SINPE M√≥vil</option>
          <option value="Transferencia">üè¶ Transferencia</option>
          <option value="Tarjeta">üí≥ Tarjeta</option>
        </select>
      </div>
      
      <div class="grupo-formulario">
        <label for="pago-nota">Notas (opcional)</label>
        <textarea id="pago-nota" placeholder="Ej: Pago parcial, referencia, etc."></textarea>
      </div>
      
      <div class="botones-modal">
        <button id="btn-guardar-pago" class="btn-modal">
          ‚úÖ Registrar Pago
        </button>
        <button id="btn-cancelar-pago" class="btn-modal">
          ‚ùå Cancelar
        </button>
      </div>
    </div>
  </div>

  <script>
    if (typeof cargarClientesConDeuda === 'undefined') {
      console.log("Esperando inicializaci√≥n de Firebase...");
    }
  </script>
</body>
</html>