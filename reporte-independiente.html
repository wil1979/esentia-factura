<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <title>üí∞ Clientes con Saldo Pendiente - Esentia</title>
  <script type="module">
    // üî• Firebase Config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, collection, getDocs, doc, getDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentia-factura-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===============================
    // üìä Estado global
    // ===============================
    let clientesConDeuda = [];
    let filtroMinimo = 0;
    let ordenarPor = 'monto';
    let ordenAsc = false;
    let clientePagoSeleccionado = null;

    // ===============================
    // üì• Cargar datos
    // ===============================
    async function cargarClientesConDeuda() {
      try {
        document.getElementById('loading').style.display = 'flex';
        
        const snapClientes = await getDocs(collection(db, "clientesBD"));
        const clientesBase = [];
        
        for (const docSnap of snapClientes.docs) {
          const data = docSnap.data();
          clientesBase.push({
            id: docSnap.id,
            nombre: data.nombre || "Sin nombre",
            telefono: data.telefono || "",
            cedula: data.cedula || ""
          });
        }

        clientesConDeuda = [];
        
        for (const cliente of clientesBase) {
          const refFacturas = doc(db, "facturas", cliente.id);
          const snapFacturas = await getDoc(refFacturas);
          
          if (snapFacturas.exists()) {
            const data = snapFacturas.data();
            const compras = data.compras || [];
            const abonos = data.abonos || [];
            
            let deudaTotal = 0;
            let fechaUltimaCompra = null;
            let fechaUltimaCompraPendiente = null;
            let comprasPendientes = [];
            let totalCompras = 0;
            let totalPagado = 0;
            
            compras.forEach(compra => {
              const monto = Number(compra.total ?? (compra.monto - (compra.descuento || 0)));
              const pagado = Number(compra.pagado || 0);
              const saldo = Math.max(0, monto - pagado);
              
              totalCompras += monto;
              totalPagado += pagado;
              
              if (saldo > 0) {
                deudaTotal += saldo;
                comprasPendientes.push({
                  fecha: compra.fecha,
                  monto: monto,
                  pagado: pagado,
                  saldo: saldo,
                  productos: compra.productos || [],
                  metodoPago: compra.metodoPago || "Pendiente"
                });
                
                if (compra.fecha) {
                  const fechaCompra = new Date(compra.fecha);
                  if (!fechaUltimaCompraPendiente || fechaCompra > fechaUltimaCompraPendiente) {
                    fechaUltimaCompraPendiente = fechaCompra;
                  }
                }
              }
              
              if (compra.fecha) {
                const fechaCompra = new Date(compra.fecha);
                if (!fechaUltimaCompra || fechaCompra > fechaUltimaCompra) {
                  fechaUltimaCompra = fechaCompra;
                }
              }
            });
            
            if (deudaTotal > 0) {
              clientesConDeuda.push({
                id: cliente.id,
                nombre: cliente.nombre,
                telefono: cliente.telefono,
                cedula: cliente.cedula,
                deudaTotal: deudaTotal,
                totalCompras: totalCompras,
                totalPagado: totalPagado,
                fechaUltimaCompra: fechaUltimaCompra,
                fechaUltimaCompraPendiente: fechaUltimaCompraPendiente,
                comprasPendientes: comprasPendientes,
                cantidadFacturasPendientes: comprasPendientes.length,
                abonos: abonos
              });
            }
          }
        }
        
        document.getElementById('loading').style.display = 'none';
        renderizarReporte();
        actualizarResumen();
      } catch (error) {
        console.error("Error cargando datos:", error);
        document.getElementById('loading').style.display = 'none';
        mostrarToast("‚ùå Error al cargar datos: " + error.message);
      }
    }

    // ===============================
    // üí∞ Abrir modal de pago (CORREGIDO PARA M√ìVIL)
    // ===============================
    function abrirPago(clienteId) {
      const cliente = clientesConDeuda.find(c => c.id === clienteId);
      if (!cliente) return;
      
      clientePagoSeleccionado = cliente;
      
      // Rellenar modal
      document.getElementById('pago-cliente-nombre').textContent = cliente.nombre;
      document.getElementById('pago-cliente-deuda').textContent = `‚Ç°${cliente.deudaTotal.toLocaleString('es-CR')}`;
      document.getElementById('pago-monto').value = '';
      document.getElementById('pago-metodo').value = 'Efectivo';
      document.getElementById('pago-nota').value = '';
      
      // Mostrar modal con animaci√≥n suave
      const modal = document.getElementById('modal-registrar-pago');
      modal.style.display = 'block';
      
      // Forzar repaint para animaci√≥n
      setTimeout(() => {
        modal.style.opacity = '1';
        modal.style.transform = 'translateY(0)';
        
        // Enfocar campo de monto despu√©s de mostrar modal
        setTimeout(() => {
          document.getElementById('pago-monto').focus();
          document.getElementById('pago-monto').click(); // Forzar teclado en m√≥vil
        }, 300);
      }, 10);
      
      // Prevenir scroll en background
      document.body.style.overflow = 'hidden';
    }

    // ===============================
    // ‚úÖ Guardar pago
    // ===============================
    async function guardarPago() {
      if (!clientePagoSeleccionado) {
        mostrarToast("‚ùå No hay cliente seleccionado");
        return;
      }
      
      const montoStr = document.getElementById('pago-monto').value.trim();
      const monto = montoStr ? Number(montoStr.replace(/[^0-9]/g, '')) : 0;
      const metodo = document.getElementById('pago-metodo').value;
      const nota = document.getElementById('pago-nota').value.trim();
      
      // Validaciones
      if (!montoStr || monto <= 0) {
        mostrarToast("‚ö†Ô∏è Ingresa un monto v√°lido mayor a ‚Ç°0");
        document.getElementById('pago-monto').focus();
        return;
      }
      
      if (monto > clientePagoSeleccionado.deudaTotal) {
        const confirmar = confirm(`‚ö†Ô∏è El monto (‚Ç°${monto.toLocaleString('es-CR')}) es mayor que la deuda (‚Ç°${clientePagoSeleccionado.deudaTotal.toLocaleString('es-CR')}).\n\n¬øRegistrar igual?`);
        if (!confirmar) return;
      }
      
      try {
        document.getElementById('loading').style.display = 'flex';
        
        const ref = doc(db, "facturas", clientePagoSeleccionado.id);
        const snap = await getDoc(ref);
        
        if (!snap.exists()) {
          document.getElementById('loading').style.display = 'none';
          mostrarToast("‚ùå Cliente no encontrado");
          return;
        }
        
        const data = snap.data();
        const compras = [...(data.compras || [])];
        const abonos = [...(data.abonos || [])];
        
        let restante = monto;
        
        // Aplicar pago FIFO (m√°s antiguas primero)
        const comprasOrdenadas = [...compras].sort((a, b) => {
          return new Date(a.fecha) - new Date(b.fecha);
        });
        
        comprasOrdenadas.forEach(compra => {
          if (restante <= 0) return;
          
          const totalCompra = Number(compra.total ?? (compra.monto - (compra.descuento || 0)));
          const pagadoActual = Number(compra.pagado || 0);
          const saldoActual = totalCompra - pagadoActual;
          
          if (saldoActual > 0) {
            const aplicar = Math.min(saldoActual, restante);
            compra.pagado = pagadoActual + aplicar;
            
            const index = compras.findIndex(c => 
              c.fecha === compra.fecha && 
              Math.abs((c.monto || c.total) - (compra.monto || compra.total)) < 1
            );
            
            if (index !== -1) {
              compras[index].pagado = compra.pagado;
              compras[index].metodoPago = metodo;
            }
            
            restante -= aplicar;
          }
        });
        
        // Registrar abono
        abonos.push({
          fecha: new Date().toISOString(),
          monto: monto,
          metodo: metodo,
          nota: nota || '-'
        });
        
        await updateDoc(ref, {
          compras: compras,
          abonos: abonos
        });
        
        // Cerrar modal con animaci√≥n
        cerrarModalPago(true);
        
        // Recargar datos
        await cargarClientesConDeuda();
        
        // Mostrar toast de √©xito
        mostrarToast(`‚úÖ Pago registrado: ‚Ç°${monto.toLocaleString('es-CR')} (${metodo})`);
        
      } catch (error) {
        console.error("Error guardando pago:", error);
        document.getElementById('loading').style.display = 'none';
        mostrarToast("‚ùå Error al registrar pago: " + error.message);
      }
    }

    // ===============================
    // ‚ùå Cerrar modal con animaci√≥n
    // ===============================
    function cerrarModalPago(conExito = false) {
      const modal = document.getElementById('modal-registrar-pago');
      
      if (conExito) {
        // Animaci√≥n de √©xito
        modal.style.opacity = '0';
        modal.style.transform = 'translateY(20px)';
      }
      
      setTimeout(() => {
        modal.style.display = 'none';
        modal.style.opacity = '0';
        modal.style.transform = 'translateY(20px)';
        clientePagoSeleccionado = null;
        document.body.style.overflow = 'auto';
      }, 300);
    }

    // ===============================
    // üì± Soporte t√°ctil mejorado
    // ===============================
    function initEventosMovil() {
      // Delegaci√≥n de eventos para botones de pago
      document.addEventListener('click', function(e) {
        if (e.target.closest('.btn-pagar')) {
          const btn = e.target.closest('.btn-pagar');
          const clienteId = btn.getAttribute('data-cliente-id');
          if (clienteId) abrirPago(clienteId);
        }
      }, { passive: true });
      
      // Cerrar modal al tocar fuera (con protecci√≥n para contenido interno)
      document.getElementById('modal-registrar-pago').addEventListener('click', function(e) {
        if (e.target === this) {
          cerrarModalPago();
        }
      }, { passive: true });
      
      // Botones del modal
      document.getElementById('btn-guardar-pago').addEventListener('click', guardarPago);
      document.getElementById('btn-cancelar-pago').addEventListener('click', () => cerrarModalPago());
      
      // Soporte touch para botones principales
      document.querySelectorAll('.btn-accion, .btn-recargar, .btn-exportar').forEach(btn => {
        btn.addEventListener('touchstart', function() {
          this.classList.add('activo-touch');
        }, { passive: true });
        
        btn.addEventListener('touchend', function() {
          this.classList.remove('activo-touch');
        }, { passive: true });
      });
    }

    // ===============================
    // üçû Renderizar reporte
    // ===============================
    function renderizarReporte() {
      const contenedor = document.getElementById('tabla-clientes-deuda');
      
      let clientesFiltrados = [...clientesConDeuda];
      if (filtroMinimo > 0) {
        clientesFiltrados = clientesFiltrados.filter(c => c.deudaTotal >= filtroMinimo);
      }
      
      clientesFiltrados.sort((a, b) => {
        let valorA, valorB;
        
        if (ordenarPor === 'monto') {
          valorA = a.deudaTotal;
          valorB = b.deudaTotal;
        } else if (ordenarPor === 'fecha') {
          valorA = a.fechaUltimaCompraPendiente ? a.fechaUltimaCompraPendiente.getTime() : 0;
          valorB = b.fechaUltimaCompraPendiente ? b.fechaUltimaCompraPendiente.getTime() : 0;
        } else if (ordenarPor === 'nombre') {
          valorA = a.nombre.toLowerCase();
          valorB = b.nombre.toLowerCase();
        }
        
        if (valorA < valorB) return ordenAsc ? -1 : 1;
        if (valorA > valorB) return ordenAsc ? 1 : -1;
        return 0;
      });
      
      let html = `
        <div class="tabla-responsive">
          <table class="tabla-deuda">
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Tel√©fono</th>
                <th>Monto Pendiente</th>
                <th>√öltima Compra</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      clientesFiltrados.forEach(cliente => {
        const fechaUltima = cliente.fechaUltimaCompraPendiente 
          ? formatearFecha(cliente.fechaUltimaCompraPendiente) 
          : 'Sin fecha';
        const diasAtraso = calcularDiasAtraso(cliente.fechaUltimaCompraPendiente);
        
        html += `
          <tr>
            <td data-label="Cliente">
              <strong>${cliente.nombre}</strong>
              ${cliente.cedula ? `<br><small class="cedula-movil">üÜî ${cliente.cedula}</small>` : ''}
            </td>
            <td data-label="Tel√©fono">
              <a href="tel:+506${cliente.telefono.replace(/\D/g, '')}" class="btn-whatsapp-movil">
                üìû ${cliente.telefono}
              </a>
            </td>
            <td data-label="Monto" class="numero deuda-alta">
              <strong>‚Ç°${cliente.deudaTotal.toLocaleString('es-CR')}</strong>
              ${diasAtraso > 0 ? `<br><small class="badge-atraso">‚è± ${diasAtraso} d√≠as</small>` : ''}
            </td>
            <td data-label="√öltima Compra">
              ${fechaUltima}
              ${diasAtraso > 7 ? '<small class="atraso-alto">üî¥</small>' : ''}
            </td>
            <td data-label="Acciones" class="acciones-movil">
              <div class="grupo-acciones-movil">
                <a href="https://wa.me/506${cliente.telefono.replace(/\D/g, '')}" class="btn-accion-movil whatsapp" title="WhatsApp">
                  üí¨
                </a>
                <button class="btn-accion-movil pagar btn-pagar" data-cliente-id="${cliente.id}" title="Registrar pago">
                  üí∞
                </button>
              </div>
            </td>
          </tr>
        `;
      });
      
      if (clientesFiltrados.length === 0) {
        html += `
          <tr>
            <td colspan="5" class="sin-datos">
              ${clientesConDeuda.length === 0 
                ? 'No hay clientes con saldos pendientes' 
                : 'No hay clientes que coincidan con el filtro'}
            </td>
          </tr>
        `;
      }
      
      html += `
            </tbody>
          </table>
        </div>
        
        <div class="resumen-pie">
          <strong>Total:</strong> ${clientesFiltrados.length} clientes | 
          <strong>‚Ç°${clientesFiltrados.reduce((sum, c) => sum + c.deudaTotal, 0).toLocaleString('es-CR')}</strong> pendientes
        </div>
      `;
      
      contenedor.innerHTML = html;
    }

    // ===============================
    // üìÖ Funciones auxiliares
    // ===============================
    function formatearFecha(fecha) {
      if (!fecha) return 'Sin fecha';
      if (typeof fecha === 'string') fecha = new Date(fecha);
      return fecha.toLocaleDateString('es-CR');
    }
    
    function calcularDiasAtraso(fecha) {
      if (!fecha) return 0;
      if (typeof fecha === 'string') fecha = new Date(fecha);
      const hoy = new Date();
      const diff = hoy - fecha;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }
    
    function mostrarToast(mensaje) {
      const toast = document.getElementById('toast');
      toast.textContent = mensaje;
      toast.className = 'toast show';
      
      setTimeout(() => {
        toast.className = toast.className.replace('show', '');
      }, 3000);
    }

    // ===============================
    // üéõÔ∏è Inicializaci√≥n
    // ===============================
    document.addEventListener('DOMContentLoaded', () => {
      // Eventos m√≥viles
      initEventosMovil();
      
      // Filtro
      document.getElementById('filtro-monto').addEventListener('input', (e) => {
        filtroMinimo = Number(e.target.value.replace(/[^0-9]/g, '')) || 0;
        e.target.value = filtroMinimo || '';
        renderizarReporte();
      });
      
      // Bot√≥n recargar
      document.getElementById('btn-recargar').addEventListener('click', cargarClientesConDeuda);
      
      // Tecla Enter en filtro
      document.getElementById('filtro-monto').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          cargarClientesConDeuda();
        }
      });
      
      // Establecer fecha
      document.getElementById('fecha-actual').textContent = new Date().toLocaleDateString('es-CR');
      
      // Cargar datos
      cargarClientesConDeuda();
      
      // Prevenir zoom en inputs (m√≥vil)
      document.querySelectorAll('input, select, textarea').forEach(input => {
        input.addEventListener('touchstart', function() {
          document.body.style.zoom = '1';
        }, { passive: true });
      });
    });

    // Exponer funciones globales
    window.cargarClientesConDeuda = cargarClientesConDeuda;
    window.abrirPago = abrirPago;
    window.guardarPago = guardarPago;
    window.cerrarModalPago = cerrarModalPago;
    window.mostrarToast = mostrarToast;
  </script>
  <style>
    :root {
      --color-primary: #8B7500;
      --color-secondary: #2E7D32;
      --color-danger: #c62828;
      --color-bg: rgba(255, 255, 255, 0.92);
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.18);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      -webkit-touch-callout: none;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      color: #333;
      padding: 12px;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
      font-size: 16px;
    }
    
    .contenedor-principal {
      max-width: 100%;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 15px;
      padding: 0 8px;
    }
    
    h1 {
      font-size: 1.8rem;
      color: var(--color-danger);
      margin-bottom: 8px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
      line-height: 1.3;
    }
    
    .subtitulo {
      color: #666;
      font-size: 0.95rem;
      margin-bottom: 12px;
    }
    
    .fecha-actual {
      background: rgba(255, 255, 255, 0.85);
      display: inline-block;
      padding: 6px 16px;
      border-radius: 16px;
      font-weight: 600;
      color: var(--color-primary);
      margin-top: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      font-size: 0.95rem;
    }
    
    .panel {
      background: var(--color-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 20px;
      box-shadow: var(--shadow);
      padding: 18px;
      margin-bottom: 20px;
      border: 1px solid rgba(198, 40, 40, 0.25);
      position: relative;
    }
    
    .controles-filtro {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 16px;
      border-left: 3px solid var(--color-danger);
    }
    
    .grupo-filtro {
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 140px;
    }
    
    .grupo-filtro label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    
    .grupo-filtro input {
      padding: 11px 14px;
      border: 2px solid #ddd;
      border-radius: 14px;
      font-size: 1.1rem;
      width: 100%;
      transition: border-color 0.25s;
      font-weight: 600;
      touch-action: manipulation;
    }
    
    .grupo-filtro input:focus {
      border-color: var(--color-danger);
      outline: none;
      box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.2);
    }
    
    .btn-recargar {
      background: var(--color-danger);
      color: white;
      border: none;
      padding: 11px 22px;
      border-radius: 16px;
      font-size: 1.05rem;
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 14px rgba(198, 40, 40, 0.35);
      flex: 1;
      min-width: 140px;
      transition: all 0.2s;
    }
    
    .btn-recargar:active,
    .btn-recargar.activo-touch {
      transform: scale(0.97);
      background: #b71c1c;
    }
    
    .resumen-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    
    .resumen-item {
      background: white;
      padding: 16px;
      border-radius: 16px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      border-top: 3px solid var(--color-danger);
    }
    
    .resumen-item.grande {
      grid-column: span 2;
      background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
    }
    
    .etiqueta {
      display: block;
      color: #777;
      font-size: 0.9rem;
      margin-bottom: 6px;
      font-weight: 500;
    }
    
    .valor {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--color-danger);
      line-height: 1.2;
    }
    
    /* Tabla responsive para m√≥vil */
    .tabla-responsive {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      margin: 10px 0;
    }
    
    .tabla-deuda {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      min-width: 600px;
    }
    
    .tabla-deuda th {
      background: var(--color-danger);
      color: white;
      padding: 12px 10px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      font-size: 0.9rem;
    }
    
    .tabla-deuda td {
      padding: 13px 10px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
      font-size: 0.95rem;
    }
    
    .tabla-deuda tr {
      transition: background-color 0.2s;
    }
    
    .tabla-deuda tr:hover {
      background-color: rgba(255, 245, 245, 0.5);
    }
    
    .tabla-deuda tr:nth-child(even) {
      background-color: rgba(255, 250, 250, 0.3);
    }
    
    .numero {
      text-align: right;
      font-family: 'Courier New', monospace;
      font-weight: 600;
    }
    
    .deuda-alta {
      color: var(--color-danger);
      font-size: 1.05rem;
    }
    
    .badge-atraso {
      background: #ffcdd2;
      color: var(--color-danger);
      padding: 2px 7px;
      border-radius: 9px;
      font-size: 0.8rem;
      font-weight: 600;
      display: inline-block;
      margin-top: 3px;
    }
    
    .atraso-alto {
      color: var(--color-danger);
      font-weight: 700;
      margin-left: 4px;
    }
    
    .btn-whatsapp-movil {
      color: #128C7E;
      text-decoration: none;
      font-weight: 600;
      display: inline-block;
      font-size: 0.95rem;
      line-height: 1.4;
    }
    
    .btn-whatsapp-movil:active {
      color: #075E54;
    }
    
    /* Acciones m√≥viles optimizadas */
    .acciones-movil {
      text-align: center;
      padding: 4px 0 !important;
    }
    
    .grupo-acciones-movil {
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-accion-movil {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      touch-action: manipulation;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .btn-accion-movil:active,
    .btn-accion-movil.activo-touch {
      transform: scale(0.92);
      opacity: 0.85;
    }
    
    .btn-accion-movil.whatsapp {
      background: #25D366;
      color: white;
    }
    
    .btn-accion-movil.pagar {
      background: #FF9800;
      color: white;
    }
    
    .cedula-movil {
      font-size: 0.85rem;
      color: #777;
      display: block;
      margin-top: 3px;
    }
    
    .sin-datos {
      text-align: center;
      padding: 30px 15px;
      color: #999;
      font-style: italic;
      background: rgba(245, 245, 245, 0.6);
      font-size: 1rem;
      font-weight: 500;
      line-height: 1.4;
    }
    
    .resumen-pie {
      background: rgba(255, 245, 245, 0.8);
      padding: 12px;
      border-radius: 14px;
      margin: 15px 0;
      border-left: 3px solid var(--color-danger);
      font-weight: 600;
      color: var(--color-danger);
      font-size: 0.95rem;
      text-align: center;
    }
    
    /* Modal de pago optimizado para m√≥vil */
    #modal-registrar-pago {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.75);
      z-index: 3000;
      justify-content: center;
      align-items: flex-end;
      padding: 20px 0;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      -webkit-overflow-scrolling: touch;
      touch-action: manipulation;
    }
    
    .modal-contenido-pago {
      background: white;
      border-radius: 24px 24px 0 0;
      padding: 24px 20px;
      width: 100%;
      max-width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.35);
      position: relative;
      transform: translateY(0);
      transition: transform 0.3s;
      touch-action: pan-y;
    }
    
    .modal-contenido-pago h3 {
      color: var(--color-danger);
      margin-bottom: 18px;
      text-align: center;
      font-size: 1.7rem;
      font-weight: 700;
    }
    
    .info-cliente-pago {
      background: rgba(255, 245, 245, 0.35);
      padding: 16px;
      border-radius: 16px;
      margin-bottom: 20px;
      border-left: 4px solid var(--color-danger);
    }
    
    .info-cliente-pago p {
      margin: 7px 0;
      font-size: 1.1rem;
      line-height: 1.5;
    }
    
    .info-cliente-pago strong {
      color: var(--color-danger);
      font-size: 1.15rem;
    }
    
    .grupo-formulario {
      margin-bottom: 18px;
    }
    
    .grupo-formulario label {
      display: block;
      margin-bottom: 10px;
      font-weight: 600;
      color: #444;
      font-size: 1.05rem;
    }
    
    .grupo-formulario input,
    .grupo-formulario select,
    .grupo-formulario textarea {
      width: 100%;
      padding: 14px;
      border: 2px solid #ddd;
      border-radius: 16px;
      font-size: 1.25rem;
      transition: border-color 0.25s;
      font-weight: 600;
      touch-action: manipulation;
    }
    
    .grupo-formulario input:focus,
    .grupo-formulario select:focus,
    .grupo-formulario textarea:focus {
      border-color: var(--color-primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(139, 117, 0, 0.25);
    }
    
    .grupo-formulario textarea {
      resize: vertical;
      min-height: 80px;
      font-size: 1.05rem;
      line-height: 1.5;
    }
    
    .botones-modal {
      display: flex;
      gap: 14px;
      justify-content: center;
      margin-top: 15px;
      padding-top: 18px;
      border-top: 2px solid #f0f0f0;
      flex-direction: column;
    }
    
    .btn-modal {
      padding: 16px;
      border: none;
      border-radius: 18px;
      font-size: 1.25rem;
      font-weight: 700;
      cursor: pointer;
      touch-action: manipulation;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      transition: all 0.25s;
      letter-spacing: -0.3px;
    }
    
    #btn-guardar-pago {
      background: var(--color-danger);
      color: white;
      box-shadow: 0 4px 16px rgba(198, 40, 40, 0.4);
    }
    
    #btn-guardar-pago:active,
    #btn-guardar-pago.activo-touch {
      background: #b71c1c;
      transform: scale(0.98);
      box-shadow: 0 2px 10px rgba(198, 40, 40, 0.5);
    }
    
    #btn-cancelar-pago {
      background: #757575;
      color: white;
      box-shadow: 0 4px 16px rgba(117, 117, 117, 0.35);
    }
    
    #btn-cancelar-pago:active,
    #btn-cancelar-pago.activo-touch {
      background: #424242;
      transform: scale(0.98);
      box-shadow: 0 2px 10px rgba(117, 117, 117, 0.45);
    }
    
    /* Loading optimizado */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.94);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2500;
    }
    
    .spinner {
      width: 48px;
      height: 48px;
      border: 5px solid rgba(198, 40, 40, 0.25);
      border-top: 5px solid var(--color-danger);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 18px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 1.4rem;
      color: var(--color-danger);
      font-weight: 700;
      text-align: center;
      padding: 0 20px;
      line-height: 1.4;
    }
    
    /* Toast notifications */
    #toast {
      visibility: hidden;
      min-width: 240px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 16px;
      padding: 14px 20px;
      position: fixed;
      z-index: 4000;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%) translateY(50px);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
      font-size: 1.05rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      max-width: 90%;
      word-wrap: break-word;
    }
    
    #toast.show {
      visibility: visible;
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    /* Media queries mejoradas */
    @media (min-width: 768px) {
      body {
        padding: 20px;
        font-size: 16px;
      }
      
      .panel {
        padding: 25px;
      }
      
      .controles-filtro {
        padding: 15px;
      }
      
      .resumen-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
      }
      
      .resumen-item.grande {
        grid-column: span 2;
      }
      
      .tabla-deuda {
        min-width: auto;
        font-size: 0.98rem;
      }
      
      .tabla-deuda th {
        padding: 14px 12px;
        font-size: 1rem;
      }
      
      .tabla-deuda td {
        padding: 14px 12px;
      }
      
      .btn-accion-movil {
        width: 42px;
        height: 42px;
        font-size: 1.35rem;
      }
      
      #modal-registrar-pago {
        align-items: center;
        padding: 0;
      }
      
      .modal-contenido-pago {
        border-radius: 24px;
        max-width: 520px;
        padding: 32px 30px;
        margin: 20px;
      }
      
      .modal-contenido-pago h3 {
        font-size: 2rem;
        margin-bottom: 25px;
      }
      
      .botones-modal {
        flex-direction: row;
        gap: 20px;
        margin-top: 25px;
        padding-top: 22px;
      }
      
      .btn-modal {
        padding: 15px 28px;
        font-size: 1.15rem;
        width: auto;
      }
    }
    
    @media (min-width: 1024px) {
      .resumen-grid {
        grid-template-columns: repeat(6, 1fr);
      }
      
      .resumen-item.grande {
        grid-column: span 2;
      }
      
      .tabla-deuda th {
        padding: 15px 14px;
      }
      
      .tabla-deuda td {
        padding: 15px 14px;
      }
      
      .btn-recargar {
        flex: 0;
        min-width: auto;
      }
    }
  </style>
</head>
<body>
  <!-- Toast notifications -->
  <div id="toast"></div>
  
  <!-- Loading spinner -->
  <div id="loading">
    <div class="spinner"></div>
    <div class="loading-text">Cargando clientes...</div>
  </div>

  <div class="contenedor-principal">
    <header>
      <h1>üí∞ Clientes con Saldo Pendiente</h1>
      <div class="subtitulo">Gestiona deudas y registra pagos f√°cilmente</div>
      <div class="fecha-actual" id="fecha-actual">Cargando...</div>
    </header>

    <div class="panel">
      <div class="controles-filtro">
        <div class="grupo-filtro">
          <label for="filtro-monto">Monto m√≠nimo (‚Ç°)</label>
          <input type="tel" id="filtro-monto" placeholder="0" inputmode="numeric">
        </div>
        <button id="btn-recargar" class="btn-recargar">
          <span>‚Üª</span> Actualizar
        </button>
      </div>

      <div id="resumen-deuda">
        <div class="resumen-grid">
          <div class="resumen-item grande">
            <span class="etiqueta">Total Deuda</span>
            <span class="valor">‚Ç°0</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">Clientes</span>
            <span class="valor">0</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">Promedio</span>
            <span class="valor">‚Ç°0</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">‚â§ ‚Ç°5k</span>
            <span class="valor">0</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">‚Ç°5k-20k</span>
            <span class="valor">0</span>
          </div>
          <div class="resumen-item">
            <span class="etiqueta">> ‚Ç°20k</span>
            <span class="valor">0</span>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div id="tabla-clientes-deuda">
        <div style="text-align:center; padding:35px 20px; color:#888">
          <div class="spinner" style="margin:0 auto 18px; width:42px; height:42px;"></div>
          <div>Cargando reporte...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Registrar Pago (optimizado para m√≥vil) -->
  <div id="modal-registrar-pago">
    <div class="modal-contenido-pago">
      <h3>üí∞ Registrar Pago</h3>
      
      <div class="info-cliente-pago">
        <p><strong>Cliente:</strong> <span id="pago-cliente-nombre">-</span></p>
        <p><strong>Deuda actual:</strong> <span id="pago-cliente-deuda">‚Ç°0</span></p>
      </div>
      
      <div class="grupo-formulario">
        <label for="pago-monto">Monto a pagar (‚Ç°)</label>
        <input type="tel" id="pago-monto" placeholder="Ingrese monto" inputmode="numeric" autocomplete="off">
      </div>
      
      <div class="grupo-formulario">
        <label for="pago-metodo">M√©todo de Pago</label>
        <select id="pago-metodo">
          <option value="Efectivo">üíµ Efectivo</option>
          <option value="SINPE">üì± SINPE M√≥vil</option>
          <option value="Transferencia">üè¶ Transferencia</option>
          <option value="Tarjeta">üí≥ Tarjeta</option>
        </select>
      </div>
      
      <div class="grupo-formulario">
        <label for="pago-nota">Notas (opcional)</label>
        <textarea id="pago-nota" placeholder="Ej: Referencia, motivo, etc."></textarea>
      </div>
      
      <div class="botones-modal">
        <button id="btn-guardar-pago" class="btn-modal">
          ‚úÖ Registrar Pago
        </button>
        <button id="btn-cancelar-pago" class="btn-modal">
          ‚ùå Cancelar
        </button>
      </div>
    </div>
  </div>

  <script>
    // Polyfill para m√≥viles antiguos
    if (!window.customElements) {
      console.log("Navegador antiguo detectado, cargando polyfills...");
    }
  </script>
</body>
</html>