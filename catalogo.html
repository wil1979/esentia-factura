<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cat√°logo Esentia</title>
  <link rel="icon" href="images/logo.png" sizes="192x192" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="catalogo.css" />

  <!-- Estilos generales -->
  <style>
    .btn-filtro {
      background: #f0f0f0;
      border: 2px solid #ccc;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-filtro:hover { background: #e0e0e0; }

    .btn-filtro.activo {
      background: #6c4ba3;
      color: white;
      border-color: #6c4ba3;
    }

    .modal-carrito {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-contenido {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
      position: relative;
    }

    .producto-card {
      position: relative;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
      z-index: 2000;
    }
  </style>

  <!-- Bottom sheet admin negro/dorado -->
  <style>
    .admin-sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: flex-end;
      align-items: stretch;
      z-index: 1200;
    }

    .admin-sheet {
      background: #050505;
      border-radius: 20px 20px 0 0;
      border-top: 2px solid #d4af37;
      box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.6);
      padding: 16px 20px 22px;
      width: 25%;
      max-height: 65vh;
      animation: adminSheetIn 0.25s ease-out;
    }

    @keyframes adminSheetIn {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .admin-sheet-handle {
      width: 48px;
      height: 4px;
      background: rgba(255, 255, 255, 0.25);
      border-radius: 999px;
      margin: 0 auto 12px;
    }

    .admin-sheet-title {
      color: #f5eec2;
      font-size: 1.05rem;
      margin-bottom: 10px;
      text-align: center;
    }

    .admin-sheet-desc {
      color: #d4af37;
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 16px;
    }

    .admin-sheet-btn {
      width: 100%;
      padding: 10px 14px;
      margin-top: 8px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: linear-gradient(135deg, #d4af37, #b8891e);
      color: #000;
      font-weight: 600;
    }

    .admin-sheet-btn-secondary {
      width: 100%;
      padding: 9px 14px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: transparent;
      color: #f5f5f5;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .admin-dot-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(212, 175, 55, 0.9);
      background: rgba(0, 0, 0, 0.7);
      color: #f5eec2;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 20;
      backdrop-filter: blur(2px);
    }

    .admin-dot-btn:hover {
      background: rgba(18, 18, 18, 0.95);
    }
  </style>

  <!-- LOGIN GLASS OSCURO -->
  <style>
    #modalLoginRegistro {
      backdrop-filter: blur(10px);
      background: rgba(0, 0, 0, 0.65);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1100;
    }

    #modalLoginRegistro .modal-contenido {
      background: radial-gradient(circle at top, rgba(255, 255, 255, 0.22), rgba(10, 10, 10, 0.9));
      backdrop-filter: blur(16px);
      border: 1px solid rgba(212, 175, 55, 0.6);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.65);
      border-radius: 18px !important;
      padding: 24px 22px !important;
      max-width: 380px !important;
      color: #f5eec2;
      animation: glassFadeIn 0.4s ease;
    }

    @keyframes glassFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9) translateY(10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    #modalLoginRegistro h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 12px;
      font-size: 1.4rem;
      letter-spacing: 0.5px;
    }

    .btn-tab {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: transparent;
      color: #f5eec2;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .btn-tab.activo {
      background: linear-gradient(90deg, #b89446, #efd28f);
      color: #000;
      border-color: transparent;
      font-weight: 600;
    }

    #modalLoginRegistro input {
      background: rgba(0, 0, 0, 0.5) !important;
      color: #f5eec2 !important;
      border: 1px solid rgba(255, 255, 255, 0.3) !important;
    }

    #modalLoginRegistro input::placeholder {
      color: rgba(245, 238, 194, 0.7);
    }

    #modalLoginRegistro button {
      background: linear-gradient(90deg, #b89446, #efd28f);
      color: #000 !important;
      font-weight: 600;
      border-radius: 10px !important;
    }

    #loginMensaje {
      color: #ffb3b3 !important;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-left">
      <img src="images/logo.png" alt="Esentia" class="logo">
      <div>
        <h1>Cat√°logo Esentia</h1>
        <p>Fragancias que enamoran</p>
      </div>
    </div>
    <div class="header-right">
      <div id="panelUsuario" style="display:none; align-items:center; gap:10px;">
        <span id="nombreUsuario"></span>
        <button onclick="cerrarSesion()" class="btn-cerrar-sesion">Salir</button>
      </div>
      <button id="btnLogin" onclick="abrirLoginRegistro()" class="btn-login">Iniciar sesi√≥n</button>
    </div>
  </header>

  <main class="contenedor">
    <div id="loader" style="display:flex; justify-content:center; align-items:center; height:300px; color:#6c4ba3; font-size:1.5rem; font-weight:bold;">
      <div style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">‚è≥</div>
        <div>Cargando cat√°logo...</div>
      </div>
    </div>
    <div id="productos-hogar"></div>

    <div style="text-align:center; margin:2rem 0; padding:1.2rem; background:#f9f7ff; border-radius:12px; max-width:600px; margin-left:auto; margin-right:auto;">
      <h3 style="margin-top:0; color:#6c4ba3;">¬øNo encuentras lo que buscas?</h3>
      <button onclick="solicitarAroma()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üå∏ Solicitar un aroma especial
      </button>
      <button onclick="copiarEnlaceRecomendacion()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer;">
        üîó Copiar enlace para recomendar
      </button>
    </div>
  </main>

  <!-- Modal Producto -->
  <div id="modalProducto" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalProducto()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px;">&times;</span>
      <h2 id="modalProductoNombre"></h2>
      <img id="modalProductoImagen" src="" alt="Producto"
           style="width:100%; max-width:280px; height:auto; object-fit:contain; border-radius:8px; margin:10px 0; background:#fff;">
      <p id="modalProductoInfo"></p>
      <p id="modalProductoUso"></p>
      <p id="modalProductoPrecio" style="font-size:1.4rem; font-weight:bold;"></p>
      <div id="selectorVariante"></div>
      <button onclick="agregarAlCarritoDesdeModal()"
              style="display:block; width:100%; padding:10px; margin-top:10px; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üõí Agregar al carrito
      </button>
    </div>
  </div>

  <!-- Modal Carrito -->
  <div id="modalCarrito" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalCarrito()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px;">&times;</span>
      <h2>Tu carrito</h2>
      <ul id="listaCarrito"></ul>
      <p id="totalModal"></p>
      <input type="text" id="codigoPremio" placeholder="C√≥digo de promoci√≥n o premio"
             style="width:100%; padding:8px; margin:10px 0;" />
      <button id="btnAplicarCodigo"
              style="width:100%; padding:8px; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üéÅ Aplicar c√≥digo
      </button>
      <button onclick="finalizarPedido()"
              style="width:100%; padding:10px; margin-top:10px; background:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer;">
        ‚úÖ Finalizar pedido por WhatsApp
      </button>
    </div>
  </div>

  <!-- Modal Login / Registro (glass) -->
  <div id="modalLoginRegistro" class="modal-carrito">
    <div class="modal-contenido">
      <h2>Bienvenido a Esentia</h2>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <button class="btn-tab activo" data-tab="login">Iniciar sesi√≥n</button>
        <button class="btn-tab" data-tab="registro">Registrarse</button>
      </div>

      <form id="formLogin">
        <input type="text" id="loginCedulaTel" placeholder="C√©dula o Tel√©fono" required
               style="width:100%; padding:12px; margin:8px 0; border-radius:8px;">
        <button type="submit" style="width:100%; padding:12px; margin-top:10px;">
          Entrar
        </button>
      </form>

      <form id="formRegistro" style="display:none;">
        <input type="text" id="regNombre" placeholder="Nombre completo" required
               style="width:100%; padding:12px; margin:8px 0; border-radius:8px;">
        <input type="text" id="regCedula" placeholder="C√©dula (opcional)"
               style="width:100%; padding:12px; margin:8px 0; border-radius:8px;">
        <input type="text" id="regTelefono" placeholder="Tel√©fono (opcional)" required
               style="width:100%; padding:12px; margin:8px 0; border-radius:8px;">
        <button type="submit" style="width:100%; padding:12px; margin-top:10px;">
          Registrarme
        </button>
      </form>

      <div id="loginMensaje" style="margin-top:15px; min-height:20px; text-align:center; font-size:0.9rem;"></div>
    </div>
  </div>

  <!-- Bot√≥n flotante del carrito -->
  <button id="botonCarrito" onclick="abrirModalCarrito()" style="
    position:fixed;
    bottom:20px;
    right:20px;
    padding:12px 16px;
    background:#6c4ba3;
    color:white;
    border:none;
    border-radius:50%;
    width:60px;
    height:60px;
    font-size:1.4rem;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    z-index:999;
  ">
    üõí <span id="contadorCarrito">0</span>
  </button>

  <div id="toast" class="toast"></div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      addDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockCollection = collection(db, "stock");

    window.db = db;
    window.firebaseUtils = { query, where, collection, getDocs, addDoc };

    let inventario = {};
    window.inventario = inventario;

    async function cargarInventario() {
      try {
        const snapshot = await getDocs(stockCollection);
        snapshot.forEach(doc => {
          const data = doc.data();
          inventario[data.nombre] = data.cantidad;
        });
        if (typeof intentarRenderizar === "function" && window.catalogoListo) {
          intentarRenderizar();
        }
      } catch (error) {
        console.error("Error cargando inventario:", error);
        if (typeof mostrarErrorCarga === "function") {
          mostrarErrorCarga();
        }
      }
    }

    document.addEventListener("DOMContentLoaded", cargarInventario);
  </script>

  <!-- L√≥gica principal -->
  <script>
    let carrito = [];
    let productos = [];
    let productoSeleccionado = null;
    let codigoAplicado = null;
    let descuentoAplicado = 0;
    let difusorAplicado = null;
    let clienteAutenticado = null;
    window.catalogoListo = false;

    function mostrarToast(mensaje, color = "#4caf50") {
      const t = document.getElementById("toast");
      t.textContent = mensaje;
      t.style.backgroundColor = color;
      t.style.display = "block";
      t.style.opacity = "1";
      setTimeout(() => {
        t.style.transition = "opacity 0.5s";
        t.style.opacity = "0";
        setTimeout(() => {
          t.style.display = "none";
          t.style.transition = "";
        }, 500);
      }, 2000);
    }

    function abrirLoginRegistro() {
      document.getElementById("modalLoginRegistro").style.display = "flex";
    }

    function verificarSesion() {
      const sesion = localStorage.getItem("sesionEsentia");
      if (sesion) {
        clienteAutenticado = JSON.parse(sesion);
        document.getElementById("nombreUsuario").textContent = clienteAutenticado.nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("btnLogin").style.display = "none";
        document.getElementById("modalLoginRegistro").style.display = "none";

        const esAdmin =
          clienteAutenticado.cedula === "110350666" ||
          clienteAutenticado.id === "110350666" ||
          clienteAutenticado.telefono === "110350666";

        if (esAdmin) {
          localStorage.setItem("adminEsentia", "1");
        } else {
          localStorage.removeItem("adminEsentia");
        }

        window.catalogoListo = true;
        intentarRenderizar();
      } else {
        document.getElementById("loader").style.display = "none";
        document.getElementById("modalLoginRegistro").style.display = "flex";
        document.getElementById("btnLogin").style.display = "inline-block";
      }
    }

    function intentarRenderizar() {
      if (window.catalogoListo && Object.keys(inventario).length > 0 && productos.length > 0) {
        renderizarProductos();
      }
    }

    async function cargarProductos() {
      try {
        const resp = await fetch("https://wil1979.github.io/esentia-factura/productos_esentia.json");
        productos = await resp.json();
        intentarRenderizar();
      } catch (error) {
        console.error("Error cargando productos:", error);
        mostrarErrorCarga();
      }
    }

    function mostrarErrorCarga() {
      document.getElementById("loader").style.display = "none";
      const cont = document.getElementById("productos-hogar");
      cont.innerHTML = "<p>Error cargando cat√°logo. Intenta m√°s tarde.</p>";
    }

    function renderizarProductos() {
      const container = document.getElementById("productos-hogar");
      const loader = document.getElementById("loader");
      if (!container || !loader) return;
      loader.style.display = "none";
      container.innerHTML = "";

      const fila = document.createElement("div");
      fila.className = "productos";
      fila.style.display = "flex";
      fila.style.flexWrap = "wrap";
      fila.style.gap = "1.5rem";

      const productosFiltrados = productos.filter(
        p => p.disponible && (inventario[p.nombre] ?? 0) > 0
      );

      if (productosFiltrados.length === 0) {
        const m = document.createElement("p");
        m.textContent = "üì≠ No hay productos disponibles.";
        m.style.textAlign = "center";
        m.style.fontSize = "1.2rem";
        m.style.color = "#666";
        fila.appendChild(m);
      }

      productosFiltrados.forEach(p => {
        const precioFinal = p.precioOferta || p.precio;
        let estrellas = "";
        if (p.calificacion) {
          const llenas = Math.floor(p.calificacion);
          const media = p.calificacion % 1 >= 0.5;
          for (let i = 0; i < llenas; i++) estrellas += "‚≠ê";
          if (media) estrellas += "‚ú®";
          while (estrellas.length < 5) estrellas += "‚òÜ";
        }

        const precioHTML = p.precioOferta
          ? `<p><span class="precio-original">‚Ç°${p.precioOriginal}</span> ‚Ç°${p.precioOferta}</p>`
          : `<p>‚Ç°${p.precio}</p>`;

        const nombreEsc = p.nombre.replace(/'/g, "\\'");
        const infoEsc = (p.info || "").replace(/`/g, "\\`");
        const benefEsc = (p.beneficios || "").replace(/`/g, "\\`");
        const usoEsc = (p.usoRecomendado || "").replace(/`/g, "\\`");

        const div = document.createElement("div");
        div.className = p.precioOferta ? "producto oferta producto-card" : "producto producto-card";
        div.dataset.nombre = p.nombre;
        div.innerHTML = `
          <div style="position:relative;">
            <img src="${p.imagen}" alt="${p.nombre}"
              style="width:100%; max-width:220px; height:220px; object-fit:contain; border-radius:12px; cursor:pointer;"
              onclick="mostrarInfoProducto('${nombreEsc}', ${precioFinal}, '${p.imagen}', \`${infoEsc}\`, \`${benefEsc}\`, \`${usoEsc}\`)">
          </div>
          <h3>${p.nombre}</h3>
          <div class="estrellas">${estrellas}</div>
          ${precioHTML}
          <p class="stock-label">Cargando stock...</p>
          <button class="btn-agregar"
            onclick="mostrarInfoProducto('${nombreEsc}', ${precioFinal}, '${p.imagen}', \`${infoEsc}\`, \`${benefEsc}\`, \`${usoEsc}\`)">
            Ver detalles
          </button>
        `;
        fila.appendChild(div);
      });

      container.appendChild(fila);

      if (typeof actualizarCatalogoConStock === "function") actualizarCatalogoConStock();
      if (localStorage.getItem("adminEsentia") === "1") activarAccionesAdminTarjetas();
    }

    function mostrarInfoProducto(nombre, precio, imagen, info, beneficios, usoRecomendado) {
      document.getElementById("modalProductoNombre").textContent = nombre;
      document.getElementById("modalProductoImagen").src = imagen;
      document.getElementById("modalProductoInfo").textContent = info;
      document.getElementById("modalProductoUso").innerHTML =
        `<strong>‚ú® Beneficios:</strong> ${beneficios}<br><strong>üè† Uso recomendado:</strong> ${usoRecomendado}`;
      document.getElementById("modalProductoPrecio").textContent =
        `‚Ç°${precio.toLocaleString()}`;

      const p = productos.find(x => x.nombre === nombre);
      productoSeleccionado = { ...p };

      const sel = document.getElementById("selectorVariante");
      sel.innerHTML = "";

      if (p.variantes && p.variantes.length > 0) {
        const select = document.createElement("select");
        select.id = "varianteSeleccionada";
        select.style.width = "100%";
        select.style.marginTop = "1rem";
        select.style.padding = "10px";
        select.innerHTML = '<option value="">-- Selecciona una presentaci√≥n --</option>';
        p.variantes.forEach(v => {
          const opt = document.createElement("option");
          opt.value = JSON.stringify(v);
          opt.textContent = `${v.nombre} ‚Äì ‚Ç°${v.precio.toLocaleString()}`;
          select.appendChild(opt);
        });
        sel.appendChild(select);
      }

      document.getElementById("modalProducto").style.display = "flex";
      if (typeof actualizarModalConStock === "function") actualizarModalConStock(nombre);
    }

    function cerrarModalProducto() {
      document.getElementById("modalProducto").style.display = "none";
    }

    function agregarAlCarritoDesdeModal() {
      if (!productoSeleccionado) return;

      let variante = { nombre: "30 ml", precio: 3000 };
      const select = document.getElementById("varianteSeleccionada");
      if (select && select.value) {
        try {
          variante = JSON.parse(select.value);
        } catch {}
      }

      const item = {
        id: productoSeleccionado.imagen.split("/").pop().split(".")[0].toLowerCase(),
        nombre: `${productoSeleccionado.nombre} ${variante.nombre}`,
        precio: variante.precio || 3000,
        cantidad: 1,
        imagen: productoSeleccionado.imagen
      };

      const existente = carrito.find(x => x.id === item.id && x.nombre === item.nombre);
      if (existente) existente.cantidad += 1;
      else carrito.push(item);

      renderCarrito();
      cerrarModalProducto();
      mostrarToast("Producto a√±adido al carrito üõí");
    }

    function abrirModalCarrito() {
      document.getElementById("modalCarrito").style.display = "flex";
    }

    function cerrarModalCarrito() {
      document.getElementById("modalCarrito").style.display = "none";
    }

    function solicitarAroma() {
      const msg = encodeURIComponent(
        "Hola, me gustar√≠a un aroma personalizado para mi hogar. üå∏"
      );
      window.open(`https://wa.me/50672952454?text=${msg}`, "_blank");
    }

    function copiarEnlaceRecomendacion() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        mostrarToast("Enlace copiado para recomendar üíå");
      });
    }

    function cerrarSesion() {
      localStorage.removeItem("sesionEsentia");
      localStorage.removeItem("adminEsentia");
      clienteAutenticado = null;
      carrito = [];
      localStorage.removeItem("carrito");
      renderCarrito();
      codigoAplicado = null;
      descuentoAplicado = 0;
      difusorAplicado = null;

      document.getElementById("panelUsuario").style.display = "none";
      document.getElementById("btnLogin").style.display = "inline-block";
      document.getElementById("loader").style.display = "none";
      document.getElementById("productos-hogar").innerHTML = "";
      document.getElementById("modalLoginRegistro").style.display = "flex";
    }

    // Login
    document.getElementById("formLogin")?.addEventListener("submit", async e => {
      e.preventDefault();
      const valor = document.getElementById("loginCedulaTel").value.trim();
      const msg = document.getElementById("loginMensaje");
      if (!valor) {
        msg.textContent = "Ingresa c√©dula o tel√©fono.";
        return;
      }

      try {
        msg.textContent = "Buscando cliente...";
        const { query, where, collection, getDocs } = window.firebaseUtils;
        const col = collection(window.db, "clientes");
        const q1 = query(col, where("cedula", "==", valor));
        const q2 = query(col, where("telefono", "==", valor));

        const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
        let docSnap = null;

        if (!snap1.empty) docSnap = snap1.docs[0];
        else if (!snap2.empty) docSnap = snap2.docs[0];

        if (!docSnap) {
          msg.textContent = "Cliente no registrado. Usa 'Registrarse'.";
          return;
        }

        const data = docSnap.data();
        clienteAutenticado = {
          id: docSnap.id,
          nombre: data.nombre,
          cedula: data.cedula,
          telefono: data.telefono
        };

        localStorage.setItem("sesionEsentia", JSON.stringify(clienteAutenticado));

        const esAdmin =
          data.cedula === "110350666" ||
          data.telefono === "110350666" ||
          valor === "110350666";

        if (esAdmin) {
          localStorage.setItem("adminEsentia", "1");
        } else {
          localStorage.removeItem("adminEsentia");
        }

        document.getElementById("nombreUsuario").textContent = clienteAutenticado.nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("btnLogin").style.display = "none";
        document.getElementById("modalLoginRegistro").style.display = "none";
        msg.textContent = "";
        document.getElementById("loader").style.display = "flex";
        window.catalogoListo = true;
        setTimeout(intentarRenderizar, 300);
      } catch (err) {
        console.error("Error login:", err);
        msg.textContent = "Error de conexi√≥n.";
      }
    });

    // Registro
    document.getElementById("formRegistro")?.addEventListener("submit", async e => {
      e.preventDefault();
      const nombre = document.getElementById("regNombre").value.trim();
      const cedula = document.getElementById("regCedula").value.trim();
      const telefono = document.getElementById("regTelefono").value.trim();
      const msg = document.getElementById("loginMensaje");

      if (!nombre || !telefono) {
        msg.textContent = "Nombre y tel√©fono son obligatorios.";
        return;
      }

      try {
        msg.textContent = "Registrando...";
        const { collection, addDoc } = window.firebaseUtils;
        const nuevoCliente = {
          nombre: nombre,
          cedula: cedula || "",
          telefono: telefono,
          creado: new Date()
        };
        const ref = await addDoc(collection(window.db, "clientes"), nuevoCliente);
        clienteAutenticado = {
          id: ref.id,
          nombre: nombre,
          cedula: cedula || "",
          telefono: telefono
        };
        localStorage.setItem("sesionEsentia", JSON.stringify(clienteAutenticado));
        document.getElementById("nombreUsuario").textContent = nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("btnLogin").style.display = "none";
        document.getElementById("modalLoginRegistro").style.display = "none";
        msg.textContent = "";
        document.getElementById("loader").style.display = "flex";
        window.catalogoListo = true;
        setTimeout(intentarRenderizar, 300);
      } catch (err) {
        console.error("Error registro:", err);
        msg.textContent = "Error registrando. Intenta de nuevo.";
      }
    });

    // Tabs login/registro
    document.querySelectorAll(".btn-tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".btn-tab").forEach(b => b.classList.remove("activo"));
        btn.classList.add("activo");
        const tab = btn.dataset.tab;
        document.getElementById("formLogin").style.display =
          tab === "login" ? "block" : "none";
        document.getElementById("formRegistro").style.display =
          tab === "registro" ? "block" : "none";
        document.getElementById("loginMensaje").textContent = "";
      });
    });

    // Acciones admin
    let adminProductoActualId = null;

    function activarAccionesAdminTarjetas() {
      const esAdmin = localStorage.getItem("adminEsentia") === "1";
      if (!esAdmin) return;

      const cards = document.querySelectorAll(".producto-card");
      cards.forEach(card => {
        if (card.dataset.adminEnhanced === "1") return;
        const img = card.querySelector("img");
        if (!img) return;
        const src = img.getAttribute("src") || "";
        if (!src) return;
        const file = src.split("/").pop().split(".")[0].toLowerCase();

        const wrapper = img.parentElement;
        if (!wrapper) return;
        if (getComputedStyle(wrapper).position === "static") {
          wrapper.style.position = "relative";
        }

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "admin-dot-btn";
        btn.textContent = "‚ãÆ";
        btn.addEventListener("click", e => {
          e.stopPropagation();
          abrirAdminSheet(file);
        });

        wrapper.appendChild(btn);
        card.dataset.adminEnhanced = "1";
      });
    }

    function abrirAdminSheet(idProducto) {
      adminProductoActualId = idProducto;
      const overlay = document.getElementById("adminSheetOverlay");
      if (!overlay) return;
      overlay.style.display = "flex";
    }

    function cerrarAdminSheet() {
      const overlay = document.getElementById("adminSheetOverlay");
      if (overlay) overlay.style.display = "none";
      adminProductoActualId = null;
    }

    function publicarFacebook(idProducto) {
      if (!idProducto) return;
      const urlProducto = `https://wil1979.github.io/esentia-factura/producto.html?id=${encodeURIComponent(
        idProducto
      )}`;
      const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(
        urlProducto
      )}`;
      window.open(shareUrl, "_blank");
    }

    function publicarFacebookDesdeSheet() {
      if (!adminProductoActualId) return;
      publicarFacebook(adminProductoActualId);
    }

    // Cerrar bottom sheet al tocar fuera
    window.addEventListener("click", e => {
      const overlay = document.getElementById("adminSheetOverlay");
      if (!overlay || overlay.style.display !== "flex") return;
      if (e.target === overlay) {
        cerrarAdminSheet();
      }
    });

    // Aviso al salir si hay productos en carrito
    window.addEventListener("beforeunload", e => {
      try {
        const data = localStorage.getItem("carrito");
        if (!data) return;
        const c = JSON.parse(data);
        if (!Array.isArray(c) || c.length === 0) return;
        const mensaje =
          "Tienes productos en tu carrito. ¬øSeguro que deseas salir sin completar tu compra?";
        e.returnValue = mensaje;
        return mensaje;
      } catch {
        return;
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      cargarCarrito();
      document
        .getElementById("btnAplicarCodigo")
        ?.addEventListener("click", aplicarCodigoPremio);
      verificarSesion();
      cargarProductos(); // üî• importante para que cargue el cat√°logo

      const params = new URLSearchParams(window.location.search);
      if (params.get("added") === "1") {
        setTimeout(() => {
          mostrarToast("Producto a√±adido al carrito üõí");
        }, 600);
      }
    });

    function cargarCarrito() {
      const data = localStorage.getItem("carrito");
      if (data) carrito = JSON.parse(data);
      renderCarrito();
    }

    function renderCarrito() {
      const lista = document.getElementById("listaCarrito");
      const contador = document.getElementById("contadorCarrito");
      const totalModal = document.getElementById("totalModal");

      if (!lista || !contador || !totalModal) return;

      lista.innerHTML = "";
      let total = 0;

      carrito.forEach((item, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span>${item.nombre} (${item.cantidad})</span>
          <strong>‚Ç°${(item.precio * item.cantidad).toLocaleString()}</strong>
        </div>
        <button onclick="eliminarDelCarrito(${index})"
          style="background:#ff5b5b; color:white; border:none; padding:5px 8px; border-radius:6px; margin-top:6px; cursor:pointer;">
          üóë Quitar
        </button>
      `;
        lista.appendChild(li);
        total += item.precio * item.cantidad;
      });

      totalModal.textContent = `Total: ‚Ç°${total.toLocaleString()}`;
      contador.textContent = carrito.length;
      localStorage.setItem("carrito", JSON.stringify(carrito));
    }

    function eliminarDelCarrito(i) {
      carrito.splice(i, 1);
      renderCarrito();
    }

    function aplicarCodigoPremio() {
      const input = document.getElementById("codigoPremio");
      if (!input) return;

      const codigo = input.value.trim().toUpperCase();
      if (!codigo) {
        mostrarToast("Ingresa un c√≥digo v√°lido ‚ùó", "#E74C3C");
        return;
      }

      const codigosValidos = {
        ESENTIA10: { tipo: "porcentaje", valor: 10 },
        ESENTIA20: { tipo: "porcentaje", valor: 20 },
        NAVIDAD: { tipo: "monto", valor: 1500 },
        PREMIO1: { tipo: "monto", valor: 1000 }
      };

      const promo = codigosValidos[codigo];
      if (!promo) {
        mostrarToast("C√≥digo inv√°lido ‚ùå", "#E74C3C");
        return;
      }

      let total = carrito.reduce(
        (sum, item) => sum + item.precio * item.cantidad,
        0
      );

      let descuento = 0;
      if (promo.tipo === "porcentaje") {
        descuento = Math.round(total * (promo.valor / 100));
      } else if (promo.tipo === "monto") {
        descuento = promo.valor;
      }

      total -= descuento;
      if (total < 0) total = 0;

      document.getElementById("totalModal").textContent = `Total con descuento: ‚Ç°${total.toLocaleString()} (-‚Ç°${descuento.toLocaleString()})`;

      mostrarToast(
        `C√≥digo aplicado üéâ Descuento: ‚Ç°${descuento.toLocaleString()}`
      );

      codigoAplicado = codigo;
      descuentoAplicado = descuento;
    }

    // Aqu√≠ deber√≠as tener tu funci√≥n finalizarPedido() original
    function finalizarPedido() {
      if (!clienteAutenticado) {
        mostrarToast("Inicia sesi√≥n para finalizar el pedido", "#E74C3C");
        abrirLoginRegistro();
        return;
      }
      if (!carrito.length) {
        mostrarToast("Tu carrito est√° vac√≠o üõí", "#E74C3C");
        return;
      }

      let mensaje = `Hola Wilber üëã\n\nQuiero hacer un pedido:\n\n`;
      carrito.forEach(item => {
        mensaje += `‚Ä¢ ${item.nombre} x${item.cantidad} ‚Äì ‚Ç°${(item.precio * item.cantidad).toLocaleString()}\n`;
      });
      let total = carrito.reduce(
        (sum, item) => sum + item.precio * item.cantidad,
        0
      );
      if (descuentoAplicado > 0) {
        mensaje += `\nDescuento aplicado: -‚Ç°${descuentoAplicado.toLocaleString()}`;
        total -= descuentoAplicado;
      }
      mensaje += `\n\nTotal a pagar: ‚Ç°${total.toLocaleString()}\n\n`;
      mensaje += `Cliente: ${clienteAutenticado.nombre}\nTel: ${clienteAutenticado.telefono || "No registrado"}`;

      window.open(
        `https://wa.me/50672952454?text=${encodeURIComponent(mensaje)}`,
        "_blank"
      );
    }

    function publicarFacebookOG() {
  if (!adminProductoActualId) return;

  const urlOG = `https://wil1979.github.io/esentia-factura/og/${adminProductoActualId}.html`;
  const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(urlOG)}`;
  window.open(shareUrl, "_blank");
}

function publicarFacebookDirecto() {
  if (!adminProductoActualId) return;

  const urlProducto = `https://wil1979.github.io/esentia-factura/producto.html?id=${encodeURIComponent(adminProductoActualId)}`;
  const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(urlProducto)}`;
  window.open(shareUrl, "_blank");
}

function actualizarCatalogoConStock() {
  const cards = document.querySelectorAll(".producto-card");

  cards.forEach(card => {
    const nombre = card.dataset.nombre;

    // Lectura del stock desde inventario
    const stock = inventario[nombre] ?? 0;

    // Busca la etiqueta donde se muestra el stock
    const label = card.querySelector(".stock-label");

    if (!label) return;

    if (stock > 10) {
      label.textContent = "En stock";
      label.style.color = "#28a745"; // verde
    } else if (stock > 0) {
      label.textContent = `Stock: ${stock}`;
      label.style.color = "#f0ad4e"; // amarillo
    } else {
      label.textContent = "Agotado";
      label.style.color = "#dc3545"; // rojo
      // (Opcional: desactivar bot√≥n si quer√©s)
      const btn = card.querySelector(".btn-agregar");
      if (btn) btn.disabled = true;
    }
  });
}

  </script>

  <!-- Bottom sheet admin -->
 <div id="adminSheetOverlay" class="admin-sheet-overlay">
  <div class="admin-sheet">
    <div class="admin-sheet-handle"></div>
    <div class="admin-sheet-title">Acciones de administrador</div>
    <div class="admin-sheet-desc">Herramientas r√°pidas para este producto.</div>

    <!-- Vista PRO con p√°gina OG -->
    <button type="button" class="admin-sheet-btn" onclick="publicarFacebookOG()">
      <span>üì£</span> <span>Publicar en Facebook (Vista PRO)</span>
    </button>

    <!-- Enlace directo normal al producto -->
    <button type="button" class="admin-sheet-btn-secondary" onclick="publicarFacebookDirecto()">
      üîó Publicar en Facebook (Enlace directo)
    </button>

    <button type="button" class="admin-sheet-btn-secondary" onclick="cerrarAdminSheet()">
      Cancelar
    </button>
  </div>
</div>
</body>
</html>
