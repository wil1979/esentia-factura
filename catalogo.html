<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cat√°logo Esentia</title>
  <link rel="icon" href="images/logo.png" sizes="192x192" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="catalogo.css" />

  <!-- Estilos para botones de filtro -->
  <style>
    .btn-filtro {
      background: #f0f0f0;
      border: 2px solid #ccc;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-filtro:hover {
      background: #e0e0e0;
    }

    .btn-filtro.activo {
      background: #6c4ba3;
      color: white;
      border-color: #6c4ba3;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="images/logo.png" alt="Logo de Esentia" class="logo" />
    </div>
    <h1>üåø Cat√°logo de Productos Esentia</h1>
  </header>

  <main class="contenedor">
    <!-- Loader -->
    <div id="loader" style="display:flex; justify-content:center; align-items:center; height:300px; color:#6c4ba3; font-size:1.5rem; font-weight:bold;">
      <div style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">‚è≥</div>
        <div>Cargando cat√°logo...</div>
      </div>
    </div>

    <!-- Filtros (ocultos hasta que cargue todo) -->
    <div style="text-align:center; margin:1.5rem 0; display:none;" id="filtros-container">
      <button id="btnMostrarDisponibles" class="btn-filtro activo">üì¶ Disponibles</button>
      <button id="btnMostrarTodos" class="btn-filtro">üìö Ver todo el cat√°logo</button>
    </div>

    <!-- Contenedor de productos -->
    <div id="productos-hogar"></div>

    <!-- Secci√≥n: M√°s opciones -->
    <div style="text-align:center; margin:2rem 0; padding:1.2rem; background:#f9f6ff; border-radius:12px; max-width:600px; margin-left:auto; margin-right:auto;">
      <h3 style="margin-top:0; color:#6c4ba3;">¬øNo encuentras lo que buscas?</h3>
      
      <button onclick="solicitarAroma()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üå∏ Solicitar un aroma especial
      </button>

      <button onclick="recomendarPorWhatsApp()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#25D366; color:white; border:none; border-radius:8px; cursor:pointer;">
        üì≤ Recomendar a un amigo por WhatsApp
      </button>

      <button onclick="copiarEnlaceRecomendacion()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer;">
        üîó Copiar enlace para recomendar
      </button>
    </div>
  </main>

  <!-- Modal de Producto -->
  <div id="modalProducto" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalProducto()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px;">&times;</span>
      <h2 id="modalProductoNombre"></h2>
      <img id="modalProductoImagen" src="" alt="Producto">
      <p id="modalProductoInfo"></p>
      <p id="modalProductoUso"></p>
      <p id="modalProductoPrecio" style="font-size:1.2rem; font-weight:bold; color:#6c4ba3;"></p>
      <div id="modalProductoCalificacion"></div>
      <div id="selectorVariante"></div>
      <!-- Stock en modal -->
      <p id="modalProductoStock" style="font-weight:bold; margin-top:5px;"></p>
      <button id="botonAgregarDesdeModal" class="btn-agregar" onclick="agregarDesdeModal()">üõí Agregar al carrito</button>
    </div>
  </div>

  <!-- Modal Carrito -->
  <div id="modalCarrito" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalCarrito()" style="position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer;">&times;</span>
      <h2>üõí Tu Carrito</h2>
      <ul id="listaCarritoModal"></ul>
      <p id="totalModal"><strong>Total:</strong> ‚Ç°0</p>
      <button onclick="finalizarPedido()" style="background:#25D366; color:white; width:100%; padding:10px; margin-top:10px; border-radius:6px;">üì≤ Enviar Pedido por WhatsApp</button>
    </div>
  </div>

  <!-- Bot√≥n flotante del carrito -->
  <button id="botonCarrito" onclick="abrirModalCarrito()">
    üõí <span id="contadorCarrito">0</span>
  </button>

  <!-- Toast -->
  <div id="toast" style="position:fixed; bottom:20px; right:20px; background:#4caf50; color:white; padding:12px 16px; border-radius:6px; display:none; z-index:10000;"></div>

  <!-- üî• Bloque Firebase (para inventario y actualizaci√≥n de stock) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockCollection = collection(db, "stock");

    window.stockCollection = stockCollection;
    let inventario = {};
    window.inventario = inventario;

    async function cargarInventario() {
      try {
        const snapshot = await getDocs(stockCollection);
        snapshot.forEach(doc => {
          const data = doc.data();
          inventario[data.nombre] = data.cantidad;
        });
        if (typeof intentarRenderizar === "function") {
          intentarRenderizar();
        }
      } catch (error) {
        console.error("Error cargando inventario:", error);
        if (typeof mostrarErrorCarga === "function") {
          mostrarErrorCarga();
        }
      }
    }

    window.actualizarCatalogoConStock = function() {
      document.querySelectorAll(".producto-card").forEach(card => {
        const nombre = card.dataset.nombre;
        const stock = inventario[nombre] ?? 0;
        const stockLabel = card.querySelector(".stock-label");
        const boton = card.querySelector(".btn-agregar");
        if (stock > 0) {
          stockLabel.innerHTML = `<span style="color:green;">‚úÖ Disponible: ${stock}</span>`;
          if (boton) boton.disabled = false;
        } else {
          stockLabel.textContent = `‚ùå Agotado`;
          if (boton) boton.disabled = true;
        }
      });
    };

    window.actualizarModalConStock = function(nombre) {
      const stock = inventario[nombre] ?? 0;
      const stockEl = document.getElementById("modalProductoStock");
      const botonModal = document.getElementById("botonAgregarDesdeModal");
      if (stock > 0) {
        stockEl.textContent = `Disponible: ${stock} unidades`;
        botonModal.disabled = false;
      } else {
        stockEl.textContent = `Agotado`;
        botonModal.disabled = true;
      }
    };

    document.addEventListener("DOMContentLoaded", cargarInventario);
  </script>

  <!-- ‚úÖ Script principal integrado -->
  <script>
    let carrito = [];
    let cuponActivo = false;
    let productoSeleccionado = null;
    let productos = [];
    let modoVisualizacion = "disponibles";

    const URL_ESENCIA = "https://wil1979.github.io/esentia-factura/productos_esentia.json";

    fetch(URL_ESENCIA)
      .then(res => res.json())
      .then(data => {
        productos = data;
        intentarRenderizar();
      })
      .catch(err => {
        console.error("Error cargando productos:", err);
        mostrarErrorCarga();
      });

    function renderizarProductos() {
      const container = document.getElementById("productos-hogar");
      const loader = document.getElementById("loader");
      const filtrosContainer = document.getElementById("filtros-container");

      if (!container || !loader) return;

      loader.style.display = "none";
      if (filtrosContainer) filtrosContainer.style.display = "block";

      container.innerHTML = "";

      const fila = document.createElement("div");
      fila.className = "productos";
      fila.style.display = "flex";
      fila.style.flexWrap = "wrap";
      fila.style.gap = "1.5rem";

      const productosFiltrados = productos.filter(producto => {
        if (!producto.disponible) return false;
        if (modoVisualizacion === "disponibles") {
          const stock = inventario[producto.nombre] ?? 0;
          return stock > 0;
        }
        return true;
      });

      if (productosFiltrados.length === 0) {
        const mensaje = document.createElement("p");
        mensaje.textContent = "üì≠ No hay productos disponibles en este filtro.";
        mensaje.style.gridColumn = "1 / -1";
        mensaje.style.textAlign = "center";
        mensaje.style.fontSize = "1.2rem";
        mensaje.style.color = "#666";
        fila.appendChild(mensaje);
      }

      productosFiltrados.forEach(producto => {
        const precioFinal = producto.precioOferta || producto.precio;

        let estrellasHTML = "";
        if (producto.calificacion) {
          const estrellasLlenas = Math.floor(producto.calificacion);
          const mediaEstrella = producto.calificacion % 1 >= 0.5;
          for (let i = 0; i < estrellasLlenas; i++) estrellasHTML += "‚≠ê";
          if (mediaEstrella) estrellasHTML += "‚ú®";
          while (estrellasHTML.length < 5) estrellasHTML += "‚òÜ";
        }

        const precioHTML = producto.precioOferta
          ? `<p><span class="precio-original">‚Ç°${producto.precioOriginal}</span> ‚Ç°${producto.precioOferta}</p>`
          : `<p>‚Ç°${producto.precio}</p>`;

        // Escapar caracteres problem√°ticos para evitar errores de sintaxis
        const nombreEscapado = producto.nombre.replace(/'/g, "\\'");
        const infoEscapada = (producto.info || '').replace(/`/g, "\\`");
        const beneficiosEscapados = (producto.beneficios || '').replace(/`/g, "\\`");
        const usoEscapado = (producto.usoRecomendado || '').replace(/`/g, "\\`");

        const botonHTML = `<button class="btn-agregar" onclick="mostrarInfoProducto(
          '${nombreEscapado}',
          ${precioFinal},
          '${producto.imagen}',
          \`${infoEscapada}\`,
          \`${beneficiosEscapados}\`,
          \`${usoEscapado}\`
        )">Ver detalles</button>`;

        const divProducto = document.createElement("div");
        divProducto.className = producto.precioOferta
          ? "producto oferta producto-card"
          : "producto producto-card";
        divProducto.dataset.nombre = producto.nombre;

        divProducto.innerHTML = `
          <div style="position:relative;">
            <img src="${producto.imagen}" alt="${producto.nombre}"
              onclick="mostrarInfoProducto(
                '${nombreEscapado}',
                ${precioFinal},
                '${producto.imagen}',
                \`${infoEscapada}\`,
                \`${beneficiosEscapados}\`,
                \`${usoEscapado}\`
              )">
          </div>
          <h3>${producto.nombre}</h3>
          <div class="estrellas">${estrellasHTML}</div>
          ${precioHTML}
          <p class="stock-label">Cargando stock...</p>
          ${botonHTML}
        `;

        fila.appendChild(divProducto);
      });

      container.appendChild(fila);

      const btnDisponibles = document.getElementById("btnMostrarDisponibles");
      const btnTodos = document.getElementById("btnMostrarTodos");
      if (btnDisponibles && btnTodos) {
        btnDisponibles.classList.toggle("activo", modoVisualizacion === "disponibles");
        btnTodos.classList.toggle("activo", modoVisualizacion === "todos");
      }

      if (typeof actualizarCatalogoConStock === "function") {
        actualizarCatalogoConStock();
      }
    }

    function mostrarInfoProducto(nombre, precio, imagen, info, beneficios, usoRecomendado) {
      document.getElementById("modalProductoNombre").textContent = nombre;
      document.getElementById("modalProductoImagen").src = imagen;
      document.getElementById("modalProductoInfo").textContent = info;
      document.getElementById("modalProductoUso").innerHTML = `
        <strong>üß† Beneficios:</strong> ${beneficios}<br>
        <strong>üè† Uso recomendado:</strong> ${usoRecomendado}`;

      document.getElementById("modalProductoPrecio").textContent = `‚Ç°${precio.toLocaleString()}`;

      const productoReal = productos.find(p => p.nombre === nombre);
      productoSeleccionado = { ...productoReal };

      const selectorContainer = document.getElementById("selectorVariante");
      selectorContainer.innerHTML = "";

      if (productoReal.variantes && productoReal.variantes.length > 0) {
        const select = document.createElement("select");
        select.id = "varianteSeleccionada";
        select.style.width = "100%";
        select.style.marginTop = "1rem";
        select.style.padding = "10px";

        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- Selecciona una presentaci√≥n --";
        select.appendChild(defaultOption);

        productoReal.variantes.forEach(v => {
          const option = document.createElement("option");
          option.value = JSON.stringify(v);
          option.textContent = `${v.nombre} ‚Äì ‚Ç°${v.precio.toLocaleString()}`;
          select.appendChild(option);
        });

        selectorContainer.appendChild(select);
      }

      const modal = document.getElementById("modalProducto");
      modal.style.display = "flex";

      if (typeof actualizarModalConStock === "function") {
        actualizarModalConStock(nombre);
      }
    }

    function cerrarModalProducto() {
      document.getElementById("modalProducto").style.display = "none";
    }

    function agregarDesdeModal() {
      if (!productoSeleccionado) return;

      const selector = document.getElementById("varianteSeleccionada");
      if (selector && selector.value === "") {
        mostrarToast("‚ö†Ô∏è Selecciona una presentaci√≥n", "#e53935");
        return;
      }

      if (selector && selector.value) {
        const variante = JSON.parse(selector.value);
        agregarCarrito(`${productoSeleccionado.nombre} ${variante.nombre}`, variante.precio);
      } else {
        agregarCarrito(productoSeleccionado.nombre, productoSeleccionado.precio);
      }

      cerrarModalProducto();
    }

    function agregarCarrito(nombre, precio) {
      const itemExistente = carrito.find(item => item.nombre === nombre);
      if (itemExistente) {
        itemExistente.cantidad += 1;
      } else {
        carrito.push({ nombre, precio, cantidad: 1 });
      }
      renderCarrito();
      mostrarToast(`‚úÖ "${nombre}" agregado al carrito`);
    }

    function renderCarrito() {
      const lista = document.getElementById("listaCarritoModal");
      lista.innerHTML = "";
      let total = 0;

      carrito.forEach((item, i) => {
        const subtotal = item.precio * item.cantidad;
        total += subtotal;

        const li = document.createElement("li");
        li.textContent = `${item.nombre} x${item.cantidad} - ‚Ç°${subtotal.toLocaleString()}`;

        const btnQuitar = document.createElement("button");
        btnQuitar.textContent = "‚ùå";
        btnQuitar.onclick = () => {
          carrito.splice(i, 1);
          renderCarrito();
        };

        li.appendChild(btnQuitar);
        lista.appendChild(li);
      });

      document.getElementById("totalModal").textContent = `Total: ‚Ç°${Math.round(total).toLocaleString()}`;
      document.getElementById("contadorCarrito").textContent = carrito.reduce((s, i) => s + i.cantidad, 0);
      localStorage.setItem("carrito", JSON.stringify(carrito));
    }

    function cargarCarrito() {
      const data = localStorage.getItem("carrito");
      if (data) {
        carrito = JSON.parse(data);
        renderCarrito();
      }
    }

    function vaciarCarrito() {
      if (confirm("¬øVaciar todo el carrito?")) {
        carrito = [];
        renderCarrito();
      }
    }

    async function finalizarPedido() {
      if (carrito.length === 0) {
        alert("El carrito est√° vac√≠o");
        return;
      }

      for (const item of carrito) {
        const nombreBase = item.nombre.split(" ")[0];
        const stockActual = inventario[nombreBase] ?? 0;

        if (stockActual < item.cantidad) {
          mostrarToast(`‚ùå No hay suficiente stock de "${nombreBase}"`, "#e53935");
          return;
        }
      }

      let mensaje = "Hola Wilber üëã%0AQuiero hacer el siguiente pedido:%0A%0A";
      let total = 0;

      carrito.forEach(item => {
        const subtotal = item.precio * item.cantidad;
        mensaje += `üß¥ ${item.nombre} x${item.cantidad} - ‚Ç°${subtotal.toLocaleString()}%0A`;
        total += subtotal;
      });

      mensaje += `%0Aüí∞ Total: ‚Ç°${Math.round(total).toLocaleString()}%0A%0A¬°Gracias por tu compra! üåø`;
      window.open(`https://wa.me/50672952454?text=${mensaje}`, "_blank");

      try {
        for (const item of carrito) {
          const nombreBase = item.nombre.split(" ")[0];
          const stockActual = inventario[nombreBase] ?? 0;
          const nuevoStock = stockActual - item.cantidad;

          const querySnapshot = await getDocs(stockCollection);
          const doc = querySnapshot.docs.find(d => d.data().nombre === nombreBase);

          if (doc) {
            await updateDoc(doc.ref, { cantidad: nuevoStock });
            inventario[nombreBase] = nuevoStock;
          } else {
            console.warn(`No se encontr√≥ documento para: ${nombreBase}`);
          }
        }

        if (typeof actualizarCatalogoConStock === "function") {
          actualizarCatalogoConStock();
        }

        carrito = [];
        renderCarrito();
        mostrarToast("‚úÖ Pedido enviado y stock actualizado", "#4caf50");

      } catch (error) {
        console.error("Error actualizando stock:", error);
        mostrarToast("‚ö†Ô∏è Error al actualizar stock. Contacta al administrador.", "#e53935");
      }
    }

    function mostrarToast(mensaje, color = "#4caf50") {
      const toast = document.getElementById("toast");
      toast.textContent = mensaje;
      toast.style.backgroundColor = color;
      toast.style.display = "block";
      toast.style.opacity = "1";

      setTimeout(() => {
        toast.style.transition = "opacity 0.5s";
        toast.style.opacity = "0";
        setTimeout(() => {
          toast.style.display = "none";
          toast.style.transition = "";
        }, 500);
      }, 3000);
    }

    function abrirModalCarrito() {
      renderCarrito();
      document.getElementById("modalCarrito").style.display = "flex";
    }

    function cerrarModalCarrito() {
      document.getElementById("modalCarrito").style.display = "none";
    }

    function intentarRenderizar() {
      if (productos.length > 0 && typeof inventario !== "undefined" && Object.keys(inventario).length > 0) {
        renderizarProductos();
      } else {
        setTimeout(intentarRenderizar, 100);
      }
    }

    function mostrarErrorCarga() {
      const loader = document.getElementById("loader");
      if (loader) {
        loader.innerHTML = `
          <div style="text-align:center;">
            <div style="font-size:3rem; margin-bottom:10px;">‚ö†Ô∏è</div>
            <div>Error al cargar el cat√°logo. Por favor, recarga la p√°gina.</div>
          </div>
        `;
      }
    }

    // ==============================
    // üå∏ NUEVAS FUNCIONES: RECOMENDAR Y SOLICITAR
    // ==============================
    function solicitarAroma() {
      const mensaje = "Hola Wilber üëã%0A%0ANo encontr√© un aroma que busco en el cat√°logo.%0A¬øPodr√≠as ayudarme a conseguirlo?%0A%0A¬°Gracias! üåø";
      window.open(`https://wa.me/50672952454?text=${mensaje}`, "_blank");
    }

    function recomendarPorWhatsApp() {
      const urlCatalogo = encodeURIComponent(window.location.href);
      const mensaje = "¬°Hola! üëã%0AQuiero recomendarte Esentia, una marca con productos naturales y esencias hermosas üåø%0A%0AMira su cat√°logo aqu√≠:%0A" + urlCatalogo + "%0A%0A¬°Vale mucho la pena! üíú";
      window.open(`https://wa.me/?text=${mensaje}`, "_blank");
    }

    function copiarEnlaceRecomendacion() {
      const url = window.location.href;
      navigator.clipboard.writeText(url)
        .then(() => {
          mostrarToast("‚úÖ Enlace copiado. ¬°Comp√°rtelo con quien quieras!", "#4caf50");
        })
        .catch(() => {
          mostrarToast("‚ö†Ô∏è No se pudo copiar el enlace", "#e53935");
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarCarrito();

      const btnDisponibles = document.getElementById("btnMostrarDisponibles");
      const btnTodos = document.getElementById("btnMostrarTodos");

      if (btnDisponibles) {
        btnDisponibles.addEventListener("click", () => {
          modoVisualizacion = "disponibles";
          renderizarProductos();
        });
      }

      if (btnTodos) {
        btnTodos.addEventListener("click", () => {
          modoVisualizacion = "todos";
          renderizarProductos();
        });
      }
    });
  </script>
</body>
</html>
