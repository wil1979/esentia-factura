<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cat√°logo Esentia</title>
  <link rel="icon" href="images/logo.png" sizes="192x192" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="catalogo.css" />

  <!-- Estilos para botones de filtro -->
  <style>
    .btn-filtro {
      background: #f0f0f0;
      border: 2px solid #ccc;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-filtro:hover {
      background: #e0e0e0;
    }

    .btn-filtro.activo {
      background: #6c4ba3;
      color: white;
      border-color: #6c4ba3;
    }

    /* Popup de carrito r√°pido */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-container">
      <img src="images/logo.png" alt="Logo de Esentia" class="logo" />
    </div>
    <h1>üåø Cat√°logo de Productos Esentia</h1>
  </header>

  <main class="contenedor">
    <!-- Loader -->
    <div id="loader" style="display:flex; justify-content:center; align-items:center; height:300px; color:#6c4ba3; font-size:1.5rem; font-weight:bold;">
      <div style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">‚è≥</div>
        <div>Cargando cat√°logo...</div>
      </div>
    </div>

    <!-- Filtros 
    <div style="text-align:center; margin:1.5rem 0; display:none;" id="filtros-container">
      <button id="btnMostrarDisponibles" class="btn-filtro activo">üì¶ Disponibles</button>
      <button id="btnMostrarTodos" class="btn-filtro">üìö Ver todo el cat√°logo</button>
    </div>-->

    <!-- Contenedor de productos -->
    <div id="productos-hogar"></div>

    <!-- Secci√≥n: M√°s opciones -->
    <div style="text-align:center; margin:2rem 0; padding:1.2rem; background:#f9f6ff; border-radius:12px; max-width:600px; margin-left:auto; margin-right:auto;">
      <h3 style="margin-top:0; color:#6c4ba3;">¬øNo encuentras lo que buscas?</h3>
      <button onclick="solicitarAroma()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üå∏ Solicitar un aroma especial
      </button>
      <!--<button onclick="recomendarPorWhatsApp()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#25D366; color:white; border:none; border-radius:8px; cursor:pointer;">
        üì≤ Recomendar a un amigo por WhatsApp
      </button>-->
      <button onclick="copiarEnlaceRecomendacion()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer;">
        üîó Copiar enlace para recomendar
      </button>
    </div>
  </main>  

  <!-- Modal de Producto -->
  <div id="modalProducto" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalProducto()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px;">&times;</span>
      <h2 id="modalProductoNombre"></h2>
      <img id="modalProductoImagen" src="" alt="Producto" style="width:100%; max-height:250px; object-fit:contain; border-radius:8px; margin:10px 0; background:#fff;">
      <p id="modalProductoInfo"></p>
      <p id="modalProductoUso"></p>
      <p id="modalProductoPrecio" style="font-size:1.2rem; font-weight:bold; color:#6c4ba3;"></p>
      <div id="modalProductoCalificacion"></div>
      <div id="selectorVariante"></div>
      <p id="modalProductoStock" style="font-weight:bold; margin-top:5px;"></p>
      <button id="botonAgregarDesdeModal" class="btn-agregar" onclick="agregarDesdeModal()">üõí Agregar al carrito</button>
    </div>
  </div>

  <!-- Modal Carrito -->
  <div id="modalCarrito" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalCarrito()" style="position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer;">&times;</span>
      <h2>üõí Tu Carrito</h2>
      <ul id="listaCarritoModal"></ul>
      <p id="totalModal"><strong>Total:</strong> ‚Ç°0</p>
      <button onclick="finalizarPedido()" style="background:#25D366; color:white; width:100%; padding:10px; margin-top:10px; border-radius:6px;">üì≤ Enviar Pedido por WhatsApp</button>
    </div>
  </div>

  <!-- Bot√≥n flotante del carrito -->
  <button id="botonCarrito" onclick="abrirModalCarrito()">
    üõí <span id="contadorCarrito">0</span>
  </button>

  <!-- Toast -->
  <div id="toast" style="position:fixed; bottom:20px; right:20px; background:#4caf50; color:white; padding:12px 16px; border-radius:6px; display:none; z-index:10000;"></div>

  <!-- Popup de carrito r√°pido -->
  <div id="popupCarritoRapido" style="
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10000;
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    width: 320px;
    max-width: 90vw;
    padding: 16px;
    font-family: var(--fuente-principal);
    animation: fadeInUp 0.4s ease;
  ">
    <div style="display:flex; gap:12px;">
      <img id="popupImagen" src="" alt="Producto" style="width:70px; height:70px; object-fit:contain; border-radius:8px; background:#fff;">
      <div style="flex:1;">
        <h3 id="popupNombre" style="margin:0 0 6px; font-size:1.1rem; color:#333;"></h3>
        <p id="popupPrecio" style="margin:0 0 8px; font-weight:bold; color:#6c4ba3;"></p>
        <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
          <label style="font-size:0.85rem;">Cantidad:</label>
          <input type="number" id="popupCantidad" min="1" value="1" style="width:60px; padding:4px; border:1px solid #ccc; border-radius:4px;">
        </div>
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-top:16px;">
      <button id="popupVerCarrito" style="flex:1; padding:8px; background:#6c4ba3; color:white; border:none; border-radius:6px; cursor:pointer;">
        üõí Ver carrito
      </button>
      <button id="popupCerrar" style="flex:1; padding:8px; background:#ccc; color:#333; border:none; border-radius:6px; cursor:pointer;">
        Cerrar
      </button>
    </div>
  </div>

  <!-- üî• Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockCollection = collection(db, "stock");

    window.stockCollection = stockCollection;
    let inventario = {};
    window.inventario = inventario;

    async function cargarInventario() {
      try {
        const snapshot = await getDocs(stockCollection);
        snapshot.forEach(doc => {
          const data = doc.data();
          inventario[data.nombre] = data.cantidad;
        });
        if (typeof intentarRenderizar === "function") {
          intentarRenderizar();
        }
      } catch (error) {
        console.error("Error cargando inventario:", error);
        if (typeof mostrarErrorCarga === "function") {
          mostrarErrorCarga();
        }
      }
    }

    window.actualizarCatalogoConStock = function() {
      document.querySelectorAll(".producto-card").forEach(card => {
        const nombre = card.dataset.nombre;
        const stock = inventario[nombre] ?? 0;
        const stockLabel = card.querySelector(".stock-label");
        const boton = card.querySelector(".btn-agregar");
        if (stock > 0) {
          stockLabel.innerHTML = `<span style="color:green;">‚úÖ Disponible: ${stock}</span>`;
          if (boton) boton.disabled = false;
        } else {
          stockLabel.textContent = `‚ùå Agotado`;
          if (boton) boton.disabled = true;
        }
      });
    };

    window.actualizarModalConStock = function(nombre) {
      const stock = inventario[nombre] ?? 0;
      const stockEl = document.getElementById("modalProductoStock");
      const botonModal = document.getElementById("botonAgregarDesdeModal");
      if (stock > 0) {
        stockEl.textContent = `Disponible: ${stock} unidades`;
        botonModal.disabled = false;
      } else {
        stockEl.textContent = `Agotado`;
        botonModal.disabled = true;
      }
    };

    document.addEventListener("DOMContentLoaded", cargarInventario);
  </script>

  <!-- ‚úÖ Script principal -->
  <script>
    let carrito = [];
    let productos = [];
    let modoVisualizacion = "disponibles";
    let productoSeleccionado = null;

    const URL_ESENCIA = "https://wil1979.github.io/esentia-factura/productos_esentia.json";

    fetch(URL_ESENCIA)
      .then(res => res.json())
      .then(data => {
        productos = data;
        intentarRenderizar();
      })
      .catch(err => {
        console.error("Error cargando productos:", err);
        mostrarErrorCarga();
      });

    function renderizarProductos() {
      const container = document.getElementById("productos-hogar");
      const loader = document.getElementById("loader");
      const filtrosContainer = document.getElementById("filtros-container");

      if (!container || !loader) return;

      loader.style.display = "none";
      if (filtrosContainer) filtrosContainer.style.display = "block";
      container.innerHTML = "";

      const fila = document.createElement("div");
      fila.className = "productos";
      fila.style.display = "flex";
      fila.style.flexWrap = "wrap";
      fila.style.gap = "1.5rem";

      const productosFiltrados = productos.filter(producto => {
        if (!producto.disponible) return false;
        if (modoVisualizacion === "disponibles") {
          const stock = inventario[producto.nombre] ?? 0;
          return stock > 0;
        }
        return true;
      });

      if (productosFiltrados.length === 0) {
        const mensaje = document.createElement("p");
        mensaje.textContent = "üì≠ No hay productos disponibles en este filtro.";
        mensaje.style.gridColumn = "1 / -1";
        mensaje.style.textAlign = "center";
        mensaje.style.fontSize = "1.2rem";
        mensaje.style.color = "#666";
        fila.appendChild(mensaje);
      }

      productosFiltrados.forEach(producto => {
        const precioFinal = producto.precioOferta || producto.precio;
        let estrellasHTML = "";
        if (producto.calificacion) {
          const llenas = Math.floor(producto.calificacion);
          const media = producto.calificacion % 1 >= 0.5;
          for (let i = 0; i < llenas; i++) estrellasHTML += "‚≠ê";
          if (media) estrellasHTML += "‚ú®";
          while (estrellasHTML.length < 5) estrellasHTML += "‚òÜ";
        }

        const precioHTML = producto.precioOferta
          ? `<p><span class="precio-original">‚Ç°${producto.precioOriginal}</span> ‚Ç°${producto.precioOferta}</p>`
          : `<p>‚Ç°${producto.precio}</p>`;

        const nombreEsc = producto.nombre.replace(/'/g, "\\'");
        const infoEsc = (producto.info || '').replace(/`/g, "\\`");
        const benefEsc = (producto.beneficios || '').replace(/`/g, "\\`");
        const usoEsc = (producto.usoRecomendado || '').replace(/`/g, "\\`");

        const divProducto = document.createElement("div");
        divProducto.className = producto.precioOferta ? "producto oferta producto-card" : "producto producto-card";
        divProducto.dataset.nombre = producto.nombre;

        divProducto.innerHTML = `
          <div style="position:relative;">
            <img src="${producto.imagen}" alt="${producto.nombre}"
              style="width:100%; height:200px; object-fit:contain; margin:18px auto 10px auto; border-radius:8px; background:#fff;"
              onclick="mostrarInfoProducto('${nombreEsc}', ${precioFinal}, '${producto.imagen}', \`${infoEsc}\`, \`${benefEsc}\`, \`${usoEsc}\`)">
          </div>
          <h3>${producto.nombre}</h3>
          <div class="estrellas">${estrellasHTML}</div>
          ${precioHTML}
          <p class="stock-label">Cargando stock...</p>
          <button class="btn-agregar" onclick="mostrarInfoProducto('${nombreEsc}', ${precioFinal}, '${producto.imagen}', \`${infoEsc}\`, \`${benefEsc}\`, \`${usoEsc}\`)">Ver detalles</button>
        `;

        fila.appendChild(divProducto);
      });

      container.appendChild(fila);

      const btnDisponibles = document.getElementById("btnMostrarDisponibles");
      const btnTodos = document.getElementById("btnMostrarTodos");
      if (btnDisponibles && btnTodos) {
        btnDisponibles.classList.toggle("activo", modoVisualizacion === "disponibles");
        btnTodos.classList.toggle("activo", modoVisualizacion === "todos");
      }

      if (typeof actualizarCatalogoConStock === "function") {
        actualizarCatalogoConStock();
      }
    }

    function mostrarInfoProducto(nombre, precio, imagen, info, beneficios, usoRecomendado) {
      document.getElementById("modalProductoNombre").textContent = nombre;
      document.getElementById("modalProductoImagen").src = imagen;
      document.getElementById("modalProductoInfo").textContent = info;
      document.getElementById("modalProductoUso").innerHTML = `
        <strong>üß† Beneficios:</strong> ${beneficios}<br>
        <strong>üè† Uso recomendado:</strong> ${usoRecomendado}`;
      document.getElementById("modalProductoPrecio").textContent = `‚Ç°${precio.toLocaleString()}`;

      const productoReal = productos.find(p => p.nombre === nombre);
      productoSeleccionado = { ...productoReal };

      const selectorContainer = document.getElementById("selectorVariante");
      selectorContainer.innerHTML = "";

      if (productoReal.variantes && productoReal.variantes.length > 0) {
        const select = document.createElement("select");
        select.id = "varianteSeleccionada";
        select.style.width = "100%"; select.style.marginTop = "1rem"; select.style.padding = "10px";
        select.innerHTML = '<option value="">-- Selecciona una presentaci√≥n --</option>';
        productoReal.variantes.forEach(v => {
          const opt = document.createElement("option");
          opt.value = JSON.stringify(v);
          opt.textContent = `${v.nombre} ‚Äì ‚Ç°${v.precio.toLocaleString()}`;
          select.appendChild(opt);
        });
        selectorContainer.appendChild(select);
      }

      document.getElementById("modalProducto").style.display = "flex";
      if (typeof actualizarModalConStock === "function") {
        actualizarModalConStock(nombre);
      }
    }

    function cerrarModalProducto() {
      document.getElementById("modalProducto").style.display = "none";
    }

    function agregarDesdeModal() {
      if (!productoSeleccionado) return;
      const selector = document.getElementById("varianteSeleccionada");
      if (selector && selector.value === "") {
        mostrarToast("‚ö†Ô∏è Selecciona una presentaci√≥n", "#e53935");
        return;
      }

      if (selector && selector.value) {
        const v = JSON.parse(selector.value);
        agregarCarrito(`${productoSeleccionado.nombre} ${v.nombre}`, v.precio, productoSeleccionado.imagen);
      } else {
        agregarCarrito(productoSeleccionado.nombre, productoSeleccionado.precio, productoSeleccionado.imagen);
      }
      cerrarModalProducto();
    }

    // ‚úÖ NUEVA FUNCI√ìN: agregarCarrito con soporte para imagen
    function agregarCarrito(nombre, precio, imagen = '') {
      const existente = carrito.find(item => item.nombre === nombre);
      if (existente) {
        existente.cantidad += 1;
      } else {
        carrito.push({ nombre, precio, cantidad: 1, imagen });
      }
      renderCarrito();
      mostrarPopupCarrito(nombre, precio, imagen); // üåü Mostrar popup
    }

    // ‚úÖ NUEVA FUNCI√ìN: popup al agregar
    function mostrarPopupCarrito(nombre, precio, imagen) {
      const popup = document.getElementById("popupCarritoRapido");
      document.getElementById("popupNombre").textContent = nombre;
      document.getElementById("popupPrecio").textContent = `‚Ç°${precio.toLocaleString()}`;
      document.getElementById("popupImagen").src = imagen || 'https://via.placeholder.com/70?text=Esentia';

      const input = document.getElementById("popupCantidad");
      const item = carrito.find(i => i.nombre === nombre);
      input.value = item ? item.cantidad : 1;

      popup.style.display = "block";

      document.getElementById("popupVerCarrito").onclick = () => {
        popup.style.display = "none";
        abrirModalCarrito();
      };
      document.getElementById("popupCerrar").onclick = () => {
        popup.style.display = "none";
      };

      input.onchange = () => {
        const val = parseInt(input.value) || 1;
        if (val < 1) input.value = 1;
        const it = carrito.find(i => i.nombre === nombre);
        if (it) it.cantidad = val;
        renderCarrito();
      };

      const cerrarFuera = (e) => {
        if (!popup.contains(e.target)) {
          popup.style.display = "none";
          document.removeEventListener("click", cerrarFuera);
        }
      };
      setTimeout(() => document.addEventListener("click", cerrarFuera), 100);
    }

    function renderCarrito() {
      const ul = document.getElementById("listaCarritoModal");
      ul.innerHTML = "";
      let total = 0;
      carrito.forEach((item, i) => {
        const sub = item.precio * item.cantidad;
        total += sub;
        const li = document.createElement("li");
        li.textContent = `${item.nombre} x${item.cantidad} - ‚Ç°${sub.toLocaleString()}`;
        const btn = document.createElement("button");
        btn.textContent = "‚ùå";
        btn.onclick = () => { carrito.splice(i, 1); renderCarrito(); };
        li.appendChild(btn);
        ul.appendChild(li);
      });
      document.getElementById("totalModal").textContent = `Total: ‚Ç°${Math.round(total).toLocaleString()}`;
      document.getElementById("contadorCarrito").textContent = carrito.reduce((s, i) => s + i.cantidad, 0);
      localStorage.setItem("carrito", JSON.stringify(carrito));
    }

    function cargarCarrito() {
      const data = localStorage.getItem("carrito");
      if (data) carrito = JSON.parse(data);
      renderCarrito();
    }

    async function finalizarPedido() {
      if (carrito.length === 0) return alert("El carrito est√° vac√≠o");

      for (const item of carrito) {
        const base = item.nombre.split(" ")[0];
        const stock = inventario[base] ?? 0;
        if (stock < item.cantidad) {
          mostrarToast(`‚ùå No hay suficiente stock de "${base}"`, "#e53935");
          return;
        }
      }

      let msg = "Hola Wilber üëã%0AQuiero hacer el siguiente pedido:%0A%0A";
      let total = 0;
      carrito.forEach(i => {
        const sub = i.precio * i.cantidad;
        msg += `üß¥ ${i.nombre} x${i.cantidad} - ‚Ç°${sub.toLocaleString()}%0A`;
        total += sub;
      });
      msg += `%0Aüí∞ Total: ‚Ç°${Math.round(total).toLocaleString()}%0A%0A¬°Gracias! üåø`;
      window.open(`https://wa.me/50672952454?text=${encodeURIComponent(msg)}`, "_blank");

      try {
        for (const item of carrito) {
          const base = item.nombre.split(" ")[0];
          const nuevo = (inventario[base] ?? 0) - item.cantidad;
          const snap = await getDocs(stockCollection);
          const doc = snap.docs.find(d => d.data().nombre === base);
          if (doc) {
            await updateDoc(doc.ref, { cantidad: nuevo });
            inventario[base] = nuevo;
          }
        }
        if (typeof actualizarCatalogoConStock === "function") actualizarCatalogoConStock();
        carrito = [];
        renderCarrito();
        mostrarToast("‚úÖ Pedido enviado y stock actualizado", "#4caf50");
      } catch (e) {
        console.error("Error:", e);
        mostrarToast("‚ö†Ô∏è Error al actualizar stock", "#e53935");
      }
    }

    function mostrarToast(mensaje, color = "#4caf50") {
      const t = document.getElementById("toast");
      t.textContent = mensaje;
      t.style.backgroundColor = color;
      t.style.display = "block";
      t.style.opacity = "1";
      setTimeout(() => {
        t.style.transition = "opacity 0.5s";
        t.style.opacity = "0";
        setTimeout(() => { t.style.display = "none"; t.style.transition = ""; }, 500);
      }, 3000);
    }

    function abrirModalCarrito() {
      renderCarrito();
      document.getElementById("modalCarrito").style.display = "flex";
    }

    function cerrarModalCarrito() {
      document.getElementById("modalCarrito").style.display = "none";
    }

    function intentarRenderizar() {
      if (productos.length > 0 && typeof inventario !== "undefined" && Object.keys(inventario).length > 0) {
        renderizarProductos();
      } else {
        setTimeout(intentarRenderizar, 100);
      }
    }

    function mostrarErrorCarga() {
      const loader = document.getElementById("loader");
      if (loader) {
        loader.innerHTML = `<div style="text-align:center;"><div style="font-size:3rem; margin-bottom:10px;">‚ö†Ô∏è</div><div>Error al cargar el cat√°logo. Por favor, recarga la p√°gina.</div></div>`;
      }
    }

    // üå∏ Recomendaci√≥n y aromas
    function solicitarAroma() {
      const m = "Hola Wilber üëã%0A%0ANo encontr√© un aroma que busco en el cat√°logo.%0A¬øPodr√≠as ayudarme a conseguirlo?%0A%0A¬°Gracias! üåø";
      window.open(`https://wa.me/50672952454?text=${encodeURIComponent(m)}`, "_blank");
    }

   /* function recomendarPorWhatsApp() {
      const url = encodeURIComponent("https://wil1979.github.io/esentia-factura/catalogo.html");
      const m = "¬°Hola! üëãQuiero recomendarte Esentia, una marca con productos aromaticos y esencias hermosas üåøMira su cat√°logo aqu√≠:" + url + "¬°Vale mucho la pena! üíú";
      window.open(`https://wa.me/?text=${encodeURIComponent(m)}`, "_blank");
    }*/

    function copiarEnlaceRecomendacion() {
      navigator.clipboard.writeText(window.location.href)
        .then(() => mostrarToast("‚úÖ Enlace copiado", "#4caf50"))
        .catch(() => mostrarToast("‚ö†Ô∏è No se pudo copiar", "#e53935"));
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarCarrito();
      document.getElementById("btnMostrarDisponibles")?.addEventListener("click", () => {
        modoVisualizacion = "disponibles"; renderizarProductos();
      });
      document.getElementById("btnMostrarTodos")?.addEventListener("click", () => {
        modoVisualizacion = "todos"; renderizarProductos();
      });
    });
  </script>
</body>
</html>
