<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cat√°logo Esentia</title>
  <link rel="icon" href="images/logo.png" sizes="192x192" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="catalogo.css" />

  <style>
    .btn-filtro {
      background: #f0f0f0;
      border: 2px solid #ccc;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-filtro:hover { background: #e0e0e0; }
    .btn-filtro.activo {
      background: #6c4ba3; color: white; border-color: #6c4ba3;
    }

    .modal-carrito {
      display: none; position: fixed; z-index: 1000; left: 0; top: 0;
      width: 100%; height: 100%; overflow: auto;
      background-color: rgba(0,0,0,0.7);
    }
    .modal-contenido {
      background-color: #fefefe; margin: 5% auto; padding: 20px;
      border: 1px solid #888; width: 90%; max-width: 500px;
      border-radius: 12px; position: relative;
    }

    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* === Modal Login/Registro Glass === */
    .modal-login {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    .modal-login-contenido {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.2);
      padding: 25px;
      border-radius: 16px;
      width: 90%;
      max-width: 400px;
      color: white;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      font-family: 'Segoe UI', sans-serif;
    }
    .btn-tab {
      flex: 1;
      padding: 10px;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-tab.activo {
      background: #6c4ba3;
      border-color: #6c4ba3;
    }
    .modal-login input, .modal-login button {
      font-family: 'Segoe UI', sans-serif;
    }
  </style>
</head>
<body>
  <header style="position:relative; padding-right:160px; box-sizing:border-box;">
    <div class="logo-container">
      <img src="images/logo.png" alt="Logo de Esentia" class="logo" />
    </div>
    <h1>üåø Cat√°logo de Productos Esentia</h1>
    
    <!-- Panel de usuario (nombre + cerrar sesi√≥n) -->
    <div id="panelUsuario" style="display:none; position:absolute; top:12px; right:15px; 
          background:rgba(255,255,255,0.12); backdrop-filter:blur(10px); 
          border:1px solid rgba(255,255,255,0.2); border-radius:24px; 
          padding:6px 12px; color:white; font-size:0.95rem; z-index:10;
          display:flex; align-items:center; gap:8px;">
      <span id="nombreUsuario" style="font-weight:600;"></span>
      <button onclick="cerrarSesion()" 
              style="background:transparent; border:none; color:white; cursor:pointer; 
                     font-size:1.2rem; width:24px; height:24px; display:flex; align-items:center; justify-content:center;">
        &times;
      </button>
    </div>
  </header>

  <main class="contenedor">
    <div id="loader" style="display:flex; justify-content:center; align-items:center; height:300px; color:#6c4ba3; font-size:1.5rem; font-weight:bold;">
      <div style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">‚è≥</div>
        <div>Cargando cat√°logo...</div>
      </div>
    </div>
    <div id="productos-hogar"></div>

    <div style="text-align:center; margin:2rem 0; padding:1.2rem; background:#f9f6ff; border-radius:12px; max-width:600px; margin-left:auto; margin-right:auto;">
      <h3 style="margin-top:0; color:#6c4ba3;">¬øNo encuentras lo que buscas?</h3>
      <button onclick="solicitarAroma()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üå∏ Solicitar un aroma especial
      </button>
      <button onclick="copiarEnlaceRecomendacion()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer;">
        üîó Copiar enlace para recomendar
      </button>
    </div>
  </main>  

  <!-- Modal Producto -->
  <div id="modalProducto" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalProducto()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px;">&times;</span>
      <h2 id="modalProductoNombre"></h2>
      <img id="modalProductoImagen" src="" alt="Producto" style="width:100%; max-height:250px; object-fit:contain; border-radius:8px; margin:10px 0; background:#fff;">
      <p id="modalProductoInfo"></p>
      <p id="modalProductoUso"></p>
      <p id="modalProductoPrecio" style="font-size:1.2rem; font-weight:bold; color:#6c4ba3;"></p>
      <div id="modalProductoCalificacion"></div>
      <div id="selectorVariante"></div>
      <p id="modalProductoStock" style="font-weight:bold; margin-top:5px;"></p>
      <button id="botonAgregarDesdeModal" class="btn-agregar" onclick="agregarDesdeModal()">üõí Agregar al carrito</button>
    </div>
  </div>

  <!-- Modal Carrito -->
  <div id="modalCarrito" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalCarrito()" style="position:absolute; top:10px; right:15px; font-size:22px; cursor:pointer;">&times;</span>
      <h2>üõí Tu Carrito</h2>
      <ul id="listaCarritoModal"></ul>

      <div style="margin:15px 0; padding:12px; background:#f0f8ff; border-radius:8px;">
        <label for="inputCodigo" style="display:block; margin-bottom:6px; font-weight:bold; color:#1a3a6c;">
          ¬øTienes un c√≥digo de premio?
        </label>
        <input type="text" id="inputCodigo" placeholder="Ej: ES-1234-10PCT-AB12" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px; margin-bottom:8px;">
        <button id="btnAplicarCodigo" style="width:100%; padding:8px; background:#4caf50; color:white; border:none; border-radius:6px; cursor:pointer;">
          Aplicar c√≥digo
        </button>
        <div id="mensajeCodigo" style="margin-top:8px; font-size:0.9rem; min-height:20px;"></div>
      </div>

      <p id="totalModal"><strong>Total:</strong> ‚Ç°0</p>
      <button onclick="finalizarPedido()" style="background:#25D366; color:white; width:100%; padding:10px; margin-top:10px; border-radius:6px;">üì≤ Enviar Pedido por WhatsApp</button>
    </div>
  </div>

  <!-- Modal Login/Registro -->
  <div id="modalLoginRegistro" class="modal-login">
    <div class="modal-login-contenido">
      <h2 style="text-align:center; margin-top:0; color:#6c4ba3;">üë§ Bienvenido a Esentia</h2>
      <p style="text-align:center; margin-bottom:20px; color:#ddd;">
        Inicia sesi√≥n o reg√≠strate para acceder al cat√°logo
      </p>

      <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button class="btn-tab activo" data-tab="login">Iniciar sesi√≥n</button>
        <button class="btn-tab" data-tab="registro">Registrarse</button>
      </div>

      <form id="formLogin">
        <input type="text" id="loginCedulaTel" placeholder="C√©dula o Tel√©fono" required
          style="width:100%; padding:12px; margin:8px 0; border:1px solid rgba(255,255,255,0.3); border-radius:8px; background:rgba(255,255,255,0.9);">
        <button type="submit" style="width:100%; padding:12px; background:#6c4ba3; color:white; border:none; border-radius:8px; margin-top:10px;">
          Entrar
        </button>
      </form>

      <form id="formRegistro" style="display:none;">
        <input type="text" id="regNombre" placeholder="Nombre completo" required
          style="width:100%; padding:12px; margin:8px 0; border:1px solid rgba(255,255,255,0.3); border-radius:8px; background:rgba(255,255,255,0.9);">
        <input type="text" id="regCedula" placeholder="C√©dula (opcional)"
          style="width:100%; padding:12px; margin:8px 0; border:1px solid rgba(255,255,255,0.3); border-radius:8px; background:rgba(255,255,255,0.9);">
        <input type="text" id="regTelefono" placeholder="Tel√©fono (opcional)" required
          style="width:100%; padding:12px; margin:8px 0; border:1px solid rgba(255,255,255,0.3); border-radius:8px; background:rgba(255,255,255,0.9);">
        <button type="submit" style="width:100%; padding:12px; background:#4caf50; color:white; border:none; border-radius:8px; margin-top:10px;">
          Registrarme
        </button>
      </form>

      <div id="loginMensaje" style="margin-top:15px; min-height:20px; text-align:center; font-size:0.9rem; color:#ffcccb;"></div>
    </div>
  </div>

  <!-- Bot√≥n flotante del carrito (AJUSTADO M√ÅS ABAJO) -->
  <button id="botonCarrito" onclick="abrirModalCarrito()" style="
    position:sticky; bottom:450px; right:120px; 
    padding:12px 16px; background:#6c4ba3; color:white; border:none; 
    border-radius:50%; width:60px; height:60px; font-size:1.4rem; 
    box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index:999;
  ">
    üõí <span id="contadorCarrito">0</span>
  </button>

  <div id="toast" style="position:fixed; bottom:20px; right:20px; background:#4caf50; color:white; padding:12px 16px; border-radius:6px; display:none; z-index:10000;"></div>

  <div id="popupCarritoRapido" style="display:none; position:fixed; bottom:20px; right:20px; z-index:10000; background:white; border-radius:12px; box-shadow:0 6px 20px rgba(0,0,0,0.2); width:320px; max-width:90vw; padding:16px; animation:fadeInUp 0.4s ease;">
    <div style="display:flex; gap:12px;">
      <img id="popupImagen" src="" alt="Producto" style="width:70px; height:70px; object-fit:contain; border-radius:8px; background:#fff;">
      <div style="flex:1;">
        <h3 id="popupNombre" style="margin:0 0 6px; font-size:1.1rem; color:#333;"></h3>
        <p id="popupPrecio" style="margin:0 0 8px; font-weight:bold; color:#6c4ba3;"></p>
        <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
          <label style="font-size:0.85rem;">Cantidad:</label>
          <input type="number" id="popupCantidad" min="1" value="1" style="width:60px; padding:4px; border:1px solid #ccc; border-radius:4px;">
        </div>
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-top:16px;">
      <button id="popupVerCarrito" style="flex:1; padding:8px; background:#6c4ba3; color:white; border:none; border-radius:6px; cursor:pointer;">üõí Ver carrito</button>
      <button id="popupCerrar" style="flex:1; padding:8px; background:#ccc; color:#333; border:none; border-radius:6px; cursor:pointer;">Cerrar</button>
    </div>
  </div>

  <!-- üî• Firebase (M√≥dulo) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs, updateDoc, doc,
      query, where, addDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockCollection = collection(db, "stock");

    window.db = db;
    window.firebaseUtils = { query, where, collection, getDocs, updateDoc, doc, addDoc };
    window.stockCollection = stockCollection;

    let inventario = {};
    window.inventario = inventario;

    async function cargarInventario() {
      try {
        const snapshot = await getDocs(stockCollection);
        snapshot.forEach(doc => {
          const data = doc.data();
          inventario[data.nombre] = data.cantidad;
        });
        if (typeof intentarRenderizar === "function" && window.catalogoListo) {
          intentarRenderizar();
        }
      } catch (error) {
        console.error("Error cargando inventario:", error);
        if (typeof mostrarErrorCarga === "function") {
          mostrarErrorCarga();
        }
      }
    }

    window.actualizarCatalogoConStock = function() {
      document.querySelectorAll(".producto-card").forEach(card => {
        const nombre = card.dataset.nombre;
        const stock = inventario[nombre] ?? 0;
        const stockLabel = card.querySelector(".stock-label");
        const boton = card.querySelector(".btn-agregar");
        if (stock > 0) {
          stockLabel.innerHTML = `<span style="color:green;">‚úÖ Disponible: ${stock}</span>`;
          if (boton) boton.disabled = false;
        } else {
          stockLabel.textContent = `‚ùå Agotado`;
          if (boton) boton.disabled = true;
        }
      });
    };

    window.actualizarModalConStock = function(nombre) {
      const stock = inventario[nombre] ?? 0;
      const stockEl = document.getElementById("modalProductoStock");
      const botonModal = document.getElementById("botonAgregarDesdeModal");
      if (stock > 0) {
        stockEl.textContent = `Disponible: ${stock} unidades`;
        botonModal.disabled = false;
      } else {
        stockEl.textContent = `Agotado`;
        botonModal.disabled = true;
      }
    };

    document.addEventListener("DOMContentLoaded", cargarInventario);
  </script>

  <script>
    let carrito = [];
    let productos = [];
    let productoSeleccionado = null;
    let codigoAplicado = null;
    let descuentoAplicado = 0;
    let difusorAplicado = null;
    let clienteAutenticado = null;

    const URL_ESENCIA = "https://wil1979.github.io/esentia-factura/productos_esentia.json";

    // === SESI√ìN Y LOGIN ===
    function verificarSesion() {
      const sesion = localStorage.getItem("sesionEsentia");
      if (sesion) {
        clienteAutenticado = JSON.parse(sesion);
        document.getElementById("nombreUsuario").textContent = clienteAutenticado.nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("modalLoginRegistro").style.display = "none";
        window.catalogoListo = true;
        if (typeof intentarRenderizar === "function") {
          intentarRenderizar();
        }
      } else {
        document.getElementById("loader").style.display = "none";
        document.getElementById("modalLoginRegistro").style.display = "flex";
      }
    }

    function cerrarSesion() {
      localStorage.removeItem("sesionEsentia");
      clienteAutenticado = null;
      carrito = [];
      localStorage.removeItem("carrito");
      renderCarrito();
      codigoAplicado = null;
      descuentoAplicado = 0;
      difusorAplicado = null;
      document.getElementById("panelUsuario").style.display = "none";
      document.getElementById("modalLoginRegistro").style.display = "flex";
      document.getElementById("loader").style.display = "none";
      document.getElementById("productos-hogar").innerHTML = "";
      document.querySelectorAll(".btn-tab").forEach(b => b.classList.remove("activo"));
      document.querySelector(".btn-tab[data-tab='login']").classList.add("activo");
      document.getElementById("formLogin").style.display = "block";
      document.getElementById("formRegistro").style.display = "none";
      document.getElementById("loginMensaje").textContent = "";
    }

    document.querySelectorAll(".btn-tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".btn-tab").forEach(b => b.classList.remove("activo"));
        btn.classList.add("activo");
        const tab = btn.dataset.tab;
        document.getElementById("formLogin").style.display = tab === "login" ? "block" : "none";
        document.getElementById("formRegistro").style.display = tab === "registro" ? "block" : "none";
        document.getElementById("loginMensaje").textContent = "";
      });
    });

    // Login
    document.getElementById("formLogin")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const valor = document.getElementById("loginCedulaTel").value.trim();
      const msg = document.getElementById("loginMensaje");
      if (!valor) {
        msg.textContent = "Ingresa c√©dula o tel√©fono.";
        return;
      }

      try {
        msg.textContent = "Buscando cliente...";
        const { query, where, collection, getDocs } = window.firebaseUtils;
        const col = collection(window.db, "clientes");
        const q1 = query(col, where("cedula", "==", valor));
        const q2 = query(col, where("telefono", "==", valor));

        const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
        let docSnap = null;

        if (!snap1.empty) {
          docSnap = snap1.docs[0];
        } else if (!snap2.empty) {
          docSnap = snap2.docs[0];
        }

        if (!docSnap) {
          msg.textContent = "Cliente no registrado. Usa 'Registrarse'.";
          return;
        }

        const data = docSnap.data();
        clienteAutenticado = {
          id: docSnap.id,
          nombre: data.nombre,
          cedula: data.cedula,
          telefono: data.telefono
        };

        localStorage.setItem("sesionEsentia", JSON.stringify(clienteAutenticado));
        document.getElementById("nombreUsuario").textContent = clienteAutenticado.nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("modalLoginRegistro").style.display = "none";
        msg.textContent = "";
        document.getElementById("loader").style.display = "flex";
        window.catalogoListo = true;
        setTimeout(intentarRenderizar, 300);

      } catch (err) {
        console.error("Error login:", err);
        msg.textContent = "Error de conexi√≥n.";
      }
    });

    // Registro
    document.getElementById("formRegistro")?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const nombre = document.getElementById("regNombre").value.trim();
      const cedula = document.getElementById("regCedula").value.trim();
      const telefono = document.getElementById("regTelefono").value.trim();
      const msg = document.getElementById("loginMensaje");

      if (!nombre || !telefono) {
        msg.textContent = "Nombre y tel√©fono son obligatorios.";
        return;
      }

      try {
        msg.textContent = "Registrando...";
        const { collection, addDoc } = window.firebaseUtils;
        const nuevoCliente = {
          nombre: nombre,
          cedula: cedula || null,
          telefono: telefono,
          fechaRegistro: new Date(),
          yaParticipo: false,
          premioObtenido: null,
          codigoCanje: null,
          codigoUsado: false
        };

        const docRef = await addDoc(collection(window.db, "clientes"), nuevoCliente);
        clienteAutenticado = { id: docRef.id, ...nuevoCliente };
        localStorage.setItem("sesionEsentia", JSON.stringify({
          id: docRef.id,
          nombre: nombre,
          cedula: cedula || null,
          telefono: telefono
        }));
        document.getElementById("nombreUsuario").textContent = nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("modalLoginRegistro").style.display = "none";
        msg.textContent = "";
        document.getElementById("loader").style.display = "flex";
        window.catalogoListo = true;
        setTimeout(intentarRenderizar, 300);

      } catch (err) {
        console.error("Error registro:", err);
        msg.textContent = "Error al registrar.";
      }
    });

    // === FUNCIONES DEL CAT√ÅLOGO ===
    fetch(URL_ESENCIA)
      .then(res => res.json())
      .then(data => {
        productos = data;
        if (clienteAutenticado) {
          window.catalogoListo = true;
          intentarRenderizar();
        }
      })
      .catch(err => {
        console.error("Error cargando productos:", err);
        mostrarErrorCarga();
      });

    function renderizarProductos() {
      const container = document.getElementById("productos-hogar");
      const loader = document.getElementById("loader");
      if (!container || !loader) return;
      loader.style.display = "none";
      container.innerHTML = "";
      const fila = document.createElement("div");
      fila.className = "productos";
      fila.style.display = "flex"; fila.style.flexWrap = "wrap"; fila.style.gap = "1.5rem";
      const productosFiltrados = productos.filter(p => p.disponible && (inventario[p.nombre] ?? 0) > 0);
      if (productosFiltrados.length === 0) {
        const m = document.createElement("p");
        m.textContent = "üì≠ No hay productos disponibles.";
        m.style.textAlign = "center"; m.style.fontSize = "1.2rem"; m.style.color = "#666";
        fila.appendChild(m);
      }
      productosFiltrados.forEach(p => {
        const precioFinal = p.precioOferta || p.precio;
        let estrellas = "";
        if (p.calificacion) {
          const llenas = Math.floor(p.calificacion);
          const media = p.calificacion % 1 >= 0.5;
          for (let i = 0; i < llenas; i++) estrellas += "‚≠ê";
          if (media) estrellas += "‚ú®";
          while (estrellas.length < 5) estrellas += "‚òÜ";
        }
        const precioHTML = p.precioOferta
          ? `<p><span class="precio-original">‚Ç°${p.precioOriginal}</span> ‚Ç°${p.precioOferta}</p>`
          : `<p>‚Ç°${p.precio}</p>`;
        const nombreEsc = p.nombre.replace(/'/g, "\\'");
        const infoEsc = (p.info || '').replace(/`/g, "\\`");
        const benefEsc = (p.beneficios || '').replace(/`/g, "\\`");
        const usoEsc = (p.usoRecomendado || '').replace(/`/g, "\\`");
        const div = document.createElement("div");
        div.className = p.precioOferta ? "producto oferta producto-card" : "producto producto-card";
        div.dataset.nombre = p.nombre;
        div.innerHTML = `
          <div style="position:relative;">
            <img src="${p.imagen}" alt="${p.nombre}" style="width:100%; height:200px; object-fit:contain; margin:18px auto 10px auto; border-radius:8px; background:#fff;" onclick="mostrarInfoProducto('${nombreEsc}', ${precioFinal}, '${p.imagen}', \`${infoEsc}\`, \`${benefEsc}\`, \`${usoEsc}\`)">
          </div>
          <h3>${p.nombre}</h3>
          <div class="estrellas">${estrellas}</div>
          ${precioHTML}
          <p class="stock-label">Cargando stock...</p>
          <button class="btn-agregar" onclick="mostrarInfoProducto('${nombreEsc}', ${precioFinal}, '${p.imagen}', \`${infoEsc}\`, \`${benefEsc}\`, \`${usoEsc}\`)">Ver detalles</button>
        `;
        fila.appendChild(div);
      });
      container.appendChild(fila);
      if (typeof actualizarCatalogoConStock === "function") actualizarCatalogoConStock();
    }

    function mostrarInfoProducto(nombre, precio, imagen, info, beneficios, usoRecomendado) {
      document.getElementById("modalProductoNombre").textContent = nombre;
      document.getElementById("modalProductoImagen").src = imagen;
      document.getElementById("modalProductoInfo").textContent = info;
      document.getElementById("modalProductoUso").innerHTML = `<strong>üß† Beneficios:</strong> ${beneficios}<br><strong>üè† Uso recomendado:</strong> ${usoRecomendado}`;
      document.getElementById("modalProductoPrecio").textContent = `‚Ç°${precio.toLocaleString()}`;
      const p = productos.find(x => x.nombre === nombre);
      productoSeleccionado = { ...p };
      const sel = document.getElementById("selectorVariante");
      sel.innerHTML = "";
      if (p.variantes && p.variantes.length > 0) {
        const select = document.createElement("select");
        select.id = "varianteSeleccionada";
        select.style.width = "100%"; select.style.marginTop = "1rem"; select.style.padding = "10px";
        select.innerHTML = '<option value="">-- Selecciona una presentaci√≥n --</option>';
        p.variantes.forEach(v => {
          const opt = document.createElement("option");
          opt.value = JSON.stringify(v);
          opt.textContent = `${v.nombre} ‚Äì ‚Ç°${v.precio.toLocaleString()}`;
          select.appendChild(opt);
        });
        sel.appendChild(select);
      }
      document.getElementById("modalProducto").style.display = "flex";
      if (typeof actualizarModalConStock === "function") actualizarModalConStock(nombre);
    }

    function cerrarModalProducto() {
      document.getElementById("modalProducto").style.display = "none";
    }

    function agregarDesdeModal() {
      if (!productoSeleccionado) return;
      const sel = document.getElementById("varianteSeleccionada");
      if (sel && sel.value === "") {
        mostrarToast("‚ö†Ô∏è Selecciona una presentaci√≥n", "#e53935");
        return;
      }
      if (sel && sel.value) {
        const v = JSON.parse(sel.value);
        agregarCarrito(`${productoSeleccionado.nombre} ${v.nombre}`, v.precio, productoSeleccionado.imagen);
      } else {
        agregarCarrito(productoSeleccionado.nombre, productoSeleccionado.precio, productoSeleccionado.imagen);
      }
      cerrarModalProducto();
    }

    function agregarCarrito(nombre, precio, imagen = '') {
      const existente = carrito.find(i => i.nombre === nombre);
      if (existente) {
        existente.cantidad += 1;
      } else {
        carrito.push({ nombre, precio, cantidad: 1, imagen });
      }
      renderCarrito();
      mostrarPopupCarrito(nombre, precio, imagen);
    }

    function mostrarPopupCarrito(nombre, precio, imagen) {
      const popup = document.getElementById("popupCarritoRapido");
      document.getElementById("popupNombre").textContent = nombre;
      document.getElementById("popupPrecio").textContent = `‚Ç°${precio.toLocaleString()}`;
      document.getElementById("popupImagen").src = imagen || 'https://via.placeholder.com/70?text=Esentia';
      const input = document.getElementById("popupCantidad");
      const item = carrito.find(i => i.nombre === nombre);
      input.value = item ? item.cantidad : 1;
      popup.style.display = "block";
      document.getElementById("popupVerCarrito").onclick = () => { popup.style.display = "none"; abrirModalCarrito(); };
      document.getElementById("popupCerrar").onclick = () => { popup.style.display = "none"; };
      input.onchange = () => {
        const val = parseInt(input.value) || 1;
        if (val < 1) input.value = 1;
        const it = carrito.find(i => i.nombre === nombre);
        if (it) it.cantidad = val;
        renderCarrito();
      };
      const cerrar = (e) => { if (!popup.contains(e.target)) { popup.style.display = "none"; document.removeEventListener("click", cerrar); } };
      setTimeout(() => document.addEventListener("click", cerrar), 100);
    }

    function aplicarCodigoPremio() {
      const codigo = document.getElementById("inputCodigo").value.trim().toUpperCase();
      if (!codigo) {
        document.getElementById("mensajeCodigo").innerHTML = "‚ö†Ô∏è Ingresa un c√≥digo.";
        return;
      }
      aplicarCodigoDirectoSinLogin(codigo);
    }

    async function aplicarCodigoDirectoSinLogin(codigo) {
      const mensaje = document.getElementById("mensajeCodigo");
      try {
        const { query, where, collection, getDocs, updateDoc, doc } = window.firebaseUtils;
        const q = query(collection(window.db, "clientes"), where("codigoCanje", "==", codigo));
        const snap = await getDocs(q);
        if (snap.empty) {
          mensaje.innerHTML = "‚ùå C√≥digo no v√°lido.";
          mensaje.style.color = "#e53935";
          return;
        }
        const docSnap = snap.docs[0];
        const clienteData = docSnap.data();
        const docRef = docSnap.ref;

        if (clienteData.codigoUsado) {
          mensaje.innerHTML = "‚ö†Ô∏è C√≥digo ya usado.";
          mensaje.style.color = "#e53935";
          return;
        }

        const premio = clienteData.premioObtenido;
        if (premio.includes("5%")) {
          descuentoAplicado = 0.05;
        } else if (premio.includes("10%")) {
          descuentoAplicado = 0.10;
        } else if (premio.includes("50%")) {
          descuentoAplicado = 0.50;
        } else if (premio.includes("Difusor")) {
          const difusores = productos.filter(p => p.nombre.toLowerCase().includes("difusor") && (inventario[p.nombre] ?? 0) > 0);
          if (difusores.length === 0) {
            mensaje.innerHTML = "‚ùå No hay difusores.";
            mensaje.style.color = "#e53935";
            return;
          }
          const selector = document.createElement("div");
          selector.innerHTML = `
            <p><strong>Selecciona aroma:</strong></p>
            <select id="selectDifusor" style="width:100%; padding:8px; margin:8px 0; border-radius:4px;">
              <option value="">-- Elige --</option>
              ${difusores.map(p => `<option value="${p.nombre}">${p.nombre}</option>`).join('')}
            </select>
            <button id="btnConfirmarDifusor" style="width:100%; padding:8px; background:#6c4ba3; color:white; border:none; border-radius:6px; margin-top:8px;">Confirmar</button>
          `;
          mensaje.innerHTML = "";
          mensaje.appendChild(selector);
          document.getElementById("btnConfirmarDifusor").onclick = async () => {
            const aroma = document.getElementById("selectDifusor").value;
            if (!aroma) return;
            const difusor = productos.find(p => p.nombre === aroma);
            carrito.push({ nombre: `${difusor.nombre} (üéÅ Premio)`, precio: 0, cantidad: 1, imagen: difusor.imagen, esPremio: true });
            await updateDoc(docRef, { codigoUsado: true, fechaUso: new Date() });
            codigoAplicado = codigo;
            mensaje.innerHTML = `‚úÖ ¬°Difusor de <strong>${aroma}</strong> agregado!`;
            mensaje.style.color = "#2e7d32";
            renderCarrito();
          };
          return;
        } else {
          mensaje.innerHTML = "‚ùå Premio no reconocido.";
          mensaje.style.color = "#e53935";
          return;
        }

        await updateDoc(docRef, { codigoUsado: true, fechaUso: new Date() });
        codigoAplicado = codigo;
        mensaje.innerHTML = `‚úÖ ${Math.round(descuentoAplicado * 100)}% de descuento aplicado!`;
        mensaje.style.color = "#2e7d32";
        renderCarrito();

      } catch (err) {
        console.error("Error c√≥digo:", err);
        mensaje.innerHTML = "‚ö†Ô∏è Error al aplicar.";
        mensaje.style.color = "#e53935";
      }
    }

    function renderCarrito() {
      const ul = document.getElementById("listaCarritoModal");
      ul.innerHTML = "";
      let total = 0;
      carrito.forEach((item, i) => {
        const sub = item.precio * item.cantidad;
        total += sub;
        const li = document.createElement("li");
        li.textContent = `${item.nombre} x${item.cantidad} - ‚Ç°${sub.toLocaleString()}`;
        const btn = document.createElement("button");
        btn.textContent = "‚ùå";
        btn.onclick = () => { 
          carrito.splice(i, 1);
          if (item.esPremio) {
            difusorAplicado = null; codigoAplicado = null; descuentoAplicado = 0;
          }
          renderCarrito(); 
        };
        li.appendChild(btn);
        ul.appendChild(li);
      });
      let totalFinal = total;
      if (descuentoAplicado > 0) {
        totalFinal = total * (1 - descuentoAplicado);
        document.getElementById("totalModal").innerHTML = `
          Subtotal: ‚Ç°${Math.round(total).toLocaleString()}<br>
          Descuento (${Math.round(descuentoAplicado * 100)}%): -‚Ç°${Math.round(total * descuentoAplicado).toLocaleString()}<br>
          <strong>Total: ‚Ç°${Math.round(totalFinal).toLocaleString()}</strong>
        `;
      } else {
        document.getElementById("totalModal").textContent = `Total: ‚Ç°${Math.round(totalFinal).toLocaleString()}`;
      }
      document.getElementById("contadorCarrito").textContent = carrito.reduce((s, i) => s + i.cantidad, 0);
      localStorage.setItem("carrito", JSON.stringify(carrito));
    }

    async function finalizarPedido() {
      if (carrito.length === 0) return alert("El carrito est√° vac√≠o");
      for (const item of carrito) {
        let nombreStock = item.nombre;
        if (item.esPremio) nombreStock = item.nombre.replace(/ \(üéÅ Premio\)$/, "");
        else nombreStock = item.nombre.split(" ")[0];
        const stock = inventario[nombreStock] ?? 0;
        if (stock < item.cantidad) {
          mostrarToast(`‚ùå No hay stock de "${nombreStock}"`, "#e53935");
          return;
        }
      }

      const nombreCliente = clienteAutenticado?.nombre || "Cliente";
      let msg = `Hola Wilber üëã%0AEl cliente **${nombreCliente}** ha realizado el siguiente pedido:%0A%0A`;
      let total = 0;
      carrito.forEach(i => {
        const sub = i.precio * i.cantidad;
        msg += `üß¥ ${i.nombre} x${i.cantidad} - ‚Ç°${sub.toLocaleString()}%0A`;
        total += sub;
      });
      if (descuentoAplicado > 0) total = total * (1 - descuentoAplicado);
      msg += `%0Aüí∞ Total: ‚Ç°${Math.round(total).toLocaleString()}%0A%0A¬°Gracias! üåø`;
      window.open(`https://wa.me/50672952454?text=${encodeURIComponent(msg)}`, "_blank");

      try {
        for (const item of carrito) {
          let nombreStock = item.nombre;
          if (item.esPremio) nombreStock = item.nombre.replace(/ \(üéÅ Premio\)$/, "");
          else nombreStock = item.nombre.split(" ")[0];
          const nuevo = (inventario[nombreStock] ?? 0) - item.cantidad;
          const snap = await window.firebaseUtils.getDocs(window.stockCollection);
          const doc = snap.docs.find(d => d.data().nombre === nombreStock);
          if (doc) {
            await window.firebaseUtils.updateDoc(doc.ref, { cantidad: nuevo });
            inventario[nombreStock] = nuevo;
          }
        }
        if (typeof actualizarCatalogoConStock === "function") actualizarCatalogoConStock();
        carrito = []; codigoAplicado = null; descuentoAplicado = 0; difusorAplicado = null;
        renderCarrito();
        mostrarToast("‚úÖ Pedido enviado", "#4caf50");
      } catch (e) {
        console.error("Error:", e);
        mostrarToast("‚ö†Ô∏è Error al actualizar stock", "#e53935");
      }
    }

    function mostrarToast(mensaje, color = "#4caf50") {
      const t = document.getElementById("toast");
      t.textContent = mensaje;
      t.style.backgroundColor = color;
      t.style.display = "block";
      t.style.opacity = "1";
      setTimeout(() => {
        t.style.transition = "opacity 0.5s";
        t.style.opacity = "0";
        setTimeout(() => { t.style.display = "none"; t.style.transition = ""; }, 500);
      }, 3000);
    }

    function abrirModalCarrito() { renderCarrito(); document.getElementById("modalCarrito").style.display = "flex"; }
    function cerrarModalCarrito() { document.getElementById("modalCarrito").style.display = "none"; }

    function intentarRenderizar() {
      if (productos.length > 0 && typeof inventario !== "undefined" && Object.keys(inventario).length > 0) {
        renderizarProductos();
      } else {
        setTimeout(intentarRenderizar, 100);
      }
    }

    function mostrarErrorCarga() {
      const loader = document.getElementById("loader");
      if (loader) {
        loader.innerHTML = `<div style="text-align:center;"><div style="font-size:3rem; margin-bottom:10px;">‚ö†Ô∏è</div><div>Error al cargar el cat√°logo.</div></div>`;
      }
    }

    function solicitarAroma() {
      const m = "Hola Wilber üëã%0A%0ANo encontr√© un aroma en el cat√°logo.%0A¬øPodr√≠as ayudarme?%0A%0A¬°Gracias! üåø";
      window.open(`https://wa.me/50672952454?text=${encodeURIComponent(m)}`, "_blank");
    }

    function copiarEnlaceRecomendacion() {
      navigator.clipboard.writeText(window.location.href)
        .then(() => mostrarToast("‚úÖ Enlace copiado", "#4caf50"))
        .catch(() => mostrarToast("‚ö†Ô∏è No se pudo copiar", "#e53935"));
    }

    document.addEventListener("DOMContentLoaded", () => {
      cargarCarrito();
      document.getElementById("btnAplicarCodigo")?.addEventListener("click", aplicarCodigoPremio);
      verificarSesion();
    });

    function cargarCarrito() {
      const data = localStorage.getItem("carrito");
      if (data) carrito = JSON.parse(data);
      renderCarrito();
    }
  </script>
</body>
</html>