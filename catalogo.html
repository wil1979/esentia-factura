<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Cat√°logo Esentia</title>
  <link rel="icon" href="images/logo.png" sizes="192x192" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="catalogo.css" />

  <!-- Estilos generales -->
  <style>
    .btn-filtro {
      background: #f0f0f0;
      border: 2px solid #ccc;
      padding: 8px 16px;
      margin: 0 5px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-filtro:hover { background: #e0e0e0; }

    .btn-filtro.activo {
      background: #6c4ba3;
      color: white;
      border-color: #6c4ba3;
    }

    .modal-carrito {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-contenido {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 12px;
      position: relative;
    }

    .producto-card {
      position: relative;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #4caf50;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      display: none;
      z-index: 2000;
    }
  </style>

  <!-- Bottom sheet admin negro/dorado -->
  <style>
    .admin-sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: flex-end;
      align-items: stretch;
      z-index: 1200;
    }

    .admin-sheet {
      background: #050505;
      border-radius: 20px 20px 0 0;
      border-top: 2px solid #d4af37;
      box-shadow: 0 -6px 20px rgba(0, 0, 0, 0.6);
      padding: 16px 20px 22px;
      width: 25%;
      max-height: 65vh;
      animation: adminSheetIn 0.25s ease-out;
    }

    @keyframes adminSheetIn {
      from {
        transform: translateY(100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .admin-sheet-handle {
      width: 48px;
      height: 4px;
      background: rgba(255, 255, 255, 0.25);
      border-radius: 999px;
      margin: 0 auto 12px;
    }

    .admin-sheet-title {
      color: #f5eec2;
      font-size: 1.05rem;
      margin-bottom: 10px;
      text-align: center;
    }

    .admin-sheet-desc {
      color: #d4af37;
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 16px;
    }

    .admin-sheet-btn {
      width: 100%;
      padding: 10px 14px;
      margin-top: 8px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: linear-gradient(135deg, #d4af37, #b8891e);
      color: #000;
      font-weight: 600;
    }

    .admin-sheet-btn-secondary {
      width: 100%;
      padding: 9px 14px;
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background: transparent;
      color: #f5f5f5;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .admin-dot-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      border: 1px solid rgba(212, 175, 55, 0.9);
      background: rgba(0, 0, 0, 0.7);
      color: #f5eec2;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 20;
      backdrop-filter: blur(2px);
    }

    .admin-dot-btn:hover {
      background: rgba(18, 18, 18, 0.95);
    }
   
 
   #modalLoginRegistro {
  backdrop-filter: blur(12px) saturate(180%);
  background: rgba(10, 8, 22, 0.78); /* fondo morado oscuro transl√∫cido */
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1100;
  inset: 0;
}
#modalLoginRegistro .modal-contenido {
  background: radial-gradient(circle at 20% 30%, rgba(212, 175, 55, 0.12), transparent 60%),
              radial-gradient(circle at 80% 70%, rgba(108, 75, 163, 0.25), transparent 70%),
              rgba(12, 10, 25, 0.85);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1px solid rgba(212, 175, 55, 0.55);
  box-shadow:
    0 12px 40px rgba(0, 0, 0, 0.6),
    inset 0 0 0 1px rgba(255, 255, 255, 0.08);
  border-radius: 20px !important;
  padding: 28px 24px !important;
  max-width: 380px !important;
  color: #f5eec2;
  animation: glassFadeIn 0.45s cubic-bezier(0.22, 0.61, 0.36, 1);
  position: relative;
  overflow: hidden;
}
#modalLoginRegistro .modal-contenido::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.4), transparent 50%);
  z-index: -1;
  border-radius: 22px;
  opacity: 0.6;
}
#modalLoginRegistro h2 {
  text-align: center;
  margin-top: 0;
  margin-bottom: 14px;
  font-size: 1.45rem;
  letter-spacing: 0.8px;
  color: #f5eec2;
  text-shadow: 0 0 8px rgba(212, 175, 55, 0.3);
}
.btn-tab {
  flex: 1;
  padding: 10px 12px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  background: transparent;
  color: #f5eec2;
  cursor: pointer;
  font-size: 0.95rem;
  transition: all 0.25s ease;
}
.btn-tab.activo {
  background: linear-gradient(90deg, #d4af37, #efd28f);
  color: #000;
  border-color: transparent;
  font-weight: 600;
  box-shadow: 0 2px 8px rgba(212, 175, 55, 0.4);
}
#modalLoginRegistro input {
  background: rgba(0, 0, 0, 0.45) !important;
  color: #f5eec2 !important;
  border: 1px solid rgba(212, 175, 55, 0.35) !important;
  border-radius: 10px !important;
  padding: 12px !important;
  font-size: 1rem;
  transition: border-color 0.3s, box-shadow 0.3s;
}
#modalLoginRegistro input:focus {
  outline: none;
  border-color: #d4af37 !important;
  box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.4);
}
#modalLoginRegistro input::placeholder {
  color: rgba(245, 238, 194, 0.7);
}
#modalLoginRegistro button {
  background: linear-gradient(90deg, #d4af37, #b8891e);
  color: #000 !important;
  font-weight: 600;
  border: none;
  border-radius: 10px !important;
  padding: 12px;
  font-size: 1rem;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}
#modalLoginRegistro button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(212, 175, 55, 0.5);
}
#loginMensaje {
  color: #ffb3b3 !important;
  min-height: 1.2em;
  font-size: 0.9rem;
  text-align: center;
}

  
 
    /* Contenedor flotante de la tarjeta de lealtad */
    .lealtad-container {
      position: fixed;
      bottom: 100px;
      right: 20px;
      z-index: 998;
      display: none;
      flex-direction: column;
      gap: 10px;
    }

    .lealtad-container.activo {
      display: flex;
    }

    /* Tarjeta de lealtad flotante */
    .tarjeta-lealtad {
      background: linear-gradient(135deg, #6c4ba3 0%, #8b6bb4 100%);
      border-radius: 16px;
      padding: 20px;
      width: 320px;
      box-shadow: 0 8px 24px rgba(108, 75, 163, 0.3);
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      animation: slideInRight 0.4s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .tarjeta-lealtad-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      padding-bottom: 12px;
    }

    .tarjeta-lealtad-header h3 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .btn-cerrar-tarjeta {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .btn-cerrar-tarjeta:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    .cliente-info {
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      font-size: 0.95rem;
    }

    .cliente-info p {
      margin: 4px 0;
      display: flex;
      justify-content: space-between;
    }

    .cliente-info strong {
      color: #ffd700;
    }

    /* Sellos de lealtad */
    .sellos-container {
      margin: 16px 0;
      padding: 16px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
    }

    .sellos-titulo {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 12px;
      text-align: center;
      color: #ffd700;
    }

    .sellos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .sello {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
      font-weight: bold;
      border: 2px dashed rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.05);
      transition: all 0.3s ease;
    }

    .sello.activo {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      border-color: #ffd700;
      color: #333;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
      animation: popIn 0.5s ease-out;
    }

    @keyframes popIn {
      0% {
        transform: scale(0.5);
        opacity: 0;
      }
      50% {
        transform: scale(1.15);
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .sello.inactivo {
      color: rgba(255, 255, 255, 0.4);
    }

    .progreso-lealtad {
      margin-top: 12px;
      text-align: center;
      font-size: 0.85rem;
      color: #ffd700;
      font-weight: 600;
    }

    /* Caja de regalo flotante */
    .caja-regalo-flotante {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, #ff6b6b, #962b3b);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      cursor: pointer;
      box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
      animation: bounce 2s infinite;
      transition: all 0.3s ease;
    }

    .caja-regalo-flotante:hover {
      transform: scale(1.1);
      box-shadow: 0 8px 24px rgba(255, 107, 107, 0.4);
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    /* Estado premio obtenido */
    .estado-premio {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
      padding: 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      margin-top: 12px;
      animation: slideInUp 0.4s ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Responsive */
    @media (max-width: 480px) {
      .lealtad-container {
        bottom: 80px;
        right: 10px;
      }

      .tarjeta-lealtad {
        width: 280px;
        padding: 16px;
      }

      .sellos-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .caja-regalo-flotante {
        width: 20px;
        height: 20px;
        font-size: 2rem;
      }
    }

    .glass-visitas {
  position: fixed;
  top: 90px;
  right: 20px;
  width: 320px;
  max-height: 60vh;
  overflow-y: auto;
  padding: 16px;
  border-radius: 18px;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(14px);
  border: 1px solid rgba(212,175,55,0.5);
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  color: #f5eec2;
  z-index: 1300;
}

.glass-visitas h3 {
  margin-top: 0;
  text-align: center;
  color: #d4af37;
}

.hidden { display: none; }

.btn-toggle-visitas {
  position: fixed;
  top: 90px;
  right: 20px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: 1px solid rgba(212,175,55,0.7);
  background: rgba(0,0,0,0.65);
  backdrop-filter: blur(10px);
  color: #f5eec2;
  font-size: 1.2rem;
  cursor: pointer;
  z-index: 1400;
  box-shadow: 0 6px 18px rgba(0,0,0,0.5);
}

.btn-toggle-visitas:hover {
  background: rgba(15,15,15,0.9);
  transform: scale(1.05);
}

.btn-toggle-visitas.hidden {
  display: none;
}
  

  </style>
</head>

<body>
  <header class="header">
    <div class="header-left">
      <img src="images/logo.png" alt="Esentia" class="logo">
      <div>
        <h1>Cat√°logo Esentia</h1>
        <p>Fragancias que enamoran</p>
      </div>
    </div>
    <div class="header-right">
      <div id="panelUsuario" style="display:none; align-items:center; gap:10px;">
        <span id="nombreUsuario"></span>
        <button onclick="cerrarSesion()" class="btn-cerrar-sesion">Salir</button>
      </div>
      <button id="btnLogin" onclick="abrirLoginRegistro()" class="btn-login">Iniciar sesi√≥n</button>
    </div>
  </header>

  <main class="contenedor">
    <div id="loader" style="display:flex; justify-content:center; align-items:center; height:300px; color:#6c4ba3; font-size:1.5rem; font-weight:bold;">
      <div style="text-align:center;">
        <div style="font-size:3rem; margin-bottom:10px;">‚è≥</div>
        <div>Estamos Actualizando el Inventario...</div>
      </div>
    </div>
    <div id="productos-hogar"></div>

    <div style="text-align:center; margin:2rem 0; padding:1.2rem; background:#f9f7ff; border-radius:12px; max-width:600px; margin-left:auto; margin-right:auto;">
      <h3 style="margin-top:0; color:#6c4ba3;">¬øNo encuentras lo que buscas?</h3>
      <button onclick="solicitarAroma()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üå∏ Solicitar un aroma especial
      </button>
      <button onclick="copiarEnlaceRecomendacion()" style="display:block; width:100%; padding:10px; margin:8px 0; background:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer;">
        üîó Copiar enlace para recomendar
      </button>
    </div>
  </main>

  <!-- Modal Producto -->
  <div id="modalProducto" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalProducto()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px;">&times;</span>
      <h2 id="modalProductoNombre"></h2>
      <img id="modalProductoImagen" src="" alt="Producto"
           style="width:100%; max-width:280px; height:auto; object-fit:contain; border-radius:8px; margin:10px 0; background:#fff;">
      <p id="modalProductoInfo"></p>
      <p id="modalProductoUso"></p>
      <p id="modalProductoPrecio" style="font-size:1.4rem; font-weight:bold;"></p>
      <div id="selectorVariante"></div>
      <button onclick="agregarAlCarritoDesdeModal()"
              style="display:block; width:100%; padding:10px; margin-top:10px; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üõí Agregar al carrito
      </button>
    </div>
  </div>

  <!-- Modal Carrito -->
  <div id="modalCarrito" class="modal-carrito">
    <div class="modal-contenido">
      <span onclick="cerrarModalCarrito()" style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:22px;">&times;</span>
      <h2>Tu carrito</h2>
      <ul id="listaCarrito"></ul>
      <p id="totalModal"></p>
      <input type="text" id="codigoPremio" placeholder="C√≥digo de promoci√≥n o premio"
             style="width:100%; padding:8px; margin:10px 0;" />
      <button id="btnAplicarCodigo"
              style="width:100%; padding:8px; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;">
        üéÅ Aplicar c√≥digo
      </button>
      <button onclick="finalizarPedido()"
              style="width:100%; padding:10px; margin-top:10px; background:#4caf50; color:white; border:none; border-radius:8px; cursor:pointer;">
        ‚úÖ Finalizar pedido por WhatsApp
      </button>
    </div>
  </div>

  <!-- Modal Login / Registro (glass) -->
  <div id="modalLoginRegistro" class="modal-carrito">
    <div class="modal-contenido">
      <h2>Bienvenido a Esentia</h2>
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <button class="btn-tab activo" data-tab="login">Iniciar sesi√≥n</button>
        <button class="btn-tab" data-tab="registro">Registrarse</button>
      </div>

      <form id="formLogin">
        <input type="text" id="loginCedulaTel" placeholder="C√©dula o Tel√©fono" required
               style="width:100%; padding:12px; margin:8px 0; border-radius:8px;">
        <button type="submit" style="width:100%; padding:12px; margin-top:10px;">
          Entrar
        </button>
      </form>

      <form id="formRegistro" style="display:none;">
  
  
  <div style="position:relative;">
    <input type="text" id="regCedula" placeholder="C√©dula (9 d√≠gitos)" required
           maxlength="9" inputmode="numeric" autocomplete="off"
           style="width:100%; padding:12px 40px 12px 12px; margin:8px 0; border-radius:8px;">
    <span id="cedulaStatus" style="position:absolute; right:12px; top:22px; font-size:1.2rem;"></span>
  </div>

  <input type="text" id="regTelefono" placeholder="Tel√©fono (ej: 88888888)" required
         maxlength="8" inputmode="tel" autocomplete="tel"
         style="width:100%; padding:12px; margin:8px 0; border-radius:8px;">

         <input type="text" id="regNombre" placeholder="Nombre completo" readonly
         style="width:100%; padding:12px; margin:8px 0; border-radius:8px; background:#f0f0f0;">
  
  <button type="submit" id="btnRegistrar" 
          style="width:100%; padding:12px; margin-top:10px; background:#6c4ba3; color:white; border:none; border-radius:8px; cursor:pointer;"
          disabled>
    üîÑ Verificando c√©dula...
  </button>
</form>

      <div id="loginMensaje" style="margin-top:15px; min-height:20px; text-align:center; font-size:0.9rem;"></div>
    </div>
  </div>

  <!-- Bot√≥n flotante del carrito -->
  <button id="botonCarrito" onclick="abrirModalCarrito()" style="
    position:fixed;
    bottom:20px;
    right:20px;
    padding:12px 16px;
    background:#6c4ba3;
    color:white;
    border:none;
    border-radius:50%;
    width:60px;
    height:60px;
    font-size:1.4rem;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    z-index:999;
  ">
    üõí <span id="contadorCarrito">0</span>
  </button>

  <div id="toast" class="toast"></div>

  <!-- TARJETA DE LEALTAD FLOTANTE -->
  <div class="lealtad-container" id="lealtadContainer">
    <!-- Tarjeta de lealtad (visible cuando est√° abierta) -->
    <div class="tarjeta-lealtad" id="tarjetaLealtad">
      <div class="tarjeta-lealtad-header">
        <h3>üí≥ Mi Lealtad</h3>
        <button class="btn-cerrar-tarjeta" onclick="cerrarTarjetaLealtad()">√ó</button>
      </div>

      <div class="cliente-info" id="clienteInfoLealtad">
        <p><span>Cliente:</span> <strong id="nombreClienteLealtad">-</strong></p>
        <p><span>Sellos:</span> <strong id="sellsActualesLealtad">0</strong> / <strong id="sellsObjetivoLealtad">6</strong></p>
      </div>

      <div class="sellos-container">
        <div class="sellos-titulo">Tus sellos de compra</div>
        <div class="sellos-grid" id="sellsGrid">
          <!-- Los sellos se generar√°n din√°micamente -->
        </div>
        <div class="progreso-lealtad" id="progresoLealtad">
          Completa 6 sellos para obtener tu regalo
        </div>
      </div>

      <div id="estadoPremioLealtad"></div>
    </div>

    <!-- Caja de regalo (visible cuando la tarjeta est√° cerrada) -->
    <div class="caja-regalo-flotante" id="cajaRegaloFlotante" onclick="abrirTarjetaLealtad()" style="display:none;" title="Abre tu tarjeta de lealtad">
      üéÅ
    </div>
  </div>


  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
  getFirestore,
  collection,
  getDocs,
  getDoc,       // ‚úÖ
  doc,          // ‚úÖ
  setDoc,       // ‚úÖ
  query,
  where,
  addDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const stockCollection = collection(db, "stock");

    window.db = db;
    window.firebaseUtils = {
  query,
  where,
  collection,
  getDocs,
  getDoc,      // ‚úÖ
  doc,         // ‚úÖ
  setDoc,      // ‚úÖ
  addDoc,
  serverTimestamp
};

    let inventario = {};
    window.inventario = inventario;

    async function cargarInventario() {
      try {
        const snapshot = await getDocs(stockCollection);
        snapshot.forEach(doc => {
          const data = doc.data();
          inventario[data.nombre] = data.cantidad;
        });
        // ‚úÖ Actualizar tarjeta de lealtad
        if (typeof actualizarLealtadAlAutenticar === "function") {
          actualizarLealtadAlAutenticar();
        }

        if (typeof intentarRenderizar === "function" && window.catalogoListo) {
          intentarRenderizar();
        }
      } catch (error) {
        console.error("Error cargando inventario:", error);
        if (typeof mostrarErrorCarga === "function") {
          mostrarErrorCarga();
        }
      }
    }

    document.addEventListener("DOMContentLoaded", cargarInventario);
  </script>

  <!-- L√≥gica principal -->
  <script>
    let carrito = [];
    let productos = [];
    let productoSeleccionado = null;
    let codigoAplicado = null;
    let descuentoAplicado = 0;
    let difusorAplicado = null;
    let clienteAutenticado = null;
    window.catalogoListo = false;
    // ============================================
    // FUNCIONES DE TARJETA DE LEALTAD
    // ============================================

    let datosLealtadCliente = null;
    let tarjetaLealtadAbierta = true;
    
    /**
     * Abre la tarjeta de lealtad y oculta la caja de regalo
     */
    function abrirTarjetaLealtad() {
      const tarjeta = document.getElementById('tarjetaLealtad');
      const cajaRegalo = document.getElementById('cajaRegaloFlotante');
      if (tarjeta) tarjeta.style.display = 'block';
      if (cajaRegalo) cajaRegalo.style.display = 'none';
      tarjetaLealtadAbierta = true;
      localStorage.setItem('tarjetaLealtadAbierta', 'true');
    }

    /**
     * Cierra la tarjeta de lealtad y muestra la caja de regalo
     */
    function cerrarTarjetaLealtad() {
      const tarjeta = document.getElementById('tarjetaLealtad');
      const cajaRegalo = document.getElementById('cajaRegaloFlotante');
      if (tarjeta) tarjeta.style.display = 'none';
      if (cajaRegalo) cajaRegalo.style.display = 'flex';
      tarjetaLealtadAbierta = false;
      localStorage.setItem('tarjetaLealtadAbierta', 'false');
    }

    /**
     * Muestra la tarjeta de lealtad solo si el cliente est√° autenticado
     */
    function mostrarTarjetaLealtad() {
      const container = document.getElementById('lealtadContainer');
      if (!container) return;

      if (clienteAutenticado) {
        container.classList.add('activo');
        cargarDatosLealtadCliente();
        activarControlesAdmin();
      } else {
        container.classList.remove('activo');
      }
    }

    /**
     * Carga los datos de lealtad del cliente desde Firestore
     */
async function cargarDatosLealtadCliente() {
  if (!clienteAutenticado) return;

  try {
    const { doc, getDoc } = window.firebaseUtils;

    // üî• AQU√ç ESTABA EL ERROR: debe ser "facturas"
    const ref = doc(window.db, "facturas", clienteAutenticado.id);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      datosLealtadCliente = {
        nombre: clienteAutenticado.nombre,
        sellos: 0,
        objetivo: 6,
        premiosPendientes: 0
      };
    } else {
      const data = snap.data();
      datosLealtadCliente = {
        nombre: clienteAutenticado.nombre,
        ...(data.lealtad || {
          sellos: 0,
          objetivo: 6,
          premiosPendientes: 0
        })
      };
    }

    renderizarTarjetaLealtad();

  } catch (error) {
    console.error("Error cargando lealtad:", error);
  }
}

function renderizarTarjetaLealtad() {
  if (!datosLealtadCliente) return;

  document.getElementById("nombreClienteLealtad").textContent =
    datosLealtadCliente.nombre;

  document.getElementById("sellsActualesLealtad").textContent =
    datosLealtadCliente.sellos;

  document.getElementById("sellsObjetivoLealtad").textContent =
    datosLealtadCliente.objetivo;

  const grid = document.getElementById("sellsGrid");
  grid.innerHTML = "";

  for (let i = 1; i <= datosLealtadCliente.objetivo; i++) {
    const div = document.createElement("div");
    div.className = "sello " + (i <= datosLealtadCliente.sellos ? "activo" : "inactivo");
    div.textContent = "‚òÖ";
    grid.appendChild(div);
  }
}

    /**
     * Actualiza la visualizaci√≥n de la tarjeta de lealtad con los datos del cliente
     */
    function actualizarVisualizacionLealtad() {
      if (!datosLealtadCliente) return;

      const lealtad = datosLealtadCliente.lealtad || {};
      const sellos = lealtad.sellos || 0;
      const objetivo = lealtad.objetivo || 6;
      const premiosPendientes = lealtad.premiosPendientes || 0;

      // Actualizar informaci√≥n del cliente
      document.getElementById('nombreClienteLealtad').textContent = datosLealtadCliente.nombre || '-';
      document.getElementById('sellsActualesLealtad').textContent = sellos;
      document.getElementById('sellsObjetivoLealtad').textContent = objetivo;

      // Generar los sellos visuales
      const sellsGrid = document.getElementById('sellsGrid');
      sellsGrid.innerHTML = '';

      for (let i = 1; i <= objetivo; i++) {
        const sello = document.createElement('div');
        sello.className = i <= sellos ? 'sello activo' : 'sello inactivo';
        sello.textContent = '‚≠ê';
        sellsGrid.appendChild(sello);
      }

      // Actualizar progreso
      const progresoDiv = document.getElementById('progresoLealtad');
      if (sellos >= objetivo) {
        progresoDiv.innerHTML = `<div class="estado-premio">üéâ ¬°Completaste tu tarjeta! Reclama tu regalo</div>`;
      } else {
        const faltantes = objetivo - sellos;
        progresoDiv.textContent = `Faltan ${faltantes} sello${faltantes !== 1 ? 's' : ''} para tu regalo`;
      }

      // Mostrar estado de premios pendientes
      const estadoPremio = document.getElementById('estadoPremioLealtad');
      if (premiosPendientes > 0) {
        estadoPremio.innerHTML = `<div class="estado-premio">üéÅ Tienes ${premiosPendientes} premio${premiosPendientes !== 1 ? 's' : ''} por reclamar</div>`;
      } else {
        estadoPremio.innerHTML = '';
      }
    }

    /**
     * Actualiza la tarjeta de lealtad cuando el cliente se autentica
     */
    
    /**
     * Registra la visita del cliente a catalogo.html en Firestore
     * Crea un documento en la colecci√≥n "registroVisitas"
     */
    async function registrarVisita() {
  if (!clienteAutenticado) return;

  try {
    const { doc, setDoc, serverTimestamp } = window.firebaseUtils;

    const ref = doc(window.db, "registroVisitas", clienteAutenticado.id);

    await setDoc(ref, {
      nombre: clienteAutenticado.nombre,
      cedula: clienteAutenticado.cedula || "",
      pagina: "catalogo.html",
      ultimaVisita: serverTimestamp(),
      navegador: navigator.userAgent
    }, { merge: true });

  } catch (error) {
    console.error("Error registrando visita:", error);
  }
}

    function actualizarLealtadAlAutenticar() {
      mostrarTarjetaLealtad();
      registrarVisita();  // ‚úÖ Registrar visita
      
      
      // Restaurar el estado de la tarjeta (abierta o cerrada)
      const tarjetaAbierta = localStorage.getItem('tarjetaLealtadAbierta') !== 'false';
      if (tarjetaAbierta) {
        abrirTarjetaLealtad();
        renderTarjetaLealtad(window.clienteSeleccionado);
      } else {
        cerrarTarjetaLealtad();
      }
    }

    /**
     * Oculta la tarjeta de lealtad cuando el cliente cierra sesi√≥n
     */
    function ocultarTarjetaLealtadAlCerrarSesion() {
      const container = document.getElementById('lealtadContainer');
      if (container) container.classList.remove('activo');
      datosLealtadCliente = null;

      renderTarjetaLealtad(window.clienteSeleccionado);
    }


    function mostrarToast(mensaje, color = "#4caf50") {
      const t = document.getElementById("toast");
      t.textContent = mensaje;
      t.style.backgroundColor = color;
      t.style.display = "block";
      t.style.opacity = "1";
      setTimeout(() => {
        t.style.transition = "opacity 0.5s";
        t.style.opacity = "0";
        setTimeout(() => {
          t.style.display = "none";
          t.style.transition = "";
        }, 500);
      }, 2000);
    }

   async function mostrarPanelVisitasAdmin() {
  if (localStorage.getItem("adminEsentia") !== "1") return;

  const panel = document.getElementById("panelVisitas");
  const lista = document.getElementById("listaVisitas");
  if (!panel || !lista) return;

  panel.classList.remove("hidden");
  lista.innerHTML = "Cargando...";

  try {
    const { collection, getDocs } = window.firebaseUtils;
    const snap = await getDocs(collection(window.db, "registroVisitas"));

    lista.innerHTML = "";

   snap.docs
  .sort((a, b) =>
    (b.data().ultimaVisita?.seconds || 0) -
    (a.data().ultimaVisita?.seconds || 0)
  )
  .forEach(d => {
    const v = d.data();
    const fecha = v.ultimaVisita?.seconds
      ? new Date(v.ultimaVisita.seconds * 1000).toLocaleString("es-CR")
      : "‚Äî";

    lista.innerHTML += `
      <div style="margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid rgba(255,255,255,0.2)">
        <strong>${v.nombre || "Sin nombre"}</strong><br>
        <small>√öltima visita:</small><br>
        <small>${fecha}</small>
      </div>
    `;
  });

  } catch (e) {
    lista.innerHTML = "Error cargando visitas";
  }
}

async function buscarCedulaHacienda(cedula) {
  try {
    const resp = await fetch(
      `https://api.hacienda.go.cr/fe/ae?identificacion=${cedula}`
    );
    if (!resp.ok) return null;
    const data = await resp.json();
    return data?.nombre || null;
  } catch {
    return null;
  }
}

    function abrirLoginRegistro() {
      document.getElementById("modalLoginRegistro").style.display = "flex";
    }

    function verificarSesion() {
      const sesion = localStorage.getItem("sesionEsentia");
      if (sesion) {
        clienteAutenticado = JSON.parse(sesion);
        document.getElementById("nombreUsuario").textContent = clienteAutenticado.nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("btnLogin").style.display = "none";
        document.getElementById("modalLoginRegistro").style.display = "none";

        const esAdmin =
          clienteAutenticado.cedula === "110350666" ||
          clienteAutenticado.id === "110350666" ||
          clienteAutenticado.telefono === "110350666";

        if (esAdmin) {
          localStorage.setItem("adminEsentia", "1");
        } else {
          localStorage.removeItem("adminEsentia");
        }

        window.catalogoListo = true;
        intentarRenderizar();
      } else {
        document.getElementById("loader").style.display = "none";
        document.getElementById("modalLoginRegistro").style.display = "flex";
        document.getElementById("btnLogin").style.display = "inline-block";
      }

      activarControlesAdmin(); // ‚úÖ CLAVE
      renderTarjetaLealtad(window.clienteSeleccionado);

      actualizarLealtadAlAutenticar();

    }

    function intentarRenderizar() {
      if (window.catalogoListo && Object.keys(inventario).length > 0 && productos.length > 0) {
        renderizarProductos();
      }
    }

    async function cargarProductos() {
      try {
        const resp = await fetch("https://wil1979.github.io/esentia-factura/productos_esentia.json");
        productos = await resp.json();
        intentarRenderizar();
      } catch (error) {
        console.error("Error cargando productos:", error);
        mostrarErrorCarga();
      }
    }

    function mostrarErrorCarga() {
      document.getElementById("loader").style.display = "none";
      const cont = document.getElementById("productos-hogar");
      cont.innerHTML = "<p>Error cargando cat√°logo. Intenta m√°s tarde.</p>";
    }

    function renderizarProductos() {
      const container = document.getElementById("productos-hogar");
      const loader = document.getElementById("loader");
      if (!container || !loader) return;
      loader.style.display = "none";
      container.innerHTML = "";

      const fila = document.createElement("div");
      fila.className = "productos";
      fila.style.display = "flex";
      fila.style.flexWrap = "wrap";
      fila.style.gap = "1.5rem";

      const productosFiltrados = productos.filter(
        p => p.disponible && (inventario[p.nombre] ?? 0) > 0
      );

      if (productosFiltrados.length === 0) {
        const m = document.createElement("p");
        m.textContent = "üì≠ No hay productos disponibles.";
        m.style.textAlign = "center";
        m.style.fontSize = "1.2rem";
        m.style.color = "#666";
        fila.appendChild(m);
      }

      productosFiltrados.forEach(p => {
        const precioFinal = p.precioOferta || p.precio;
        let estrellas = "";
        if (p.calificacion) {
          const llenas = Math.floor(p.calificacion);
          const media = p.calificacion % 1 >= 0.5;
          for (let i = 0; i < llenas; i++) estrellas += "‚≠ê";
          if (media) estrellas += "‚ú®";
          while (estrellas.length < 5) estrellas += "‚òÜ";
        }

        const precioHTML = p.precioOferta
          ? `<p><span class="precio-original">‚Ç°${p.precioOriginal}</span> ‚Ç°${p.precioOferta}</p>`
          : `<p>‚Ç°${p.precio}</p>`;

        const nombreEsc = p.nombre.replace(/'/g, "\\'");
        const infoEsc = (p.info || "").replace(/`/g, "\\`");
        const benefEsc = (p.beneficios || "").replace(/`/g, "\\`");
        const usoEsc = (p.usoRecomendado || "").replace(/`/g, "\\`");

        const div = document.createElement("div");
        div.className = p.precioOferta ? "producto oferta producto-card" : "producto producto-card";
        div.dataset.nombre = p.nombre;
        div.innerHTML = `
          <div style="position:relative;">
            <img src="${p.imagen}" alt="${p.nombre}"
              style="width:100%; max-width:220px; height:220px; object-fit:contain; border-radius:12px; cursor:pointer;"
              onclick="mostrarInfoProducto('${nombreEsc}', ${precioFinal}, '${p.imagen}', \`${infoEsc}\`, \`${benefEsc}\`, \`${usoEsc}\`)">
          </div>
          <h3>${p.nombre}</h3>
          <div class="estrellas">${estrellas}</div>
          ${precioHTML}
          <p class="stock-label">Cargando stock...</p>
          <button class="btn-agregar"
            onclick="mostrarInfoProducto('${nombreEsc}', ${precioFinal}, '${p.imagen}', \`${infoEsc}\`, \`${benefEsc}\`, \`${usoEsc}\`)">
            Ver detalles
          </button>
        `;
        fila.appendChild(div);
      });

      container.appendChild(fila);

      if (typeof actualizarCatalogoConStock === "function") actualizarCatalogoConStock();
      if (localStorage.getItem("adminEsentia") === "1") activarAccionesAdminTarjetas();
    }

    function mostrarInfoProducto(nombre, precio, imagen, info, beneficios, usoRecomendado) {
      document.getElementById("modalProductoNombre").textContent = nombre;
      document.getElementById("modalProductoImagen").src = imagen;
      document.getElementById("modalProductoInfo").textContent = info;
      document.getElementById("modalProductoUso").innerHTML =
        `<strong>‚ú® Beneficios:</strong> ${beneficios}<br><strong>üè† Uso recomendado:</strong> ${usoRecomendado}`;
      document.getElementById("modalProductoPrecio").textContent =
        `‚Ç°${precio.toLocaleString()}`;

      const p = productos.find(x => x.nombre === nombre);
      productoSeleccionado = { ...p };

      const sel = document.getElementById("selectorVariante");
      sel.innerHTML = "";

      if (p.variantes && p.variantes.length > 0) {
        const select = document.createElement("select");
        select.id = "varianteSeleccionada";
        select.style.width = "100%";
        select.style.marginTop = "1rem";
        select.style.padding = "10px";
        select.innerHTML = '<option value="">-- Selecciona una presentaci√≥n --</option>';
        p.variantes.forEach(v => {
          const opt = document.createElement("option");
          opt.value = JSON.stringify(v);
          opt.textContent = `${v.nombre} ‚Äì ‚Ç°${v.precio.toLocaleString()}`;
          select.appendChild(opt);
        });
        sel.appendChild(select);
      }

      document.getElementById("modalProducto").style.display = "flex";
      if (typeof actualizarModalConStock === "function") actualizarModalConStock(nombre);
    }

    function cerrarModalProducto() {
      document.getElementById("modalProducto").style.display = "none";
    }

    function agregarAlCarritoDesdeModal() {
      if (!productoSeleccionado) return;

      let variante = { nombre: "30 ml", precio: 3000 };
      const select = document.getElementById("varianteSeleccionada");
      if (select && select.value) {
        try {
          variante = JSON.parse(select.value);
        } catch {}
      }

      const item = {
        id: productoSeleccionado.imagen.split("/").pop().split(".")[0].toLowerCase(),
        nombre: `${productoSeleccionado.nombre} ${variante.nombre}`,
        precio: variante.precio || 3000,
        cantidad: 1,
        imagen: productoSeleccionado.imagen
      };

      const existente = carrito.find(x => x.id === item.id && x.nombre === item.nombre);
      if (existente) existente.cantidad += 1;
      else carrito.push(item);

      renderCarrito();
      cerrarModalProducto();
      mostrarToast("Producto a√±adido al carrito üõí");
    }

    function abrirModalCarrito() {
      document.getElementById("modalCarrito").style.display = "flex";
    }

    function cerrarModalCarrito() {
      document.getElementById("modalCarrito").style.display = "none";
    }

    function solicitarAroma() {
      const msg = encodeURIComponent(
        "Hola, me gustar√≠a un aroma personalizado para mi hogar. üå∏"
      );
      window.open(`https://wa.me/50672952454?text=${msg}`, "_blank");
    }

    function copiarEnlaceRecomendacion() {
      const url = window.location.href;
      navigator.clipboard.writeText(url).then(() => {
        mostrarToast("Enlace copiado para recomendar üíå");
      });
    }

    function cerrarSesion() {
      localStorage.removeItem("sesionEsentia");
      renderTarjetaLealtad(null);
      localStorage.removeItem("adminEsentia");
      clienteAutenticado = null;
      carrito = [];
      localStorage.removeItem("carrito");
      renderCarrito();
      
      codigoAplicado = null;
      descuentoAplicado = 0;
      difusorAplicado = null;

      document.getElementById("panelUsuario").style.display = "none";
      document.getElementById("btnLogin").style.display = "inline-block";
      document.getElementById("loader").style.display = "none";
      document.getElementById("productos-hogar").innerHTML = "";
      document.getElementById("modalLoginRegistro").style.display = "flex";
    }

    // Login
    document.getElementById("formLogin")?.addEventListener("submit", async e => {
      e.preventDefault();
      const valor = document.getElementById("loginCedulaTel").value.trim();
      const msg = document.getElementById("loginMensaje");
      if (!valor) {
        msg.textContent = "Ingresa c√©dula o tel√©fono.";
        return;
      }

      try {
        msg.textContent = "Buscando cliente...";
        const { query, where, collection, getDocs } = window.firebaseUtils;
        const col = collection(window.db, "clientesBD");
        const q1 = query(col, where("cedula", "==", valor));
        const q2 = query(col, where("telefono", "==", valor));

        const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);
        let docSnap = null;

        if (!snap1.empty) docSnap = snap1.docs[0];
        else if (!snap2.empty) docSnap = snap2.docs[0];

        if (!docSnap) {
          msg.textContent = "Cliente no registrado. Usa 'Registrarse'.";
          return;
        }

        const data = docSnap.data();
        clienteAutenticado = {
          id: docSnap.id,
          nombre: data.nombre,
          cedula: data.cedula,
          telefono: data.telefono
        };

        localStorage.setItem("sesionEsentia", JSON.stringify(clienteAutenticado));

        const esAdmin =
          data.cedula === "110350666" ||
          data.telefono === "110350666" ||
          valor === "110350666";

        if (esAdmin) {
          localStorage.setItem("adminEsentia", "1");
        } else {
          localStorage.removeItem("adminEsentia");
        }

        document.getElementById("nombreUsuario").textContent = clienteAutenticado.nombre;
        document.getElementById("panelUsuario").style.display = "flex";
        document.getElementById("btnLogin").style.display = "none";
        document.getElementById("modalLoginRegistro").style.display = "none";
        msg.textContent = "";
        document.getElementById("loader").style.display = "flex";
        window.catalogoListo = true;
        setTimeout(intentarRenderizar, 300);
      } catch (err) {
        console.error("Error login:", err);
        msg.textContent = "Error de conexi√≥n.";
      }

      activarControlesAdmin();
    });

    // Registro
// ================================
// üîê Registro mejorado con validaci√≥n CR
// ================================

let cedulaValidaCache = null; // { cedula: "123...", nombre: "Nombre" }

function limpiarCedula(cedula) {
  return cedula.replace(/\D/g, "").padStart(9, "0").slice(-9);
}

async function cargarLealtadCliente(clienteId) {
  const { doc, getDoc } = window.firebaseUtils;

  const ref = doc(window.db, "facturas", clienteId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    return {
      sellos: 0,
      objetivo: 6,
      premiosPendientes: 0
    };
  }

  return snap.data().lealtad || {
    sellos: 0,
    objetivo: 6,
    premiosPendientes: 0
  };
}


function renderTarjetaLealtad(cliente) {
  const card = document.getElementById("tarjeta-lealtad");
  if (!card) return;

  if (!cliente || !cliente.lealtad) {
    card.innerHTML = `
      <h4>üéÅ Lealtad</h4>
      <p>Sin datos</p>
    `;
    return;
  }

  const { sellos = 0, objetivo = 6, premiosPendientes = 0 } = cliente.lealtad;

  card.innerHTML = `
    <h4>üéÅ Lealtad</h4>
    <p>Sellos: ${sellos} / ${objetivo}</p>
    <p>üéâ Premios pendientes: <strong>${premiosPendientes}</strong></p>
  `;
}

async function cargarLealtadCliente(clienteId) {
  const ref = doc(db, "facturas", clienteId);
  const snap = await getDoc(ref);

  if (!snap.exists()) {
    return {
      sellos: 0,
      objetivo: 6,
      premiosPendientes: 0
    };
  }

  return snap.data().lealtad || {
    sellos: 0,
    objetivo: 6,
    premiosPendientes: 0
  };
}



async function verificarCedulaEnHacienda(cedula) {
  const msg = document.getElementById("loginMensaje");
  const statusIcon = document.getElementById("cedulaStatus");
  const btn = document.getElementById("btnRegistrar");
  
  if (!cedula || cedula.length !== 9) {
    statusIcon.textContent = "";
    btn.disabled = false;
    btn.innerHTML = "Registrarme";
    btn.style.background = "#6c4ba3";
    return null;
  }

  statusIcon.textContent = "üîç";
  btn.disabled = true;
  btn.innerHTML = "Verificando c√©dula...";
  msg.textContent = "Consultando c√©dula con Hacienda...";

  try {
    const nombreHacienda = await buscarCedulaHacienda(cedula);
    if (nombreHacienda) {
      statusIcon.textContent = "‚úÖ";
      msg.textContent = "";
      btn.disabled = false;
      btn.innerHTML = "Registrarme";
      btn.style.background = "#4caf50";
      document.getElementById("regNombre").value = nombreHacienda;
      cedulaValidaCache = { cedula, nombre: nombreHacienda };
      return nombreHacienda;
    } else {
      statusIcon.textContent = "‚ùå";
      msg.textContent = "‚ùå C√©dula no v√°lida en Hacienda";
      btn.disabled = true;
      btn.innerHTML = "C√©dula inv√°lida";
      btn.style.background = "#ff5252";
      cedulaValidaCache = null;
      return null;
    }
  } catch (err) {
    console.error("Error en API de Hacienda:", err);
    statusIcon.textContent = "‚ö†Ô∏è";
    msg.textContent = "‚ö†Ô∏è Error al consultar Hacienda";
    btn.disabled = true;
    btn.innerHTML = "Reintentar";
    btn.style.background = "#ffa726";
    return null;
  }
}

// Validaci√≥n autom√°tica en tiempo real
document.getElementById("regCedula")?.addEventListener("input", (e) => {
  let val = e.target.value.replace(/\D/g, "");
  e.target.value = val;
  if (val.length === 9) {
    verificarCedulaEnHacienda(val);
  } else if (val.length === 0) {
    document.getElementById("cedulaStatus").textContent = "";
    document.getElementById("regNombre").value = "";
    document.getElementById("loginMensaje").textContent = "";
    cedulaValidaCache = null;
  }
});

document.getElementById("regCedula")?.addEventListener("blur", (e) => {
  const cedula = limpiarCedula(e.target.value);
  if (cedula.length === 9 && (!cedulaValidaCache || cedulaValidaCache.cedula !== cedula)) {
    verificarCedulaEnHacienda(cedula);
  }
});

// Submit del formulario
document.getElementById("formRegistro")?.addEventListener("submit", async e => {
  e.preventDefault();
  
  const msg = document.getElementById("loginMensaje");
  const cedula = limpiarCedula(document.getElementById("regCedula").value);
  const telefono = document.getElementById("regTelefono").value.trim();
  const nombre = document.getElementById("regNombre").value.trim();

  // ‚úÖ Validar que haya nombre (de Hacienda o manual)
  if (!nombre) {
    msg.textContent = "‚ùå Debes ingresar una c√©dula v√°lida o escribir tu nombre.";
    return;
  }

  // ‚úÖ Validar tel√©fono (m√≠nimo 8 d√≠gitos)
  if (!telefono || telefono.replace(/\D/g, "").length < 8) {
    msg.textContent = "‚ùå Tel√©fono inv√°lido. Debe tener al menos 8 d√≠gitos.";
    return;
  }

  // ‚úÖ Asegurar coherencia: si hay c√©dula, debe ser v√°lida
  if (cedula && cedula.length === 9) {
    if (!cedulaValidaCache || cedulaValidaCache.cedula !== cedula) {
      msg.textContent = "‚ùå C√©dula no verificada. Espera la validaci√≥n.";
      return;
    }
    if (cedulaValidaCache.nombre !== nombre) {
      msg.textContent = "‚ùå Inconsistencia: el nombre no coincide con Hacienda.";
      return;
    }
  }

  // ‚úÖ Registrar
  try {
    msg.textContent = "Registrando cliente...";
    const { collection, addDoc } = window.firebaseUtils;
    
    const nuevoCliente = {
      nombre: nombre,
      cedula: cedula && cedula !== "000000000" ? cedula : "",
      telefono: telefono.replace(/\D/g, ""),
      creado: new Date()
    };

    const ref = await addDoc(collection(window.db, "clientesBD"), nuevoCliente);
    
    clienteAutenticado = {
      id: ref.id,
      nombre: nombre,
      cedula: nuevoCliente.cedula,
      telefono: nuevoCliente.telefono
    };

    // üî• cargar lealtad REAL desde facturas
const lealtad = await cargarLealtadCliente(clienteAutenticado.id);
clienteAutenticado.lealtad = lealtad;
    
    localStorage.setItem("sesionEsentia", JSON.stringify(clienteAutenticado));
    
    // ¬øEs admin?
    const esAdmin = cedula === "110350666" || telefono.includes("110350666");
    if (esAdmin) {
      localStorage.setItem("adminEsentia", "1");
    } else {
      localStorage.removeItem("adminEsentia");
    }

    // ‚úÖ √âxito
    document.getElementById("nombreUsuario").textContent = nombre;
    document.getElementById("panelUsuario").style.display = "flex";
    renderTarjetaLealtad(clienteAutenticado);
    document.getElementById("btnLogin").style.display = "none";
    document.getElementById("modalLoginRegistro").style.display = "none";
    msg.textContent = "";
    document.getElementById("loader").style.display = "flex";
    window.catalogoListo = true;
    setTimeout(intentarRenderizar, 300);

    mostrarToast(`‚úÖ Bienvenido, ${nombre}!`, "#4caf50");

  } catch (err) {
    console.error("Error en registro:", err);
    msg.textContent = "‚ùå Error al registrar. Intenta de nuevo.";
  }
});

    // Tabs login/registro
    document.querySelectorAll(".btn-tab").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".btn-tab").forEach(b => b.classList.remove("activo"));
    btn.classList.add("activo");
    const tab = btn.dataset.tab;
    document.getElementById("formLogin").style.display = tab === "login" ? "block" : "none";
    document.getElementById("formRegistro").style.display = tab === "registro" ? "block" : "none";
    document.getElementById("loginMensaje").textContent = ""; // ‚úÖ limpiar mensaje al cambiar
  });
});
    // Acciones admin
    let adminProductoActualId = null;

    function activarAccionesAdminTarjetas() {
      const esAdmin = localStorage.getItem("adminEsentia") === "1";
      if (!esAdmin) return;

      const cards = document.querySelectorAll(".producto-card");
      cards.forEach(card => {
        if (card.dataset.adminEnhanced === "1") return;
        const img = card.querySelector("img");
        if (!img) return;
        const src = img.getAttribute("src") || "";
        if (!src) return;
        const file = src.split("/").pop().split(".")[0].toLowerCase();

        const wrapper = img.parentElement;
        if (!wrapper) return;
        if (getComputedStyle(wrapper).position === "static") {
          wrapper.style.position = "relative";
        }

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "admin-dot-btn";
        btn.textContent = "‚ãÆ";
        btn.addEventListener("click", e => {
          e.stopPropagation();
          abrirAdminSheet(file);
        });

        wrapper.appendChild(btn);
        card.dataset.adminEnhanced = "1";
      });
    }

    function abrirAdminSheet(idProducto) {
      adminProductoActualId = idProducto;
      const overlay = document.getElementById("adminSheetOverlay");
      if (!overlay) return;
      overlay.style.display = "flex";
    }

    function cerrarAdminSheet() {
      const overlay = document.getElementById("adminSheetOverlay");
      if (overlay) overlay.style.display = "none";
      adminProductoActualId = null;
    }

    function publicarFacebook(idProducto) {
      if (!idProducto) return;
      const urlProducto = `https://wil1979.github.io/esentia-factura/producto.html?id=${encodeURIComponent(
        idProducto
      )}`;
      const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(
        urlProducto
      )}`;
      window.open(shareUrl, "_blank");
    }

    function publicarFacebookDesdeSheet() {
      if (!adminProductoActualId) return;
      publicarFacebook(adminProductoActualId);
    }

    function activarControlesAdmin() {
  const esAdmin = localStorage.getItem("adminEsentia") === "1";
  const btn = document.getElementById("btnToggleVisitas");
  const panel = document.getElementById("panelVisitas");

  if (!btn || !panel) return;

  if (!esAdmin) {
    btn.classList.add("hidden");
    panel.classList.add("hidden");
    return;
  }

  btn.classList.remove("hidden");

  // Restaurar estado anterior
  const visible = localStorage.getItem("visitasVisible") === "1";
  if (visible) {
    panel.classList.remove("hidden");
    mostrarPanelVisitasAdmin();
  } else {
    panel.classList.add("hidden");
  }
}

    // Cerrar bottom sheet al tocar fuera
    window.addEventListener("click", e => {
      const overlay = document.getElementById("adminSheetOverlay");
      if (!overlay || overlay.style.display !== "flex") return;
      if (e.target === overlay) {
        cerrarAdminSheet();
      }
    });

    // Aviso al salir si hay productos en carrito
    window.addEventListener("beforeunload", e => {
      try {
        const data = localStorage.getItem("carrito");
        if (!data) return;
        const c = JSON.parse(data);
        if (!Array.isArray(c) || c.length === 0) return;
        const mensaje =
          "Tienes productos en tu carrito. ¬øSeguro que deseas salir sin completar tu compra?";
        e.returnValue = mensaje;
        return mensaje;
      } catch {
        return;
      }
    });

    document.addEventListener("DOMContentLoaded", () => {
      cargarCarrito();
      document
        .getElementById("btnAplicarCodigo")
        ?.addEventListener("click", aplicarCodigoPremio);
      verificarSesion();
      cargarProductos(); // üî• importante para que cargue el cat√°logo

      const params = new URLSearchParams(window.location.search);
      if (params.get("added") === "1") {
        setTimeout(() => {
          mostrarToast("Producto a√±adido al carrito üõí");
        }, 600);
      }
    });

    function cargarCarrito() {
      const data = localStorage.getItem("carrito");
      if (data) carrito = JSON.parse(data);
      renderCarrito();
    }

    function renderCarrito() {
      const lista = document.getElementById("listaCarrito");
      const contador = document.getElementById("contadorCarrito");
      const totalModal = document.getElementById("totalModal");

      if (!lista || !contador || !totalModal) return;

      lista.innerHTML = "";
      let total = 0;

      carrito.forEach((item, index) => {
        const li = document.createElement("li");
        li.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span>${item.nombre} (${item.cantidad})</span>
          <strong>‚Ç°${(item.precio * item.cantidad).toLocaleString()}</strong>
        </div>
        <button onclick="eliminarDelCarrito(${index})"
          style="background:#ff5b5b; color:white; border:none; padding:5px 8px; border-radius:6px; margin-top:6px; cursor:pointer;">
          üóë Quitar
        </button>
      `;
        lista.appendChild(li);
        total += item.precio * item.cantidad;
      });

      totalModal.textContent = `Total: ‚Ç°${total.toLocaleString()}`;
      contador.textContent = carrito.length;
      localStorage.setItem("carrito", JSON.stringify(carrito));
    }

    function eliminarDelCarrito(i) {
      carrito.splice(i, 1);
      renderCarrito();
    }

    function aplicarCodigoPremio() {
      const input = document.getElementById("codigoPremio");
      if (!input) return;

      const codigo = input.value.trim().toUpperCase();
      if (!codigo) {
        mostrarToast("Ingresa un c√≥digo v√°lido ‚ùó", "#E74C3C");
        return;
      }

      const codigosValidos = {
        ESENTIA10: { tipo: "porcentaje", valor: 10 },
        ESENTIA20: { tipo: "porcentaje", valor: 20 },
        NAVIDAD: { tipo: "monto", valor: 1500 },
        PREMIO1: { tipo: "monto", valor: 1000 }
      };

      const promo = codigosValidos[codigo];
      if (!promo) {
        mostrarToast("C√≥digo inv√°lido ‚ùå", "#E74C3C");
        return;
      }

      let total = carrito.reduce(
        (sum, item) => sum + item.precio * item.cantidad,
        0
      );

      let descuento = 0;
      if (promo.tipo === "porcentaje") {
        descuento = Math.round(total * (promo.valor / 100));
      } else if (promo.tipo === "monto") {
        descuento = promo.valor;
      }

      total -= descuento;
      if (total < 0) total = 0;

      document.getElementById("totalModal").textContent = `Total con descuento: ‚Ç°${total.toLocaleString()} (-‚Ç°${descuento.toLocaleString()})`;

      mostrarToast(
        `C√≥digo aplicado üéâ Descuento: ‚Ç°${descuento.toLocaleString()}`
      );

      codigoAplicado = codigo;
      descuentoAplicado = descuento;
    }

    // Aqu√≠ deber√≠as tener tu funci√≥n finalizarPedido() original
    function finalizarPedido() {
      if (!clienteAutenticado) {
        mostrarToast("Inicia sesi√≥n para finalizar el pedido", "#E74C3C");
        abrirLoginRegistro();
        return;
      }
      if (!carrito.length) {
        mostrarToast("Tu carrito est√° vac√≠o üõí", "#E74C3C");
        return;
      }

      let mensaje = `Hola Wilber üëã\n\nQuiero hacer un pedido:\n\n`;
      carrito.forEach(item => {
        mensaje += `‚Ä¢ ${item.nombre} x${item.cantidad} ‚Äì ‚Ç°${(item.precio * item.cantidad).toLocaleString()}\n`;
      });
      let total = carrito.reduce(
        (sum, item) => sum + item.precio * item.cantidad,
        0
      );
      if (descuentoAplicado > 0) {
        mensaje += `\nDescuento aplicado: -‚Ç°${descuentoAplicado.toLocaleString()}`;
        total -= descuentoAplicado;
      }
      mensaje += `\n\nTotal a pagar: ‚Ç°${total.toLocaleString()}\n\n`;
      mensaje += `Cliente: ${clienteAutenticado.nombre}\nTel: ${clienteAutenticado.telefono || "No registrado"}`;

      window.open(
        `https://wa.me/50672952454?text=${encodeURIComponent(mensaje)}`,
        "_blank"
      );
    }

    function publicarFacebookOG() {
  if (!adminProductoActualId) return;

  const urlOG = `https://wil1979.github.io/esentia-factura/og/${adminProductoActualId}.html`;
  const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(urlOG)}`;
  window.open(shareUrl, "_blank");
}

function publicarFacebookDirecto() {
  if (!adminProductoActualId) return;

  const urlProducto = `https://wil1979.github.io/esentia-factura/producto.html?id=${encodeURIComponent(adminProductoActualId)}`;
  const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(urlProducto)}`;
  window.open(shareUrl, "_blank");
}

function actualizarCatalogoConStock() {
  const cards = document.querySelectorAll(".producto-card");

  cards.forEach(card => {
    const nombre = card.dataset.nombre;

    // Lectura del stock desde inventario
    const stock = inventario[nombre] ?? 0;

    // Busca la etiqueta donde se muestra el stock
    const label = card.querySelector(".stock-label");

    if (!label) return;

    if (stock > 10) {
      label.textContent = "En stock";
      label.style.color = "#28a745"; // verde
    } else if (stock > 0) {
      label.textContent = `Stock: ${stock}`;
      label.style.color = "#f0ad4e"; // amarillo
    } else {
      label.textContent = "Agotado";
      label.style.color = "#dc3545"; // rojo
      // (Opcional: desactivar bot√≥n si quer√©s)
      const btn = card.querySelector(".btn-agregar");
      if (btn) btn.disabled = true;
    }
  });
}

function togglePanelVisitas() {
  const panel = document.getElementById("panelVisitas");
  if (!panel) return;

  const visible = !panel.classList.contains("hidden");

  if (visible) {
    panel.classList.add("hidden");
    localStorage.setItem("visitasVisible", "0");
  } else {
    panel.classList.remove("hidden");
    localStorage.setItem("visitasVisible", "1");
    mostrarPanelVisitasAdmin(); // recarga si se abre
  }
}

  </script>

  <!-- Bottom sheet admin -->
 <div id="adminSheetOverlay" class="admin-sheet-overlay">
  <div class="admin-sheet">
    <div class="admin-sheet-handle"></div>
    <div class="admin-sheet-title">Acciones de administrador</div>
    <div class="admin-sheet-desc">Herramientas r√°pidas para este producto.</div>

    <!-- Vista PRO con p√°gina OG -->
    <button type="button" class="admin-sheet-btn" onclick="publicarFacebookOG()">
      <span>üì£</span> <span>Publicar en Facebook (Vista PRO)</span>
    </button>

    <!-- Enlace directo normal al producto -->
    <button type="button" class="admin-sheet-btn-secondary" onclick="publicarFacebookDirecto()">
      üîó Publicar en Facebook (Enlace directo)
    </button>

    <button type="button" class="admin-sheet-btn-secondary" onclick="cerrarAdminSheet()">
      Cancelar
    </button>
  </div>
</div>

<div id="panelVisitas" class="glass-visitas hidden">
  <h3>üëÅÔ∏è Visitas al cat√°logo</h3>
  <div id="listaVisitas"></div>
</div>

<button id="btnToggleVisitas" class="btn-toggle-visitas hidden"
        onclick="togglePanelVisitas()"
        title="Mostrar / ocultar visitas">
  üëÅÔ∏è
</button> 

 <button type="button" class="admin-sheet-btn-secondary" onclick="mostrarPanelVisitasAdmin()"></button>

 
  
</body>
</html>