<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Generador de Etiquetas Esentia</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
:root{
  --ancho-etiqueta:2cm;
  --alto-etiqueta:4cm;
  --tamano-fuente:7px;
  --tamano-nombre:7px;
  --ancho-logo:65px;

  --color-fondo:#ffffff;
  --color-texto:#000000;
  --color-borde:#cccccc;

  --debug-color:#ff0000;
}

@page{
  size:letter;
  margin:0.5cm;
}

body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#fff;
}

/* === CONTENEDOR HOJA === */
.hoja{
  display:grid;
  gap:5mm;
  padding:1.5cm;
  max-width:21.6cm;
  grid-auto-flow:row;
}

/* === ETIQUETA === */
.etiqueta{
  width:var(--ancho-etiqueta);
  height:var(--alto-etiqueta);
  padding:2mm;
  box-sizing:border-box;
  border:0.5px solid var(--color-borde);
  border-radius:15%;
  background:var(--color-fondo);
  color:var(--color-texto);
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  text-align:center;
  font-size:var(--tamano-fuente);
  break-inside:avoid;
}

.etiqueta.redonda{
  border-radius:50%;
  padding:1mm;
}

.logo{
  width:var(--ancho-logo);
  margin:0 auto;
}

.nombre-producto{
  font-size:var(--tamano-nombre);
  font-weight:bold;
  line-height:1.1;
}

.precio{
  font-weight:bold;
}

/* === MODO DEBUG (GU√çAS) === */
body.debug .etiqueta{
  outline:0.5px dashed var(--debug-color);
}

body.debug .hoja{
  outline:1px solid var(--debug-color);
  background:
    repeating-linear-gradient(
      to right,
      rgba(255,0,0,0.08),
      rgba(255,0,0,0.08) 1px,
      transparent 1px,
      transparent 1cm
    ),
    repeating-linear-gradient(
      to bottom,
      rgba(255,0,0,0.08),
      rgba(255,0,0,0.08) 1px,
      transparent 1px,
      transparent 1cm
    );
}

/* === OPTIMIZACI√ìN IMPRESI√ìN === */
body.imprimiendo *{
  transition:none!important;
  animation:none!important;
}

/* === PANEL === */
.config-modal{
  position:fixed;
  right:0;
  top:0;
  width:320px;
  height:100%;
  background:#fff;
  border-left:1px solid #ccc;
  padding:15px;
  overflow:auto;
  z-index:1000;
}

.config-modal.hidden{
  transform:translateX(100%);
}

label{
  font-size:12px;
  font-weight:bold;
  display:block;
  margin-top:8px;
}

input,select,button{
  width:100%;
  margin-top:4px;
  font-size:12px;
}

button{
  padding:6px;
  cursor:pointer;
}

#btnConfig{
  position:fixed;
  bottom:15px;
  right:15px;
  z-index:1100;
}

/* === PRINT === */
@media print{
  .config-modal,#btnConfig{ display:none!important }
  body.debug .hoja{ background:none!important }
}
@media print {
  .etiqueta {
    page-break-inside: avoid;
  }
}

</style>
</head>

<body>

<!-- PANEL -->
<div class="config-modal" id="configModal">
  <h3>Configuraci√≥n</h3>

  <label>Cantidad por producto</label>
  <input type="number" id="cantidad" value="6">

  <label>Forma</label>
  <select id="forma">
    <option value="rectangular">Rectangular</option>
    <option value="redonda">Redonda</option>
  </select>

  <label>Ancho etiqueta (cm)</label>
  <input type="number" id="ancho" value="2" step="0.1">

  <label>Alto etiqueta (cm)</label>
  <input type="number" id="alto" value="4" step="0.1">

  <label>Precio</label>
  <input type="text" id="precio" value="¬§20 ml ¬§30 ml">

  <hr>

  <h4>üé® Colores</h4>

  <label>Fondo</label>
  <input type="color" id="colorFondo" value="#ffffff">

  <label>Texto</label>
  <input type="color" id="colorTexto" value="#000000">

  <label>Borde</label>
  <input type="color" id="colorBorde" value="#cccccc">

  <hr>

  <button onclick="toggleDebug()">üéØ Mostrar / ocultar gu√≠as</button>
  <button onclick="imprimir()">üßæ Imprimir / PDF</button>
</div>

<button id="btnConfig" onclick="toggleConfig()">‚öôÔ∏è</button>

<div class="hoja" id="hoja"></div>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey:"AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
  authDomain:"esentiacreditos-8345f.firebaseapp.com",
  projectId:"esentiacreditos-8345f"
});
const db=firebase.firestore();

/* ================= GLOBAL ================= */
const LOGO="https://wil1979.github.io/esentia-factura/images/logo.png";
let productos=[];
let printing=false;

/* ================= DATA ================= */
async function cargarProductos(){
  const snap=await db.collection("stock").get();
  productos=[];
  snap.forEach(d=>{
    const p=d.data();
    if(p.cantidad>0){
      productos.push({
        nombre:p.nombre,
        imagen:`https://wil1979.github.io/esentia-factura/etiqueta/${p.nombre
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g,"")
          .replace(/\s+/g,"")
          .toLowerCase()}.png`
      });
    }
  });
  generarEtiquetas();
}

/* ================= CORE ================= */
function generarEtiquetas(){
  const hoja=document.getElementById("hoja");
  hoja.innerHTML="";

  const cfg={
    cantidad:+cantidad.value||1,
    ancho:+ancho.value||2,
    alto:+alto.value||4,
    forma:forma.value,
    precio:precio.value,
    fondo:colorFondo.value,
    texto:colorTexto.value,
    borde:colorBorde.value
  };

  /* === CSS VARIABLES === */
  document.documentElement.style.setProperty("--ancho-etiqueta",cfg.ancho+"cm");
  document.documentElement.style.setProperty("--alto-etiqueta",cfg.alto+"cm");
  document.documentElement.style.setProperty("--color-fondo",cfg.fondo);
  document.documentElement.style.setProperty("--color-texto",cfg.texto);
  document.documentElement.style.setProperty("--color-borde",cfg.borde);

  /* === CALCULO DE COLUMNAS (LETTER) === */
  const ANCHO_HOJA=21.6;
  const PADDING=3; // 1.5cm x 2
  const GAP=0.5;   // 5mm

  const anchoEtiqueta=cfg.forma==="redonda"
    ? Math.min(cfg.ancho,cfg.alto)
    : cfg.ancho;

  const columnas=Math.max(
    1,
    Math.floor((ANCHO_HOJA-PADDING)/(anchoEtiqueta+GAP))
  );

  hoja.style.gridTemplateColumns=`repeat(${columnas}, ${anchoEtiqueta}cm)`;

  /* === RENDER === */
  const frag=document.createDocumentFragment();
  let count=0, MAX_PREVIEW=60;

  productos.forEach(p=>{
    for(let i=0;i<cfg.cantidad;i++){
      if(!printing && count>=MAX_PREVIEW) return;
      count++;

      const e=document.createElement("div");
      e.className="etiqueta"+(cfg.forma==="redonda"?" redonda":"");

      e.innerHTML=`
        <img src="${LOGO}" class="logo" loading="lazy">
        <div class="nombre-producto">${p.nombre}</div>
        <img src="${p.imagen}"
             style="max-width:80%;margin:auto"
             loading="lazy"
             onerror="this.style.display='none'">
        <div class="precio">${cfg.precio}</div>
      `;

      frag.appendChild(e);
    }
  });

  hoja.appendChild(frag);
}

/* ================= DEBUG ================= */
function toggleDebug(){
  document.body.classList.toggle("debug");
}

/* ================= PRINT ================= */
function imprimir(){
  printing=true;
  generarEtiquetas();
  document.body.classList.add("imprimiendo");

  setTimeout(()=>{
    window.print();
    printing=false;
    document.body.classList.remove("imprimiendo");
    generarEtiquetas();
  },300);
}

/* ================= UI ================= */
function toggleConfig(){
  configModal.classList.toggle("hidden");
}

window.onload=cargarProductos;
</script>

</body>
</html>