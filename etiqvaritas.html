<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Generador de Etiquetas Esentia</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
:root{
  --ancho-etiqueta:2cm;
  --alto-etiqueta:4cm;
  --tamano-fuente:7px;
  --tamano-nombre:7px;
  --ancho-logo:65px;
  --diametro-etiqueta:2cm;
  --border-radius:2px;
}

@page{
  size:letter;
  margin:0.5cm;
}

body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#fff;
}

.hoja{
  display:grid;
  gap:5mm;
  padding:1.5cm;
  max-width:21.6cm;
}

.etiqueta{
  width:var(--ancho-etiqueta);
  height:var(--alto-etiqueta);
  border:0.5px solid #ccc;
  padding:2mm;
  font-size:var(--tamano-fuente);
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  text-align:center;
  box-sizing:border-box;
  break-inside:avoid;
}

.etiqueta.redonda{
  border-radius:50%;
  padding:1mm;
}

.logo{
  width:var(--ancho-logo);
  margin:0 auto;
}

.nombre-producto{
  font-size:var(--tamano-nombre);
  font-weight:bold;
  line-height:1.1;
}

.precio{
  font-weight:bold;
}

body.imprimiendo *{
  animation:none!important;
  transition:none!important;
}

.config-modal{
  position:fixed;
  right:0;
  top:0;
  width:300px;
  height:100%;
  background:#fff;
  border-left:1px solid #ccc;
  padding:15px;
  overflow:auto;
  z-index:1000;
}

.config-modal.hidden{transform:translateX(100%)}

@media print{
  .config-modal,#btnConfig{display:none!important}
}
</style>
</head>

<body>

<!-- PANEL -->
<div class="config-modal" id="configModal">
  <h3>Configuraci√≥n</h3>

  <label>Cantidad por producto</label>
  <input type="number" id="cantidad" value="6" oninput="generarEtiquetas()">

  <label>Forma</label>
  <select id="forma" onchange="generarEtiquetas()">
    <option value="rectangular">Rectangular</option>
    <option value="redonda">Redonda</option>
  </select>

  <label>Ancho (cm)</label>
  <input type="number" id="ancho" value="2" step="0.1" oninput="generarEtiquetas()">

  <label>Alto (cm)</label>
  <input type="number" id="alto" value="4" step="0.1" oninput="generarEtiquetas()">

  <label>Precio</label>
  <input type="text" id="precio" value="¬§20 ml ¬§30 ml">

  <button onclick="imprimir()">üßæ Imprimir / PDF r√°pido</button>
</div>

<button id="btnConfig" onclick="toggleConfig()" style="position:fixed;bottom:15px;right:15px;">‚öôÔ∏è</button>

<div class="hoja" id="hoja"></div>

<script>
/* ================= CONFIG ================= */
const firebaseConfig={
  apiKey:"AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
  authDomain:"esentiacreditos-8345f.firebaseapp.com",
  projectId:"esentiacreditos-8345f"
};

firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const LOGO_URL="https://wil1979.github.io/esentia-factura/images/logo.png";
window.DEBUG_ETIQUETAS=false;
let printing=false;
let productos=[];

/* ================= DATA ================= */
async function cargarProductos(){
  const snap=await db.collection("stock").get();
  productos=[];
  snap.forEach(d=>{
    const p=d.data();
    if(p.cantidad>0){
      productos.push({
        nombre:p.nombre||"Producto",
        imagen:`https://wil1979.github.io/esentia-factura/etiqueta/${(p.nombre||"").toLowerCase().replace(/\s+/g,"")}.png`
      });
    }
  });
  generarEtiquetas();
}

/* ================= CORE ================= */
function generarEtiquetas(){
  const hoja=document.getElementById("hoja");
  hoja.innerHTML="";

  const cfg={
    cantidad:+document.getElementById("cantidad").value||1,
    ancho:+document.getElementById("ancho").value||2,
    alto:+document.getElementById("alto").value||4,
    forma:document.getElementById("forma").value,
    precio:document.getElementById("precio").value
  };

  document.documentElement.style.setProperty("--ancho-etiqueta",cfg.ancho+"cm");
  document.documentElement.style.setProperty("--alto-etiqueta",cfg.alto+"cm");
  document.documentElement.style.setProperty("--border-radius",cfg.forma==="redonda"?"50%":"2px");

  const frag=document.createDocumentFragment();
  const MAX_PREVIEW=60;
  let count=0;

  productos.forEach(p=>{
    for(let i=0;i<cfg.cantidad;i++){
      if(!printing && count>=MAX_PREVIEW) return;
      count++;

      const e=document.createElement("div");
      e.className="etiqueta"+(cfg.forma==="redonda"?" redonda":"");

      e.innerHTML=`
        <img src="${LOGO_URL}" class="logo" loading="lazy" decoding="async">
        <div class="nombre-producto">${p.nombre}</div>
        <img src="${p.imagen}" loading="lazy" decoding="async"
             style="max-width:80%;margin:auto"
             onerror="this.style.display='none'">
        <div class="precio">${cfg.precio}</div>
      `;
      frag.appendChild(e);
    }
  });

  hoja.appendChild(frag);
}

/* ================= PRINT ================= */
function imprimir(){
  printing=true;
  generarEtiquetas();
  document.body.classList.add("imprimiendo");
  setTimeout(()=>{
    window.print();
    printing=false;
    document.body.classList.remove("imprimiendo");
    generarEtiquetas();
  },300);
}

/* ================= UI ================= */
function toggleConfig(){
  document.getElementById("configModal").classList.toggle("hidden");
}

window.onload=cargarProductos;
</script>

</body>
</html>