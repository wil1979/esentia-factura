<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Generador de Etiquetas Esentia</title>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<style>
:root{
  --ancho-etiqueta:2cm;
  --alto-etiqueta:4cm;
  --tamano-fuente:7px;
  --tamano-nombre:7px;
  --ancho-logo:65px;
  --color-fondo:#ffffff;
  --color-texto:#000000;
  --color-borde:#cccccc;
}

@page{ size:letter; margin:0.5cm }

body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#fff;
}

.hoja{
  display:grid;
  gap:5mm;
  padding:1.5cm;
  max-width:21.6cm;
}

.etiqueta{
  width:var(--ancho-etiqueta);
  height:var(--alto-etiqueta);
  padding:2mm;
  box-sizing:border-box;
  border:0.5px solid var(--color-borde);
  background:var(--color-fondo);
  color:var(--color-texto);
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  text-align:center;
  break-inside:avoid;
  font-size:var(--tamano-fuente);
}

.etiqueta.redonda{
  border-radius:50%;
  padding:1mm;
}

.logo{ width:var(--ancho-logo); margin:0 auto }
.nombre-producto{ font-size:var(--tamano-nombre); font-weight:bold }
.precio{ font-weight:bold }

body.imprimiendo *{
  transition:none!important;
  animation:none!important;
}

.config-modal{
  position:fixed;
  right:0;
  top:0;
  width:320px;
  height:100%;
  background:#fff;
  border-left:1px solid #ccc;
  padding:15px;
  overflow:auto;
  z-index:1000;
}

.config-modal.hidden{ transform:translateX(100%) }

label{ font-size:12px; font-weight:bold; display:block; margin-top:8px }
input,select,button{ width:100%; margin-top:4px; font-size:12px }

@media print{
  .config-modal,#btnConfig{ display:none!important }
}
</style>
</head>

<body>

<div class="config-modal" id="configModal">
  <h3>Configuraci√≥n</h3>

  <label>Cantidad por producto</label>
  <input type="number" id="cantidad" value="6">

  <label>Forma</label>
  <select id="forma">
    <option value="rectangular">Rectangular</option>
    <option value="redonda">Redonda</option>
  </select>

  <label>Ancho (cm)</label>
  <input type="number" id="ancho" value="2" step="0.1">

  <label>Alto (cm)</label>
  <input type="number" id="alto" value="4" step="0.1">

  <label>Precio</label>
  <input type="text" id="precio" value="¬§20 ml ¬§30 ml">

  <hr>

  <h4>üé® Colores</h4>

  <label>Fondo etiqueta</label>
  <input type="color" id="colorFondo" value="#ffffff">

  <label>Texto</label>
  <input type="color" id="colorTexto" value="#000000">

  <label>Borde</label>
  <input type="color" id="colorBorde" value="#cccccc">

  <hr>

  <h4>üß† Presets</h4>

  <input type="text" id="nombrePreset" placeholder="Nombre del preset">
  <button onclick="guardarPreset()">üíæ Guardar preset</button>

  <select id="listaPresets" onchange="cargarPreset()">
    <option value="">‚Äî Seleccionar preset ‚Äî</option>
  </select>

  <button onclick="eliminarPreset()" style="background:#f44336;color:#fff">üóë Eliminar preset</button>

  <hr>

  <button onclick="imprimir()">üßæ Imprimir / PDF r√°pido</button>
</div>

<button id="btnConfig" onclick="toggleConfig()" style="position:fixed;bottom:15px;right:15px;">‚öôÔ∏è</button>

<div class="hoja" id="hoja"></div>

<script>
/* ========= FIREBASE ========= */
firebase.initializeApp({
  apiKey:"AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
  authDomain:"esentiacreditos-8345f.firebaseapp.com",
  projectId:"esentiacreditos-8345f"
});
const db=firebase.firestore();

/* ========= GLOBAL ========= */
const LOGO="https://wil1979.github.io/esentia-factura/images/logo.png";
let productos=[];
let printing=false;

/* ========= DATA ========= */
async function cargarProductos(){
  const snap=await db.collection("stock").get();
  productos=[];
  snap.forEach(d=>{
    const p=d.data();
    if(p.cantidad>0){
      productos.push({
        nombre:p.nombre,
        imagen:`https://wil1979.github.io/esentia-factura/etiqueta/${p.nombre.toLowerCase().replace(/\s+/g,"")}.png`
      });
    }
  });
  generarEtiquetas();
}

/* ========= CORE ========= */
function generarEtiquetas(){
  const hoja=document.getElementById("hoja");
  hoja.innerHTML="";

  const cfg={
    cantidad:+cantidad.value,
    ancho:+ancho.value,
    alto:+alto.value,
    forma:forma.value,
    precio:precio.value,
    fondo:colorFondo.value,
    texto:colorTexto.value,
    borde:colorBorde.value
  };

  document.documentElement.style.setProperty("--ancho-etiqueta",cfg.ancho+"cm");
  document.documentElement.style.setProperty("--alto-etiqueta",cfg.alto+"cm");
  document.documentElement.style.setProperty("--color-fondo",cfg.fondo);
  document.documentElement.style.setProperty("--color-texto",cfg.texto);
  document.documentElement.style.setProperty("--color-borde",cfg.borde);

  const frag=document.createDocumentFragment();
  let count=0, MAX=60;

  productos.forEach(p=>{
    for(let i=0;i<cfg.cantidad;i++){
      if(!printing && count>=MAX) return;
      count++;

      const e=document.createElement("div");
      e.className="etiqueta"+(cfg.forma==="redonda"?" redonda":"");
      e.innerHTML=`
        <img src="${LOGO}" class="logo" loading="lazy">
        <div class="nombre-producto">${p.nombre}</div>
        <img src="${p.imagen}" style="max-width:80%" loading="lazy" onerror="this.style.display='none'">
        <div class="precio">${cfg.precio}</div>
      `;
      frag.appendChild(e);
    }
  });

  hoja.appendChild(frag);
}

/* ========= PRESETS ========= */
function guardarPreset(){
  const nombre=nombrePreset.value.trim();
  if(!nombre) return alert("Nombre requerido");

  const preset={
    cantidad:cantidad.value,
    ancho:ancho.value,
    alto:alto.value,
    forma:forma.value,
    precio:precio.value,
    fondo:colorFondo.value,
    texto:colorTexto.value,
    borde:colorBorde.value
  };

  localStorage.setItem("preset_"+nombre,JSON.stringify(preset));
  cargarListaPresets();
  nombrePreset.value="";
}

function cargarPreset(){
  const key=listaPresets.value;
  if(!key) return;
  const p=JSON.parse(localStorage.getItem(key));

  Object.assign(cantidad,p.cantidad);
  ancho.value=p.ancho;
  alto.value=p.alto;
  forma.value=p.forma;
  precio.value=p.precio;
  colorFondo.value=p.fondo;
  colorTexto.value=p.texto;
  colorBorde.value=p.borde;

  generarEtiquetas();
}

function eliminarPreset(){
  const key=listaPresets.value;
  if(key && confirm("Eliminar preset?")){
    localStorage.removeItem(key);
    cargarListaPresets();
  }
}

function cargarListaPresets(){
  listaPresets.innerHTML='<option value="">‚Äî Seleccionar preset ‚Äî</option>';
  Object.keys(localStorage)
    .filter(k=>k.startsWith("preset_"))
    .forEach(k=>{
      const o=document.createElement("option");
      o.value=k;
      o.textContent=k.replace("preset_","");
      listaPresets.appendChild(o);
    });
}

/* ========= PRINT ========= */
function imprimir(){
  printing=true;
  generarEtiquetas();
  document.body.classList.add("imprimiendo");
  setTimeout(()=>{
    window.print();
    printing=false;
    document.body.classList.remove("imprimiendo");
    generarEtiquetas();
  },300);
}

function toggleConfig(){
  configModal.classList.toggle("hidden");
}

window.onload=()=>{
  cargarProductos();
  cargarListaPresets();
  generarEtiquetas();
};
</script>

</body>
</html>