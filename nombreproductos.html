<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Esentia – Etiquetas DTF + Foil + QR</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: "Playfair Display", serif;
      margin: 0;
      background: #f4f4f4;
    }

    header {
      background: #222;
      color: white;
      padding: 18px;
      text-align: center;
      font-size: 26px;
    }

    #controls {
      padding: 20px;
      display: flex;
      gap:20px;
      flex-wrap: wrap;
      background: #fff;
    }

    button {
      padding: 12px 20px;
      font-size: 17px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      background: #333;
      color: white;
    }

    #previewArea {
      margin: 30px auto;
      background: white;
      padding: 40px;
      width: fit-content;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 15px rgba(0,0,0,0.15);
    }

    /* Modal selector */
    #modal {
      position: fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.65);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:100;
    }

    #modalContent {
      background:white;
      padding:25px;
      width: 450px;
      max-height:80vh;
      overflow-y:auto;
      border-radius:15px;
    }

    .qrContainer {
      margin-top:20px;
    }

  </style>
</head>
<body>

<header>Generador de Etiquetas Esentia – Foil + QR</header>

<div id="controls">

  <button onclick="abrirSelector()">Seleccionar productos</button>

  <select id="foilSelector">
    <option value="gold">Foil Gold</option>
    <option value="silver">Foil Silver (pendiente)</option>
    <option value="black">Black Matte</option>
    <option value="white">White Gloss</option>
    <option value="holo">Holographic (pendiente)</option>
  </select>

  <label>Tamaño texto: 
    <input id="fontSize" type="number" value="120" min="20" max="300">
  </label>

  <button onclick="exportPNG()">Exportar PNG</button>
  <button onclick="exportPDF()">Exportar PDF</button>
</div>

<!-- Vista previa -->
<div id="previewArea">
  <img id="foilSvg" src="esign/foil/gold.svg" width="700">
  <div class="qrContainer">
    <canvas id="qrCanvas"></canvas>
  </div>
</div>


<!-- Modal selector -->
<div id="modal">
  <div id="modalContent">
    <h2>Selecciona los productos</h2>
    <div id="listaProductos"></div>
    <br>
    <button onclick="cerrarSelector()">Cerrar</button>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>

// ---------- CARGAR JSON ----------
let productos = [];
fetch("productos_esentia.json")
  .then(r => r.json())
  .then(data => {
    productos = data;
    cargarListaProductos();
  });


// ---------- SELECTOR ----------
function abrirSelector(){ document.getElementById("modal").style.display="flex"; }
function cerrarSelector(){ document.getElementById("modal").style.display="none"; }

function cargarListaProductos(){
  const lista = document.getElementById("listaProductos");
  lista.innerHTML = productos.map(p => `
    <label>
      <input type="radio" name="producto" value="${(p.nombreOriginal || p.nombre).replace(/\s+/g,'')}">
      ${p.nombre}
    </label><br>
  `).join("");
}

// ---------- PREVIEW FOIL + QR ----------
function actualizarPreview(){

  const seleccionado = document.querySelector("input[name='producto']:checked");
  if(!seleccionado) return;

  const id = seleccionado.value;
  const item = productos.find(p => (p.nombreOriginal || p.nombre).replace(/\s+/g,'') === id);

  // cambiar texto en el SVG foil
  const size = document.getElementById("fontSize").value;
  const foil = document.getElementById("foilSelector").value;
  const svgPath = `esign/foil/gold.svg`;

  // Recargar SVG y reemplazar texto dinámicamente
  fetch(svgPath)
    .then(r => r.text())
    .then(svg => {
      svg = svg.replace(">SAMPLE<", `>${item.nombre}<`);
      svg = svg.replace('font-size="120"', `font-size="${size}"`);
      const blob = new Blob([svg], {type:"image/svg+xml"});
      const url = URL.createObjectURL(blob);
      document.getElementById("foilSvg").src = url;
    });

  // QR
  const qrUrl = `https://wil1979.github.io/esentia-factura/producto.html?id=${id}`;
  const qr = new QRious({
    element: document.getElementById("qrCanvas"),
    value: qrUrl,
    size: 200,
  });
}

document.getElementById("modal").addEventListener("change", actualizarPreview);
document.getElementById("fontSize").addEventListener("input", actualizarPreview);
document.getElementById("foilSelector").addEventListener("change", actualizarPreview);


// ---------- EXPORTAR PNG ----------
function exportPNG(){
  html2canvas(document.getElementById("previewArea")).then(canvas => {
    const link = document.createElement("a");
    link.download = "etiqueta.png";
    link.href = canvas.toDataURL();
    link.click();
  });
}


// ---------- EXPORTAR PDF ----------
function exportPDF(){
  html2canvas(document.getElementById("previewArea")).then(canvas => {
    const img = canvas.toDataURL("image/png");
    const pdf = new jsPDF({orientation:"portrait", unit:"px", format:"a4"});
    pdf.addImage(img, "PNG", 20, 20);
    pdf.save("etiqueta.pdf");
  });
}

</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>