<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Esentia DTF UV Tool PRO</title>

<!-- Fuentes elegantes -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Cinzel:wght@400;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">

<style>
body {
    background: #eaeaea;
    padding: 20px;
    font-family: Arial, sans-serif;
}
.panel {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
}
button {
    padding: 10px 20px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    background: #444;
    color: white;
}
#preview {
    background: white;
    padding: 30px;
    border-radius: 12px;
    min-height: 400px;
}
.item {
    margin: 12px 0;
    padding: 10px;
    cursor: grab;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
.item.dragging {
    opacity: 0.4;
}
.qr {
    width: 60px;
    margin-left: 20px;
}
#logo {
    width: 120px;
    display: none;
    margin-bottom: 20px;
}

/* Bordes */
.border-gold { border-bottom: 2px solid #d4af37; }
.border-black { border-bottom: 2px solid #000; }
.border-double { border-bottom: 4px double black; }

/* FOIL GOLD REAL */
.foil-gold {
    background: linear-gradient(45deg, #d4af37, #f7e98e, #b2892b, #f4d77f, #c59c35);
    background-size: 200% 200%;
    animation: shine 4s ease infinite;
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent !important;
    filter: drop-shadow(0 0 5px rgba(255,200,80,0.4));
}
@keyframes shine {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* MODAL SELECTOR */
#modal {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
#modal-content {
    width: 90%;
    height: 80%;
    background: white;
    padding: 20px;
    border-radius: 12px;
    overflow-y: auto;
}
</style>
</head>

<body>

<div class="panel">
    <h2>Esentia DTF UV ‚Äì Panel de Control</h2>

    <button onclick="abrirModal()">Seleccionar productos</button>
    <br><br>

    <label>üé® Estilo visual:</label><br>
    <select id="theme">
        <option value="deluxe">‚ú® Deluxe</option>
        <option value="nature">üåø Nature</option>
        <option value="minimal">üñ§ Minimal</option>
    </select><br><br>

    <label>üé® Color del texto:</label><br>
    <select id="color">
        <option value="foil">‚ú® Foil Gold (Met√°lico)</option>
        <option value="#d4af37">Oro</option>
        <option value="#c0c0c0">Plata</option>
        <option value="#000">Negro</option>
        <option value="#fff">Blanco</option>
    </select><br><br>

    <label>üìè Tipo de borde:</label><br>
    <select id="border">
        <option value="none">Sin borde</option>
        <option value="border-gold">L√≠nea Dorada</option>
        <option value="border-black">L√≠nea Negra</option>
        <option value="border-double">Doble Elegante</option>
    </select><br><br>

    <label>üî† Tama√±o de letra:</label><br>
    <input type="number" id="fontSize" value="30" min="10" max="100"> px<br><br>

    <label>üìå Incluir c√≥digos QR:</label>
    <input type="checkbox" id="qrToggle"><br><br>

    <label>üåü Incluir logo Esentia:</label>
    <input type="checkbox" id="logoToggle"><br><br>

    <button onclick="aplicarEstilos()">Aplicar estilos</button>
    <button onclick="window.print()">PDF</button>
    <button onclick="descargarPNG()">PNG</button>
</div>

<!-- LOGO -->
<img id="logo" src="https://wil1979.github.io/esentia-factura/logo_esentia.png">

<h3>Vista previa:</h3>
<div id="preview"></div>

<!-- MODAL SELECTOR -->
<div id="modal">
    <div id="modal-content">
        <h3>Selecciona los productos</h3>
        <div id="listaProductos"></div>
        <br>
        <button onclick="guardarSeleccion(); cerrarModal();">Guardar selecci√≥n</button>
        <button onclick="cerrarModal()" style="background:#999">Cerrar</button>
    </div>
</div>

<!-- LIBRER√çA PNG -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
const url = "https://wil1979.github.io/esentia-factura/productos_esentia.json";
let productos = [];
let seleccionados = JSON.parse(localStorage.getItem("seleccionEsentia") || "[]");

// Cargar JSON
fetch(url)
.then(res => res.json())
.then(data => {
    productos = data;
    cargarModal();
    renderizar();
});

// Modal
function abrirModal() { document.getElementById("modal").style.display = "flex"; }
function cerrarModal() { document.getElementById("modal").style.display = "none"; }

// Cargar lista en modal
function cargarModal() {
    const cont = document.getElementById("listaProductos");
    cont.innerHTML = "";

    productos.forEach(p => {
        const div = document.createElement("div");
        div.innerHTML = `
            <label>
                <input type="checkbox" value="${p.nombre}" ${seleccionados.includes(p.nombre) ? "checked" : ""}>
                ${p.nombre}
            </label>
        `;
        cont.appendChild(div);
    });
}

// Guardar selecci√≥n
function guardarSeleccion() {
    const checks = [...document.querySelectorAll("#listaProductos input:checked")];
    seleccionados = checks.map(c => c.value);

    localStorage.setItem("seleccionEsentia", JSON.stringify(seleccionados));
    renderizar();
}

// Renderizar preview
function renderizar() {
    const preview = document.getElementById("preview");
    preview.innerHTML = "";

    seleccionados.forEach(nombre => {
        const div = document.createElement("div");
        div.className = "item";
        div.draggable = true;
        div.textContent = nombre;

        div.addEventListener("dragstart", () => div.classList.add("dragging"));
        div.addEventListener("dragend", () => div.classList.remove("dragging"));

        preview.appendChild(div);
    });

    aplicarEstilos();
}

// Estilos
function aplicarEstilos() {
    const theme = document.getElementById("theme").value;
    const color = document.getElementById("color").value;
    const border = document.getElementById("border").value;
    const size = document.getElementById("fontSize").value;
    const qrOn = document.getElementById("qrToggle").checked;
    const logoOn = document.getElementById("logoToggle").checked;

    document.getElementById("logo").style.display = logoOn ? "block" : "none";

    [...preview.children].forEach(el => {
        el.style.fontSize = size + "px";

        // Borrar estilos previos
        el.className = "item";
        el.style.color = "";
        el.style.background = "";

        // Estilos
        el.classList.add(theme);
        if (border !== "none") el.classList.add(border);

        // FOIL GOLD
        if (color === "foil") {
            el.classList.add("foil-gold");
        } else {
            el.style.color = color;
        }

        // QR
        if (qrOn) {
            if (!el.querySelector("img")) {
                let qr = document.createElement("img");
                qr.className = "qr";
                qr.src = "https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=" + encodeURIComponent(el.textContent);
                el.appendChild(qr);
            }
        } else {
            let img = el.querySelector("img");
            if (img) img.remove();
        }
    });

    guardarConfig();
}

// Guardar configuraci√≥n completa
function guardarConfig() {
    const config = {
        theme: theme.value,
        color: color.value,
        border: border.value,
        fontSize: fontSize.value,
        qrToggle: qrToggle.checked,
        logoToggle: logoToggle.checked
    };
    localStorage.setItem("configEsentia", JSON.stringify(config));
}

// Cargar config guardada
window.onload = () => {
    const config = JSON.parse(localStorage.getItem("configEsentia") || "{}");
    Object.keys(config).forEach(k => {
        document.getElementById(k).value = config[k];
        if (typeof config[k] === "boolean") {
            document.getElementById(k).checked = config[k];
        }
    });
};

// PNG
function descargarPNG() {
    html2canvas(preview).then(canvas => {
        const link = document.createElement("a");
        link.download = "esentia_dtf.png";
        link.href = canvas.toDataURL();
        link.click();
    });
}

// Drag & Drop
preview.addEventListener("dragover", e => {
    e.preventDefault();
    const dragging = document.querySelector(".dragging");
    const after = [...preview.querySelectorAll(".item:not(.dragging)")].find(x => {
        const rect = x.getBoundingClientRect();
        return e.clientY < rect.top + rect.height / 2;
    });
    if (after) preview.insertBefore(dragging, after);
    else preview.appendChild(dragging);
});
</script>

</body>
</html>