<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Molde Caja - Promocionales Esentia</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      background-color: #f7f7f7;
    }

    #opciones {
      margin-bottom: 1rem;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .molde {
      width: 19cm;
      height: 28.5cm;
      position: relative;
      border: 1px dashed #aaa;
      background-color: #fff;
      background-size: cover;
      background-image: url('../etiqueta/molde_varitas.png');
      background-position: center;
      margin: 2rem auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }

    .cara {
      position: absolute;
      width: 4cm;
      height: 28.5cm;
      top: 0;
      border: 1px solid transparent;
      box-sizing: border-box;
      padding: 14.5rem 1rem;
    }

    .cara:hover {
      border: 1px solid rgba(0, 100, 255, 0.5);
    }

    .cara.frente { left: 4.7cm; background-color: rgba(246, 248, 250, 0.1); }
    .cara.lateral-izq { left: 9.4cm; background-color: rgba(249, 250, 250, 0.1); }
    .cara.dorso { left: 14.1cm; background-color: rgba(253, 253, 252, 0.1); }
    .cara.lateral-der { left: 18.8cm; background-color: rgba(241, 239, 241, 0.1); }

    /* Solapas */
    .solapa {
      position: absolute;
      width: 2.3cm;
      height: 28.5cm;
      top: 0;
      background-color: rgba(228, 227, 227, 0.2);
      border: 1px solid #ddd;
    }

    .solapa.derecha { right: 12.8cm - 1cm; }

    /* Elementos internos */
    .molde img.producto {
      position: absolute;
      width: 70%;
      top: 55%;
      left: 255%;
      transform: translate(-50%, -50%);
      z-index: 2;
    }

    .molde img.logo {
      position: absolute;
      width: 105%;
      top: 35%;
      left: 262%;
      transform: translateX(-50%);
      z-index: 2;
    }

    .molde .nombre {
      position: absolute;
      bottom: 140%;
      width: 35%;
      left: 255%;
      text-align: center;
      font-size: 2.5rem;
      font-weight: bold;
      color: #b3acbe;
      z-index: 2;
    }

    .molde .descripcion {
      position: relative;
      top: 100%;
      width: 120%;
      left: -364%;
      text-align: center;
      font-size: 1.7rem;
      color: #6c1dd3;
      z-index: 2;
    }

    .molde .ingredientes {
      position: absolute;
      bottom: 25%;
      width: 120%;
      left: -280%;
      text-align: center;
      font-size: 1rem;
      color: #690a0a;
      z-index: 2;
    }

    button {
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background: #f2f1f3;
      color: #333;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0.2rem;
    }

    button:hover {
      background: #5a0bab;
      color: white;
    }

    .error {
      color: red;
      font-weight: bold;
    }

    /* Estilos del modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 10% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
    }

    .modal input[type="number"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      margin-top: 6px;
      margin-bottom: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h1>Generador de Moldes para Caja - Promocionales Esentia</h1>

<div id="opciones">
  <label for="producto">Selecciona producto:</label>
  <select id="producto"></select>
  <br><br>
  <label><input type="checkbox" id="mostrarLogo" checked> Mostrar logo</label>
  <label><input type="checkbox" id="mostrarImagen" checked> Mostrar imagen del producto</label>
  <label><input type="checkbox" id="mostrarNombre" checked> Mostrar nombre</label>
  <label><input type="checkbox" id="mostrarSolapas" checked> Mostrar solapas</label>
  <br><br>
  <button id="generarTodos">Generar todos los moldes</button>
  <button id="abrirModal">Ajustar posiciones</button>
  <button id="btnImprimir">üñ®Ô∏è Imprimir molde</button>
</div>

<div id="contenedorMoldes"></div>
<div id="mensajeError" class="error"></div>

<!-- Modal -->
<div id="myModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Ajustar Posiciones</h2>
    <form id="posicionForm">
      <!-- Configuraci√≥n general -->
      <label for="generalWidth">Ancho total del molde (cm):</label>
      <input type="number" id="generalWidth" value="19" step="0.1">

      <label for="generalHeight">Altura total del molde (cm):</label>
      <input type="number" id="generalHeight" value="28.5" step="0.1">

      <!-- Cara frontal -->
      <h3>Cara Frontal</h3>
      <label for="frenteLeft">Posici√≥n izquierda (left) (%):</label>
      <input type="number" id="frenteLeft" value="25" step="1">

      <!-- Cara lateral izquierda -->
      <h3>Cara Lateral Izquierda</h3>
      <label for="lateralIzqLeft">Posici√≥n izquierda (left) (%):</label>
      <input type="number" id="lateralIzqLeft" value="49" step="1">

      <!-- Cara dorso -->
      <h3>Cara Dorso</h3>
      <label for="dorsoLeft">Posici√≥n izquierda (left) (%):</label>
      <input type="number" id="dorsoLeft" value="74" step="1">

      <!-- Cara lateral derecha -->
      <h3>Cara Lateral Derecha</h3>
      <label for="lateralDerLeft">Posici√≥n izquierda (left) (%):</label>
      <input type="number" id="lateralDerLeft" value="98" step="1">

      <!-- Bot√≥n de guardar -->
      <button type="button" id="guardarPosiciones">Guardar Posiciones</button>
    </form>
  </div>
</div>

<script>
  const selectProducto = document.getElementById('producto');
  const contenedor = document.getElementById('contenedorMoldes');
  const mensajeError = document.getElementById('mensajeError');
  const botonGenerarTodos = document.getElementById('generarTodos');
  const btnImprimir = document.getElementById('btnImprimir');

  // Datos de prueba
  const productosPrueba = [
    {
      nombre: "Varita Energ√©tica Azul",
      imagen: "https://placehold.co/200x300/0055ff/ffffff?text=Producto",
      descripcion: "30ml.",
      ingredientes: [
        "Producto NO Comestible.üö´",
        "No aplicar directamente sobre la piel.",
        "Evite el contacto con los ojos.",
        "Como utilizar: Abre la botella de aceite Esentia, y descarta la tapa interior.",
        "Desliza la tapa decorativa en la botella y inserta las ca√±as en la Fragancia Esentia.",
        "D√≥nde se usa: Reforzar la decoraci√≥n del espacio que te gusta.",
        "Difusor de Ca√±a fragancia maravillosa para la zona sin velas tales como, oficinas, dormitorios."
      ].join(' ')
    },
    {
      nombre: "Varita de Luna",
      imagen: "https://placehold.co/200x300/ffcc00/000000?text=Luna",
      descripcion: "30ml.",
      ingredientes: [
        "Producto NO Comestible.üö´",
        "No aplicar directamente sobre la piel.",
        "Evite el contacto con los ojos.",
        "Como utilizar: Abre la botella de aceite Esentia, y descarta la tapa interior.",
        "Desliza la tapa decorativa en la botella y inserta las ca√±as en la Fragancia Esentia.",
        "D√≥nde se usa: Reforzar la decoraci√≥n del espacio que te gusta.",
        "Difusor de Ca√±a fragancia maravillosa para la zona sin velas tales como, oficinas, dormitorios."
      ].join(' ')
    }
  ];

  let productos = [];
  let configuracion = {
    generalWidth: 19,
    generalHeight: 28.5,
    frenteLeft: 25,
    lateralIzqLeft: 49,
    dorsoLeft: 74,
    lateralDerLeft: 98
  };

  fetch('productos_esentia.json')
    .then(res => {
      if (!res.ok) throw new Error(`Error ${res.status}: archivo no encontrado`);
      return res.json();
    })
    .then(data => {
      productos = data;
      console.log('Productos cargados:', productos);
      inicializarProductos();
    })
    .catch(err => {
      console.warn('No se pudo cargar productos_esentia.json:', err);
      mensajeError.textContent = '‚ö†Ô∏è No se encontr√≥ productos_esentia.json. Usando datos de prueba.';
      productos = productosPrueba;
      setTimeout(() => inicializarProductos(), 500);
    });

  function inicializarProductos() {
    selectProducto.innerHTML = '';
    productos.forEach((producto, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = producto.nombre;
      selectProducto.appendChild(option);
    });
    mostrarProducto(0);
  }

  selectProducto.addEventListener('change', () => {
    mostrarProducto(selectProducto.value);
  });

  document.querySelectorAll('#opciones input[type=checkbox]').forEach(input => {
    input.addEventListener('change', () => mostrarProducto(selectProducto.value));
  });

  botonGenerarTodos.addEventListener('click', () => {
    contenedor.innerHTML = '';
    productos.forEach((producto, i) => {
      contenedor.appendChild(crearMolde(producto));
    });
  });

  function mostrarProducto(index) {
    contenedor.innerHTML = '';
    const prod = productos[index];
    if (prod) {
      contenedor.appendChild(crearMolde(prod));
    } else {
      contenedor.innerHTML = '<p class="error">Producto no encontrado.</p>';
    }
  }

  function crearMolde(prod) {
    const molde = document.createElement('div');
    molde.className = 'molde';

    const caras = ['frente', 'lateral-izq', 'dorso', 'lateral-der'];
    caras.forEach((cara, i) => {
      const div = document.createElement('div');
      div.className = `cara ${cara}`;

      if (cara === 'frente') {
        if (document.getElementById('mostrarImagen').checked) {
          const img = document.createElement('img');
          img.src = prod.imagen;
          img.className = 'producto';
          div.appendChild(img);
        }
        if (document.getElementById('mostrarLogo').checked) {
          const logo = document.createElement('img');
          logo.src = 'images/logo.png';
          logo.className = 'logo';
          div.appendChild(logo);
        }
        if (document.getElementById('mostrarNombre').checked) {
          const nombre = document.createElement('div');
          nombre.className = 'nombre';
          nombre.textContent = prod.nombre;
          div.appendChild(nombre);
        }
      } else if (cara === 'lateral-izq') {
        if (prod.imagen) {
          const img = document.createElement('img');
          img.src = prod.imagen;
          img.style.width = '100%';
          img.style.top = '0%';
          img.style.left = '50%';
          img.style.transform = 'translate(-40%, 450%)';
          div.appendChild(img);
        }
      } else if (cara === 'lateral-der') {
        const qrUrl = "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://wil1979.github.io/esentia-factura/catalogo.html";
        const qrImg = document.createElement('img');
        qrImg.src = qrUrl;
        qrImg.style.width = '60%';
        qrImg.style.top = '50%';
        qrImg.style.left = '50%';
        qrImg.style.transform = 'translate(10%, 900%)';
        div.appendChild(qrImg);
      } else if (cara === 'dorso') {
        const descripcion = document.createElement('div');
        descripcion.className = 'descripcion';
        descripcion.textContent = prod.descripcion || '30ml.';
        div.appendChild(descripcion);

        const ingredientes = document.createElement('div');
        ingredientes.className = 'ingredientes';
        ingredientes.textContent = `Indicaciones: ${prod.ingredientes || 'No especificadas'}`;
        div.appendChild(ingredientes);
      }

      molde.appendChild(div);
    });

    // Aplicar configuraci√≥n
    molde.style.width = `${configuracion.generalWidth}cm`;
    molde.style.height = `${configuracion.generalHeight}cm`;
    const carasMolde = molde.querySelectorAll('.cara');
    carasMolde[0].style.left = `${configuracion.frenteLeft}%`;
    carasMolde[1].style.left = `${configuracion.lateralIzqLeft}%`;
    carasMolde[2].style.left = `${configuracion.dorsoLeft}%`;
    carasMolde[3].style.left = `${configuracion.lateralDerLeft}%`;

    // Solapas
    if (document.getElementById('mostrarSolapas').checked) {
      const solapaIzq = document.createElement('div');
      solapaIzq.className = 'solapa izquierda';
      solapaIzq.title = 'Solapa izquierda';
      molde.appendChild(solapaIzq);

      const solapaDer = document.createElement('div');
      solapaDer.className = 'solapa derecha';
      solapaDer.title = 'Solapa derecha';
      molde.appendChild(solapaDer);
    }

    return molde;
  }

  // --- MODAL ---
  const modal = document.getElementById('myModal');
  const abrirModalBtn = document.getElementById('abrirModal');
  const closeModalBtn = document.querySelector('.close');
  const guardarPosicionesBtn = document.getElementById('guardarPosiciones');

  abrirModalBtn.onclick = () => modal.style.display = "block";
  closeModalBtn.onclick = () => modal.style.display = "none";
  window.onclick = (event) => {
    if (event.target == modal) modal.style.display = "none";
  };

  guardarPosicionesBtn.onclick = () => {
    configuracion.generalWidth = parseFloat(document.getElementById('generalWidth').value);
    configuracion.generalHeight = parseFloat(document.getElementById('generalHeight').value);
    configuracion.frenteLeft = parseFloat(document.getElementById('frenteLeft').value);
    configuracion.lateralIzqLeft = parseFloat(document.getElementById('lateralIzqLeft').value);
    configuracion.dorsoLeft = parseFloat(document.getElementById('dorsoLeft').value);
    configuracion.lateralDerLeft = parseFloat(document.getElementById('lateralDerLeft').value);
    modal.style.display = "none";
    mostrarProducto(selectProducto.value);
  };

  // --- IMPRIMIR ---
  btnImprimir.addEventListener('click', () => {
    const contenedor = document.getElementById('contenedorMoldes');
    if (contenedor.children.length === 0) {
      alert("Primero genera un molde para imprimir.");
      return;
    }

    const w = window.open('', '_blank');
    const printContent = `
      <html>
        <head>
          <title>Imprimir Molde de Caja</title>
          <style>
            body {
              font-family: sans-serif;
              margin: 1cm;
              background: white;
            }
            .molde {
              width: ${configuracion.generalWidth}cm !important;
              height: ${configuracion.generalHeight}cm !important;
              margin: 2rem auto !important;
              box-shadow: none !important;
              border: 1px solid #000;
              page-break-inside: avoid;
            }
            .cara {
              border: 1px solid #888 !important;
            }
            .solapa {
              background-color: #eee !important;
              border: 1px dashed #555 !important;
            }
            img {
              max-height: 100%;
              width: auto;
            }
            @page {
              size: A4 portrait;
              margin: 1cm;
            }
            @media print {
              body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            }
            #opciones, .error, button, .modal {
              display: none !important;
            }
          </style>
        </head>
        <body>
          <h1 style="text-align: center;">Molde de Caja - Promocionales Esentia</h1>
          ${contenedor.innerHTML}
        </body>
      </html>
    `;

    w.document.write(printContent);
    w.document.close();

    w.addEventListener('load', () => {
      w.focus();
      setTimeout(() => w.print(), 300);
    });
  });
</script>

</body>
</html>
