<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Esentia CrÃ©ditos</title>
  <style>

    .boton-accion.activo {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  transform: translateY(-2px);
}

    .scroll-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 999;
    }
    .scroll-btn {
      padding: 15px 20px;
      border: none;
      border-radius: 25px;
      background: #2196F3;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .scroll-btn:hover {
      background: #1976D2;
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.2);
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background-color: #f3f2f7;
      color: #333;
    }

    /* Estilos para el logo */
.logo-container {
  text-align: center;
  margin-bottom: 20px;
}

.logo {
  max-width: 200px; /* Ajusta este valor segÃºn lo grande que quieras el logo */
  height: auto;
  border-radius: 8px; /* Opcional: esquinas redondeadas */
  box-shadow: 0 2px 8px rgba(0,0,0,0.1); /* Opcional: sombra suave */
  transition: transform 0.3s ease;
}

.logo:hover {
  transform: scale(1.05); /* Efecto al pasar el mouse */
}
    h1 {
      color: #6c4ba3;
      text-align: center;
    }
    .cliente {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s;
    }
    .cliente:hover {
      transform: scale(1.01);
    }
    .cliente-no-deudor {
      opacity: 0.65;
      background: #f8f8f8;
      border-color: #e0e0e0;
    }
    .cliente-no-deudor .botones-derecha {
      pointer-events: none;
      opacity: 0.5;
    }
    .cliente-no-deudor:hover {
      transform: none;
    }
    .botones-derecha {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: flex-end;
      margin-top: 0.5rem;
    }
   .boton-accion {
  padding: 4px 8px;           /* ğŸ‘ˆ Menos padding (mÃ¡s pequeÃ±o) */
  font-size: 0.75rem;         /* ğŸ‘ˆ Fuente mÃ¡s pequeÃ±a */
  border: none;
  background: #6c4ba3;
  color: white;
  border-radius: 4px;         /* ğŸ‘ˆ Bordes ligeramente menos redondeados */
  cursor: pointer;
  transition: background 0.2s;
  white-space: nowrap;        /* ğŸ‘ˆ Evita que el texto se envuelva en dos lÃ­neas */
  min-width: auto;            /* ğŸ‘ˆ Permite que el botÃ³n sea tan pequeÃ±o como su contenido */
}
    .boton-accion:hover {
      background-color: #573993;
    }
    /* Historial de compras */
    .historial-compras {
      margin-top: 10px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 6px;
      font-size: 0.9rem;
      border: 1px dashed #ccc;
    }
    .historial-compras h4 {
      margin: 0 0 10px 0;
      color: #555;
    }
    .historial-compras ul {
      list-style: none;
      padding: 0;
    }
    .historial-compras li {
      margin-bottom: 12px;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    /* SecciÃ³n de reportes */
    #seccion-reportes {
      margin-top: 30px;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #ddd;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .filtros-reportes {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      align-items: end;
    }
    .filtro-item {
      display: flex;
      flex-direction: column;
    }
    .filtro-item label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #6c4ba3;
    }
    .tabla-reportes {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .tabla-reportes th, .tabla-reportes td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .tabla-reportes th {
      background-color: #6c4ba3;
      color: white;
    }
    .tabla-reportes tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .tabla-reportes tr:hover {
      background-color: #f5f5f5;
    }
    .deuda-alta {
      color: #d32f2f;
      font-weight: bold;
    }
    .deuda-media {
      color: #f57c00;
      font-weight: bold;
    }
    .deuda-baja {
      color: #388e3c;
      font-weight: bold;
    }
    /* Modal de productos */
    #modal-productos {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    #modal-productos > div {
      background: white;
      width: 90%;
      max-width: 800px;
      border-radius: 10px;
      padding: 20px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .producto-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      margin-bottom: 5px;
    }
    .producto-info {
      flex: 1;
    }
    .producto-cantidad {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-left: 20px;
    }
    .cantidad-control {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .btn-cantidad {
      width: 30px;
      height: 30px;
      border: 1px solid #ddd;
      background: #f9f9f9;
      border-radius: 4px;
      cursor: pointer;
    }
    .cantidad-display {
      width: 50px;
      text-align: center;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .resumen-total {
      margin-top: 20px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      font-size: 1.1rem;
      font-weight: bold;
    }
    .acciones-modal {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    .precio-personalizado {
      width: 100px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-left: 10px;
    }
    /* Modal de impresiÃ³n */
    #modal-impresion, #modal-historial {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    #modal-impresion > div, #modal-historial > div {
      background: white;
      width: 90%;
      max-width: 1000px;
      border-radius: 10px;
      padding: 20px;
      max-height: 90vh;
      overflow-y: auto;
    }
    /* Responsive */
    @media (max-width: 480px) {
      .boton-accion {
    font-size: 0.7rem;        /* ğŸ‘ˆ AÃºn mÃ¡s pequeÃ±o en mÃ³vil */
    padding: 3px 6px;
      }
      .botones-derecha {
  display: flex;
  flex-wrap: wrap;
  gap: 0.3rem;                /* ğŸ‘ˆ Menos espacio entre botones */
  justify-content: flex-end;
  margin-top: 0.3rem;         /* ğŸ‘ˆ Menos margen superior */
}
      .boton-accion {
        width: 100%;
        margin-left: 0;
        margin-bottom: 5px;
      }
      .editar-cliente {
        flex-direction: column;
      }
      .filtros-reportes {
        flex-direction: column;
      }
      .producto-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .producto-cantidad {
        margin-top: 10px;
        margin-left: 0;
      }
    }

     .nueva-venta-btn {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 999;
  }

   .barra-acciones-flotante {
    position: fixed;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 999;
  }
  .barra-acciones-flotante .scroll-btn {
    padding: 10px 16px;
    font-size: 0.85rem;
    white-space: nowrap;
    width: 160px;
    text-align: center;
  }
  @media (max-width: 480px) {
    .barra-acciones-flotante {
      width: auto;
      right: 10px;
    }
    .barra-acciones-flotante .scroll-btn {
      width: 130px;
      padding: 8px 12px;
      font-size: 0.75rem;
    }
  }
  </style>
</head>
<body>
  <div class="logo-container">
    <img src="https://wil1979.github.io/esentia-factura/images/logo.png" alt="Esentia Logo" class="logo">
  </div>

  <div class="barra-acciones-flotante">
    <button class="scroll-btn" style="background: #6c4ba3;" onclick="abrirModalNuevoCliente()">
      â• Nuevo Cliente
    </button>
    <button class="scroll-btn" style="background: #4CAF50;" onclick="abrirModalNuevaVenta()">
      â• Nueva Venta
    </button>
    <button class="scroll-btn" style="background: #2196F3;" onclick="cargarClientes(false)">
      ğŸ‘¥ Mostrar Todos
    </button>
    <button class="scroll-btn" style="background: #4CAF50;" onclick="cargarClientes(true)">
      ğŸ’³ Solo Deudores
    </button>
    <button class="scroll-btn" onclick="scrollToTop()">â†‘</button>
    <button class="scroll-btn" onclick="scrollToBottom()">â†“</button>
  </div>

  <h1>ğŸ“‹ Esentia - Registro de CrÃ©ditos</h1>
  <h2>ğŸ‘¥ Clientes</h2>

  <!-- Filtros de visualizaciÃ³n -->
  <div style="margin-bottom: 15px; text-align: center;">
    <input type="text" id="filtro-clientes" placeholder="ğŸ” Buscar cliente por nombre..." style="width: 90%; max-width: 500px; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem;">
  </div>

  <div id="clientes"></div>

  <hr>
  <!-- SecciÃ³n de Reportes -->
  <div id="seccion-reportes">
    <h2>ğŸ“Š Reporte General de Clientes</h2>
    <div class="filtros-reportes">
      <div class="filtro-item">
        <label for="filtro-nombre">Nombre:</label>
        <input type="text" id="filtro-nombre" placeholder="Buscar por nombre">
      </div>
      <div class="filtro-item">
        <label for="filtro-deuda-min">Deuda MÃ­nima:</label>
        <input type="number" id="filtro-deuda-min" placeholder="â‚¡0" min="0">
      </div>
      <div class="filtro-item">
        <label for="filtro-deuda-max">Deuda MÃ¡xima:</label>
        <input type="number" id="filtro-deuda-max" placeholder="Sin lÃ­mite" min="0">
      </div>
      <div class="filtro-item">
        <label for="filtro-orden">Ordenar por:</label>
        <select id="filtro-orden">
          <option value="nombre-asc">Nombre (A-Z)</option>
          <option value="nombre-desc">Nombre (Z-A)</option>
          <option value="deuda-desc">Deuda (Mayor a Menor)</option>
          <option value="deuda-asc">Deuda (Menor a Mayor)</option>
        </select>
      </div>
      <div class="filtro-item">
        <button class="boton-accion" onclick="generarReporte()" style="margin-top: 22px;">ğŸ” Filtrar</button>
      </div>
      <div class="filtro-item">
        <button class="boton-accion" onclick="abrirModalImpresion()" style="margin-top: 22px;">ğŸ–¨ï¸ Imprimir</button>
      </div>
    </div>
    <div id="resultados-reportes">
      <p>Haz clic en "Filtrar" para generar el reporte.</p>
    </div>
  </div>

  <!-- Modal de productos -->
<div id="modal-productos">
  <div>
    <h2>ğŸ›ï¸ Agregar Productos al Cliente</h2>
    <div style="margin-bottom: 20px;">
      <label for="select-producto">Seleccionar producto:</label>
      <select id="select-producto"></select>
      <button onclick="agregarAlCarritoModal()" style="margin-left: 10px;">Agregar</button>
    </div>

    <!-- Vista previa: imagen + info -->
    <div id="vista-previa-producto" style="text-align: center; margin: 15px 0;">
      <img id="img-producto" src="" alt="Producto" style="max-width: 150px; max-height: 150px; display: none; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
      <p id="info-producto" style="margin-top: 8px; font-size: 0.95rem; color: #555;"></p>
      <!-- Selector de variantes (se genera dinÃ¡micamente) -->
      <div id="selector-variantes" style="margin-top: 12px;"></div>
    </div>

    <div id="carrito-modal"></div>
    <div style="margin: 15px 0;">
      <label for="descuento">Descuento: â‚¡</label>
      <input type="number" id="descuento" value="0" min="0">
    </div>
    <div class="resumen-total">
      <span>Total:</span>
      <span>â‚¡<span id="total-compra">0</span></span>
    </div>
    <div class="acciones-modal">
      <button class="boton-accion" onclick="cerrarModalProductos()" style="background: #666;">âŒ Cancelar</button>
      <button class="boton-accion" onclick="guardarCompraDesdeCarrito()">ğŸ’¾ Guardar Compra</button>
    </div>
  </div>
</div>

  <!-- Modal de impresiÃ³n del reporte -->
  <div id="modal-impresion">
    <div>
      <h2>ğŸ–¨ï¸ Imprimir Reporte</h2>
      <div class="filtros-reportes" style="margin-bottom: 20px;">
        <div class="filtro-item">
          <label for="filtro-nombre-modal">Nombre:</label>
          <input type="text" id="filtro-nombre-modal" placeholder="Buscar por nombre">
        </div>
        <div class="filtro-item">
          <label for="filtro-deuda-min-modal">Deuda MÃ­nima:</label>
          <input type="number" id="filtro-deuda-min-modal" placeholder="â‚¡0" min="0">
        </div>
        <div class="filtro-item">
          <label for="filtro-deuda-max-modal">Deuda MÃ¡xima:</label>
          <input type="number" id="filtro-deuda-max-modal" placeholder="Sin lÃ­mite" min="0">
        </div>
        <div class="filtro-item">
          <label for="filtro-orden-modal">Ordenar por:</label>
          <select id="filtro-orden-modal">
            <option value="nombre-asc">Nombre (A-Z)</option>
            <option value="nombre-desc">Nombre (Z-A)</option>
            <option value="deuda-desc">Deuda (Mayor a Menor)</option>
            <option value="deuda-asc">Deuda (Menor a Mayor)</option>
          </select>
        </div>
        <div class="filtro-item">
          <button class="boton-accion" onclick="generarReporteModal()">ğŸ” Filtrar</button>
        </div>
      </div>
      <div id="resultado-modal" style="margin-top: 20px;">
        <p>Haz clic en "Filtrar" para ver los resultados.</p>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
        <button class="boton-accion" onclick="cerrarModalImpresion()">âŒ Cerrar</button>
        <button class="boton-accion" onclick="imprimirModal()">ğŸ–¨ï¸ Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Modal de historial individual -->
  <div id="modal-historial">
    <div>
      <h2>ğŸ“‹ Historial de Compras</h2>
      <div id="contenido-historial"></div>
      <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
        <button class="boton-accion" onclick="cerrarModalHistorial()">âŒ Cerrar</button>
        <button class="boton-accion" onclick="imprimirModalHistorial()">ğŸ–¨ï¸ Imprimir</button>
      </div>
    </div>
  </div>

  <!-- Firebase y lÃ³gica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const clientesRef = collection(db, "clientes");

    // âœ… FunciÃ³n reutilizable para consultar nombre desde cÃ©dula
async function consultarNombreDesdeCedula(inputCedula, inputNombre, elementoMensaje) {
  const cedula = inputCedula.value.trim().replace(/\D/g, "");
  elementoMensaje.textContent = "";
  elementoMensaje.style.color = "#4CAF50";

  if (cedula.length < 9) {
    elementoMensaje.textContent = "âš ï¸ CÃ©dula invÃ¡lida (mÃ­nimo 9 dÃ­gitos)";
    return;
  }

  try {
    elementoMensaje.textContent = "Buscando en Hacienda...";
    const res = await fetch(`https://api.hacienda.go.cr/fe/ae?identificacion=${cedula}`);
    if (!res.ok) throw new Error("No encontrado");
    const data = await res.json();
    const nombreCompleto = data.nombre || data.nombre_completo || "";
    if (nombreCompleto) {
      inputNombre.value = nombreCompleto;
      elementoMensaje.textContent = `âœ… Nombre: ${nombreCompleto}`;
      elementoMensaje.style.color = "#4CAF50";
    } else {
      elementoMensaje.textContent = "âš ï¸ No encontrado en Hacienda";
      elementoMensaje.style.color = "#d32f2f";
    }
  } catch (err) {
    console.warn("Error al consultar Hacienda:", err);
    elementoMensaje.textContent = "âš ï¸ Error de conexiÃ³n o cÃ©dula no registrada";
    elementoMensaje.style.color = "#d32f2f";
  }
}

    // âœ… Abrir modal de ediciÃ³n
function abrirModalEditarCliente(id, nombre, cedula, telefono) {
  document.getElementById("modal-edit-id").value = id;
  document.getElementById("modal-edit-nombre").value = nombre;
  document.getElementById("modal-edit-cedula").value = cedula;
  document.getElementById("modal-edit-telefono").value = telefono;
  document.getElementById("modal-editar-cliente").style.display = "flex";
}

// âœ… Cerrar modal
function cerrarModalEditarCliente() {
  document.getElementById("modal-editar-cliente").style.display = "none";
}

// âœ… Guardar ediciÃ³n desde modal
async function guardarEdicionDesdeModal() {
  const clienteId = document.getElementById("modal-edit-id").value;
  const nuevoNombre = document.getElementById("modal-edit-nombre").value.trim();
  const nuevaCedula = document.getElementById("modal-edit-cedula").value.trim();
  let nuevoTelefono = document.getElementById("modal-edit-telefono").value.trim();

  if (!nuevoNombre) {
    alert("âš ï¸ Completa el nombre.");
    return;
  }

  const telefonoLimpio = nuevoTelefono.replace(/\D/g, '');
  if (!telefonoLimpio || telefonoLimpio === "00000000" || telefonoLimpio.length !== 8) {
    const nuevo = prompt("El nÃºmero no es vÃ¡lido. Ingresa un nÃºmero de telÃ©fono vÃ¡lido (8 dÃ­gitos):");
    if (!nuevo) {
      alert("Se requiere un nÃºmero vÃ¡lido.");
      return;
    }
    nuevoTelefono = nuevo;
  }

  try {
    const clienteDoc = doc(db, "clientes", clienteId);
    await updateDoc(clienteDoc, {
      nombre: nuevoNombre,
      telefono: nuevoTelefono,
      cedula: nuevaCedula || null
    });
    alert("âœ… Cliente actualizado.");
    cerrarModalEditarCliente();
    await cargarClientes(filtroDeudoresActivo); // âœ… Usa la variable global
  } catch (error) {
    console.error("Error al actualizar:", error);
    alert("âŒ Error: " + error.message);
  }
}

    // âœ… Abrir modal nuevo cliente
function abrirModalNuevoCliente() {
  document.getElementById("modal-nuevo-cliente").style.display = "flex";
  document.getElementById("modal-cedula").value = "";
  document.getElementById("modal-nombre").value = "";
  document.getElementById("modal-telefono").value = "";
  document.getElementById("nombre-desde-api").textContent = "";
  document.getElementById("modal-cedula").focus();

  // Escuchar cambios en cÃ©dula para consultar Hacienda
  const cedulaInput = document.getElementById("modal-cedula");
  cedulaInput.addEventListener("blur", consultarNombreHacienda);
}

function cerrarModalNuevoCliente() {
  document.getElementById("modal-nuevo-cliente").style.display = "none";
}

// âœ… Consultar API pÃºblica de Hacienda CR
async function consultarNombreHacienda() {
  const cedula = document.getElementById("modal-cedula").value.trim().replace(/\D/g, "");
  const nombreApi = document.getElementById("nombre-desde-api");
  const nombreInput = document.getElementById("modal-nombre");

  if (cedula.length < 9) {
    nombreApi.textContent = "âš ï¸ CÃ©dula invÃ¡lida (mÃ­nimo 9 dÃ­gitos)";
    return;
  }

  try {
    nombreApi.textContent = "Buscando en Hacienda...";
    const res = await fetch(`https://api.hacienda.go.cr/fe/ae?identificacion=${cedula}`);
    if (!res.ok) throw new Error("No encontrado o error en API");
    const data = await res.json();
    const nombreCompleto = data.nombre || data.nombre_completo || "";
    if (nombreCompleto) {
      nombreInput.value = nombreCompleto;
      nombreApi.textContent = `âœ… Nombre obtenido: ${nombreCompleto}`;
      nombreApi.style.color = "#4CAF50";
    } else {
      nombreApi.textContent = "âš ï¸ No se encontrÃ³ el nombre en Hacienda";
      nombreApi.style.color = "#d32f2f";
    }
  } catch (err) {
    console.warn("Error al consultar Hacienda:", err);
    nombreApi.textContent = "âš ï¸ No se pudo consultar Hacienda (fuera de lÃ­nea o cÃ©dula no registrada)";
    nombreApi.style.color = "#d32f2f";
  }
}

// âœ… Guardar cliente y abrir modal de productos
async function guardarNuevoCliente() {
  const cedula = document.getElementById("modal-cedula").value.trim().replace(/\D/g, "");
  const nombre = document.getElementById("modal-nombre").value.trim();
  const telefono = document.getElementById("modal-telefono").value.trim().replace(/\D/g, "");

  if (!cedula || cedula.length < 9) {
    alert("âš ï¸ Ingresa una cÃ©dula vÃ¡lida (9 dÃ­gitos).");
    return;
  }
  if (!nombre) {
    alert("âš ï¸ Ingresa un nombre vÃ¡lido.");
    return;
  }
  if (!telefono || telefono.length !== 8) {
    alert("âš ï¸ Ingresa un telÃ©fono vÃ¡lido de 8 dÃ­gitos.");
    return;
  }

  try {
    const docRef = await addDoc(clientesRef, {
      cedula,
      nombre,
      telefono,
      compras: []
    });
    alert("âœ… Cliente registrado con Ã©xito.");
    cerrarModalNuevoCliente();
    // Abrir directamente el modal de productos con el nuevo cliente
    abrirModalProductos(docRef.id);
  } catch (error) {
    console.error("Error al guardar cliente:", error);
    alert("âŒ Error al registrar cliente: " + error.message);
  }
}


    // âœ… Abrir modal para seleccionar cliente
async function abrirModalNuevaVenta() {
  const modal = document.getElementById("modal-seleccionar-cliente");
  const lista = document.getElementById("lista-clientes-modal");
  const filtro = document.getElementById("filtro-cliente-modal");
  lista.innerHTML = "<p>Cargando clientes...</p>";

  const snapshot = await getDocs(clientesRef);
  const clientes = [];

  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    clientes.push({
      id: docSnap.id,
      nombre: data.nombre,
      telefono: data.telefono
    });
  });

  const renderizar = () => {
    lista.innerHTML = "";
    const filtroTexto = filtro.value.toLowerCase().trim();
    const filtrados = clientes.filter(c => c.nombre.toLowerCase().includes(filtroTexto));

    if (filtrados.length === 0) {
      lista.innerHTML = "<p>No se encontraron clientes.</p>";
      return;
    }

    filtrados.forEach(cliente => {
      const div = document.createElement("div");
      div.style.padding = "10px";
      div.style.margin = "5px 0";
      div.style.border = "1px solid #eee";
      div.style.borderRadius = "6px";
      div.style.cursor = "pointer";
      div.style.backgroundColor = "#f9f9f9";
      div.onmouseover = () => div.style.backgroundColor = "#f0f0f0";
      div.onmouseout = () => div.style.backgroundColor = "#f9f9f9";
      div.innerHTML = `
  <div style="display: flex; justify-content: space-between; align-items: center;">
    <div>
      <strong>${cliente.nombre}</strong><br>
      <small>${ocultarTelefono(cliente.telefono)}</small>
    </div>
    <button class="boton-accion" style="padding: 4px 8px; font-size: 0.7rem; background: #FF9800;" 
            onclick="event.stopPropagation(); editarClienteDesdeModal('${cliente.id}');">
      âœï¸ Editar
    </button>
  </div>
`;
div.onclick = () => {
  cerrarModalSeleccionarCliente();
  abrirModalProductos(cliente.id); // Abre el modal de productos
};
      lista.appendChild(div);
    });
  };

  renderizar();
  filtro.addEventListener("input", renderizar);
  modal.style.display = "flex";
}

// âœ… Cerrar modal
function cerrarModalSeleccionarCliente() {
  document.getElementById("modal-seleccionar-cliente").style.display = "none";
}





   // âœ… Agregar cliente (con cÃ©dula)
async function agregarCliente() {
  const nombre = document.getElementById("nombre").value.trim();
  const telefono = document.getElementById("telefono").value.trim();
  const cedula = document.getElementById("cedula").value.trim();
  if (!nombre || !telefono) {
    alert("âš ï¸ Completa al menos nombre y telÃ©fono.");
    return;
  }
  try {
    await addDoc(clientesRef, {
      nombre,
      telefono,
      cedula: cedula || null, // Guardar como null si estÃ¡ vacÃ­o
      compras: []
    });
    alert("âœ… Cliente agregado exitosamente.");
    document.getElementById("nombre").value = "";
    document.getElementById("telefono").value = "";
    document.getElementById("cedula").value = "";
    await cargarClientes(filtroDeudoresActivo);
  } catch (error) {
    alert("âŒ Error al agregar cliente: " + error.message);
    console.error("Error al agregar cliente:", error);
  }
}

function marcarBotones() {
const btnDeud = document.getElementById('btn-solo-deudores');
const btnTodos = document.getElementById('btn-mostrar-todos');
if (!btnDeud || !btnTodos) return;
btnDeud.classList.toggle('activo', filtroDeudoresActivo === true);
btnTodos.classList.toggle('activo', filtroDeudoresActivo === false);
}


    // âœ… Cargar clientes con filtro
    async function cargarClientes(filtrarDeudores = true) {
      filtroDeudoresActivo = filtrarDeudores;
      marcarBotones();
      const cont = document.getElementById("clientes");
      const filtroInput = document.getElementById("filtro-clientes");

      const renderizarClientes = async () => {
        cont.innerHTML = "";
        const snapshot = await getDocs(clientesRef);
        const filtroTexto = filtroInput.value.toLowerCase().trim();

        snapshot.forEach(docSnap => {
          const cliente = docSnap.data();
          const id = docSnap.id;

          // Filtrar por nombre
          if (!cliente.nombre.toLowerCase().includes(filtroTexto)) return;

          // Calcular saldo pendiente
          let totalPendiente = 0;
          const compras = cliente.compras || [];
          compras.forEach(c => {
            const totalCompra = (c.monto || 0) - (c.descuento || 0);
            totalPendiente += totalCompra - (c.pagado || 0);
          });

          // Filtrar por deuda si se solicita
          if (filtrarDeudores && totalPendiente <= 0) return;

          // Clase para deshabilitado
          const esDeudor = totalPendiente > 0;
          const claseCliente = esDeudor ? "" : "cliente-no-deudor";

          const div = document.createElement("div");
          div.className = `cliente ${claseCliente}`.trim();

              // Indicador de participaciÃ³n
const estadoParticipacion = cliente.yaParticipo === true 
  ? '<span style="color:orange; font-weight:bold;">ğŸ¯ Ya participÃ³</span>' 
  : '<span style="color:green;">ğŸ”„ Puede participar</span>';

          div.innerHTML = `
  <strong>${cliente.nombre}</strong><br>
  ğŸ“ <a href="https://wa.me/506${cliente.telefono}" target="_blank" title="${cliente.telefono}">${ocultarTelefono(cliente.telefono)}</a><br>
  ${estadoParticipacion}<br>
  ${cliente.cedula ? `ğŸ†” CÃ©dula: ${cliente.cedula}<br>` : ''}
  ğŸ’¸ Pendiente: â‚¡${totalPendiente.toLocaleString()}<br>
${cliente.ultimoRecordatorio 
    ? `<small style="color:#6c4ba3;">ğŸ“… Ãšltimo recordatorio: ${new Date(cliente.ultimoRecordatorio).toLocaleDateString()}</small><br>` 
    : ''}
            
           <div class="botones-derecha">
  <button class="boton-accion" onclick="abrirModalEditarCliente('${id}', '${cliente.nombre.replace(/'/g, "\\'")}', '${cliente.cedula || ''}', '${cliente.telefono}')">âœï¸ Editar</button>
  <button class="boton-accion" onclick="abrirModalProductos('${id}')">â• Productos</button>
  <button class="boton-accion" onclick="registrarPago('${id}', '${cliente.nombre}', '${cliente.telefono}')">ğŸ’° Pago</button>
  <button class="boton-accion" onclick="abrirModalHistorial('${id}', '${cliente.nombre}')">ğŸ–¨ï¸ Imprimir</button>
 <button class="boton-accion" onclick="enviarWhatsApp('${cliente.telefono}', '${cliente.nombre}', ${totalPendiente}, '${id}')">ğŸ“² WhatsApp</button>
 <button class="boton-accion" onclick="eliminarCliente('${id}', '${cliente.nombre}')">ğŸ—‘ï¸ Eliminar</button>
</div>
          `;
          cont.appendChild(div);

         // BotÃ³n para mostrar/ocultar historial
const btnToggleHistorial = document.createElement("button");
btnToggleHistorial.className = "boton-accion";
btnToggleHistorial.style.marginTop = "10px";
btnToggleHistorial.textContent = "ğŸ“‹ Ver/Ocultar Historial";
btnToggleHistorial.onclick = function() {
  const historialDiv = this.nextElementSibling;
  if (historialDiv && historialDiv.classList.contains("historial-compras")) {
    historialDiv.style.display = historialDiv.style.display === "none" ? "block" : "none";
  }
};
div.appendChild(btnToggleHistorial);

if (compras.length > 0) {
  const historial = document.createElement("div");
  historial.className = "historial-compras";
  historial.style.display = "none"; // Oculto por defecto
  let html = "<h4>ğŸ›’ Historial de Compras:</h4><ul>";
  compras.forEach((compra, index) => {
    const total = (compra.monto || 0) - (compra.descuento || 0);
    const saldo = total - (compra.pagado || 0);
    const estadoInv = compra.inventarioActualizado ? 
      `<small style="color: green;">âœ… Inventario actualizado</small>` : 
      `<small style="color: orange;">ğŸ”¸ Pendiente</small>`;
    html += `
      <li>
    <strong>ğŸ“… ${compra.fecha}</strong> | 
    Total: â‚¡${total.toLocaleString()} | 
    Descuento: â‚¡${(compra.descuento || 0).toLocaleString()} | 
    Pagado: â‚¡${(compra.pagado || 0).toLocaleString()} | 
    Saldo: â‚¡${saldo.toLocaleString()}
    <br>
        <small><strong>Productos:</strong> 
          ${compra.productos?.map(p => `${p.cantidad}x ${p.nombre} (${p.presentacion || ''}${p.aroma ? ' - ' + p.aroma : ''})`).join(', ') || 'Sin productos'}
        </small><br>
        ${estadoInv}
        <br>
        <button class="boton-accion" style="padding: 3px 6px; font-size: 0.75rem; margin-top: 5px;" 
                onclick="editarCompra('${id}', ${index})">
          âœï¸ Editar
        </button>
        <button class="boton-accion" style="padding: 3px 6px; font-size: 0.75rem; margin-top: 5px; background: #d32f2f;" 
                onclick="eliminarCompra('${id}', ${index})">
          ğŸ—‘ï¸ Eliminar
        </button>
        <button class="boton-accion" style="padding: 3px 6px; font-size: 0.75rem; margin-top: 5px; background: #6c4ba3;"
                onclick="actualizarInventario('${id}', ${index})">
          ğŸ“¦ Actualizar Inventario
        </button>
        ${compra.inventarioActualizado ? `
        <button class="boton-accion" style="padding: 3px 6px; font-size: 0.75rem; margin-top: 5px; background: #757575;"
                onclick="revertirInventario('${id}', ${index})">
          ğŸ” Revertir Inventario
        </button>
        ` : ''}
      </li>`;
  });
  html += "</ul>";
  historial.innerHTML = html;
  div.appendChild(historial);
}
        });
      };

      await renderizarClientes();
      filtroInput.addEventListener("input", renderizarClientes);
    }

    // âœ… Actualizar inventario
    async function actualizarInventario(clienteId, compraIndex) {
      try {
        const clienteDoc = doc(db, "clientes", clienteId);
        const docSnap = await getDoc(clienteDoc);
        if (!docSnap.exists()) {
          alert("Cliente no encontrado.");
          return;
        }

        const cliente = docSnap.data();
        const compras = cliente.compras || [];
        const compra = compras[compraIndex];
        if (!compra || !compra.productos) {
          alert("Compra o productos no encontrados.");
          return;
        }

        if (compra.inventarioActualizado) {
          alert("âš ï¸ El inventario ya fue actualizado para esta compra.");
          return;
        }

        const productos = compra.productos;
        for (const prod of productos) {
          const nombreProducto = prod.nombre;
          const cantidadVendida = prod.cantidad;

          const q = query(
            collection(db, "stock"),
            where("nombre", "==", nombreProducto)
          );
          const stockSnap = await getDocs(q);

          if (stockSnap.empty) {
            console.warn(`âš ï¸ Producto "${nombreProducto}" no existe en inventario.`);
            continue;
          }

          const stockDoc = stockSnap.docs[0];
          const stockData = stockDoc.data();
          const nuevaCantidad = Math.max(0, (stockData.cantidad || 0) - cantidadVendida);

          await updateDoc(doc(db, "stock", stockDoc.id), {
            cantidad: nuevaCantidad,
            ultimaActualizacion: new Date().toISOString()
          });
        }

        // Marcar como actualizado
        compras[compraIndex].inventarioActualizado = true;
        await updateDoc(clienteDoc, { compras });

        alert("âœ… Inventario actualizado correctamente.");
        await cargarClientes(filtroDeudoresActivo);
      } catch (error) {
        console.error("Error al actualizar inventario:", error);
        alert("âŒ Hubo un error al actualizar el inventario.");
      }
    }

    // âœ… Revertir inventario
    async function revertirInventario(clienteId, compraIndex) {
      try {
        const clienteDoc = doc(db, "clientes", clienteId);
        const docSnap = await getDoc(clienteDoc);
        if (!docSnap.exists()) {
          alert("Cliente no encontrado.");
          return;
        }

        const cliente = docSnap.data();
        const compras = cliente.compras || [];
        const compra = compras[compraIndex];
        if (!compra || !compra.productos) {
          alert("Compra o productos no encontrados.");
          return;
        }

        if (!compra.inventarioActualizado) {
          alert("âš ï¸ Esta compra no ha actualizado el inventario.");
          return;
        }

        if (!confirm("Â¿Revertir el inventario? Se devolverÃ¡n las cantidades al stock.")) return;

        const productos = compra.productos;
        for (const prod of productos) {
          const nombreProducto = prod.nombre;
          const cantidadVendida = prod.cantidad;

          const q = query(
            collection(db, "stock"),
            where("nombre", "==", nombreProducto)
          );
          const stockSnap = await getDocs(q);

          if (stockSnap.empty) {
            console.warn(`âš ï¸ Producto "${nombreProducto}" no existe en inventario.`);
            continue;
          }

          const stockDoc = stockSnap.docs[0];
          const stockData = stockDoc.data();
          const nuevaCantidad = (stockData.cantidad || 0) + cantidadVendida;

          await updateDoc(doc(db, "stock", stockDoc.id), {
            cantidad: nuevaCantidad,
            ultimaActualizacion: new Date().toISOString()
          });
        }

        // Desmarcar como actualizado
        compras[compraIndex].inventarioActualizado = false;
        await updateDoc(clienteDoc, { compras });

        alert("âœ… Inventario revertido correctamente.");
        await cargarClientes(filtroDeudoresActivo);
      } catch (error) {
        console.error("Error al revertir inventario:", error);
        alert("âŒ Hubo un error al revertir el inventario.");
      }
    }

    // âœ… Editar cliente
    function editarCliente(clienteId) {
      document.querySelectorAll('.editar-cliente').forEach(div => div.style.display = 'none');
      const el = document.getElementById(`editar-${clienteId}`);
      if (el) el.style.display = 'flex';
    }

    async function guardarEdicion(clienteId) {
  const nuevoNombre = document.getElementById(`edit-nombre-${clienteId}`).value.trim();
  const nuevaCedula = document.getElementById(`edit-cedula-${clienteId}`).value.trim();
  let nuevoTelefono = document.getElementById(`edit-telefono-${clienteId}`).value.trim();
  if (!nuevoNombre) {
    alert("âš ï¸ Completa el nombre.");
    return;
  }
  const telefonoLimpio = nuevoTelefono.replace(/\D/g, '');
  if (!telefonoLimpio || telefonoLimpio === "00000000" || telefonoLimpio.length < 8) {
    const nuevo = prompt("El nÃºmero no es vÃ¡lido. Ingresa un nÃºmero de telÃ©fono vÃ¡lido (8 dÃ­gitos):");
    if (!nuevo) {
      alert("Se requiere un nÃºmero vÃ¡lido.");
      return;
    }
    nuevoTelefono = nuevo;
  }
  try {
    const clienteDoc = doc(db, "clientes", clienteId);
    await updateDoc(clienteDoc, { 
      nombre: nuevoNombre, 
      telefono: nuevoTelefono,
      cedula: nuevaCedula || null
    });
    alert("âœ… Cliente actualizado.");
    await cargarClientes(filtroDeudoresActivo);
  } catch (error) {
    alert("âŒ Error al actualizar: " + error.message);
    console.error("Error:", error);
  }
}

    function cancelarEdicion(clienteId) {
      const el = document.getElementById(`editar-${clienteId}`);
      if (el) el.style.display = 'none';
    }

    // âœ… Eliminar cliente
    async function eliminarCliente(clienteId, nombre) {
      if (!confirm(`Â¿Eliminar a ${nombre}? Esta acciÃ³n no se puede deshacer.`)) return;
      try {
        await deleteDoc(doc(db, "clientes", clienteId));
        alert(`âœ… ${nombre} eliminado.`);
        await cargarClientes(filtroDeudoresActivo);
      } catch (error) {
        alert("âŒ Error al eliminar.");
        console.error(error);
      }
    }

    // âœ… Editar compra
    window.editarCompra = async function(clienteId, index) {
      const clienteDoc = doc(db, "clientes", clienteId);
      const docSnap = await getDoc(clienteDoc);
      if (!docSnap.exists()) return;
      const cliente = docSnap.data();
      const compras = cliente.compras || [];
      const compra = compras[index];
      if (!compra) return;
      const nuevoMonto = prompt("Editar monto total:", compra.monto);
      const nuevoDescuento = prompt("Editar descuento:", compra.descuento || 0);
      const nuevoPagado = prompt("Editar pago:", compra.pagado || 0);
      if ([nuevoMonto, nuevoDescuento, nuevoPagado].some(v => v === null)) return;
      const monto = parseFloat(nuevoMonto);
      const descuento = parseFloat(nuevoDescuento);
      const pagado = parseFloat(nuevoPagado);
      if (isNaN(monto) || isNaN(descuento) || isNaN(pagado)) {
        alert("âš ï¸ Todos los valores deben ser nÃºmeros.");
        return;
      }
      if (pagado > monto - descuento) {
        alert("âš ï¸ El pago no puede superar el total.");
        return;
      }
      compras[index] = { ...compra, monto, descuento, pagado };
      await updateDoc(clienteDoc, { compras });
      alert("âœ… Compra actualizada.");
      await cargarClientes(filtroDeudoresActivo);
    };

    // âœ… Eliminar compra
    window.eliminarCompra = async function(clienteId, index) {
      if (!confirm("Â¿Eliminar esta compra?")) return;
      const clienteDoc = doc(db, "clientes", clienteId);
      const docSnap = await getDoc(clienteDoc);
      const cliente = docSnap.data();
      const compras = cliente.compras || [];
      compras.splice(index, 1);
      await updateDoc(clienteDoc, { compras });
      alert("âœ… Compra eliminada.");
      await cargarClientes(filtroDeudoresActivo);
    };

    // âœ… Nueva funciÃ³n: abrir modal de pagos con facturas pendientes
window.registrarPago = async function(clienteId, nombreCliente, telefonoCliente) {
  const clienteDoc = doc(db, "clientes", clienteId);
  const docSnap = await getDoc(clienteDoc);
  if (!docSnap.exists()) {
    alert("Cliente no encontrado.");
    return;
  }
  const cliente = docSnap.data();
  const compras = cliente.compras || [];
  const facturasPendientes = compras
    .map((compra, index) => {
      const total = (compra.monto || 0) - (compra.descuento || 0);
      const pagado = compra.pagado || 0;
      const saldo = total - pagado;
      return { ...compra, saldo, index, total };
    })
    .filter(f => f.saldo > 0);

  if (facturasPendientes.length === 0) {
    alert("ğŸ‰ No hay facturas pendientes.");
    return;
  }

  // Mostrar nombre del cliente
  document.getElementById("nombre-cliente-pago").textContent = nombreCliente;

  // Renderizar facturas
  const contenedor = document.getElementById("lista-facturas-pendientes");
  let html = `<h3>Facturas pendientes (${facturasPendientes.length}):</h3><ul style="list-style:none; padding:0;">`;
  facturasPendientes.forEach(f => {
    const productosResumen = f.productos?.map(p => `${p.cantidad}x ${p.nombre}`).join(", ") || "Sin productos";
    html += `
      <li style="border:1px solid #eee; padding:12px; margin:10px 0; border-radius:8px; background:#f9f9f9;">
        <strong>ğŸ“… ${f.fecha}</strong><br>
        <small><em>${productosResumen}</em></small><br>
        Total: â‚¡${f.total.toLocaleString()} | Pagado: â‚¡${f.pagado.toLocaleString()}<br>
        <strong style="color:red;">Saldo: â‚¡${f.saldo.toLocaleString()}</strong><br>
        <input type="number" id="pago-${f.index}" placeholder="Monto a pagar" min="1" max="${f.saldo}" 
               style="margin-top:8px; padding:6px; width:100%; border:1px solid #ccc; border-radius:4px;">
        <button class="boton-accion" style="margin-top:8px; padding:5px 10px;"
                onclick="aplicarPago('${clienteId}', ${f.index}, ${f.saldo})">
          âœ… Aplicar Pago
        </button>
      </li>
    `;
  });
  html += `</ul>`;
  contenedor.innerHTML = html;

  // Guardar ID en el Ã¡mbito global para WhatsApp/impresiÃ³n
  // Al final, al guardar en window.clienteActualPago, incluye el telÃ©fono:
  window.clienteActualPago = {
    id: clienteId,
    nombre: nombreCliente,
    telefono: telefonoCliente,  // âœ… Ahora sÃ­ estÃ¡ definido
    facturas: facturasPendientes
  };

  document.getElementById("modal-pago").style.display = "flex";
};

// âœ… Aplicar pago a una factura especÃ­fica
window.aplicarPago = async function(clienteId, compraIndex, saldoMax) {
  const input = document.getElementById(`pago-${compraIndex}`);
  const montoStr = input?.value?.trim();
  if (!montoStr) {
    alert("âš ï¸ Ingresa un monto.");
    return;
  }
  const monto = parseFloat(montoStr);
  if (isNaN(monto) || monto <= 0 || monto > saldoMax) {
    alert(`âš ï¸ Ingresa un monto vÃ¡lido (1 â€“ â‚¡${saldoMax.toLocaleString()}).`);
    return;
  }

  try {
    // ğŸ”¥ LEER EL DOCUMENTO ACTUAL DE NUEVO (evita conflictos)
    const clienteDocRef = doc(db, "clientes", clienteId);
    const docSnap = await getDoc(clienteDocRef);
    if (!docSnap.exists()) {
      alert("Cliente no encontrado.");
      return;
    }
    const clienteData = docSnap.data();
    const compras = [...(clienteData.compras || [])]; // Copia profunda simple

    if (!compras[compraIndex]) {
      alert("Factura no encontrada.");
      return;
    }

    const compra = compras[compraIndex];
    const totalNeto = (compra.monto || 0) - (compra.descuento || 0);
    const pagadoActual = compra.pagado || 0;
    const nuevoPagado = Math.min(pagadoActual + monto, totalNeto);

    // Aplicar el nuevo valor
    compras[compraIndex] = { ...compra, pagado: nuevoPagado };

    // ğŸ”¥ ACTUALIZAR EN FIRESTORE
    await updateDoc(clienteDocRef, { compras });

    alert("âœ… Pago aplicado correctamente.");

    // Recargar el modal con los datos actualizados
    const nombre = window.clienteActualPago?.nombre || "Desconocido";
    const telefono = window.clienteActualPago?.telefono || "";
    registrarPago(clienteId, nombre, telefono);

  } catch (error) {
    console.error("Error al aplicar pago:", error);
    alert("âŒ Error al aplicar el pago: " + (error.message || "error desconocido"));
  }
};

// âœ… Cerrar modal de pago
window.cerrarModalPago = function() {
  document.getElementById("modal-pago").style.display = "none";
  delete window.clienteActualPago;
};

// âœ… Enviar WhatsApp con resumen de deudas
window.enviarWhatsAppDeudas = function() {
  if (!window.clienteActualPago || !window.clienteActualPago.telefono) {
    alert("âŒ No se encontrÃ³ el nÃºmero de telÃ©fono del cliente.");
    return;
  }
  const { nombre, facturas, telefono } = window.clienteActualPago;
  const telefonoLimpio = (telefono || "").toString().replace(/\D/g, "");
  if (telefonoLimpio.length !== 8) {
    alert("âš ï¸ El nÃºmero de telÃ©fono no es vÃ¡lido para WhatsApp.");
    return;
  }

  let mensaje = `Hola ${nombre}, estos son tus saldos pendientes en Esentia:\n\n`;
  facturas.forEach(f => {
    mensaje += `â€¢ ${f.fecha}: â‚¡${f.saldo.toLocaleString()}\n`;
  });
  const total = facturas.reduce((sum, f) => sum + f.saldo, 0);
  mensaje += `\nTotal pendiente: â‚¡${total.toLocaleString()}\n\nGracias por tu confianza ğŸ’œ`;

  window.open(`https://wa.me/506${telefonoLimpio}?text=${encodeURIComponent(mensaje)}`, "_blank");
};

// âœ… Imprimir resumen de deudas
window.imprimirDeudasPago = function() {
  if (!window.clienteActualPago) return;
  const { nombre, facturas } = window.clienteActualPago;
  const totalGeneral = facturas.reduce((sum, f) => sum + f.saldo, 0);

  let html = `<h2>ğŸ“‹ Deudas Pendientes â€“ ${nombre}</h2><table border="1" style="border-collapse:collapse; width:100%; margin:20px 0;">
    <tr><th>Fecha</th><th>Productos</th><th>Saldo</th></tr>`;
  facturas.forEach(f => {
    const productos = f.productos?.map(p => `${p.cantidad}x ${p.nombre}`).join(", ") || "â€”";
    html += `<tr><td>${f.fecha}</td><td>${productos}</td><td>â‚¡${f.saldo.toLocaleString()}</td></tr>`;
  });
  html += `<tr><td colspan="2" style="text-align:right;"><strong>TOTAL:</strong></td><td><strong>â‚¡${totalGeneral.toLocaleString()}</strong></td></tr>`;
  html += `</table><p>Fecha: ${new Date().toLocaleDateString()}</p>`;

  const win = window.open("", "_blank", "width=800,height=600");
  win.document.write(`
    <html><head><title>Deudas - ${nombre}</title>
    <style>body { font-family: Arial, sans-serif; padding: 20px; }</style></head>
    <body>${html}
    <button onclick="window.print()" style="padding:10px; background:#6c4ba3; color:white; border:none; margin-top:20px;">ğŸ–¨ï¸ Imprimir</button>
    </body></html>
  `);
  win.document.close();
};

    // âœ… Enviar WhatsApp y registrar fecha de recordatorio
async function enviarWhatsApp(telefono, nombre, deuda, clienteId) {
  const limpio = telefono.replace(/\D/g, '');
  if (!limpio || limpio.length !== 8) {
    alert("âš ï¸ TelÃ©fono no vÃ¡lido para WhatsApp.");
    return;
  }

  // Verificar si ya se enviÃ³ hoy
  const hoy = new Date().setHours(0, 0, 0, 0);
  const clienteDoc = doc(db, "clientes", clienteId);
  const docSnap = await getDoc(clienteDoc);
  const clienteData = docSnap.data();
  const ultimo = clienteData?.ultimoRecordatorio ? new Date(clienteData.ultimoRecordatorio).setHours(0, 0, 0, 0) : null;

  if (ultimo && ultimo >= hoy) {
    if (!confirm("Ya se enviÃ³ un recordatorio hoy. Â¿Reenviar de todas formas?")) {
      return;
    }
  }

  const mensaje = `Hola ${nombre}, Agradecemos tu preferencia con ESENTIA y queremos comentarte que tienes al dÃ­a de hoy saldo pendiente de â‚¡${deuda.toLocaleString()}. Gracias por confiar en Esentia llenando tu vida de fragancias que enamoran. ğŸ’œğŸ’³ Formas de pago:
1. Efectivo contra entrega
2. SINPE 72952454 Wilber CalderÃ³n M.
3. BAC: CR59010200009453897656 ğŸŒ¿`;

  const url = `https://wa.me/506${limpio}?text=${encodeURIComponent(mensaje)}`;
  window.open(url, "_blank");

  // ğŸ”¥ Registrar la fecha del recordatorio en Firestore
  try {
    const clienteDoc = doc(db, "clientes", clienteId);
    await updateDoc(clienteDoc, {
      ultimoRecordatorio: new Date().toISOString() // Fecha en formato ISO (ej: "2025-04-10T15:30:00.000Z")
    });
    // Opcional: recargar la lista para mostrar la fecha
    await cargarClientes(filtroDeudoresActivo);
  } catch (error) {
    console.error("No se pudo registrar la fecha del recordatorio:", error);
    // No bloqueamos la UX si falla solo el registro
  }
}

    // âœ… Reportes
    async function generarReporte() {
      const cont = document.getElementById("resultados-reportes");
      cont.innerHTML = "<p>Generando...</p>";
      const snapshot = await getDocs(clientesRef);
      let clientes = [];
      snapshot.forEach(docSnap => {
        const c = docSnap.data();
        let totalCompras = 0, totalPagado = 0, totalPendiente = 0, totalDescuentos = 0;
        (c.compras || []).forEach(compra => {
          const neto = (compra.monto || 0) - (compra.descuento || 0);
          totalCompras += neto;
          totalPagado += compra.pagado || 0;
          totalDescuentos += compra.descuento || 0;
          totalPendiente += neto - (compra.pagado || 0);
        });
        clientes.push({
          id: docSnap.id,
          nombre: c.nombre,
          telefono: c.telefono,
          totalCompras,
          totalPagado,
          totalDescuentos,
          totalPendiente,
          cedula: c.cedula || ''
        });
      });

      const filtroNombre = document.getElementById("filtro-nombre").value.toLowerCase();
      const min = parseFloat(document.getElementById("filtro-deuda-min").value) || 0;
      const max = parseFloat(document.getElementById("filtro-deuda-max").value) || Infinity;
      const orden = document.getElementById("filtro-orden").value;

      clientes = clientes.filter(cli => 
        cli.nombre.toLowerCase().includes(filtroNombre) &&
        cli.totalPendiente >= min &&
        cli.totalPendiente <= max
      );

      if (orden === "nombre-asc") clientes.sort((a, b) => a.nombre.localeCompare(b.nombre));
      if (orden === "nombre-desc") clientes.sort((a, b) => b.nombre.localeCompare(a.nombre));
      if (orden === "deuda-desc") clientes.sort((a, b) => b.totalPendiente - a.totalPendiente);
      if (orden === "deuda-asc") clientes.sort((a, b) => a.totalPendiente - b.totalPendiente);

      if (clientes.length === 0) {
        cont.innerHTML = "<p>No se encontraron clientes.</p>";
        return;
      }

      let totalGeneral = 0, totalPagadoGen = 0, totalPendienteGen = 0, totalDescuentosGen = 0;
      let tabla = `
        <table class="tabla-reportes">
          <thead>
  <tr>
    <th>Nombre</th>
    <th>TelÃ©fono</th>
    <th>CÃ©dula</th>
    <th>Total Compras</th>
    <th>Total Pagado</th>
    <th>Descuentos</th>
    <th>Saldo</th>
  </tr>
</thead>
          <tbody>
      `;
      clientes.forEach(cli => {
        totalGeneral += cli.totalCompras;
        totalPagadoGen += cli.totalPagado;
        totalPendienteGen += cli.totalPendiente;
        totalDescuentosGen += cli.totalDescuentos; // âœ… Â¡Agrega esta lÃ­nea!
        const clase = cli.totalPendiente > 5000 ? "deuda-alta" : cli.totalPendiente > 2000 ? "deuda-media" : "deuda-baja";
       tabla += `
  <tr>
    <td>${cli.nombre}</td>
    <td>${cli.telefono}</td>
    <td>${cli.cedula || 'â€”'}</td>
    <td>â‚¡${cli.totalCompras.toLocaleString()}</td>
    <td>â‚¡${cli.totalPagado.toLocaleString()}</td>
    <td>â‚¡${cli.totalDescuentos.toLocaleString()}</td>
    <td class="${clase}">â‚¡${cli.totalPendiente.toLocaleString()}</td>
  </tr>
`;
      });
      tabla += `</tbody></table>
        <div style="margin-top:20px; padding:15px; background:#f5f5f5; border-radius:5px;">
          <h3>Resumen:</h3>
          <p><strong>Total Compras:</strong> â‚¡${totalGeneral.toLocaleString()}</p>
          <p><strong>Total Pagado:</strong> â‚¡${totalPagadoGen.toLocaleString()}</p>
          <p><strong>Total Descuentos:</strong> â‚¡${totalDescuentosGen.toLocaleString()}</p>
          <p><strong>Total Pendiente:</strong> â‚¡${totalPendienteGen.toLocaleString()}</p>
        </div>`;
      cont.innerHTML = tabla;
    }

    // === IMPRESIÃ“N MODAL DEL REPORTE ===
    function abrirModalImpresion() {
      document.getElementById("modal-impresion").style.display = "flex";
      document.getElementById("filtro-nombre-modal").value = document.getElementById("filtro-nombre").value;
      document.getElementById("filtro-deuda-min-modal").value = document.getElementById("filtro-deuda-min").value;
      document.getElementById("filtro-deuda-max-modal").value = document.getElementById("filtro-deuda-max").value;
      document.getElementById("filtro-orden-modal").value = document.getElementById("filtro-orden").value;
    }

    function cerrarModalImpresion() {
      document.getElementById("modal-impresion").style.display = "none";
    }

    async function generarReporteModal() {
      const cont = document.getElementById("resultado-modal");
      cont.innerHTML = "<p>Generando...</p>";

      try {
      const snapshot = await getDocs(clientesRef);
      let clientes = [];
      snapshot.forEach(docSnap => {
        const c = docSnap.data();
        let totalCompras = 0, totalPagado = 0, totalPendiente = 0, totalDescuentos = 0;
        (c.compras || []).forEach(compra => {
          const neto = (compra.monto || 0) - (compra.descuento || 0);
          totalCompras += neto;
          totalPagado += compra.pagado || 0;
          totalDescuentos += compra.descuento || 0;
          totalPendiente += neto - (compra.pagado || 0);
        });
        clientes.push({
          id: docSnap.id,
          nombre: c.nombre,
          telefono: c.telefono,
          totalCompras,
          totalPagado,
          totalDescuentos,
          totalPendiente
        });
      });

      const filtroNombre = document.getElementById("filtro-nombre-modal").value.toLowerCase();
      const min = parseFloat(document.getElementById("filtro-deuda-min-modal").value) || 0;
      const max = parseFloat(document.getElementById("filtro-deuda-max-modal").value) || Infinity;
      const orden = document.getElementById("filtro-orden-modal").value;

      clientes = clientes.filter(cli => 
        cli.nombre.toLowerCase().includes(filtroNombre) &&
        cli.totalPendiente >= min &&
        cli.totalPendiente <= max
      );

      if (orden === "nombre-asc") clientes.sort((a, b) => a.nombre.localeCompare(b.nombre));
      if (orden === "nombre-desc") clientes.sort((a, b) => b.nombre.localeCompare(a.nombre));
      if (orden === "deuda-desc") clientes.sort((a, b) => b.totalPendiente - a.totalPendiente);
      if (orden === "deuda-asc") clientes.sort((a, b) => a.totalPendiente - b.totalPendiente);

      if (clientes.length === 0) {
        cont.innerHTML = "<p>No se encontraron clientes.</p>";
        return;
      }

      let totalGeneral = 0, totalPagadoGen = 0, totalPendienteGen = 0;
      let tabla = `
        <table class="tabla-reportes">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>TelÃ©fono</th>
              <th>Total Compras</th>
              <th>Total Pagado</th>
              <th>Descuentos</th>
              <th>Saldo</th>
            </tr>
          </thead>
          <tbody>
      `;
      clientes.forEach(cli => {
        totalGeneral += cli.totalCompras;
        totalPagadoGen += cli.totalPagado;
        totalPendienteGen += cli.totalPendiente;
        const clase = cli.totalPendiente > 5000 ? "deuda-alta" : cli.totalPendiente > 2000 ? "deuda-media" : "deuda-baja";
        tabla += `
          <tr>
            <td>${cli.nombre}</td>
            <td>${cli.telefono}</td>
            <td>â‚¡${cli.totalCompras.toLocaleString()}</td>
            <td>â‚¡${cli.totalPagado.toLocaleString()}</td>
            <td>â‚¡${cli.totalDescuentos.toLocaleString()}</td>
            <td class="${clase}">â‚¡${cli.totalPendiente.toLocaleString()}</td>
          </tr>
        `;
      });
      tabla += `</tbody></table>
        <div style="margin-top:20px; padding:15px; background:#f5f5f5; border-radius:5px;">
          <h3>Resumen:</h3>
          <p><strong>Total Compras:</strong> â‚¡${totalGeneral.toLocaleString()}</p>
          <p><strong>Total Pagado:</strong> â‚¡${totalPagadoGen.toLocaleString()}</p>
          <p><strong>Total Pendiente:</strong> â‚¡${totalPendienteGen.toLocaleString()}</p>
        </div>`;
      cont.innerHTML = tabla;
      } catch (error) {
    console.error("Error en generarReporte:", error);
    cont.innerHTML = `<p style="color: red;">âŒ Error: ${error.message}</p>`;
  }
}

    function imprimirModal() {
      const contenido = document.getElementById("modal-impresion").querySelector("div").innerHTML;
      const ventana = window.open('', '_blank', 'width=800,height=600');
      ventana.document.write(`
        <html>
          <head>
            <title>Reporte General de Clientes</title>
            <style>
              body { 
                font-family: Arial, sans-serif; 
                padding: 20px; 
                color: #333; 
              }
              table { 
                width: 100%; 
                border-collapse: collapse; 
                margin: 20px 0; 
              }
              th, td { 
                border: 1px solid #ddd; 
                padding: 12px; 
                text-align: left; 
              }
              th { 
                background-color: #6c4ba3; 
                color: white; 
              }
              .deuda-alta { color: #d32f2f; font-weight: bold; }
              .deuda-media { color: #f57c00; font-weight: bold; }
              .deuda-baja { color: #388e3c; font-weight: bold; }
              @media print {
                button { display: none; }
              }
            </style>
          </head>
          <body>
            <h2>ğŸ“Š Reporte General de Clientes</h2>
            <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
            ${contenido}
            <button onclick="window.print()" style="padding: 10px; background: #6c4ba3; color: white; border: none; border-radius: 5px; margin-top: 20px;">ğŸ–¨ï¸ Imprimir</button>
          </body>
        </html>
      `);
      ventana.document.close();
    }

    // === IMPRESIÃ“N MODAL DEL HISTORIAL INDIVIDUAL ===
    window.abrirModalHistorial = async function(clienteId, nombre) {
      const clienteDoc = doc(db, "clientes", clienteId);
      const docSnap = await getDoc(clienteDoc);
      if (!docSnap.exists()) {
        alert("Cliente no encontrado.");
        return;
      }
      const cliente = docSnap.data();
      const compras = cliente.compras || [];
      let totalCompras = 0, totalPagado = 0, totalPendiente = 0;
      let html = "";
      if (compras.length === 0) {
        html = '<p>No hay compras registradas.</p>';
      } else {
        compras.forEach((compra, index) => {
          const total = (compra.monto || 0) - (compra.descuento || 0);
          const saldo = total - (compra.pagado || 0);
          totalCompras += total;
          totalPagado += compra.pagado || 0;
          totalPendiente += saldo;
         html += `
  <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #eee; border-radius: 6px;">
    <h4>ğŸ“… Compra #${index+1} - ${compra.fecha}</h4>
    <ul style="margin-left: 20px;">
      ${compra.productos?.map(p => `<li>${p.cantidad}x ${p.nombre} - ${p.presentacion || ''} ${p.aroma ? '('+p.aroma+')' : ''} - â‚¡${p.precio} (Total: â‚¡${p.precio * p.cantidad})</li>`).join('') || '<li>Sin productos</li>'}
    </ul>
    <p><strong>Total:</strong> â‚¡${total} | <strong>Descuento:</strong> â‚¡${(compra.descuento || 0).toLocaleString()} | <strong>Pagado:</strong> â‚¡${compra.pagado || 0} | <strong>Saldo:</strong> â‚¡${saldo}</p>
    ${compra.inventarioActualizado ? '<p style="color: green;">âœ… Inventario actualizado</p>' : ''}
  </div>
`;
        });
      }
      const contenido = document.getElementById("contenido-historial");
      contenido.innerHTML = `
        <p><strong>Cliente:</strong> ${cliente.nombre}</p>
        <p><strong>TelÃ©fono:</strong> ${ocultarTelefono(cliente.telefono)}</p>
        <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
        <hr>
        ${html}
        <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
          <h3>Resumen</h3>
          <p><strong>Total Compras:</strong> â‚¡${totalCompras.toLocaleString()}</p>
          <p><strong>Total Pagado:</strong> â‚¡${totalPagado.toLocaleString()}</p>
          <p style="color: ${totalPendiente > 0 ? 'red' : 'green'}; font-weight: bold;">
            <strong>Saldo Pendiente:</strong> â‚¡${totalPendiente.toLocaleString()}
          </p>
        </div>
      `;
      document.getElementById("modal-historial").style.display = "flex";
    };

    function cerrarModalHistorial() {
      document.getElementById("modal-historial").style.display = "none";
    }

    function imprimirModalHistorial() {
      const contenido = document.getElementById("contenido-historial").innerHTML;
      const ventana = window.open('', '_blank', 'width:800,height:600');
      ventana.document.write(`
        <html>
          <head>
            <title>Historial de Compras - ${document.getElementById("contenido-historial").querySelector("p").textContent}</title>
            <style>
              body { 
                font-family: Arial, sans-serif; 
                padding: 20px; 
                color: #333; 
              }
              h2, h3 { 
                color: #6c4ba3; 
              }
              .resumen { 
                margin-top: 20px; 
                padding: 15px; 
                background: #f5f5f5; 
                border-radius: 6px; 
                font-weight: bold; 
              }
              @media print {
                button { display: none; }
              }
            </style>
          </head>
          <body>
            <h2>ğŸ“‹ Historial de Compras</h2>
            ${contenido}
            <button onclick="window.print()" style="padding: 10px; margin-top: 20px; background: #6c4ba3; color: white; border: none; border-radius: 5px;">ğŸ–¨ï¸ Imprimir</button>
          </body>
        </html>
      `);
      ventana.document.close();
    }

    // âœ… Ocultar telÃ©fono
    function ocultarTelefono(telefono) {
      if (!telefono || telefono === "00000000" || telefono === "0") {
        return "<span style='color: red;'>NÃºmero no vÃ¡lido</span>";
      }
      const limpio = telefono.replace(/\D/g, '');
      return limpio.length < 4 ? telefono : `****${limpio.slice(-4)}`;
    }

    // Cargar productos desde JSON
    const URL_ESENCIA = "https://wil1979.github.io/esentia-factura/productos_esentia.json";
    const URL_LIMPIEZA = "https://wil1979.github.io/esentia-factura/productos_limpieza_completo.json";
    let todosLosProductos = [];
    let carrito = [];
    let clienteSeleccionadoId = null;
    let filtroDeudoresActivo = true; // o false, segÃºn tu preferencia inicial

   async function cargarProductosJSON() {
  try {
    const [res1, res2] = await Promise.all([
      fetch(URL_ESENCIA),
      fetch(URL_LIMPIEZA)
    ]);
    const [aromas, limpieza] = await Promise.all([res1.json(), res2.json()]);
    // Unificar listados; mantener presentaciones y precios
    todosLosProductos = [...(aromas || []), ...(limpieza || [])].filter(p => p && (p.disponible === undefined || p.disponible === true));

    const select = document.getElementById("select-producto");
    if (!select) return;
    select.innerHTML = "";
    todosLosProductos.forEach((p, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = p.nombre;
      select.appendChild(opt);
    });

    // Escuchar cambios en la selecciÃ³n
    select.addEventListener("change", mostrarVistaPrevia);
    // Mostrar el primero al cargar
    if (todosLosProductos.length > 0) {
      select.value = 0;
      mostrarVistaPrevia();
    }
  } catch (err) {
    console.error("Error cargando productos JSON:", err);
  }
}

function mostrarVistaPrevia() {
  const index = parseInt(document.getElementById("select-producto").value);
  const prod = todosLosProductos[index];
  const img = document.getElementById("img-producto");
  const info = document.getElementById("info-producto");
  const selectorDiv = document.getElementById("selector-variantes");

  // Limpiar
  if (img) img.style.display = "none";
  if (info) info.textContent = "";
  if (selectorDiv) selectorDiv.innerHTML = "";
  if (!prod) return;

  // âœ… Convertir ruta relativa a URL absoluta
  if (prod.imagen && img) {
    // Base URL de tu repositorio
    const baseUrl = "https://wil1979.github.io/esentia-factura/";
    // Si la imagen ya es una URL absoluta, usarla directamente
    let src = prod.imagen;
    if (!prod.imagen.startsWith("http")) {
      // Asegurar que no haya doble barra
      src = baseUrl + (prod.imagen.startsWith("/") ? prod.imagen.slice(1) : prod.imagen);
    }
    img.src = src;
    img.style.display = "inline-block";
  }

  // Mostrar info bÃ¡sica
  if (info) info.textContent = prod.info || prod.beneficios || "";

  // Mostrar variantes si existen
  if (prod.variantes && prod.variantes.length > 0 && selectorDiv) {
    const label = document.createElement("div");
    label.textContent = "Selecciona una presentaciÃ³n:";
    label.style.marginBottom = "6px";
    label.style.fontWeight = "bold";
    selectorDiv.appendChild(label);

    const select = document.createElement("select");
    select.id = "select-variante";
    select.style.width = "100%";
    select.style.padding = "8px";
    select.style.borderRadius = "4px";
    select.style.border = "1px solid #ccc";

    const defaultOpt = document.createElement("option");
    defaultOpt.value = "";
    defaultOpt.textContent = "-- Selecciona --";
    select.appendChild(defaultOpt);

    prod.variantes.forEach(v => {
      const opt = document.createElement("option");
      opt.value = JSON.stringify(v);
      opt.textContent = `${v.nombre} â€“ â‚¡${(v.precio || 0).toLocaleString()}`;
      select.appendChild(opt);
    });

    selectorDiv.appendChild(select);
  }
}

    function abrirModalProductos(idCliente) {
      clienteSeleccionadoId = idCliente;
      carrito = [];
      document.getElementById("carrito-modal").innerHTML = "";
      document.getElementById("total-compra").textContent = "0";
      document.getElementById("descuento").value = "0";
      document.getElementById("modal-productos").style.display = "flex";
    }

    function cerrarModalProductos() {
      document.getElementById("modal-productos").style.display = "none";
    }
  

    function agregarAlCarritoModal() {
  const index = parseInt(document.getElementById("select-producto").value);
  const producto = todosLosProductos[index];
  if (!producto) return;

  let nombreFinal = producto.nombre;
  let precioFinal = producto.precioOferta ?? producto.precio ?? producto.precioOriginal ?? 0;

  // Si hay variantes, verificar selecciÃ³n
  const selectVariante = document.getElementById("select-variante");
  if (selectVariante && selectVariante.value) {
    try {
      const variante = JSON.parse(selectVariante.value);
      nombreFinal = `${producto.nombre} ${variante.nombre}`;
      precioFinal = variante.precio ?? precioFinal;
    } catch (e) {
      alert("Error al procesar la variante.");
      return;
    }
  } else if (producto.variantes && producto.variantes.length > 0) {
    alert("âš ï¸ Selecciona una presentaciÃ³n.");
    return;
  }

  // Evitar duplicados por nombre exacto
  if (carrito.some(item => item.nombre === nombreFinal)) {
    alert("Este producto ya estÃ¡ en el carrito.");
    return;
  }

  carrito.push({
    nombre: nombreFinal,
    precioUnitario: Number(precioFinal) || 0,
    cantidad: 1,
    producto: producto,
    productoOriginalIndex: index // opcional, para referencia
  });

  renderizarCarrito();
}

    function renderizarCarrito() {
  const contenedor = document.getElementById("carrito-modal");
  contenedor.innerHTML = "";
  if (carrito.length === 0) {
    contenedor.innerHTML = "<p>No hay productos en el carrito.</p>";
    actualizarTotal();
    return;
  }
  carrito.forEach((item, i) => {
    const div = document.createElement("div");
    div.className = "producto-item";
    div.innerHTML = `
      <div class="producto-info">
        <strong>${item.nombre}</strong><br>
        Precio: â‚¡${(Number(item.precioUnitario) || 0).toLocaleString()}
      </div>
      <div class="producto-cantidad">
        <div class="cantidad-control">
          <button class="btn-cantidad" onclick="cambiarCantidad(${i}, -1)">âˆ’</button>
          <input type="text" class="cantidad-display" value="${item.cantidad}" readonly>
          <button class="btn-cantidad" onclick="cambiarCantidad(${i}, 1)">+</button>
        </div>
        <button class="boton-accion" onclick="quitarDelCarrito(${i})" style="background: #d32f2f; padding: 5px 10px;">Eliminar</button>
      </div>
    `;
    contenedor.appendChild(div);
  });
  actualizarTotal();
}
    window.actualizarPrecio = function(index, nuevoPrecio) {
      const precio = parseFloat(nuevoPrecio);
      if (!isNaN(precio) && precio >= 0) {
        carrito[index].precioUnitario = precio;
        renderizarCarrito();
      }
    };

    window.cambiarCantidad = function(index, delta) {
      const nuevoValor = carrito[index].cantidad + delta;
      if (nuevoValor > 0) {
        carrito[index].cantidad = nuevoValor;
        renderizarCarrito();
      }
    };

    window.quitarDelCarrito = function(index) {
      carrito.splice(index, 1);
      renderizarCarrito();
    };

    function actualizarTotal() {
      let total = 0;
      carrito.forEach(item => {
        total += (Number(item.precioUnitario) || 0) * (Number(item.cantidad) || 0);
      });
      const descuento = parseFloat(document.getElementById("descuento").value) || 0;
      const totalConDescuento = Math.max(0, total - descuento);
      document.getElementById("total-compra").textContent = Math.round(totalConDescuento).toLocaleString();
    }

    document.getElementById("descuento").addEventListener("input", actualizarTotal);

   async function guardarCompraDesdeCarrito() {
  if (!clienteSeleccionadoId) return;
  if (carrito.length === 0) {
    alert("No hay productos en el carrito.");
    return;
  }

  // Calcular total de la compra
  let total = 0;
  carrito.forEach(item => {
    total += (Number(item.precioUnitario) || 0) * (Number(item.cantidad) || 0);
  });
  const descuento = parseFloat(document.getElementById("descuento").value) || 0;
  const totalNeto = Math.max(0, total - descuento);

  // Preguntar si se debe reiniciar yaParticipo (solo si â‰¥ â‚¡10,000)
  let reiniciarParticipacion = false;
  if (totalNeto >= 10000) {
    const respuesta = confirm(
      `âœ… Compra de â‚¡${totalNeto.toLocaleString()} registrada.\n\n` +
      `Â¿Deseas permitir que este cliente participe nuevamente en la ruleta?`
    );
    reiniciarParticipacion = respuesta;
  }

  // Guardar compra
  const clienteDoc = doc(db, "clientes", clienteSeleccionadoId);
  const snap = await getDocs(clientesRef);
  let comprasActuales = [];
  snap.forEach(s => {
    if (s.id === clienteSeleccionadoId) {
      comprasActuales = s.data().compras || [];
    }
  });

  const productos = [];
  carrito.forEach(item => {
    const producto = item.producto || todosLosProductos[item.productoOriginalIndex] || { nombre: item.nombre };
    const cantidad = Number(item.cantidad) || 0;
    const precio = Number(item.precioUnitario) || 0;
    productos.push({ 
      nombre: producto.nombre || item.nombre,
      presentacion: producto.presentacion || (producto.variantes?.[0]?.nombre) || '',
      aroma: producto.aroma || null,
      precio: precio,
      cantidad: cantidad,
      total: precio * cantidad
    });
  });

  comprasActuales.push({
    fecha: new Date().toISOString().slice(0, 10),
    productos,
    monto: total,
    descuento,
    pagado: 0,
    inventarioActualizado: false
  });

  // Preparar actualizaciÃ³n del documento
  const actualizacion = { compras: comprasActuales };
  if (reiniciarParticipacion) {
    actualizacion.yaParticipo = false;
    actualizacion.premioObtenido = null;     // Opcional: resetear
    actualizacion.codigoCanje = null;         // Opcional: resetear
    actualizacion.codigoUsado = false;        // Opcional: resetear
  }

  await updateDoc(clienteDoc, actualizacion);
  document.getElementById("modal-productos").style.display = "none";
  await cargarClientes(filtroDeudoresActivo);
  alert("âœ… Compra guardada exitosamente.");
}


    // âœ… Editar cliente directamente desde el modal de selecciÃ³n
window.editarClienteDesdeModal = async function(clienteId) {
  const clienteDoc = doc(db, "clientes", clienteId);
  const docSnap = await getDoc(clienteDoc);
  if (!docSnap.exists()) {
    alert("Cliente no encontrado.");
    return;
  }
  const cliente = docSnap.data();

  // Crear un modal simple para ediciÃ³n rÃ¡pida
  const modalEdit = document.createElement("div");
  modalEdit.style.position = "fixed";
  modalEdit.style.top = "50%";
  modalEdit.style.left = "50%";
  modalEdit.style.transform = "translate(-50%, -50%)";
  modalEdit.style.backgroundColor = "white";
  modalEdit.style.padding = "20px";
  modalEdit.style.borderRadius = "10px";
  modalEdit.style.boxShadow = "0 4px 6px rgba(0,0,0,0.1)";
  modalEdit.style.zIndex = "10000";
  modalEdit.style.width = "90%";
  modalEdit.style.maxWidth = "400px";

  modalEdit.innerHTML = `
    <h3 style="margin: 0 0 15px 0;">âœï¸ Editar Cliente</h3>
    <input type="text" id="edit-nombre-modal" value="${cliente.nombre}" placeholder="Nombre" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
    <input type="text" id="edit-cedula-modal" value="${cliente.cedula || ''}" placeholder="CÃ©dula (opcional)" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px;">
    <input type="text" id="edit-telefono-modal" value="${cliente.telefono}" placeholder="TelÃ©fono" style="width: 100%; padding: 8px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 4px;">
    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button class="boton-accion" style="background: #666;" onclick="document.body.removeChild(this.closest('div'));">âŒ Cancelar</button>
      <button class="boton-accion" style="background: #4CAF50;" onclick="guardarEdicionDesdeModal('${clienteId}')">ğŸ’¾ Guardar</button>
    </div>
  `;

  document.body.appendChild(modalEdit);

  // Centrar el foco en el primer campo
  modalEdit.querySelector("#edit-nombre-modal").focus();
};

// âœ… Guardar ediciÃ³n desde el modal emergente
window.guardarEdicionDesdeModal = async function(clienteId) {
  const nuevoNombre = document.getElementById("edit-nombre-modal").value.trim();
  const nuevaCedula = document.getElementById("edit-cedula-modal").value.trim();
  let nuevoTelefono = document.getElementById("edit-telefono-modal").value.trim();

  if (!nuevoNombre) {
    alert("âš ï¸ Completa el nombre.");
    return;
  }

  const telefonoLimpio = nuevoTelefono.replace(/\D/g, '');
  if (!telefonoLimpio || telefonoLimpio === "00000000" || telefonoLimpio.length < 8) {
    const nuevo = prompt("El nÃºmero no es vÃ¡lido. Ingresa un nÃºmero de telÃ©fono vÃ¡lido (8 dÃ­gitos):");
    if (!nuevo) {
      alert("Se requiere un nÃºmero vÃ¡lido.");
      return;
    }
    nuevoTelefono = nuevo;
  }

  try {
    const clienteDoc = doc(db, "clientes", clienteId);
    await updateDoc(clienteDoc, { 
      nombre: nuevoNombre, 
      telefono: nuevoTelefono,
      cedula: nuevaCedula || null
    });
    alert("âœ… Cliente actualizado.");
    
    // Cerrar el modal de ediciÃ³n
    const modalEdit = document.querySelector('div[style*="z-index: 10000"]');
    if (modalEdit) document.body.removeChild(modalEdit);

    // Opcional: Recargar la lista de clientes en el modal de selecciÃ³n
    const filtro = document.getElementById("filtro-cliente-modal");
    if (filtro) {
      filtro.dispatchEvent(new Event('input')); // Dispara el evento 'input' para recargar
    }
  } catch (error) {
    alert("âŒ Error al actualizar: " + error.message);
    console.error("Error:", error);
  }
};

    // Hacer funciones globales
    window.cargarClientes = cargarClientes;
    window.agregarCliente = agregarCliente;
    window.abrirModalProductos = abrirModalProductos;
    window.cerrarModalProductos = cerrarModalProductos;
    window.agregarAlCarritoModal = agregarAlCarritoModal;
    window.guardarCompraDesdeCarrito = guardarCompraDesdeCarrito;
    window.cambiarCantidad = cambiarCantidad;
    window.quitarDelCarrito = quitarDelCarrito;
    window.actualizarPrecio = actualizarPrecio;
    window.enviarWhatsApp = enviarWhatsApp;
    window.editarCliente = editarCliente;
    window.guardarEdicion = guardarEdicion;
    window.cancelarEdicion = cancelarEdicion;
    window.registrarPago = registrarPago;
    window.generarReporte = generarReporte;
    window.abrirModalImpresion = abrirModalImpresion;
    window.cerrarModalImpresion = cerrarModalImpresion;
    window.generarReporteModal = generarReporteModal;
    window.imprimirModal = imprimirModal;
    window.eliminarCliente = eliminarCliente;
    window.abrirModalHistorial = abrirModalHistorial;
    window.cerrarModalHistorial = cerrarModalHistorial;
    window.imprimirModalHistorial = imprimirModalHistorial;
    window.actualizarInventario = actualizarInventario;
    window.revertirInventario = revertirInventario;
   window.abrirModalNuevoCliente = abrirModalNuevoCliente;
window.cerrarModalNuevoCliente = cerrarModalNuevoCliente;
window.guardarNuevoCliente = guardarNuevoCliente;
    // Hacer funciones globales
window.abrirModalNuevaVenta = abrirModalNuevaVenta;
window.cerrarModalSeleccionarCliente = cerrarModalSeleccionarCliente;
// ... y las nuevas:
window.registrarPago = registrarPago;
window.aplicarPago = aplicarPago;
window.cerrarModalPago = cerrarModalPago;
window.enviarWhatsAppDeudas = enviarWhatsAppDeudas;
window.imprimirDeudasPago = imprimirDeudasPago;
window.abrirModalEditarCliente = abrirModalEditarCliente;
window.cerrarModalEditarCliente = cerrarModalEditarCliente;
window.guardarEdicionDesdeModal = guardarEdicionDesdeModal;


    // Inicializar: cargar solo deudores al inicio
    await cargarClientes(filtroDeudoresActivo);
    await cargarProductosJSON();
  </script>
  <script>
    function scrollToTop() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    }
    function scrollToBottom() {
      window.scrollTo({
        top: document.documentElement.scrollHeight,
        behavior: 'smooth'
      });
    }

    
  </script>

<!-- Modal para seleccionar cliente -->
<div id="modal-seleccionar-cliente" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
  <div style="background: white; width: 90%; max-width: 600px; border-radius: 10px; padding: 20px; max-height: 80vh; overflow-y: auto;">
    <h2>â• Seleccionar Cliente</h2>
    <input type="text" id="filtro-cliente-modal" placeholder="Buscar cliente..." style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ddd;">
    <div id="lista-clientes-modal" style="max-height: 400px; overflow-y: auto;">
      <!-- Se llenarÃ¡ dinÃ¡micamente -->
    </div>
    <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
      <button class="boton-accion" onclick="cerrarModalSeleccionarCliente()" style="background: #666;">âŒ Cerrar</button>
    </div>
  </div>
</div>
<!-- Modal para nuevo cliente -->
<div id="modal-nuevo-cliente" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:white; padding:25px; border-radius:12px; width:90%; max-width:500px;">
    <h2>ğŸ‘¤ Registrar Nuevo Cliente</h2>
    <div style="margin-bottom:15px;">
      <label>CÃ©dula:</label>
      <input type="text" id="modal-cedula" placeholder="Ej: 112230405" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
      <small id="nombre-desde-api" style="color:#4CAF50; display:block; margin-top:5px;"></small>
    </div>
    <div style="margin-bottom:15px;">
      <label>Nombre (editable):</label>
      <input type="text" id="modal-nombre" placeholder="Nombre del cliente" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
    </div>
    <div style="margin-bottom:20px;">
      <label>TelÃ©fono (con cÃ³digo, 8 dÃ­gitos):</label>
      <input type="text" id="modal-telefono" placeholder="Ej: 88889999" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="boton-accion" style="background:#666;" onclick="cerrarModalNuevoCliente()">âŒ Cancelar</button>
      <button class="boton-accion" style="background:#4CAF50;" onclick="guardarNuevoCliente()">âœ… Guardar y Agregar Productos</button>
    </div>
  </div>
</div>

<!-- Modal de selecciÃ³n de factura para pago -->
<div id="modal-pago" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:white; padding:25px; border-radius:12px; width:90%; max-width:600px; max-height:85vh; overflow-y:auto;">
    <h2>ğŸ’° Realizar Pago â€“ <span id="nombre-cliente-pago"></span></h2>
    <div id="lista-facturas-pendientes"></div>
    <div id="acciones-pago" style="margin-top: 20px; display:flex; gap:10px; justify-content:flex-end;">
      <button class="boton-accion" style="background:#666;" onclick="cerrarModalPago()">âŒ Cerrar</button>
      <button class="boton-accion" style="background:#4CAF50;" onclick="enviarWhatsAppDeudas()">ğŸ“² Enviar Saldo</button>
      <button class="boton-accion" style="background:#2196F3;" onclick="imprimirDeudasPago()">ğŸ–¨ï¸ Imprimir</button>
    </div>
  </div>
</div>

<!-- Modal para editar cliente -->
<div id="modal-editar-cliente" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:2000; justify-content:center; align-items:center;">
  <div style="background:white; padding:25px; border-radius:12px; width:90%; max-width:500px;">
    <h2>âœï¸ Editar Cliente</h2>
    <input type="hidden" id="modal-edit-id">
    <div style="margin-bottom:15px;">
      <label>Nombre:</label>
      <input type="text" id="modal-edit-nombre" placeholder="Nombre completo" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
    </div>
    <div style="margin-bottom:15px;">
      <label>CÃ©dula (opcional):</label>
      <input type="text" id="modal-edit-cedula" placeholder="CÃ©dula" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
      <small id="mensaje-nombre-desde-cedula" style="color:#4CAF50; display:block; margin-top:5px;"></small>
    </div>
    <div style="margin-bottom:20px;">
      <label>TelÃ©fono (8 dÃ­gitos):</label>
      <input type="text" id="modal-edit-telefono" placeholder="Ej: 88889999" style="width:100%; padding:10px; border:1px solid #ccc; border-radius:6px;">
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-end;">
      <button class="boton-accion" style="background:#666;" onclick="cerrarModalEditarCliente()">âŒ Cancelar</button>
      <button class="boton-accion" style="background:#4CAF50;" onclick="guardarEdicionDesdeModal()">ğŸ’¾ Guardar</button>
    </div>
  </div>
</div>

</body>
</html>