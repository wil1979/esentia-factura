<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üì¶ Esentia - Compras a Proveedores</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f8f9fa;
      color: #333;
    }
    h1, h2 {
      color: #6c4ba3;
    }
    .boton-accion {
      background: #6c4ba3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin: 4px;
    }
    .boton-accion:hover {
      background: #5a3d8a;
    }
    .boton-rojo {
      background: #d32f2f;
    }
    .boton-rojo:hover {
      background: #b71c1c;
    }
    .item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-contenido¬°Perfecto! Aqu√≠ tienes el **archivo HTML completo actualizado**, con todas las correcciones para que el bot√≥n **"‚ûï Agregar"** funcione correctamente desde el inicio:

- ‚úÖ El selector de productos se llena al abrir el modal.
- ‚úÖ La b√∫squeda filtra en tiempo real, y si est√° vac√≠a, muestra todos los productos.
- ‚úÖ El precio unitario se toma del JSON (`precioOferta` o `precio`), no es fijo.
- ‚úÖ Carrito en memoria con edici√≥n y eliminaci√≥n.

---

### ‚úÖ `compras-proveedores.html` (versi√≥n corregida y completa)

```html
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üì¶ Esentia - Compras a Proveedores</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: #f8f9fa;
      color: #333;
    }
    h1, h2 {
      color: #6c4ba3;
    }
    .boton-accion {
      background: #6c4ba3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin: 4px;
    }
    .boton-accion:hover {
      background: #5a3d8a;
    }
    .boton-rojo {
      background: #d32f2f;
    }
    .boton-rojo:hover {
      background: #b71c1c;
    }
    .item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-contenido {
      background: white;
      padding: 25px;
      border-radius: 12px;
      width: 90%;
      max-width: 600px;
      position: relative;
    }
    .cerrar-modal {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    .botones-derecha {
      text-align: right;
      margin-top: 15px;
    }
    .scroll-buttons {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .scroll-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #6c4ba3;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
    .producto-item {
      background: #f5f5f5;
      padding: 12px;
      margin: 10px 0;
      border-radius: 8px;
      border-left: 4px solid #6c4ba3;
    }
    input[type="text"],
    input[type="email"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .acciones-compra {
      margin-top: 10px;
    }
    .btn-inventario {
      background: #2e7d32;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .estado-inventario {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .actualizado {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .pendiente {
      background: #fff3e0;
      color: #e65100;
    }
  </style>
</head>
<body>

  <div class="scroll-buttons">
    <button class="scroll-btn" onclick="scrollToTop()">‚Üë</button>
    <button class="scroll-btn" onclick="scrollToBottom()">‚Üì</button>
  </div>

  <h1>üì¶ Esentia - Compras a Proveedores</h1>

  <!-- Bot√≥n para mostrar/ocultar proveedores -->
  <button class="boton-accion" style="margin-bottom: 20px;" onclick="toggleProveedores()">
    üëÅÔ∏è <span id="texto-toggle">Mostrar Proveedores</span>
  </button>

  <!-- Secci√≥n de Proveedores -->
  <div id="contenedor-proveedores" style="display: none; border: 1px solid #ddd; border-radius: 10px; padding: 15px; background: #f9f9f9; margin-bottom: 30px;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <h2>üè¢ Proveedores</h2>
      <button class="boton-accion" onclick="abrirModalProveedor()">‚ûï Nuevo Proveedor</button>
    </div>
    <div id="lista-proveedores"></div>
  </div>

  <!-- Secci√≥n de Compras -->
  <h2>üõí Compras a Proveedores</h2>
  <button class="boton-accion" onclick="abrirModalCompra()">‚ûï Registrar Compra</button>

  <!-- Filtros de Compras -->
  <div class="filtro-compras" style="margin: 15px 0;">
    <div class="filtro-item">
      <label for="filtro-proveedor">Filtrar por Proveedor:</label>
      <select id="filtro-proveedor">
        <option value="todos">Todos los proveedores</option>
      </select>
    </div>
    <button class="boton-accion" onclick="filtrarCompras()">üîç Mostrar Compras</button>
  </div>

  <!-- Lista de compras -->
  <div id="lista-compras"><p>Selecciona un filtro y haz clic en 'Mostrar Compras'.</p></div>

  <!-- Modal: Nuevo Proveedor -->
  <div id="modal-proveedor" class="modal">
    <div class="modal-contenido">
      <span class="cerrar-modal" onclick="cerrarModalProveedor()">&times;</span>
      <h3>‚ûï Nuevo Proveedor</h3>
      <input type="text" id="nombre-proveedor" placeholder="Nombre del proveedor">
      <input type="text" id="telefono-proveedor" placeholder="Tel√©fono (opcional)">
      <input type="email" id="correo-proveedor" placeholder="Correo (opcional)">
      <input type="text" id="sitio-proveedor" placeholder="Sitio web (opcional)">
      <textarea id="notas-proveedor" placeholder="Notas adicionales" style="height: 80px;"></textarea>
      <div class="botones-derecha">
        <button class="boton-accion" onclick="cerrarModalProveedor()">‚ùå Cancelar</button>
        <button class="boton-accion" onclick="guardarProveedor()">üíæ Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Nueva Compra -->
  <div id="modal-compra" class="modal">
    <div class="modal-contenido">
      <span class="cerrar-modal" onclick="cerrarModalCompra()">&times;</span>
      <h3 id="titulo-modal-compra">üõí Nueva Compra</h3>
      <label>Proveedor:</label>
      <select id="select-proveedor"></select>
      <label>Fecha:</label>
      <input type="date" id="fecha-compra">
      <label>Fecha de pago esperada (opcional):</label>
      <input type="date" id="fecha-pago">
      <label>Factura (opcional):</label>
      <input type="text" id="factura-compra" placeholder="FAC-001">
      <label>Forma de pago:</label>
      <select id="forma-pago">
        <option>Efectivo</option>
        <option>SINPE</option>
        <option>Tarjeta</option>
        <option>Cr√©dito</option>
      </select>
      <label>Notas (opcional):</label>
      <input type="text" id="notas-compra" placeholder="Detalles adicionales">

      <label>Buscar y agregar producto:</label>
      <input type="text" id="buscar-producto" placeholder="üîç Buscar producto" oninput="filtrarProductosBusqueda()">
      <select id="select-producto">
        <option value="">Selecciona un producto</option>
      </select>
      <button onclick="agregarAlCarrito()">‚ûï Agregar</button>

      <!-- Carrito renderizado aqu√≠ -->
      <div id="productos-compra" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;"></div>

      <br><br>
      <strong>Total: ‚Ç°<span id="total-compra">0</span></strong>
      <br><br>
      <div class="botones-derecha">
        <button class="boton-accion" onclick="cerrarModalCompra()">‚ùå Cancelar</button>
        <button class="boton-accion" onclick="guardarCompra()">üíæ Guardar Compra</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, getDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const proveedoresRef = collection(db, "proveedores");
    const comprasRef = collection(db, "comprasProveedor");
    const stockRef = collection(db, "stock");

    let proveedores = [];
    let todosLosProductos = [];
    let carritoCompra = [];

    const URL_ESENCIA = "https://wil1979.github.io/esentia-factura/productos_esentia.json";
    const URL_LIMPIEZA = "https://wil1979.github.io/esentia-factura/productos_limpieza_completo.json";

    window.onload = async () => {
      await cargarProductosJSON();
      await cargarProveedores();
      await cargarFiltroProveedores();
      document.getElementById("lista-compras").innerHTML = "<p>Selecciona un filtro y haz clic en 'Mostrar Compras'.</p>";
    };

    async function cargarProductosJSON() {
      try {
        const [res1, res2] = await Promise.all([fetch(URL_ESENCIA), fetch(URL_LIMPIEZA)]);
        const [aromas, limpieza] = await Promise.all([res1.json(), res2.json()]);
        todosLosProductos = [...aromas, ...limpieza].filter(p => p.disponible);
        console.log("‚úÖ Productos cargados:", todosLosProductos.length);
      } catch (error) {
        console.error("‚ùå Error al cargar productos:", error);
        alert("No se pudieron cargar los productos. Verifica la conexi√≥n.");
      }
    }

    async function cargarProveedores() {
      const cont = document.getElementById("lista-proveedores");
      cont.innerHTML = "<p>Cargando proveedores...</p>";

      try {
        const snapshot = await getDocs(proveedoresRef);
        proveedores = [];
        snapshot.forEach(docSnap => {
          const p = docSnap.data();
          p.id = docSnap.id;
          proveedores.push(p);
        });

        if (proveedores.length === 0) {
          cont.innerHTML = "<p>No hay proveedores registrados.</p>";
          return;
        }

        cont.innerHTML = "";
        proveedores.forEach(p => {
          const div = document.createElement("div");
          div.className = "item";
          div.innerHTML = `
            <strong>üè¢ ${p.nombre}</strong><br>
            üìû ${p.telefono || 'Sin tel√©fono'}<br>
            ‚úâÔ∏è ${p.correo || 'Sin correo'}<br>
            üåê ${p.sitioWeb || 'Sin sitio'}<br>
            üìù ${p.notas || 'Sin notas'}
            <div class="botones-derecha">
              <button class="boton-accion" onclick="editarProveedor('${p.id}')">‚úèÔ∏è Editar</button>
              <button class="boton-accion boton-rojo" onclick="eliminarProveedor('${p.id}', '${p.nombre}')">üóëÔ∏è Eliminar</button>
            </div>
          `;
          cont.appendChild(div);
        });
      } catch (error) {
        cont.innerHTML = "<p>Error al cargar proveedores.</p>";
        console.error("Error:", error);
      }
    }

    async function cargarFiltroProveedores() {
      const filtro = document.getElementById("filtro-proveedor");
      filtro.innerHTML = "<option value='todos'>Todos los proveedores</option>";

      try {
        const snapshot = await getDocs(proveedoresRef);
        snapshot.forEach(docSnap => {
          const p = docSnap.data();
          const opt = document.createElement("option");
          opt.value = docSnap.id;
          opt.textContent = p.nombre;
          filtro.appendChild(opt);
        });
      } catch (error) {
        console.error("Error al cargar proveedores para filtro:", error);
      }
    }

    // ‚úÖ FUNCIONES CORREGIDAS DEL CARRITO
    function llenarSelectProductos() {
      const select = document.getElementById("select-producto");
      select.innerHTML = "<option value=''>Selecciona un producto</option>";
      todosLosProductos.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        select.appendChild(opt);
      });
    }

    function filtrarProductosBusqueda() {
      const busqueda = document.getElementById("buscar-producto").value.toLowerCase().trim();
      const select = document.getElementById("select-producto");
      select.innerHTML = "<option value=''>Selecciona un producto</option>";

      const listaFiltrada = busqueda
        ? todosLosProductos.filter(p => p.nombre.toLowerCase().includes(busqueda))
        : todosLosProductos;

      listaFiltrada.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        select.appendChild(opt);
      });
    }

    function agregarAlCarrito() {
  const id = document.getElementById("select-producto").value;
  if (!id) {
    alert("‚ö†Ô∏è Por favor selecciona un producto.");
    return;
  }

  // ‚úÖ Comparaci√≥n segura: convertir ambos a string
  const producto = todosLosProductos.find(p => String(p.id) === String(id));
  if (!producto) {
    alert("‚ùå Producto no encontrado. Esto puede deberse a un problema de formato de ID.");
    console.error("ID seleccionado:", id, "Productos disponibles:", todosLosProductos.map(p => ({ id: p.id, nombre: p.nombre })));
    return;
  }

  const existente = carritoCompra.find(p => p.id === producto.id);
  if (existente) {
    existente.cantidad += 1;
  } else {
    const precioUnitario = producto.precioOferta || producto.precio || 1300;
    carritoCompra.push({
      id: producto.id, // mant√©n el tipo original (n√∫mero)
      nombre: producto.nombre,
      cantidad: 1,
      precioUnitario: precioUnitario
    });
  }

  renderCarrito();
}

    function renderCarrito() {
      const cont = document.getElementById("productos-compra");
      cont.innerHTML = "";

      let total = 0;

      carritoCompra.forEach((p, index) => {
        const subtotal = p.cantidad * p.precioUnitario;
        total += subtotal;

        const div = document.createElement("div");
        div.className = "producto-item";
        div.innerHTML = `
          <strong>${p.nombre}</strong><br>
          Cant: <input type="number" value="${p.cantidad}" min="1"
            onchange="actualizarCantidad(${index}, this.value)">
          Precio: <input type="number" value="${p.precioUnitario}"
            onchange="actualizarPrecio(${index}, this.value)">
          <br>Total: ‚Ç°${subtotal.toLocaleString()}
          <button class="boton-accion boton-rojo"
            onclick="eliminarDelCarrito(${index})">‚ùå</button>
        `;
        cont.appendChild(div);
      });

      document.getElementById("total-compra").textContent = total.toLocaleString();
    }

    function actualizarCantidad(index, valor) {
      const num = parseInt(valor) || 0;
      if (num >= 1) carritoCompra[index].cantidad = num;
      renderCarrito();
    }

    function actualizarPrecio(index, valor) {
      const num = parseFloat(valor) || 0;
      if (num >= 0) carritoCompra[index].precioUnitario = num;
      renderCarrito();
    }

    function eliminarDelCarrito(index) {
      carritoCompra.splice(index, 1);
      renderCarrito();
    }

    // PROVEEDORES
    function abrirModalProveedor() {
      document.getElementById("modal-proveedor").style.display = "flex";
      document.getElementById("nombre-proveedor").value = "";
      document.getElementById("telefono-proveedor").value = "";
      document.getElementById("correo-proveedor").value = "";
      document.getElementById("sitio-proveedor").value = "";
      document.getElementById("notas-proveedor").value = "";
    }

    function cerrarModalProveedor() {
      document.getElementById("modal-proveedor").style.display = "none";
    }

    async function guardarProveedor() {
      const nombre = document.getElementById("nombre-proveedor").value.trim();
      if (!nombre) {
        alert("‚ö†Ô∏è El nombre es obligatorio.");
        return;
      }

      const telefono = document.getElementById("telefono-proveedor").value.trim();
      const correo = document.getElementById("correo-proveedor").value.trim();
      const sitioWeb = document.getElementById("sitio-proveedor").value.trim();
      const notas = document.getElementById("notas-proveedor").value.trim();

      try {
        await addDoc(proveedoresRef, {
          nombre,
          telefono,
          correo,
          sitioWeb,
          notas
        });
        alert("‚úÖ Proveedor agregado.");
        cerrarModalProveedor();
        await cargarProveedores();
        await cargarFiltroProveedores();
      } catch (error) {
        alert("‚ùå Error: " + error.message);
      }
    }

    async function editarProveedor(id) {
      const docSnap = await getDoc(doc(db, "proveedores", id));
      if (!docSnap.exists()) return;
      const p = docSnap.data();

      const nombre = prompt("Nombre:", p.nombre);
      if (!nombre) return;
      const telefono = prompt("Tel√©fono:", p.telefono || "");
      const correo = prompt("Correo:", p.correo || "");
      const sitioWeb = prompt("Sitio web:", p.sitioWeb || "");
      const notas = prompt("Notas:", p.notas || "");

      await updateDoc(doc(db, "proveedores", id), {
        nombre,
        telefono,
        correo,
        sitioWeb,
        notas
      });
      alert("‚úÖ Proveedor actualizado.");
      await cargarProveedores();
      await cargarFiltroProveedores();
    }

    async function eliminarProveedor(id, nombre) {
      if (!confirm(`¬øEliminar a ${nombre}?`)) return;
      await deleteDoc(doc(db, "proveedores", id));
      alert(`‚úÖ ${nombre} eliminado.`);
      await cargarProveedores();
      await cargarFiltroProveedores();
    }

    // COMPRAS
    async function abrirModalCompra(editId = null) {
      const select = document.getElementById("select-proveedor");
      select.innerHTML = "";
      proveedores.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.nombre;
        select.appendChild(opt);
      });

      document.getElementById("fecha-compra").valueAsDate = new Date();
      document.getElementById("fecha-pago").value = "";
      document.getElementById("factura-compra").value = "";
      document.getElementById("notas-compra").value = "";
      document.getElementById("forma-pago").value = "Efectivo";
      document.getElementById("buscar-producto").value = "";

      carritoCompra = [];
      renderCarrito();

      // ‚úÖ Llenar el selector de productos al abrir
      llenarSelectProductos();

      const modal = document.getElementById("modal-compra");

      if (editId) {
        alert("La edici√≥n de compras a√∫n no est√° adaptada al nuevo carrito. ¬øDeseas continuar?");
        modal.dataset.editId = editId;
        document.getElementById("titulo-modal-compra").textContent = "‚úèÔ∏è Editar Compra";
      } else {
        document.getElementById("titulo-modal-compra").textContent = "üõí Nueva Compra";
        delete modal.dataset.editId;
      }

      modal.style.display = "flex";
    }

    function cerrarModalCompra() {
      document.getElementById("modal-compra").style.display = "none";
      carritoCompra = [];
      const modal = document.getElementById("modal-compra");
      if (modal.dataset.editId) delete modal.dataset.editId;
    }

    async function guardarCompra() {
      const modal = document.getElementById("modal-compra");
      const editId = modal.dataset.editId;
      const esEdicion = !!editId;

      const proveedorId = document.getElementById("select-proveedor").value;
      const fecha = document.getElementById("fecha-compra").value;
      const fechaPago = document.getElementById("fecha-pago").value;
      const factura = document.getElementById("factura-compra").value;
      const formaPago = document.getElementById("forma-pago").value;
      const notas = document.getElementById("notas-compra").value;

      if (!proveedorId || !fecha) {
        alert("‚ö†Ô∏è Completa todos los campos obligatorios.");
        return;
      }

      if (carritoCompra.length === 0) {
        alert("‚ö†Ô∏è Agrega al menos un producto.");
        return;
      }

      const proveedor = proveedores.find(p => p.id === proveedorId);
      const productos = carritoCompra.map(p => ({
        id: p.id,
        nombre: p.nombre,
        cantidad: p.cantidad,
        precioUnitario: p.precioUnitario,
        total: p.cantidad * p.precioUnitario
      }));

      const totalCompra = productos.reduce((sum, p) => sum + p.total, 0);

      try {
        const data = {
          proveedorId,
          proveedorNombre: proveedor.nombre,
          fecha,
          fechaPago,
          factura,
          formaPago,
          notas,
          productos,
          totalCompra
        };

        if (esEdicion) {
          await updateDoc(doc(db, "comprasProveedor", editId), data);
          alert("‚úÖ Compra actualizada exitosamente.");
        } else {
          await addDoc(comprasRef, data);
          alert("‚úÖ Compra registrada exitosamente.");

          if (confirm("¬øImprimir comprobante de compra?")) {
            imprimirComprobante(data);
          }
        }

        cerrarModalCompra();
        await filtrarCompras();
      } catch (error) {
        alert("‚ùå Error al guardar: " + error.message);
      }
    }

    async function filtrarCompras() {
      const proveedorId = document.getElementById("filtro-proveedor").value;
      const cont = document.getElementById("lista-compras");
      cont.innerHTML = "<p>Filtrando compras...</p>";

      try {
        const snapshot = await getDocs(comprasRef);
        const compras = [];

        snapshot.forEach(docSnap => {
          const c = docSnap.data();
          c.id = docSnap.id;
          if (proveedorId === "todos" || c.proveedorId === proveedorId) {
            compras.push(c);
          }
        });

        compras.sort((a, b) => b.fecha.localeCompare(a.fecha));

        if (compras.length === 0) {
          cont.innerHTML = "<p>No hay compras registradas para este filtro.</p>";
          return;
        }

        cont.innerHTML = "";
        compras.forEach(c => {
          const div = document.createElement("div");
          div.className = "item";
          let productosHTML = "";
          c.productos.forEach(p => {
            productosHTML += `<li>${p.cantidad}x ${p.nombre} - ‚Ç°${p.precioUnitario}/ud = ‚Ç°${p.total}</li>`;
          });

          const nombreProveedor = c.proveedorNombre;
          const fechaPago = c.fechaPago ? ` | üìÖ Pagar: ${c.fechaPago}` : '';
          const iconoPago = c.formaPago === 'Cr√©dito' ? 'üí≥' : 'üíµ';

          const estadoInventario = c.estadoInventario === 'actualizado' ? 
            '<span class="estado-inventario actualizado">‚úÖ Inventario actualizado</span>' : 
            '<span class="estado-inventario pendiente">‚ö†Ô∏è Pendiente de actualizar</span>';

          div.innerHTML = `
            <strong>üì¶ ${nombreProveedor}</strong> | üìÖ ${c.fecha} | ${iconoPago} ‚Ç°${c.totalCompra.toLocaleString()}${fechaPago}
            <br>
            <small>üìÑ ${c.factura || 'Sin factura'} | üí≥ ${c.formaPago}</small>
            <br>
            <details>
              <summary>Ver productos (${c.productos.length})</summary>
              <ul>${productosHTML}</ul>
              <p><strong>Notas:</strong> ${c.notas || 'Ninguna'}</p>
            </details>
            <div class="acciones-compra">
              <button class="boton-accion" onclick="abrirModalCompra('${c.id}')">‚úèÔ∏è Editar</button>
              <button class="boton-accion boton-rojo" onclick="eliminarCompra('${c.id}')">üóëÔ∏è Eliminar</button>
              <button class="btn-inventario" onclick="actualizarInventario('${c.id}')">
               üì¶ Actualizar Inventario
              </button>
            </div>
            ${estadoInventario}
          `;
          cont.appendChild(div);
        });
      } catch (error) {
        cont.innerHTML = "<p>Error al cargar compras.</p>";
        console.error("Error:", error);
      }
    }

    async function eliminarCompra(id) {
      if (!confirm("¬øEliminar esta compra?")) return;
      try {
        await deleteDoc(doc(db, "comprasProveedor", id));
        alert("‚úÖ Compra eliminada.");
        await filtrarCompras();
      } catch (error) {
        alert("‚ùå Error al eliminar.");
      }
    }

    function imprimirComprobante(compra) {
      const ventana = window.open('', '_blank', 'width=800,height=600');
      let productosHTML = '';
      compra.productos.forEach(p => {
        productosHTML += `
          <tr>
            <td>${p.nombre}</td>
            <td>${p.cantidad}</td>
            <td>‚Ç°${p.precioUnitario.toLocaleString()}</td>
            <td>‚Ç°${p.total.toLocaleString()}</td>
          </tr>
        `;
      });

      ventana.document.write(`
        <html>
          <head>
            <title>Comprobante de Compra</title>
            <style>
              body { font-family: Arial, sans-serif; padding: 20px; color: #333; }
              .encabezado { text-align: center; border-bottom: 2px solid #6c4ba3; padding-bottom: 10px; margin-bottom: 20px; }
              .encabezado h2 { color: #6c4ba3; margin: 0; }
              table { width: 100%; border-collapse: collapse; margin: 20px 0; }
              th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
              th { background-color: #f5f5f5; }
              .total { font-weight: bold; font-size: 1.1rem; }
              @media print {
                button { display: none; }
              }
            </style>
          </head>
          <body>
            <div class="encabezado">
              <h2>üì¶ Comprobante de Compra</h2>
              <p><strong>Proveedor:</strong> ${compra.proveedorNombre}</p>
              <p><strong>Fecha:</strong> ${compra.fecha} | <strong>Factura:</strong> ${compra.factura || 'Sin factura'}</p>
            </div>
            <table>
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Cant</th>
                  <th>Precio</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${productosHTML}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="total">Total General</td>
                  <td class="total">‚Ç°${compra.totalCompra.toLocaleString()}</td>
                </tr>
              </tfoot>
            </table>
            <p><strong>Forma de pago:</strong> ${compra.formaPago}</p>
            ${compra.fechaPago ? `<p><strong>Fecha de pago esperada:</strong> ${compra.fechaPago}</p>` : ''}
            <p><strong>Notas:</strong> ${compra.notas || 'Ninguna'}</p>
            <button onclick="window.print()" style="padding: 10px; background: #6c4ba3; color: white; border: none; border-radius: 5px; margin-top: 20px;">üñ®Ô∏è Imprimir</button>
          </body>
        </html>
      `);
      ventana.document.close();
    }

    async function actualizarInventario(compraId) {
      if (!compraId || typeof compraId !== "string") {
        alert("‚ùå Error: ID de compra inv√°lido.");
        return;
      }

      if (!confirm('¬øDeseas actualizar el inventario con los productos de esta compra?')) {
        return;
      }

      try {
        const compraRef = doc(db, "comprasProveedor", compraId);
        const compraSnap = await getDoc(compraRef);

        if (!compraSnap.exists()) {
          alert("Compra no encontrada.");
          return;
        }

        const compra = compraSnap.data();
        const productosCompra = compra.productos;

        const snapshotStock = await getDocs(stockRef);
        const stockPorId = {};
        snapshotStock.forEach(docSnap => {
          const data = docSnap.data();
          if (data.id) {
            stockPorId[data.id] = {
              id: docSnap.id,
              ...data
            };
          }
        });

        let actualizados = 0;
        let nuevos = 0;

        for (const producto of productosCompra) {
          const { id, nombre, cantidad, precioUnitario } = producto;
          if (!id) continue;

          if (stockPorId[id]) {
            const stockDoc = doc(db, "stock", stockPorId[id].id);
            const nuevaCantidad = stockPorId[id].cantidad + cantidad;
            await updateDoc(stockDoc, {
              cantidad: nuevaCantidad,
              precio: precioUnitario,
              proveedor: compra.proveedorNombre,
              fechaUltimaCompra: compra.fecha,
              ultimaActualizacion: new Date().toISOString()
            });
            actualizados++;
          } else {
            await addDoc(stockRef, {
              id,
              nombre,
              cantidad,
              precio: precioUnitario,
              proveedor: compra.proveedorNombre,
              fechaUltimaCompra: compra.fecha,
              fechaCreacion: new Date().toISOString(),
              categoria: "compra-proveedor"
            });
            nuevos++;
          }
        }

        await updateDoc(compraRef, {
          estadoInventario: "actualizado",
          fechaActualizacionInventario: new Date().toISOString()
        });

        alert(
          `‚úÖ Inventario actualizado\n` +
          `‚Ä¢ ${actualizados} productos actualizados\n` +
          `‚Ä¢ ${nuevos} productos nuevos`
        );

        await filtrarCompras();
      } catch (error) {
        console.error(error);
        alert("‚ùå Error al actualizar inventario");
      }
    }

    function toggleProveedores() {
      const cont = document.getElementById("contenedor-proveedores");
      const texto = document.getElementById("texto-toggle");
      if (cont.style.display === "block") {
        cont.style.display = "none";
        texto.textContent = "Mostrar Proveedores";
      } else {
        cont.style.display = "block";
        texto.textContent = "Ocultar Proveedores";
      }
    }

    // Hacer funciones globales
    window.abrirModalProveedor = abrirModalProveedor;
    window.cerrarModalProveedor = cerrarModalProveedor;
    window.guardarProveedor = guardarProveedor;
    window.editarProveedor = editarProveedor;
    window.eliminarProveedor = eliminarProveedor;
    window.abrirModalCompra = abrirModalCompra;
    window.cerrarModalCompra = cerrarModalCompra;
    window.guardarCompra = guardarCompra;
    window.eliminarCompra = eliminarCompra;
    window.imprimirComprobante = imprimirComprobante;
    window.toggleProveedores = toggleProveedores;
    window.cargarFiltroProveedores = cargarFiltroProveedores;
    window.filtrarCompras = filtrarCompras;
    window.actualizarInventario = actualizarInventario;
    window.filtrarProductosBusqueda = filtrarProductosBusqueda;
    window.agregarAlCarrito = agregarAlCarrito;
    window.actualizarCantidad = actualizarCantidad;
    window.actualizarPrecio = actualizarPrecio;
    window.eliminarDelCarrito = eliminarDelCarrito;
    window.llenarSelectProductos = llenarSelectProductos;
  </script>

  <script>
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function scrollToBottom() {
      window.scrollTo({ top: document.documentElement.scrollHeight, behavior: 'smooth' });
    }
  </script>
</body>
</html>