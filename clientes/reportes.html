<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üìä Esentia - Reporte de Rentabilidad</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background-color: #f3f2f7;
      color: #333;
    }
    h1 {
      color: #6c4ba3;
      text-align: center;
    }
    h2 {
      color: #555;
      border-bottom: 2px solid #6c4ba3;
      padding-bottom: 8px;
      margin-top: 30px;
    }
    .filtro-item {
      display: flex;
      flex-direction: column;
      margin-bottom: 15px;
    }
    .filtro-item label {
      font-weight: bold;
      margin-bottom: 5px;
      color: #6c4ba3;
    }
    .boton-accion {
      padding: 10px 15px;
      font-size: 1rem;
      border: none;
      background: #6c4ba3;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    .boton-accion:hover {
      background: #573993;
    }
    .resumen {
      background: #f5f5f7;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .resumen h3 {
      margin-top: 0;
      color: #555;
    }
    .tabla-reportes {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .tabla-reportes th, .tabla-reportes td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .tabla-reportes th {
      background-color: #6c4ba3;
      color: white;
    }
    .tabla-reportes tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .deuda-alta {
      color: #d32f2f;
      font-weight: bold;
    }
    .deuda-media {
      color: #f57c00;
      font-weight: bold;
    }
    .deuda-baja {
      color: #388e3c;
      font-weight: bold;
    }
    .alerta {
      color: #d32f2f;
      font-style: italic;
    }
    .acciones {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>

  <h1>üìä Esentia - Reporte de Rentabilidad</h1>

  <div style="max-width: 600px;">
    <div class="filtro-item">
      <label for="mes-reporte">Mes:</label>
      <select id="mes-reporte">
        <option value="0">Enero</option>
        <option value="1">Febrero</option>
        <option value="2">Marzo</option>
        <option value="3">Abril</option>
        <option value="4">Mayo</option>
        <option value="5">Junio</option>
        <option value="6">Julio</option>
        <option value="7">Agosto</option>
        <option value="8">Septiembre</option>
        <option value="9">Octubre</option>
        <option value="10">Noviembre</option>
        <option value="11">Diciembre</option>
        <option value="todos" selected>Todo el a√±o</option>
      </select>
    </div>
    <button class="boton-accion" onclick="generarReporte()">üìä Generar Reporte</button>
  </div>

  <!-- Botones adicionales -->
  <div class="acciones">
    <button class="boton-accion" onclick="generarReportePorProducto()">üì¶ Rentabilidad por Producto</button>
    <button class="boton-accion" onclick="exportarCSV()">‚¨áÔ∏è Exportar a Excel</button>
  </div>

  <div id="resultado-reporte" style="margin-top: 30px;">
    <p>Haz clic en "Generar Reporte" para ver los resultados.</p>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // üî• Tu configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDuMNZrLgxBs6CbuPp8j0iyynejt6WCpnQ",
      authDomain: "esentiacreditos-8345f.firebaseapp.com",
      projectId: "esentiacreditos-8345f",
      storageBucket: "esentiacreditos-8345f.firebasestorage.app",
      messagingSenderId: "888658236080",
      appId: "1:888658236080:web:506e5e2085b5a452dba175"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Referencias
    const clientesRef = collection(db, "clientes");
    const comprasProveedorRef = collection(db, "comprasProveedor");

    // Variables globales para reutilizar en exportaci√≥n
    let totalVentas = 0;
    let totalGastos = 0;
    let utilidadBruta = 0;
    let margen = 0;
    let ventasPorMes = Array(12).fill(0);
    let gastosPorMes = Array(12).fill(0);
    let utilidadPorMes = Array(12).fill(0);

    // ‚úÖ Generar Reporte de Rentabilidad
    async function generarReporte() {
      const cont = document.getElementById("resultado-reporte");
      cont.innerHTML = "<p>üìä Calculando rentabilidad...</p>";

      const mesSeleccionado = document.getElementById("mes-reporte").value;

      // Reiniciar contadores
      totalVentas = 0;
      totalGastos = 0;
      ventasPorMes = Array(12).fill(0);
      gastosPorMes = Array(12).fill(0);

      try {
        // 1. Calcular ingresos (ventas a clientes)
        const snapshotClientes = await getDocs(clientesRef);
        snapshotClientes.forEach(docSnap => {
          const cliente = docSnap.data();
          const compras = cliente.compras || [];
          compras.forEach(compra => {
            const fecha = new Date(compra.fecha);
            const mes = fecha.getMonth();
            const incluir = mesSeleccionado === "todos" || parseInt(mesSeleccionado) === mes;

            if (incluir) {
              const totalNeto = (compra.monto || 0) - (compra.descuento || 0);
              totalVentas += totalNeto;
              ventasPorMes[mes] += totalNeto;
            }
          });
        });

        // 2. Calcular gastos (compras a proveedores)
        const snapshotProveedores = await getDocs(comprasProveedorRef);
        snapshotProveedores.forEach(docSnap => {
          const compra = docSnap.data();
          const fecha = new Date(compra.fecha);
          const mes = fecha.getMonth();
          const incluir = mesSeleccionado === "todos" || parseInt(mesSeleccionado) === mes;

          if (incluir) {
            totalGastos += compra.totalCompra || 0;
            gastosPorMes[mes] += compra.totalCompra || 0;
          }
        });

        // 3. Calcular utilidad
        utilidadBruta = totalVentas - totalGastos;
        margen = totalVentas > 0 ? (utilidadBruta / totalVentas) * 100 : 0;

        // Calcular utilidad por mes
        for (let m = 0; m < 12; m++) {
          utilidadPorMes[m] = ventasPorMes[m] - gastosPorMes[m];
        }

        // 4. Mostrar resultados
        const mesTexto = mesSeleccionado === "todos" 
          ? "Todo el a√±o" 
          : new Date(2025, mesSeleccionado).toLocaleString('es-ES', { month: 'long' });

        let html = `
          <div class="resumen">
            <h3>üìà Rentabilidad (${mesTexto.charAt(0).toUpperCase() + mesTexto.slice(1)})</h3>
            <table class="tabla-reportes">
              <tr>
                <th>Concepto</th>
                <th>Monto</th>
              </tr>
              <tr>
                <td><strong>Ventas Totales</strong></td>
                <td>‚Ç°${totalVentas.toLocaleString()}</td>
              </tr>
              <tr>
                <td><strong>Gastos (Compras)</strong></td>
                <td>‚Ç°${totalGastos.toLocaleString()}</td>
              </tr>
              <tr>
                <td><strong>Utilidad Bruta</strong></td>
                <td class="${utilidadBruta >= 0 ? 'deuda-baja' : 'deuda-alta'}">
                  ‚Ç°${utilidadBruta.toLocaleString()}
                </td>
              </tr>
              <tr>
                <td><strong>Margen de Utilidad</strong></td>
                <td class="${margen >= 30 ? 'deuda-baja' : margen >= 15 ? 'deuda-media' : 'deuda-alta'}">
                  ${margen.toFixed(2)}%
                </td>
              </tr>
            </table>
          </div>
        `;

        // 5. Detalle por mes (solo si es "todo el a√±o")
        if (mesSeleccionado === "todos") {
          html += `
            <h2>üìã Detalle Mensual</h2>
            <table class="tabla-reportes">
              <thead>
                <tr>
                  <th>Mes</th>
                  <th>Ventas</th>
                  <th>Gastos</th>
                  <th>Utilidad</th>
                </tr>
              </thead>
              <tbody>
          `;

          for (let m = 0; m <= 11; m++) {
            const utilidadMes = ventasPorMes[m] - gastosPorMes[m];
            const nombreMes = new Date(2025, m).toLocaleString('es-ES', { month: 'short' });

            html += `
              <tr>
                <td><strong>${nombreMes}</strong></td>
                <td>‚Ç°${ventasPorMes[m].toLocaleString()}</td>
                <td>‚Ç°${gastosPorMes[m].toLocaleString()}</td>
                <td class="${utilidadMes >= 0 ? 'deuda-baja' : 'deuda-alta'}">‚Ç°${utilidadMes.toLocaleString()}</td>
              </tr>
            `;
          }

          html += `
              </tbody>
            </table>
          `;
        }

        // 6. Alerta si hay inconsistencias
        if (totalVentas === 0 && totalGastos === 0) {
          html += `<p class="alerta">‚ö†Ô∏è No se encontraron datos de ventas ni gastos.</p>`;
        }

        cont.innerHTML = html;

      } catch (error) {
        cont.innerHTML = `<p class="alerta">‚ùå Error al generar el reporte: ${error.message}</p>`;
        console.error("Error:", error);
      }
    }

    // ‚úÖ Generar reporte por producto
    async function generarReportePorProducto() {
      const cont = document.getElementById("resultado-reporte");
      cont.innerHTML = "<p>üìä Calculando rentabilidad por producto...</p>";

      // Estructura: { nombre: { ventas: 0, compras: 0, utilidad: 0 } }
      const productos = {};

      try {
        // 1. Ventas (de clientes)
        const snapshotClientes = await getDocs(clientesRef);
        snapshotClientes.forEach(docSnap => {
          const cliente = docSnap.data();
          (cliente.compras || []).forEach(compra => {
            (compra.productos || []).forEach(prod => {
              const nombre = prod.nombre;
              if (!productos[nombre]) productos[nombre] = { ventas: 0, compras: 0 };
              productos[nombre].ventas += prod.precio || 0;
            });
          });
        });

        // 2. Compras (a proveedores)
        const snapshotProveedores = await getDocs(comprasProveedorRef);
        snapshotProveedores.forEach(docSnap => {
          const compra = docSnap.data();
          (compra.productos || []).forEach(prod => {
            const nombre = prod.nombre;
            if (!productos[nombre]) productos[nombre] = { ventas: 0, compras: 0 };
            productos[nombre].compras += prod.total || 0;
          });
        });

        // 3. Calcular utilidad
        let totalUtilidad = 0;
        const lista = Object.keys(productos)
          .map(nombre => {
            const venta = productos[nombre].ventas;
            const compra = productos[nombre].compras;
            const utilidad = venta - compra;
            totalUtilidad += utilidad;
            return { nombre, venta, compra, utilidad };
          })
          .sort((a, b) => b.utilidad - a.utilidad); // Ordenar por utilidad

        // 4. Mostrar tabla
        let html = `
          <div class="resumen">
            <h3>üì¶ Rentabilidad por Producto</h3>
            <p><strong>Total de utilidad por productos:</strong> ‚Ç°${totalUtilidad.toLocaleString()}</p>
          </div>
          <table class="tabla-reportes">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Ventas (‚Ç°)</th>
                <th>Compras (‚Ç°)</th>
                <th>Utilidad (‚Ç°)</th>
              </tr>
            </thead>
            <tbody>
        `;

        lista.forEach(p => {
          const clase = p.utilidad >= 0 ? "deuda-baja" : "deuda-alta";
          html += `
            <tr>
              <td><strong>${p.nombre}</strong></td>
              <td>‚Ç°${p.venta.toLocaleString()}</td>
              <td>‚Ç°${p.compra.toLocaleString()}</td>
              <td class="${clase}">‚Ç°${p.utilidad.toLocaleString()}</td>
            </tr>
          `;
        });

        html += `</tbody></table>`;
        cont.innerHTML = html;

      } catch (error) {
        cont.innerHTML = `<p class="alerta">‚ùå Error: ${error.message}</p>`;
      }
    }

    // ‚úÖ Exportar a CSV
    function exportarCSV() {
      if (totalVentas === 0 && totalGastos === 0) {
        alert("‚ö†Ô∏è No hay datos para exportar. Genera un reporte primero.");
        return;
      }

      const mesSeleccionado = document.getElementById("mes-reporte").value;
      const mesTexto = mesSeleccionado === "todos" 
        ? "Todo el a√±o" 
        : new Date(2025, mesSeleccionado).toLocaleString('es-ES', { month: 'long' });

      let filas = [
        ["Reporte de Rentabilidad", mesTexto],
        [],
        ["Concepto", "Monto"],
        ["Ventas Totales", totalVentas],
        ["Gastos (Compras)", totalGastos],
        ["Utilidad Bruta", utilidadBruta],
        ["Margen de Utilidad", `${margen.toFixed(2)}%`],
        [],
        ["Mes", "Ventas", "Gastos", "Utilidad"]
      ];

      // Detalle mensual
      for (let m = 0; m <= 11; m++) {
        if (mesSeleccionado !== "todos" && parseInt(mesSeleccionado) !== m) continue;
        const nombreMes = new Date(2025, m).toLocaleString('es-ES', { month: 'short' });
        const utilidadMes = ventasPorMes[m] - gastosPorMes[m];
        filas.push([
          nombreMes,
          ventasPorMes[m],
          gastosPorMes[m],
          utilidadMes
        ]);
      }

      // Convertir a CSV
      const csv = filas.map(fila => fila.join(",")).join("\n");
      const blob = new Blob(["\uFEFF" + csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      const fecha = new Date().toISOString().slice(0,10);
      link.setAttribute("href", URL.createObjectURL(blob));
      link.setAttribute("download", `reporte-rentabilidad-${fecha}.csv`);
      link.click();
    }

    // ‚úÖ Mejorar impresi√≥n
    function imprimirModal() {
      const contenido = document.getElementById("resultado-reporte").innerHTML;
      const mesSeleccionado = document.getElementById("mes-reporte").value;
      const mesTexto = mesSeleccionado === "todos" 
        ? "Todo el a√±o" 
        : new Date(2025, mesSeleccionado).toLocaleString('es-ES', { month: 'long' });

      const ventana = window.open('', '_blank', 'width=800,height=600');
      ventana.document.write(`
        <html>
          <head>
            <title>Reporte de Rentabilidad</title>
            <style>
              body { 
                font-family: Arial, sans-serif; 
                padding: 20px; 
                color: #333; 
                max-width: 1000px;
                margin: 0 auto;
              }
              .encabezado {
                text-align: center;
                border-bottom: 3px solid #6c4ba3;
                padding-bottom: 10px;
                margin-bottom: 20px;
              }
              .encabezado h2 {
                color: #6c4ba3;
                margin: 0;
              }
              .fecha {
                color: #666;
                font-style: italic;
              }
              table { 
                width: 100%; 
                border-collapse: collapse; 
                margin: 20px 0; 
              }
              th, td { 
                border: 1px solid #ddd; 
                padding: 12px; 
                text-align: left; 
              }
              th { 
                background-color: #6c4ba3; 
                color: white; 
              }
              .deuda-alta { color: #d32f2f; font-weight: bold; }
              .deuda-media { color: #f57c00; font-weight: bold; }
              .deuda-baja { color: #388e3c; font-weight: bold; }
              .resumen {
                background: #f5f5f5;
                padding: 15px;
                border-radius: 8px;
                margin: 20px 0;
              }
              @media print {
                button { display: none; }
                body { padding: 0; margin: 20px; }
              }
            </style>
          </head>
          <body>
            <div class="encabezado">
              <h2>üìä Reporte de Rentabilidad</h2>
              <p class="fecha"><strong>Periodo:</strong> ${mesTexto}</p>
              <p class="fecha"><strong>Fecha de impresi√≥n:</strong> ${new Date().toLocaleDateString()}</p>
            </div>
            ${contenido}
            <button onclick="window.print()" style="padding: 10px; background: #6c4ba3; color: white; border: none; border-radius: 5px; margin-top: 20px;">üñ®Ô∏è Imprimir</button>
          </body>
        </html>
      `);
      ventana.document.close();
    }

    // Hacer funciones globales
    window.generarReporte = generarReporte;
    window.generarReportePorProducto = generarReportePorProducto;
    window.exportarCSV = exportarCSV;
    window.imprimirModal = imprimirModal;
  </script>

  <!-- Bot√≥n de impresi√≥n adicional -->
  <button class="boton-accion" onclick="imprimirModal()">üñ®Ô∏è Imprimir Reporte</button>
</body>
</html>